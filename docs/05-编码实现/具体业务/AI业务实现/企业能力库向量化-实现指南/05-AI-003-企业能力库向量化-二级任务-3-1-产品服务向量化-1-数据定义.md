# Python FastAPI AI 服务任务详细计划 - AI-003 - AI-003: 企业能力库向量化 - 二级任务 3.1: 产品服务向量化 - 1) 数据定义

##### Pydantic模型（Python AI服务）
```python
# app/models/capability.py
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any
from datetime import datetime
from enum import Enum

class CapabilityType(str, Enum):
    """能力类型"""
    PRODUCT = "product"       # 产品
    SERVICE = "service"       # 服务
    SOLUTION = "solution"     # 解决方案

class ProductCapability(BaseModel):
    """产品能力模型"""
    id: str = Field(..., description="产品ID（来自Java服务）")
    organization_id: str = Field(..., description="组织ID")
    capability_type: CapabilityType = Field(..., description="能力类型")

    # 基本信息
    name: str = Field(..., description="产品/服务名称")
    category: Optional[str] = Field(None, description="分类")
    description: str = Field(..., description="描述")

    # 详细信息
    features: List[str] = Field(default_factory=list, description="功能特性")
    specifications: Dict[str, Any] = Field(default_factory=dict, description="技术规格")
    advantages: List[str] = Field(default_factory=list, description="优势")
    application_scenarios: List[str] = Field(default_factory=list, description="应用场景")
    technology_stack: List[str] = Field(default_factory=list, description="技术栈")

    # 向量化相关
    embedding: Optional[List[float]] = Field(None, description="向量（1536维）")
    embedding_model: str = Field("text-embedding-ada-002", description="嵌入模型")
    vectorized_at: Optional[datetime] = Field(None, description="向量化时间")

    # 元数据
    tags: List[str] = Field(default_factory=list, description="标签")
    is_active: bool = Field(True, description="是否有效")
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

class VectorizationTask(BaseModel):
    """向量化任务"""
    task_id: str = Field(..., description="任务ID")
    capability_id: str = Field(..., description="能力ID")
    capability_type: CapabilityType = Field(..., description="能力类型")
    status: str = Field("pending", description="pending|processing|completed|failed")
    error_message: Optional[str] = Field(None, description="错误信息")
    created_at: datetime = Field(default_factory=datetime.utcnow)
    completed_at: Optional[datetime] = Field(None)
```

##### Java实体（Java服务）
```java
// CompanyCapability.java - Java服务管理的能力实体
@Data
@TableName("company_capabilities")
public class CompanyCapability {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;

    private String organizationId;

    @TableField("capability_type")
    private String capabilityType;  // product|service|solution

    private String name;
    private String category;
    private String description;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> features;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private Map<String, Object> specifications;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> advantages;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> applicationScenarios;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> technologyStack;

    // 向量化状态
    private String embeddingStatus;  // pending|completed|failed
    private LocalDateTime vectorizedAt;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> tags;

    private Boolean isActive;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
}
```

##### 数据库表设计（PostgreSQL）
```sql
-- Java服务管理的企业能力表
CREATE TABLE company_capabilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL,
    capability_type VARCHAR(50) NOT NULL,  -- 'product'|'service'|'solution'

    -- 基本信息
    name VARCHAR(200) NOT NULL,
    category VARCHAR(100),
    description TEXT NOT NULL,

    -- 详细信息（JSONB存储）
    features JSONB DEFAULT '[]'::jsonb,
    specifications JSONB DEFAULT '{}'::jsonb,
    advantages JSONB DEFAULT '[]'::jsonb,
    application_scenarios JSONB DEFAULT '[]'::jsonb,
    technology_stack JSONB DEFAULT '[]'::jsonb,

    -- 向量化状态
    embedding_status VARCHAR(20) DEFAULT 'pending',  -- pending|completed|failed
    vectorized_at TIMESTAMP WITH TIME ZONE,

    -- 元数据
    tags TEXT[],
    is_active BOOLEAN DEFAULT TRUE,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_capabilities_org ON company_capabilities(organization_id) WHERE is_active = TRUE;
CREATE INDEX idx_capabilities_type ON company_capabilities(capability_type);
CREATE INDEX idx_capabilities_status ON company_capabilities(embedding_status);
CREATE INDEX idx_capabilities_tags ON company_capabilities USING gin(tags);

-- 全文搜索索引
CREATE INDEX idx_capabilities_fts ON company_capabilities
    USING gin(to_tsvector('chinese', name || ' ' || description));
```

##### Elasticsearch索引定义
```json
{
  "mappings": {
    "properties": {
      "capability_id": { "type": "keyword" },
      "organization_id": { "type": "keyword" },
      "capability_type": { "type": "keyword" },
      "name": { "type": "text", "analyzer": "ik_max_word" },
      "description": { "type": "text", "analyzer": "ik_max_word" },
      "features": { "type": "text", "analyzer": "ik_max_word" },
      "advantages": { "type": "text", "analyzer": "ik_max_word" },
      "technology_stack": { "type": "keyword" },
      "tags": { "type": "keyword" },
      "embedding": {
        "type": "dense_vector",
        "dims": 1536,
        "index": true,
        "similarity": "cosine"
      },
      "vectorized_at": { "type": "date" },
      "is_active": { "type": "boolean" }
    }
  },
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}
```

**验证标准**:
- [ ] Pydantic模型能正确序列化/反序列化
- [ ] PostgreSQL表结构创建成功
- [ ] Elasticsearch索引创建成功，支持kNN检索
- [ ] JSONB字段能正确存储和查询
