# Java Spring Boot 服务任务详细计划 - JAVA-001 Part2 - 1.4: 权限控制 - 1.4.2 前端

**验证清单**:
- [ ] 角色管理页面开发完成
- [ ] 权限管理页面开发完成
- [ ] 用户角色分配功能正常
- [ ] 权限检查逻辑正确

#### 角色管理页面

```typescript
// frontend/src/pages/System/Role/RoleList.tsx
import React, { useRef, useState } from 'react';
import { ProTable, ProColumns, ActionType } from '@ant-design/pro-table';
import { Button, message, Modal, Tag, Space, Tooltip } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, SafetyOutlined } from '@ant-design/icons';
import type { RoleResponse } from '@/services/role.service';
import { roleService } from '@/services/role.service';
import RoleForm from './RoleForm';
import PermissionAssign from './PermissionAssign';

/**
 * 角色管理列表页面
 * 需求编号: REQ-FRONT-002
 */
const RoleList: React.FC = () => {
  const actionRef = useRef<ActionType>();
  const [createModalVisible, setCreateModalVisible] = useState(false);
  const [updateModalVisible, setUpdateModalVisible] = useState(false);
  const [permissionModalVisible, setPermissionModalVisible] = useState(false);
  const [currentRole, setCurrentRole] = useState<RoleResponse | null>(null);

  const columns: ProColumns<RoleResponse>[] = [
    {
      title: '角色名称',
      dataIndex: 'name',
      width: 150,
      fixed: 'left',
    },
    {
      title: '角色代码',
      dataIndex: 'code',
      width: 150,
      copyable: true,
    },
    {
      title: '描述',
      dataIndex: 'description',
      ellipsis: true,
      search: false,
    },
    {
      title: '层级',
      dataIndex: 'level',
      width: 80,
      sorter: true,
      render: (text) => <Tag color="blue">{text}</Tag>,
    },
    {
      title: '系统角色',
      dataIndex: 'isSystem',
      width: 100,
      valueType: 'select',
      valueEnum: {
        true: { text: '是', status: 'Success' },
        false: { text: '否', status: 'Default' },
      },
      render: (_, record) => (
        <Tag color={record.isSystem ? 'gold' : 'default'}>
          {record.isSystem ? '系统' : '自定义'}
        </Tag>
      ),
    },
    {
      title: '权限数量',
      dataIndex: 'permissions',
      width: 100,
      search: false,
      render: (_, record) => (
        <Tooltip title="点击查看权限详情">
          <Tag color="geekblue" style={{ cursor: 'pointer' }}>
            {record.permissions?.length || 0} 个
          </Tag>
        </Tooltip>
      ),
    },
    {
      title: '创建时间',
      dataIndex: 'createdAt',
      valueType: 'dateTime',
      width: 180,
      sorter: true,
      search: false,
    },
    {
      title: '操作',
      valueType: 'option',
      width: 200,
      fixed: 'right',
      render: (text, record, _, action) => [
        <a
          key="edit"
          onClick={() => {
            setCurrentRole(record);
            setUpdateModalVisible(true);
          }}
          disabled={record.isSystem}
        >
          <EditOutlined /> 编辑
        </a>,
        <a
          key="permissions"
          onClick={() => {
            setCurrentRole(record);
            setPermissionModalVisible(true);
          }}
        >
          <SafetyOutlined /> 权限
        </a>,
        <a
          key="delete"
          onClick={async () => {
            Modal.confirm({
              title: '确认删除',
              content: `确定要删除角色"${record.name}"吗？此操作不可恢复。`,
              okText: '确定',
              cancelText: '取消',
              okType: 'danger',
              onOk: async () => {
                try {
                  await roleService.deleteRole(record.id);
                  message.success('角色删除成功');
                  action?.reload();
                } catch (error: any) {
                  message.error(error.message || '删除失败');
                }
              },
            });
          }}
          disabled={record.isSystem}
        >
          <DeleteOutlined /> 删除
        </a>,
      ],
    },
  ];

  return (
    <>
      <ProTable<RoleResponse>
        columns={columns}
        actionRef={actionRef}
        request={async (params, sort, filter) => {
          const response = await roleService.getRoles({
            page: params.current || 1,
            pageSize: params.pageSize || 20,
            name: params.name,
            code: params.code,
            isSystem: params.isSystem,
            sortBy: sort && Object.keys(sort)[0],
            sortOrder: sort && Object.values(sort)[0] === 'ascend' ? 'asc' : 'desc',
          });
          return {
            data: response.data.items,
            success: response.success,
            total: response.data.total,
          };
        }}
        rowKey="id"
        pagination={{
          pageSize: 20,
          showSizeChanger: true,
          showQuickJumper: true,
        }}
        search={{
          labelWidth: 'auto',
        }}
        dateFormatter="string"
        headerTitle="角色列表"
        toolBarRender={() => [
          <Button
            key="button"
            icon={<PlusOutlined />}
            type="primary"
            onClick={() => {
              setCurrentRole(null);
              setCreateModalVisible(true);
            }}
          >
            新建角色
          </Button>,
        ]}
      />

      {/* 创建角色弹窗 */}
      <RoleForm
        visible={createModalVisible}
        onCancel={() => setCreateModalVisible(false)}
        onSuccess={() => {
          setCreateModalVisible(false);
          actionRef.current?.reload();
        }}
      />

      {/* 编辑角色弹窗 */}
      <RoleForm
        visible={updateModalVisible}
        role={currentRole}
        onCancel={() => setUpdateModalVisible(false)}
        onSuccess={() => {
          setUpdateModalVisible(false);
          actionRef.current?.reload();
        }}
      />

      {/* 权限分配弹窗 */}
      <PermissionAssign
        visible={permissionModalVisible}
        role={currentRole}
        onCancel={() => setPermissionModalVisible(false)}
        onSuccess={() => {
          setPermissionModalVisible(false);
          actionRef.current?.reload();
        }}
      />
    </>
  );
};

export default RoleList;
```

#### 角色表单组件

```typescript
// frontend/src/pages/System/Role/RoleForm.tsx
import React, { useEffect } from 'react';
import { Modal, message } from 'antd';
import { ProForm, ProFormText, ProFormTextArea, ProFormDigit, ProFormSelect } from '@ant-design/pro-form';
import type { RoleResponse, RoleRequest } from '@/services/role.service';
import { roleService } from '@/services/role.service';

interface RoleFormProps {
  visible: boolean;
  role?: RoleResponse | null;
  onCancel: () => void;
  onSuccess: () => void;
}

/**
 * 角色创建/编辑表单
 * 需求编号: REQ-FRONT-002
 */
const RoleForm: React.FC<RoleFormProps> = ({ visible, role, onCancel, onSuccess }) => {
  const [form] = ProForm.useForm();

  useEffect(() => {
    if (visible && role) {
      form.setFieldsValue({
        name: role.name,
        code: role.code,
        description: role.description,
        level: role.level,
      });
    } else {
      form.resetFields();
    }
  }, [visible, role, form]);

  const handleSubmit = async (values: RoleRequest) => {
    try {
      if (role) {
        await roleService.updateRole(role.id, values);
        message.success('角色更新成功');
      } else {
        await roleService.createRole(values);
        message.success('角色创建成功');
      }
      onSuccess();
      return true;
    } catch (error: any) {
      message.error(error.message || '操作失败');
      return false;
    }
  };

  return (
    <Modal
      title={role ? '编辑角色' : '新建角色'}
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={600}
      destroyOnClose
    >
      <ProForm
        form={form}
        onFinish={handleSubmit}
        submitter={{
          searchConfig: {
            submitText: role ? '更新' : '创建',
          },
        }}
      >
        <ProFormText
          name="name"
          label="角色名称"
          placeholder="请输入角色名称"
          rules={[
            { required: true, message: '请输入角色名称' },
            { max: 100, message: '角色名称不能超过100个字符' },
          ]}
        />

        <ProFormText
          name="code"
          label="角色代码"
          placeholder="请输入角色代码（大写字母和下划线）"
          disabled={!!role}
          rules={[
            { required: true, message: '请输入角色代码' },
            { pattern: /^[A-Z_]+$/, message: '只能包含大写字母和下划线' },
            { max: 50, message: '角色代码不能超过50个字符' },
          ]}
          tooltip="角色代码创建后不可修改"
        />

        <ProFormTextArea
          name="description"
          label="描述"
          placeholder="请输入角色描述"
          rules={[{ max: 500, message: '描述不能超过500个字符' }]}
          fieldProps={{ rows: 4 }}
        />

        <ProFormDigit
          name="level"
          label="角色层级"
          placeholder="请输入角色层级"
          min={0}
          max={100}
          initialValue={0}
          tooltip="层级越高权限越大，系统管理员为100"
        />
      </ProForm>
    </Modal>
  );
};

export default RoleForm;
```

#### 权限分配组件

```typescript
// frontend/src/pages/System/Role/PermissionAssign.tsx
import React, { useEffect, useState } from 'react';
import { Modal, Tree, message, Spin } from 'antd';
import type { DataNode } from 'antd/es/tree';
import type { RoleResponse } from '@/services/role.service';
import type { PermissionResponse } from '@/services/permission.service';
import { roleService } from '@/services/role.service';
import { permissionService } from '@/services/permission.service';

interface PermissionAssignProps {
  visible: boolean;
  role: RoleResponse | null;
  onCancel: () => void;
  onSuccess: () => void;
}

/**
 * 权限分配组件
 * 需求编号: REQ-FRONT-002
 */
const PermissionAssign: React.FC<PermissionAssignProps> = ({ visible, role, onCancel, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [permissions, setPermissions] = useState<PermissionResponse[]>([]);
  const [checkedKeys, setCheckedKeys] = useState<string[]>([]);
  const [treeData, setTreeData] = useState<DataNode[]>([]);

  useEffect(() => {
    if (visible && role) {
      loadPermissions();
    }
  }, [visible, role]);

  const loadPermissions = async () => {
    setLoading(true);
    try {
      const response = await permissionService.getAllPermissions();
      setPermissions(response.data);

      // 构建权限树
      const tree = buildPermissionTree(response.data);
      setTreeData(tree);

      // 设置已选中的权限
      const checked = role?.permissions?.map((p) => p.id) || [];
      setCheckedKeys(checked);
    } catch (error: any) {
      message.error(error.message || '加载权限失败');
    } finally {
      setLoading(false);
    }
  };

  const buildPermissionTree = (permissions: PermissionResponse[]): DataNode[] => {
    const categoryMap: Record<string, PermissionResponse[]> = {};

    permissions.forEach((permission) => {
      const category = permission.category || '其他';
      if (!categoryMap[category]) {
        categoryMap[category] = [];
      }
      categoryMap[category].push(permission);
    });

    return Object.entries(categoryMap).map(([category, perms]) => ({
      title: category,
      key: category,
      children: perms.map((p) => ({
        title: `${p.name} (${p.code})`,
        key: p.id,
      })),
    }));
  };

  const handleSubmit = async () => {
    if (!role) return;

    setLoading(true);
    try {
      await roleService.assignPermissions(role.id, {
        permissionIds: checkedKeys,
      });
      message.success('权限分配成功');
      onSuccess();
    } catch (error: any) {
      message.error(error.message || '权限分配失败');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Modal
      title={`分配权限 - ${role?.name}`}
      open={visible}
      onCancel={onCancel}
      onOk={handleSubmit}
      confirmLoading={loading}
      width={600}
      okText="保存"
      cancelText="取消"
    >
      <Spin spinning={loading}>
        <Tree
          checkable
          checkedKeys={checkedKeys}
          onCheck={(checked: any) => setCheckedKeys(checked)}
          treeData={treeData}
          defaultExpandAll
        />
      </Spin>
    </Modal>
  );
};

export default PermissionAssign;
```

#### API 客户端

```typescript
// frontend/src/services/role.service.ts
import axios from '@/utils/axios';
import type { PaginatedResponse, ApiResponse } from '@/types/api';

export interface RoleResponse {
  id: string;
  name: string;
  code: string;
  description: string;
  organizationId?: string;
  isSystem: boolean;
  level: number;
  permissions: PermissionResponse[];
  createdAt: string;
  updatedAt: string;
}

export interface RoleRequest {
  name: string;
  code: string;
  description?: string;
  organizationId?: string;
  level?: number;
  permissionIds?: string[];
}

export interface AssignPermissionsRequest {
  permissionIds: string[];
}

export const roleService = {
  /**
   * 获取角色列表
   */
  getRoles: (params: {
    page?: number;
    pageSize?: number;
    name?: string;
    code?: string;
    isSystem?: boolean;
    sortBy?: string;
    sortOrder?: 'asc' | 'desc';
  }): Promise<ApiResponse<PaginatedResponse<RoleResponse>>> => {
    return axios.get('/api/v1/roles', { params });
  },

  /**
   * 获取角色详情
   */
  getRoleById: (id: string): Promise<ApiResponse<RoleResponse>> => {
    return axios.get(`/api/v1/roles/${id}`);
  },

  /**
   * 创建角色
   */
  createRole: (data: RoleRequest): Promise<ApiResponse<RoleResponse>> => {
    return axios.post('/api/v1/roles', data);
  },

  /**
   * 更新角色
   */
  updateRole: (id: string, data: RoleRequest): Promise<ApiResponse<RoleResponse>> => {
    return axios.put(`/api/v1/roles/${id}`, data);
  },

  /**
   * 删除角色
   */
  deleteRole: (id: string): Promise<ApiResponse<void>> => {
    return axios.delete(`/api/v1/roles/${id}`);
  },

  /**
   * 分配权限给角色
   */
  assignPermissions: (id: string, data: AssignPermissionsRequest): Promise<ApiResponse<RoleResponse>> => {
    return axios.post(`/api/v1/roles/${id}/permissions`, data);
  },

  /**
   * 分配角色给用户
   */
  assignRolesToUser: (userId: string, roleIds: string[]): Promise<ApiResponse<void>> => {
    return axios.post(`/api/v1/users/${userId}/roles`, { roleIds });
  },
};
```
