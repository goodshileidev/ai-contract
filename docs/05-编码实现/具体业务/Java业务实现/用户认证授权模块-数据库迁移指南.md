# Java Spring Boot æœåŠ¡ä»»åŠ¡è¯¦ç»†è®¡åˆ’ - JAVA-001 Part3

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-001 (å­ä»»åŠ¡ 1.5-1.6)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-26
**åˆ›å»ºè€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º Part3 (å­ä»»åŠ¡1.5-1.6+æ€»ç»“) |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [task-plan-java-è¯¦ç»†-INDEX.md](./task-plan-java-è¯¦ç»†-INDEX.md)

**å…¶ä»–éƒ¨åˆ†**:
- [Part1: å­ä»»åŠ¡ 1.1-1.3](./task-plan-java-è¯¦ç»†-JAVA-001-Part1.md)
- [Part2: å­ä»»åŠ¡ 1.4](./task-plan-java-è¯¦ç»†-JAVA-001-Part2.md)

---

## æ¨¡å—æ¦‚è¿°

æœ¬æ–‡æ¡£åŒ…å« **JAVA-001: ç”¨æˆ·è®¤è¯æˆæƒæ¨¡å—** çš„æœ€å2ä¸ªå­ä»»åŠ¡åŠæ¨¡å—æ€»ç»“ï¼š
- 1.5 ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†
- 1.6 æ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- JAVA-001 æ¨¡å—å®Œæˆæ€»ç»“

**æŠ€æœ¯æ ˆ**: Java 17 LTS + Spring Boot 3.2.x + Spring Data JPA + Spring Security 6.x

---

## 1.5: ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†

**å­ä»»åŠ¡ç¼–å·**: JAVA-001-1.5
**é¢„è®¡å·¥æ—¶**: 3äººå¤©
**è´Ÿè´£äºº**: Javaåç«¯å¼€å‘ + å‰ç«¯å¼€å‘
**ä¾èµ–**: 1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½ã€1.2 Spring Security é›†æˆ
**è¾“å‡º**: ç”¨æˆ·ä¸ªäººä¸­å¿ƒå®Œæ•´åŠŸèƒ½

### ä»»åŠ¡ç›®æ ‡

å®ç°ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬:
- æŸ¥çœ‹ä¸ªäººèµ„æ–™
- æ›´æ–°ä¸ªäººèµ„æ–™
- ä¿®æ”¹å¯†ç 
- å¤´åƒä¸Šä¼ 
- å®‰å…¨è®¾ç½®ï¼ˆé‚®ç®±éªŒè¯ã€æ‰‹æœºéªŒè¯ï¼‰
- ç™»å½•å†å²æŸ¥çœ‹

---

### 1.6.1 æ•°æ®å®šä¹‰

**ä»»åŠ¡æè¿°**: è®¾è®¡å®Œæ•´çš„æ•°æ®åº“schemaï¼ŒåŒ…æ‹¬æ‰€æœ‰è¡¨ã€å­—æ®µã€çº¦æŸã€ç´¢å¼•å’Œè§¦å‘å™¨

**æ ¸å¿ƒæ•°æ®æ¨¡å‹**:

##### 1.6.1.1 users è¡¨ï¼ˆç”¨æˆ·æ ¸å¿ƒè¡¨ï¼‰

**Flywayè„šæœ¬**: `V1__create_users_table.sql`

```sql
-- ============================================================================
-- ç”¨æˆ·æ ¸å¿ƒè¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

-- å¯ç”¨UUIDæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- åˆ›å»ºusersè¡¨
CREATE TABLE users (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- åŸºæœ¬ä¿¡æ¯
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(200),
    hashed_password VARCHAR(255) NOT NULL,

    -- è”ç³»æ–¹å¼
    phone VARCHAR(20),
    phone_verified BOOLEAN DEFAULT FALSE,
    email_verified BOOLEAN DEFAULT FALSE,

    -- å¤´åƒå’Œèµ„æ–™
    avatar_url TEXT,
    bio TEXT,

    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'INACTIVE', 'SUSPENDED', 'LOCKED')),

    -- ç™»å½•ä¿¡æ¯
    last_login_at TIMESTAMP WITH TIME ZONE,
    last_login_ip INET,
    login_count INTEGER DEFAULT 0,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP WITH TIME ZONE,

    -- ç»„ç»‡å…³è”
    organization_id UUID,

    -- æ‰©å±•å­—æ®µ
    settings JSONB DEFAULT '{}'::jsonb,
    metadata JSONB DEFAULT '{}'::jsonb,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,

    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_users_organization
        FOREIGN KEY (organization_id)
        REFERENCES organizations(id)
        ON DELETE SET NULL
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_username ON users(username) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_organization_id ON users(organization_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_status ON users(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_created_at ON users(created_at DESC);
CREATE INDEX idx_users_last_login_at ON users(last_login_at DESC);

-- JSONBå­—æ®µGINç´¢å¼•ï¼ˆç”¨äºå¿«é€ŸæŸ¥è¯¢settingså’Œmetadataï¼‰
CREATE INDEX idx_users_settings ON users USING gin(settings);
CREATE INDEX idx_users_metadata ON users USING gin(metadata);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è‡ªåŠ¨æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·æ ¸å¿ƒè¡¨ - å­˜å‚¨æ‰€æœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å’Œè®¤è¯æ•°æ®';
COMMENT ON COLUMN users.id IS 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰';
COMMENT ON COLUMN users.email IS 'ç”¨æˆ·é‚®ç®±ï¼ˆå”¯ä¸€ï¼Œç”¨äºç™»å½•ï¼‰';
COMMENT ON COLUMN users.username IS 'ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰';
COMMENT ON COLUMN users.hashed_password IS 'BCryptåŠ å¯†åçš„å¯†ç ';
COMMENT ON COLUMN users.status IS 'ç”¨æˆ·çŠ¶æ€: ACTIVE-æ´»è·ƒ, INACTIVE-æœªæ¿€æ´», SUSPENDED-å·²æš‚åœ, LOCKED-å·²é”å®š';
COMMENT ON COLUMN users.settings IS 'ç”¨æˆ·ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN users.metadata IS 'ç”¨æˆ·å…ƒæ•°æ®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN users.deleted_at IS 'è½¯åˆ é™¤æ—¶é—´æˆ³';
```

##### 1.6.1.2 roles è¡¨ï¼ˆè§’è‰²è¡¨ï¼‰

**Flywayè„šæœ¬**: `V2__create_roles_table.sql`

```sql
-- ============================================================================
-- è§’è‰²è¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

CREATE TABLE roles (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- è§’è‰²ä¿¡æ¯
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,

    -- ç»„ç»‡å…³è”ï¼ˆNULLè¡¨ç¤ºå…¨å±€è§’è‰²ï¼‰
    organization_id UUID,

    -- è§’è‰²å±æ€§
    is_system BOOLEAN DEFAULT FALSE,
    level INTEGER DEFAULT 0,

    -- æ‰©å±•å­—æ®µ
    metadata JSONB DEFAULT '{}'::jsonb,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,

    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_roles_organization
        FOREIGN KEY (organization_id)
        REFERENCES organizations(id)
        ON DELETE CASCADE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_roles_code ON roles(code) WHERE deleted_at IS NULL;
CREATE INDEX idx_roles_organization_id ON roles(organization_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_roles_is_system ON roles(is_system);
CREATE INDEX idx_roles_level ON roles(level DESC);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER trigger_roles_updated_at
    BEFORE UPDATE ON roles
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ³¨é‡Š
COMMENT ON TABLE roles IS 'è§’è‰²è¡¨ - å®šä¹‰ç³»ç»Ÿå’Œç»„ç»‡çº§åˆ«çš„è§’è‰²';
COMMENT ON COLUMN roles.code IS 'è§’è‰²ä»£ç ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰';
COMMENT ON COLUMN roles.is_system IS 'æ˜¯å¦ç³»ç»Ÿè§’è‰²ï¼ˆç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤ï¼‰';
COMMENT ON COLUMN roles.level IS 'è§’è‰²å±‚çº§ï¼ˆ0-100ï¼Œæ•°å­—è¶Šå¤§æƒé™è¶Šé«˜ï¼‰';
```

##### 1.6.1.3 permissions è¡¨ï¼ˆæƒé™è¡¨ï¼‰

**Flywayè„šæœ¬**: `V3__create_permissions_table.sql`

```sql
-- ============================================================================
-- æƒé™è¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

CREATE TABLE permissions (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- æƒé™ä¿¡æ¯
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,

    -- æƒé™åˆ†ç±»
    category VARCHAR(50),
    resource VARCHAR(100) NOT NULL,
    action VARCHAR(50) NOT NULL,

    -- æƒé™å±æ€§
    is_system BOOLEAN DEFAULT FALSE,

    -- æ‰©å±•å­—æ®µ
    metadata JSONB DEFAULT '{}'::jsonb,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_permissions_code ON permissions(code);
CREATE INDEX idx_permissions_resource ON permissions(resource);
CREATE INDEX idx_permissions_category ON permissions(category);
CREATE INDEX idx_permissions_resource_action ON permissions(resource, action);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER trigger_permissions_updated_at
    BEFORE UPDATE ON permissions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ³¨é‡Š
COMMENT ON TABLE permissions IS 'æƒé™è¡¨ - å®šä¹‰æ‰€æœ‰å¯åˆ†é…çš„æƒé™';
COMMENT ON COLUMN permissions.code IS 'æƒé™ä»£ç ï¼ˆresource:actionæ ¼å¼ï¼‰';
COMMENT ON COLUMN permissions.resource IS 'èµ„æºåç§°ï¼ˆå¦‚: user, project, documentï¼‰';
COMMENT ON COLUMN permissions.action IS 'æ“ä½œç±»å‹ï¼ˆå¦‚: create, read, update, deleteï¼‰';
COMMENT ON COLUMN permissions.is_system IS 'æ˜¯å¦ç³»ç»Ÿæƒé™ï¼ˆç³»ç»Ÿæƒé™ä¸å¯åˆ é™¤ï¼‰';
```

##### 1.6.1.4 user_roles è¡¨ï¼ˆç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼‰

**Flywayè„šæœ¬**: `V4__create_user_roles_table.sql`

```sql
-- ============================================================================
-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

CREATE TABLE user_roles (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- å…³è”ID
    user_id UUID NOT NULL,
    role_id UUID NOT NULL,

    -- æˆäºˆä¿¡æ¯
    granted_by UUID,
    granted_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- æœ‰æ•ˆæœŸï¼ˆNULLè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆï¼‰
    expires_at TIMESTAMP WITH TIME ZONE,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_user_roles_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_role
        FOREIGN KEY (role_id)
        REFERENCES roles(id)
        ON DELETE CASCADE,
    CONSTRAINT fk_user_roles_granted_by
        FOREIGN KEY (granted_by)
        REFERENCES users(id)
        ON DELETE SET NULL,

    -- å”¯ä¸€çº¦æŸï¼ˆä¸€ä¸ªç”¨æˆ·ä¸èƒ½è¢«æˆäºˆåŒä¸€ä¸ªè§’è‰²ä¸¤æ¬¡ï¼‰
    UNIQUE (user_id, role_id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE INDEX idx_user_roles_expires_at ON user_roles(expires_at) WHERE expires_at IS NOT NULL;

-- æ³¨é‡Š
COMMENT ON TABLE user_roles IS 'ç”¨æˆ·è§’è‰²å…³è”è¡¨ - ç®¡ç†ç”¨æˆ·å’Œè§’è‰²çš„å¤šå¯¹å¤šå…³ç³»';
COMMENT ON COLUMN user_roles.granted_by IS 'æˆäºˆè€…ç”¨æˆ·ID';
COMMENT ON COLUMN user_roles.expires_at IS 'è§’è‰²è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆï¼‰';
```

##### 1.6.1.5 role_permissions è¡¨ï¼ˆè§’è‰²æƒé™å…³è”è¡¨ï¼‰

**Flywayè„šæœ¬**: `V5__create_role_permissions_table.sql`

```sql
-- ============================================================================
-- è§’è‰²æƒé™å…³è”è¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

CREATE TABLE role_permissions (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- å…³è”ID
    role_id UUID NOT NULL,
    permission_id UUID NOT NULL,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_role_permissions_role
        FOREIGN KEY (role_id)
        REFERENCES roles(id)
        ON DELETE CASCADE,
    CONSTRAINT fk_role_permissions_permission
        FOREIGN KEY (permission_id)
        REFERENCES permissions(id)
        ON DELETE CASCADE,

    -- å”¯ä¸€çº¦æŸï¼ˆä¸€ä¸ªè§’è‰²ä¸èƒ½è¢«åˆ†é…åŒä¸€ä¸ªæƒé™ä¸¤æ¬¡ï¼‰
    UNIQUE (role_id, permission_id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);

-- æ³¨é‡Š
COMMENT ON TABLE role_permissions IS 'è§’è‰²æƒé™å…³è”è¡¨ - ç®¡ç†è§’è‰²å’Œæƒé™çš„å¤šå¯¹å¤šå…³ç³»';
```

##### 1.6.1.6 refresh_tokens è¡¨ï¼ˆåˆ·æ–°ä»¤ç‰Œè¡¨ï¼‰

**Flywayè„šæœ¬**: `V6__create_refresh_tokens_table.sql`

```sql
-- ============================================================================
-- åˆ·æ–°ä»¤ç‰Œè¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

CREATE TABLE refresh_tokens (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- ä»¤ç‰Œä¿¡æ¯
    token VARCHAR(500) UNIQUE NOT NULL,
    user_id UUID NOT NULL,

    -- ä»¤ç‰ŒçŠ¶æ€
    is_revoked BOOLEAN DEFAULT FALSE,

    -- æ—¶é—´ä¿¡æ¯
    issued_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,

    -- å®¢æˆ·ç«¯ä¿¡æ¯
    user_agent TEXT,
    ip_address INET,

    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_refresh_tokens_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_refresh_tokens_token ON refresh_tokens(token);
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_expires_at ON refresh_tokens(expires_at);
CREATE INDEX idx_refresh_tokens_user_id_is_revoked ON refresh_tokens(user_id, is_revoked);

-- æ³¨é‡Š
COMMENT ON TABLE refresh_tokens IS 'åˆ·æ–°ä»¤ç‰Œè¡¨ - å­˜å‚¨JWTåˆ·æ–°ä»¤ç‰Œ';
COMMENT ON COLUMN refresh_tokens.token IS 'åˆ·æ–°ä»¤ç‰Œï¼ˆåŠ å¯†å­˜å‚¨ï¼‰';
COMMENT ON COLUMN refresh_tokens.is_revoked IS 'æ˜¯å¦å·²æ’¤é”€';
```

##### 1.6.1.7 login_history è¡¨ï¼ˆç™»å½•å†å²è¡¨ï¼‰

**Flywayè„šæœ¬**: `V7__create_login_history_table.sql`

```sql
-- ============================================================================
-- ç™»å½•å†å²è¡¨
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

CREATE TABLE login_history (
    -- ä¸»é”®
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- ç”¨æˆ·ID
    user_id UUID NOT NULL,

    -- ç™»å½•ç»“æœ
    login_result VARCHAR(20) NOT NULL CHECK (login_result IN ('SUCCESS', 'FAILURE', 'LOCKED')),
    failure_reason VARCHAR(100),

    -- å®¢æˆ·ç«¯ä¿¡æ¯
    ip_address INET,
    user_agent TEXT,
    device_type VARCHAR(50),
    browser VARCHAR(100),
    os VARCHAR(100),

    -- åœ°ç†ä½ç½®ï¼ˆå¯é€‰ï¼‰
    country VARCHAR(100),
    city VARCHAR(100),

    -- æ—¶é—´æˆ³
    logged_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_login_history_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE CASCADE
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_login_history_user_id ON login_history(user_id);
CREATE INDEX idx_login_history_logged_at ON login_history(logged_at DESC);
CREATE INDEX idx_login_history_user_id_logged_at ON login_history(user_id, logged_at DESC);
CREATE INDEX idx_login_history_ip_address ON login_history(ip_address);

-- æ³¨é‡Š
COMMENT ON TABLE login_history IS 'ç™»å½•å†å²è¡¨ - è®°å½•æ‰€æœ‰ç™»å½•å°è¯•';
COMMENT ON COLUMN login_history.login_result IS 'ç™»å½•ç»“æœ: SUCCESS-æˆåŠŸ, FAILURE-å¤±è´¥, LOCKED-è´¦æˆ·è¢«é”å®š';
```

##### 1.6.1.8 åˆå§‹æ•°æ®æ’å…¥

**Flywayè„šæœ¬**: `V8__insert_initial_data.sql`

```sql
-- ============================================================================
-- æ’å…¥åˆå§‹æ•°æ®
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001
-- åˆ›å»ºæ—¶é—´: 2025-11-26
-- ============================================================================

-- æ’å…¥ç³»ç»Ÿæƒé™
INSERT INTO permissions (id, name, code, description, category, resource, action, is_system) VALUES
-- ç”¨æˆ·ç®¡ç†æƒé™
(uuid_generate_v4(), 'ç”¨æˆ·æŸ¥çœ‹', 'user:read', 'æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯', 'ç”¨æˆ·ç®¡ç†', 'user', 'read', true),
(uuid_generate_v4(), 'ç”¨æˆ·åˆ›å»º', 'user:create', 'åˆ›å»ºæ–°ç”¨æˆ·', 'ç”¨æˆ·ç®¡ç†', 'user', 'create', true),
(uuid_generate_v4(), 'ç”¨æˆ·ç¼–è¾‘', 'user:update', 'ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯', 'ç”¨æˆ·ç®¡ç†', 'user', 'update', true),
(uuid_generate_v4(), 'ç”¨æˆ·åˆ é™¤', 'user:delete', 'åˆ é™¤ç”¨æˆ·', 'ç”¨æˆ·ç®¡ç†', 'user', 'delete', true),

-- è§’è‰²ç®¡ç†æƒé™
(uuid_generate_v4(), 'è§’è‰²æŸ¥çœ‹', 'role:read', 'æŸ¥çœ‹è§’è‰²ä¿¡æ¯', 'è§’è‰²ç®¡ç†', 'role', 'read', true),
(uuid_generate_v4(), 'è§’è‰²åˆ›å»º', 'role:create', 'åˆ›å»ºæ–°è§’è‰²', 'è§’è‰²ç®¡ç†', 'role', 'create', true),
(uuid_generate_v4(), 'è§’è‰²ç¼–è¾‘', 'role:update', 'ç¼–è¾‘è§’è‰²ä¿¡æ¯', 'è§’è‰²ç®¡ç†', 'role', 'update', true),
(uuid_generate_v4(), 'è§’è‰²åˆ é™¤', 'role:delete', 'åˆ é™¤è§’è‰²', 'è§’è‰²ç®¡ç†', 'role', 'delete', true),

-- é¡¹ç›®ç®¡ç†æƒé™
(uuid_generate_v4(), 'é¡¹ç›®æŸ¥çœ‹', 'project:read', 'æŸ¥çœ‹é¡¹ç›®ä¿¡æ¯', 'é¡¹ç›®ç®¡ç†', 'project', 'read', true),
(uuid_generate_v4(), 'é¡¹ç›®åˆ›å»º', 'project:create', 'åˆ›å»ºæ–°é¡¹ç›®', 'é¡¹ç›®ç®¡ç†', 'project', 'create', true),
(uuid_generate_v4(), 'é¡¹ç›®ç¼–è¾‘', 'project:update', 'ç¼–è¾‘é¡¹ç›®ä¿¡æ¯', 'é¡¹ç›®ç®¡ç†', 'project', 'update', true),
(uuid_generate_v4(), 'é¡¹ç›®åˆ é™¤', 'project:delete', 'åˆ é™¤é¡¹ç›®', 'é¡¹ç›®ç®¡ç†', 'project', 'delete', true),

-- æ–‡æ¡£ç®¡ç†æƒé™
(uuid_generate_v4(), 'æ–‡æ¡£æŸ¥çœ‹', 'document:read', 'æŸ¥çœ‹æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'read', true),
(uuid_generate_v4(), 'æ–‡æ¡£åˆ›å»º', 'document:create', 'åˆ›å»ºæ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'create', true),
(uuid_generate_v4(), 'æ–‡æ¡£ç¼–è¾‘', 'document:update', 'ç¼–è¾‘æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'update', true),
(uuid_generate_v4(), 'æ–‡æ¡£åˆ é™¤', 'document:delete', 'åˆ é™¤æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'delete', true),
(uuid_generate_v4(), 'æ–‡æ¡£è§£æ', 'document:parse', 'è§£ææ‹›æ ‡æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'parse', true),
(uuid_generate_v4(), 'æ–‡æ¡£ç”Ÿæˆ', 'document:generate', 'AIç”Ÿæˆæ–‡æ¡£å†…å®¹', 'æ–‡æ¡£ç®¡ç†', 'document', 'generate', true),

-- æ¨¡æ¿ç®¡ç†æƒé™
(uuid_generate_v4(), 'æ¨¡æ¿æŸ¥çœ‹', 'template:read', 'æŸ¥çœ‹æ¨¡æ¿', 'æ¨¡æ¿ç®¡ç†', 'template', 'read', true),
(uuid_generate_v4(), 'æ¨¡æ¿åˆ›å»º', 'template:create', 'åˆ›å»ºæ¨¡æ¿', 'æ¨¡æ¿ç®¡ç†', 'template', 'create', true),
(uuid_generate_v4(), 'æ¨¡æ¿ç¼–è¾‘', 'template:update', 'ç¼–è¾‘æ¨¡æ¿', 'æ¨¡æ¿ç®¡ç†', 'template', 'update', true),
(uuid_generate_v4(), 'æ¨¡æ¿åˆ é™¤', 'template:delete', 'åˆ é™¤æ¨¡æ¿', 'æ¨¡æ¿ç®¡ç†', 'template', 'delete', true);

-- æ’å…¥ç³»ç»Ÿè§’è‰²
INSERT INTO roles (id, name, code, description, is_system, level) VALUES
('00000000-0000-0000-0000-000000000001', 'è¶…çº§ç®¡ç†å‘˜', 'SUPER_ADMIN', 'æ‹¥æœ‰æ‰€æœ‰æƒé™çš„è¶…çº§ç®¡ç†å‘˜', true, 100),
('00000000-0000-0000-0000-000000000002', 'ç®¡ç†å‘˜', 'ADMIN', 'ç»„ç»‡ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰å¤§éƒ¨åˆ†æƒé™', true, 80),
('00000000-0000-0000-0000-000000000003', 'é¡¹ç›®ç»ç†', 'PROJECT_MANAGER', 'é¡¹ç›®ç®¡ç†äººå‘˜', true, 60),
('00000000-0000-0000-0000-000000000004', 'æ™®é€šæˆå‘˜', 'MEMBER', 'æ™®é€šå›¢é˜Ÿæˆå‘˜', true, 40),
('00000000-0000-0000-0000-000000000005', 'è®¿å®¢', 'GUEST', 'åªè¯»è®¿å®¢', true, 20);

-- ä¸ºè¶…çº§ç®¡ç†å‘˜åˆ†é…æ‰€æœ‰æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT '00000000-0000-0000-0000-000000000001', id FROM permissions WHERE is_system = true;

-- ä¸ºç®¡ç†å‘˜åˆ†é…å¤§éƒ¨åˆ†æƒé™ï¼ˆé™¤äº†ç”¨æˆ·åˆ é™¤ï¼‰
INSERT INTO role_permissions (role_id, permission_id)
SELECT '00000000-0000-0000-0000-000000000002', id FROM permissions
WHERE is_system = true AND code NOT IN ('user:delete');

-- ä¸ºé¡¹ç›®ç»ç†åˆ†é…é¡¹ç›®å’Œæ–‡æ¡£æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT '00000000-0000-0000-0000-000000000003', id FROM permissions
WHERE is_system = true AND resource IN ('project', 'document', 'template');

-- ä¸ºæ™®é€šæˆå‘˜åˆ†é…åŸºç¡€è¯»å†™æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT '00000000-0000-0000-0000-000000000004', id FROM permissions
WHERE is_system = true AND action IN ('read', 'create', 'update') AND resource IN ('project', 'document');

-- ä¸ºè®¿å®¢åˆ†é…åªè¯»æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT '00000000-0000-0000-0000-000000000005', id FROM permissions
WHERE is_system = true AND action = 'read';
```

**éªŒè¯æ£€æŸ¥æ¸…å•**:

1. æ•°æ®å®šä¹‰ (100%)
   - [ ] æ‰€æœ‰è¡¨ç»“æ„å®šä¹‰å®Œæ•´
   - [ ] ä¸»é”®ã€å¤–é”®ã€å”¯ä¸€çº¦æŸæ­£ç¡®
   - [ ] ç´¢å¼•è®¾è®¡åˆç†ï¼ˆè¦†ç›–æŸ¥è¯¢åœºæ™¯ï¼‰
   - [ ] è§¦å‘å™¨åŠŸèƒ½æ­£ç¡®
   - [ ] æ³¨é‡Šå®Œæ•´æ¸…æ™°
   - [ ] åˆå§‹æ•°æ®åˆç†

---

#### 1.6.2 å‰ç«¯

**ä»»åŠ¡æè¿°**: å‰ç«¯æ— éœ€ç‰¹æ®Šå®ç°ï¼Œæ•°æ®åº“è¿ç§»æ˜¯åç«¯èŒè´£

**å®ç°è¯´æ˜**:

å‰ç«¯å¼€å‘è€…**ä¸éœ€è¦**ç›´æ¥å‚ä¸æ•°æ®åº“è®¾è®¡å’Œè¿ç§»å·¥ä½œï¼Œä½†åº”äº†è§£ï¼š

1. **æ•°æ®æ¨¡å‹ç†è§£**: å‰ç«¯å¼€å‘äººå‘˜åº”é˜…è¯»æ•°æ®åº“schemaæ³¨é‡Šï¼Œç†è§£å„è¡¨ä¹‹é—´çš„å…³ç³»
2. **APIå¥‘çº¦**: åŸºäºæ•°æ®æ¨¡å‹è®¾è®¡TypeScriptæ¥å£å®šä¹‰
3. **å­—æ®µéªŒè¯**: äº†è§£æ•°æ®åº“å­—æ®µçº¦æŸï¼ˆé•¿åº¦ã€æ ¼å¼ç­‰ï¼‰ï¼Œåœ¨å‰ç«¯è¡¨å•ä¸­åŒæ­¥éªŒè¯è§„åˆ™

**TypeScriptç±»å‹å®šä¹‰ç¤ºä¾‹** (ä¾›å‚è€ƒ):

```typescript
// frontend/src/types/user.ts
export interface User {
  id: string;
  email: string;
  username: string;
  fullName?: string;
  avatarUrl?: string;
  phoneVerified: boolean;
  emailVerified: boolean;
  status: 'ACTIVE' | 'INACTIVE' | 'SUSPENDED' | 'LOCKED';
  lastLoginAt?: string;
  loginCount: number;
  organizationId?: string;
  createdAt: string;
  updatedAt: string;
}

export interface Role {
  id: string;
  name: string;
  code: string;
  description?: string;
  isSystem: boolean;
  level: number;
  permissions: Permission[];
}

export interface Permission {
  id: string;
  name: string;
  code: string;
  category: string;
  resource: string;
  action: string;
}
```

**éªŒè¯æ£€æŸ¥æ¸…å•**:

1. å‰ç«¯ (100%)
   - [ ] TypeScriptç±»å‹å®šä¹‰ä¸æ•°æ®åº“schemaä¸€è‡´
   - [ ] è¡¨å•éªŒè¯è§„åˆ™ä¸æ•°æ®åº“çº¦æŸåŒ¹é…
   - [ ] ç†è§£æ•°æ®æ¨¡å‹å…³ç³»

---

#### 1.6.3 Javaåç«¯

**ä»»åŠ¡æè¿°**: ç®¡ç†Flywayè¿ç§»è„šæœ¬ï¼Œç¡®ä¿æ•°æ®åº“schemaä¸JPAå®ä½“åŒæ­¥

**å…³é”®å®ç°**:

##### 1.6.3.1 Flywayé…ç½®

**æ–‡ä»¶**: `backend-java/src/main/resources/application.yml`

```yaml
# Flywayé…ç½®
spring:
  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    sql-migration-prefix: V
    sql-migration-suffix: .sql
    validate-on-migrate: true
    out-of-order: false
    clean-disabled: true  # ç”Ÿäº§ç¯å¢ƒç¦ç”¨clean
```

##### 1.6.3.2 è¿ç§»è„šæœ¬ç®¡ç†

**ç›®å½•ç»“æ„**:
```
backend-java/
â””â”€â”€ src/
    â””â”€â”€ main/
        â””â”€â”€ resources/
            â””â”€â”€ db/
                â””â”€â”€ migration/
                    â”œâ”€â”€ V1__create_users_table.sql
                    â”œâ”€â”€ V2__create_roles_table.sql
                    â”œâ”€â”€ V3__create_permissions_table.sql
                    â”œâ”€â”€ V4__create_user_roles_table.sql
                    â”œâ”€â”€ V5__create_role_permissions_table.sql
                    â”œâ”€â”€ V6__create_refresh_tokens_table.sql
                    â”œâ”€â”€ V7__create_login_history_table.sql
                    â””â”€â”€ V8__insert_initial_data.sql
```

##### 1.6.3.3 è¿ç§»éªŒè¯å·¥å…·ç±»

**æ–‡ä»¶**: `backend-java/src/main/java/com/aibidcomposer/util/FlywayValidator.java`

```java
package com.aibidcomposer.util;

import org.flywaydb.core.Flyway;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * Flywayè¿ç§»éªŒè¯å™¨
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 *
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯æ•°æ®åº“è¿ç§»çŠ¶æ€
 */
@Configuration
@Slf4j
@RequiredArgsConstructor
public class FlywayValidator {

    private final Flyway flyway;

    /**
     * éªŒè¯è¿ç§»çŠ¶æ€
     */
    @Bean
    @Profile("!test")  // æµ‹è¯•ç¯å¢ƒè·³è¿‡
    public CommandLineRunner validateMigrations() {
        return args -> {
            log.info("å¼€å§‹éªŒè¯Flywayè¿ç§»çŠ¶æ€...");

            // è·å–è¿ç§»ä¿¡æ¯
            var info = flyway.info();
            var all = info.all();
            var current = info.current();
            var pending = info.pending();

            log.info("å½“å‰ç‰ˆæœ¬: {}", current != null ? current.getVersion() : "æ— ");
            log.info("å·²åº”ç”¨è¿ç§»æ•°: {}", all.length - pending.length);
            log.info("å¾…åº”ç”¨è¿ç§»æ•°: {}", pending.length);

            if (pending.length > 0) {
                log.warn("å­˜åœ¨{}ä¸ªå¾…åº”ç”¨çš„è¿ç§»è„šæœ¬:", pending.length);
                for (var migration : pending) {
                    log.warn("  - {} : {}", migration.getVersion(), migration.getDescription());
                }
            }

            // éªŒè¯è¿ç§»
            var result = flyway.validateWithResult();
            if (result.validationSuccessful) {
                log.info("âœ“ Flywayè¿ç§»éªŒè¯é€šè¿‡");
            } else {
                log.error("âœ— Flywayè¿ç§»éªŒè¯å¤±è´¥:");
                result.invalidMigrations.forEach(error -> {
                    log.error("  - {}", error.errorDetails.errorMessage);
                });
                throw new IllegalStateException("æ•°æ®åº“è¿ç§»éªŒè¯å¤±è´¥");
            }
        };
    }
}
```

##### 1.6.3.4 æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•

**æ–‡ä»¶**: `backend-java/src/test/java/com/aibidcomposer/db/FlywayMigrationTest.java`

```java
package com.aibidcomposer.db;

import static org.assertj.core.api.Assertions.assertThat;

import org.flywaydb.core.Flyway;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.ResultSet;

/**
 * Flywayè¿ç§»æµ‹è¯•
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@SpringBootTest
@ActiveProfiles("test")
class FlywayMigrationTest {

    @Autowired
    private Flyway flyway;

    @Autowired
    private DataSource dataSource;

    @Test
    void testMigrationsApplied() {
        // éªŒè¯è¿ç§»å·²åº”ç”¨
        var info = flyway.info();
        var all = info.all();
        var pending = info.pending();

        assertThat(pending).isEmpty();
        assertThat(all).hasSizeGreaterThanOrEqualTo(8);  // è‡³å°‘8ä¸ªè¿ç§»è„šæœ¬
    }

    @Test
    void testTablesExist() throws Exception {
        try (Connection conn = dataSource.getConnection()) {
            var metaData = conn.getMetaData();

            // éªŒè¯æ‰€æœ‰è¡¨å­˜åœ¨
            String[] tables = {
                "users", "roles", "permissions",
                "user_roles", "role_permissions",
                "refresh_tokens", "login_history"
            };

            for (String tableName : tables) {
                try (ResultSet rs = metaData.getTables(null, "public", tableName, null)) {
                    assertThat(rs.next())
                        .as("è¡¨ %s åº”è¯¥å­˜åœ¨", tableName)
                        .isTrue();
                }
            }
        }
    }

    @Test
    void testInitialDataExists() throws Exception {
        try (Connection conn = dataSource.getConnection();
             var stmt = conn.createStatement()) {

            // éªŒè¯ç³»ç»Ÿè§’è‰²å­˜åœ¨
            ResultSet rs = stmt.executeQuery("SELECT COUNT(*) FROM roles WHERE is_system = true");
            rs.next();
            assertThat(rs.getInt(1))
                .as("åº”è¯¥æœ‰5ä¸ªç³»ç»Ÿè§’è‰²")
                .isEqualTo(5);

            // éªŒè¯ç³»ç»Ÿæƒé™å­˜åœ¨
            rs = stmt.executeQuery("SELECT COUNT(*) FROM permissions WHERE is_system = true");
            rs.next();
            assertThat(rs.getInt(1))
                .as("åº”è¯¥æœ‰è‡³å°‘20ä¸ªç³»ç»Ÿæƒé™")
                .isGreaterThanOrEqualTo(20);

            // éªŒè¯è¶…çº§ç®¡ç†å‘˜è§’è‰²æœ‰æƒé™
            rs = stmt.executeQuery(
                "SELECT COUNT(*) FROM role_permissions WHERE role_id = '00000000-0000-0000-0000-000000000001'"
            );
            rs.next();
            assertThat(rs.getInt(1))
                .as("è¶…çº§ç®¡ç†å‘˜åº”è¯¥æœ‰æ‰€æœ‰æƒé™")
                .isGreaterThan(0);
        }
    }

    @Test
    void testTriggersExist() throws Exception {
        try (Connection conn = dataSource.getConnection();
             var stmt = conn.createStatement()) {

            // éªŒè¯updated_atè§¦å‘å™¨å­˜åœ¨
            ResultSet rs = stmt.executeQuery(
                "SELECT COUNT(*) FROM pg_trigger WHERE tgname LIKE '%updated_at%'"
            );
            rs.next();
            assertThat(rs.getInt(1))
                .as("åº”è¯¥æœ‰updated_atè§¦å‘å™¨")
                .isGreaterThan(0);
        }
    }
}
```

##### 1.6.3.5 Mavenå‘½ä»¤é›†æˆ

**æ–‡ä»¶**: `backend-java/pom.xml` (Flywayæ’ä»¶é…ç½®)

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-maven-plugin</artifactId>
            <version>9.22.0</version>
            <configuration>
                <url>${spring.datasource.url}</url>
                <user>${spring.datasource.username}</user>
                <password>${spring.datasource.password}</password>
                <locations>
                    <location>filesystem:src/main/resources/db/migration</location>
                </locations>
            </configuration>
        </plugin>
    </plugins>
</build>
```

**å¸¸ç”¨å‘½ä»¤**:
```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
mvn flyway:info

# æ‰§è¡Œè¿ç§»
mvn flyway:migrate

# éªŒè¯è¿ç§»
mvn flyway:validate

# æŸ¥çœ‹è¿ç§»å†å²
mvn flyway:info -Dflyway.showInstalledOn=true
```

**éªŒè¯æ£€æŸ¥æ¸…å•**:

1. Javaåç«¯ (100%)
   - [ ] Flywayé…ç½®æ­£ç¡®
   - [ ] æ‰€æœ‰è¿ç§»è„šæœ¬åœ¨æ­£ç¡®ä½ç½®
   - [ ] è¿ç§»è„šæœ¬å‘½åè§„èŒƒï¼ˆV1, V2, ...ï¼‰
   - [ ] FlywayValidatorè¿è¡Œæ­£å¸¸
   - [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%
   - [ ] Mavenå‘½ä»¤å¯æ­£å¸¸æ‰§è¡Œ

---

#### 1.6.4 Pythonåç«¯

**ä»»åŠ¡æè¿°**: PythonæœåŠ¡ä¸ç›´æ¥æ“ä½œæ•°æ®åº“schemaï¼Œä½†éœ€è¦è¯»å–æƒé™æ•°æ®è¿›è¡ŒJWTéªŒè¯

**å®ç°è¯´æ˜**:

Python AIæœåŠ¡**ä¸è´Ÿè´£**æ•°æ®åº“è¿ç§»ï¼Œä½†éœ€è¦ï¼š

1. **è¯»å–æƒé™æ•°æ®**: ä»PostgreSQLè¯»å–ç”¨æˆ·çš„roleså’Œpermissionsï¼ˆé€šè¿‡JavaæœåŠ¡REST APIï¼‰
2. **JWTéªŒè¯**: è§£æJWT tokenä¸­çš„permissionså­—æ®µï¼Œè¿›è¡Œæƒé™éªŒè¯

**æ•°æ®åº“è¿æ¥é…ç½®** (ä»…ç”¨äºè¯»å–ï¼Œéè¿ç§»):

**æ–‡ä»¶**: `backend-python/app/core/database.py`

```python
# backend-python/app/core/database.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

# åˆ›å»ºæ•°æ®åº“å¼•æ“ï¼ˆåªè¯»è¿æ¥ï¼‰
engine = create_engine(
    settings.DATABASE_URL,
    pool_pre_ping=True,
    pool_size=5,
    max_overflow=10,
    echo=settings.DEBUG
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def get_db():
    """è·å–æ•°æ®åº“ä¼šè¯"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**JWTæƒé™éªŒè¯è£…é¥°å™¨** (ä½¿ç”¨æ•°æ®åº“ä¸­çš„æƒé™æ•°æ®):

**æ–‡ä»¶**: `backend-python/app/core/security.py`

```python
# backend-python/app/core/security.py
from functools import wraps
from typing import List
from fastapi import HTTPException, Depends
from jose import jwt, JWTError
from app.core.config import settings
from app.core.database import get_db

def require_permissions(required_permissions: List[str]):
    """
    æƒé™éªŒè¯è£…é¥°å™¨

    ä»JWT tokenä¸­æå–permissionså­—æ®µï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™

    Args:
        required_permissions: æ‰€éœ€æƒé™ä»£ç åˆ—è¡¨ï¼ˆå¦‚ ['document:parse', 'document:generate']ï¼‰
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # è·å–å½“å‰ç”¨æˆ·ï¼ˆä»JWT tokenè§£æï¼‰
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(status_code=401, detail="æœªç™»å½•")

            # ä»JWT payloadè·å–æƒé™åˆ—è¡¨
            user_permissions = current_user.get('permissions', [])

            # æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰æ‰€éœ€æƒé™
            missing_permissions = [
                perm for perm in required_permissions
                if perm not in user_permissions
            ]

            if missing_permissions:
                raise HTTPException(
                    status_code=403,
                    detail=f"ç¼ºå°‘æƒé™: {', '.join(missing_permissions)}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator

async def get_current_user(token: str = Depends(oauth2_scheme)):
    """
    ä»JWT tokenè§£æå½“å‰ç”¨æˆ·

    JWT payloadæ ¼å¼:
    {
        "sub": "user_id",
        "email": "user@example.com",
        "permissions": ["user:read", "document:parse", ...],
        "exp": 1234567890
    }
    """
    try:
        payload = jwt.decode(
            token,
            settings.SECRET_KEY,
            algorithms=[settings.ALGORITHM]
        )
        user_id: str = payload.get("sub")
        if user_id is None:
            raise HTTPException(status_code=401, detail="Invalid token")

        return {
            "id": user_id,
            "email": payload.get("email"),
            "permissions": payload.get("permissions", [])
        }
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# backend-python/app/api/v1/ai.py
from fastapi import APIRouter, Depends, UploadFile, File
from app.core.security import require_permissions, get_current_user
from app.services.document_parser import DocumentParser

router = APIRouter()

@router.post("/parse-document")
@require_permissions(["document:parse"])  # éœ€è¦ document:parse æƒé™
async def parse_document(
    file: UploadFile = File(...),
    current_user: dict = Depends(get_current_user)
):
    """è§£ææ‹›æ ‡æ–‡æ¡£ï¼ˆéœ€è¦æƒé™éªŒè¯ï¼‰"""
    parser = DocumentParser()
    result = await parser.parse(file, user_id=current_user['id'])
    return {"success": True, "data": result}
```

**éªŒè¯æ£€æŸ¥æ¸…å•**:

1. Pythonåç«¯ (100%)
   - [ ] æ•°æ®åº“åªè¯»è¿æ¥é…ç½®æ­£ç¡®
   - [ ] JWTæƒé™éªŒè¯è£…é¥°å™¨æ­£å¸¸å·¥ä½œ
   - [ ] æƒé™æ£€æŸ¥é€»è¾‘æ­£ç¡®
   - [ ] ä¸å°è¯•æ‰§è¡Œæ•°æ®åº“è¿ç§»

---

#### 1.6.5 éƒ¨ç½²

**ä»»åŠ¡æè¿°**: é…ç½®Dockerå’ŒKubernetesç¯å¢ƒï¼Œç¡®ä¿Flywayè¿ç§»åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ

**å…³é”®å®ç°**:

##### 1.6.5.1 Docker Composeé…ç½®

**æ–‡ä»¶**: `docker-compose.yml`

```yaml
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:14-alpine
    container_name: aibidcomposer-postgres
    environment:
      POSTGRES_DB: aibidcomposer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Javaåç«¯æœåŠ¡ï¼ˆåŒ…å«Flywayè¿ç§»ï¼‰
  backend-java:
    build:
      context: ./backend-java
      dockerfile: Dockerfile
    container_name: aibidcomposer-backend-java
    depends_on:
      postgres:
        condition: service_healthy  # ç­‰å¾…PostgreSQLå°±ç»ª
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/aibidcomposer
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_FLYWAY_ENABLED: true
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: true
    ports:
      - "8080:8080"
    command: >
      sh -c "
        echo 'Waiting for PostgreSQL...' &&
        sleep 5 &&
        echo 'Starting Spring Boot application with Flyway migration...' &&
        java -jar app.jar
      "

volumes:
  postgres_data:
```

##### 1.6.5.2 Kuberneteséƒ¨ç½²é…ç½®

**æ–‡ä»¶**: `k8s/migrations/flyway-job.yaml`

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: flyway-migration
  namespace: aibidcomposer
spec:
  template:
    metadata:
      labels:
        app: flyway-migration
    spec:
      restartPolicy: OnFailure
      containers:
      - name: flyway
        image: flyway/flyway:9.22-alpine
        command:
        - flyway
        - -url=jdbc:postgresql://postgres-service:5432/aibidcomposer
        - -user=postgres
        - -password=${POSTGRES_PASSWORD}
        - -locations=filesystem:/flyway/sql
        - migrate
        volumeMounts:
        - name: migration-scripts
          mountPath: /flyway/sql
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
      volumes:
      - name: migration-scripts
        configMap:
          name: flyway-scripts
```

**ConfigMap for migration scripts**:

**æ–‡ä»¶**: `k8s/migrations/flyway-scripts-configmap.yaml`

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-scripts
  namespace: aibidcomposer
data:
  V1__create_users_table.sql: |
    -- å°†å®Œæ•´çš„V1è„šæœ¬å†…å®¹æ”¾åœ¨è¿™é‡Œ
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    ...

  V2__create_roles_table.sql: |
    -- å°†å®Œæ•´çš„V2è„šæœ¬å†…å®¹æ”¾åœ¨è¿™é‡Œ
    ...

  # é‡å¤æ‰€æœ‰è¿ç§»è„šæœ¬
```

##### 1.6.5.3 å¥åº·æ£€æŸ¥ç«¯ç‚¹

**æ–‡ä»¶**: `backend-java/src/main/java/com/aibidcomposer/controller/HealthController.java`

```java
package com.aibidcomposer.controller;

import org.flywaydb.core.Flyway;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import lombok.RequiredArgsConstructor;

import java.util.HashMap;
import java.util.Map;

/**
 * å¥åº·æ£€æŸ¥ç«¯ç‚¹
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@RestController
@RequestMapping("/actuator/health")
@RequiredArgsConstructor
public class HealthController {

    private final Flyway flyway;

    @GetMapping("/flyway")
    public ResponseEntity<Map<String, Object>> flywayHealth() {
        Map<String, Object> health = new HashMap<>();

        try {
            var info = flyway.info();
            var current = info.current();
            var pending = info.pending();

            health.put("status", pending.length == 0 ? "UP" : "WARNING");
            health.put("currentVersion", current != null ? current.getVersion().toString() : "æ— ");
            health.put("pendingMigrations", pending.length);
            health.put("totalMigrations", info.all().length);

            return ResponseEntity.ok(health);
        } catch (Exception e) {
            health.put("status", "DOWN");
            health.put("error", e.getMessage());
            return ResponseEntity.status(503).body(health);
        }
    }
}
```

##### 1.6.5.4 åº”ç”¨å¯åŠ¨æµç¨‹

**å¯åŠ¨é¡ºåº**:

```
1. PostgreSQLå®¹å™¨å¯åŠ¨
   â””â”€> healthcheck: pg_isready

2. Flywayè¿ç§»æ‰§è¡Œï¼ˆä½œä¸ºinitContaineræˆ–Jobï¼‰
   â””â”€> åº”ç”¨æ‰€æœ‰è¿ç§»è„šæœ¬
   â””â”€> æ’å…¥åˆå§‹æ•°æ®

3. Java Spring Bootåº”ç”¨å¯åŠ¨
   â””â”€> Flyway.validate()éªŒè¯è¿ç§»
   â””â”€> JPAå®ä½“åŠ è½½
   â””â”€> åº”ç”¨æœåŠ¡å¯åŠ¨

4. å¥åº·æ£€æŸ¥é€šè¿‡
   â””â”€> /actuator/health/flywayè¿”å›UP
```

**éªŒè¯æ£€æŸ¥æ¸…å•**:

1. éƒ¨ç½² (100%)
   - [ ] Docker Composeå¯æ­£å¸¸å¯åŠ¨
   - [ ] PostgreSQLå¥åº·æ£€æŸ¥é€šè¿‡
   - [ ] Flywayè¿ç§»è‡ªåŠ¨æ‰§è¡Œ
   - [ ] åˆå§‹æ•°æ®æ’å…¥æˆåŠŸ
   - [ ] Spring Bootåº”ç”¨å¯åŠ¨æˆåŠŸ
   - [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹è¿”å›æ­£å¸¸
   - [ ] Kubernetes JobæˆåŠŸå®Œæˆ

---

### å­ä»»åŠ¡æ€»ç»“

#### å®Œæˆæ ‡å‡†

**1.6 æ•°æ®åº“è®¾è®¡å’Œè¿ç§»** è¢«è®¤ä¸ºå®Œæˆéœ€è¦æ»¡è¶³ï¼š

1. **æ•°æ®å®šä¹‰** (100%)
   - [ ] æ‰€æœ‰7å¼ è¡¨çš„Flywayè„šæœ¬ç¼–å†™å®Œæˆ
   - [ ] è¡¨ç»“æ„ã€ç´¢å¼•ã€çº¦æŸã€è§¦å‘å™¨å®šä¹‰æ­£ç¡®
   - [ ] åˆå§‹æ•°æ®ï¼ˆæƒé™ã€è§’è‰²ï¼‰æ’å…¥æˆåŠŸ
   - [ ] æ•°æ®åº“æ³¨é‡Šå®Œæ•´

2. **å‰ç«¯** (100%)
   - [ ] TypeScriptç±»å‹å®šä¹‰ä¸æ•°æ®åº“schemaä¸€è‡´
   - [ ] ç†è§£æ•°æ®æ¨¡å‹å…³ç³»

3. **Javaåç«¯** (100%)
   - [ ] Flywayé…ç½®æ­£ç¡®
   - [ ] è¿ç§»è„šæœ¬åœ¨æ­£ç¡®ä½ç½®
   - [ ] FlywayValidatoréªŒè¯é€šè¿‡
   - [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%
   - [ ] Mavenå‘½ä»¤å¯æ­£å¸¸æ‰§è¡Œ

4. **Pythonåç«¯** (100%)
   - [ ] JWTæƒé™éªŒè¯è£…é¥°å™¨æ­£å¸¸å·¥ä½œ
   - [ ] ä¸æ‰§è¡Œæ•°æ®åº“è¿ç§»æ“ä½œ

5. **éƒ¨ç½²** (100%)
   - [ ] Docker Composeè‡ªåŠ¨è¿ç§»æˆåŠŸ
   - [ ] Kubernetes Flyway JobæˆåŠŸ
   - [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸
   - [ ] åº”ç”¨å¯åŠ¨æµç¨‹é¡ºç•…

---
