# Java Spring Boot - JAVA-002 Part1 (ç»„ç»‡ç®¡ç†: æ•°æ®+å‰ç«¯) - ğŸ“‘ æ–‡æ¡£å¯¼èˆª - 2.1.3: Javaåç«¯ - å•å…ƒæµ‹è¯•

**OrganizationServiceTest** (`com.aibidcomposer.service.OrganizationServiceTest`):

```java
package com.aibidcomposer.service;

import com.aibidcomposer.dto.organization.*;
import com.aibidcomposer.entity.*;
import com.aibidcomposer.exception.BusinessException;
import com.aibidcomposer.exception.ResourceNotFoundException;
import com.aibidcomposer.repository.OrganizationMemberRepository;
import com.aibidcomposer.repository.OrganizationRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;

import java.util.*;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * ç»„ç»‡æœåŠ¡å•å…ƒæµ‹è¯•
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@ExtendWith(MockitoExtension.class)
@DisplayName("ç»„ç»‡æœåŠ¡å•å…ƒæµ‹è¯•")
class OrganizationServiceTest {

    @Mock
    private OrganizationRepository organizationRepository;

    @Mock
    private OrganizationMemberRepository memberRepository;

    @InjectMocks
    private OrganizationService organizationService;

    private Organization testOrganization;
    private UUID testOrgId;
    private UUID testUserId;

    @BeforeEach
    void setUp() {
        testOrgId = UUID.randomUUID();
        testUserId = UUID.randomUUID();

        testOrganization = Organization.builder()
                .id(testOrgId)
                .name("æµ‹è¯•ç»„ç»‡")
                .shortName("æµ‹è¯•")
                .organizationType(OrganizationType.COMPANY)
                .taxId("91110000MA01234567")
                .status(OrganizationStatus.ACTIVE)
                .build();
    }

    // ==================== ç»„ç»‡CRUDæµ‹è¯• ====================

    @Test
    @DisplayName("è·å–ç»„ç»‡åˆ—è¡¨ - æˆåŠŸ")
    void getOrganizations_Success() {
        // Arrange
        Pageable pageable = PageRequest.of(0, 20);
        List<Organization> organizations = Arrays.asList(testOrganization);
        Page<Organization> page = new PageImpl<>(organizations, pageable, 1);

        when(organizationRepository.findAll(pageable)).thenReturn(page);

        // Act
        Page<OrganizationResponseDTO> result = organizationService.getOrganizations(
                null, null, pageable
        );

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getContent()).hasSize(1);
        assertThat(result.getContent().get(0).getName()).isEqualTo("æµ‹è¯•ç»„ç»‡");

        verify(organizationRepository).findAll(pageable);
    }

    @Test
    @DisplayName("æ ¹æ®IDè·å–ç»„ç»‡ - æˆåŠŸ")
    void getOrganizationById_Success() {
        // Arrange
        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));

        // Act
        OrganizationResponseDTO result = organizationService.getOrganizationById(testOrgId);

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getId()).isEqualTo(testOrgId);
        assertThat(result.getName()).isEqualTo("æµ‹è¯•ç»„ç»‡");

        verify(organizationRepository).findById(testOrgId);
    }

    @Test
    @DisplayName("æ ¹æ®IDè·å–ç»„ç»‡ - ç»„ç»‡ä¸å­˜åœ¨")
    void getOrganizationById_NotFound() {
        // Arrange
        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.empty());

        // Act & Assert
        assertThatThrownBy(() -> organizationService.getOrganizationById(testOrgId))
                .isInstanceOf(ResourceNotFoundException.class)
                .hasMessageContaining("ç»„ç»‡ä¸å­˜åœ¨");

        verify(organizationRepository).findById(testOrgId);
    }

    @Test
    @DisplayName("åˆ›å»ºç»„ç»‡ - æˆåŠŸ")
    void createOrganization_Success() {
        // Arrange
        CreateOrganizationDTO dto = new CreateOrganizationDTO();
        dto.setName("æ–°ç»„ç»‡");
        dto.setShortName("æ–°");
        dto.setOrganizationType(OrganizationType.COMPANY);
        dto.setTaxId("91110000MA98765432");

        Organization savedOrg = Organization.builder()
                .id(UUID.randomUUID())
                .name(dto.getName())
                .shortName(dto.getShortName())
                .organizationType(dto.getOrganizationType())
                .taxId(dto.getTaxId())
                .status(OrganizationStatus.ACTIVE)
                .build();

        when(organizationRepository.existsByName(dto.getName())).thenReturn(false);
        when(organizationRepository.existsByTaxId(dto.getTaxId())).thenReturn(false);
        when(organizationRepository.save(any(Organization.class))).thenReturn(savedOrg);
        when(memberRepository.save(any(OrganizationMember.class)))
                .thenReturn(new OrganizationMember());

        // Act
        OrganizationResponseDTO result = organizationService.createOrganization(dto, testUserId);

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getName()).isEqualTo("æ–°ç»„ç»‡");
        assertThat(result.getStatus()).isEqualTo(OrganizationStatus.ACTIVE);

        verify(organizationRepository).existsByName(dto.getName());
        verify(organizationRepository).existsByTaxId(dto.getTaxId());
        verify(organizationRepository).save(any(Organization.class));
        verify(memberRepository).save(any(OrganizationMember.class));
    }

    @Test
    @DisplayName("åˆ›å»ºç»„ç»‡ - åç§°å·²å­˜åœ¨")
    void createOrganization_NameExists() {
        // Arrange
        CreateOrganizationDTO dto = new CreateOrganizationDTO();
        dto.setName("æµ‹è¯•ç»„ç»‡");

        when(organizationRepository.existsByName(dto.getName())).thenReturn(true);

        // Act & Assert
        assertThatThrownBy(() -> organizationService.createOrganization(dto, testUserId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("ç»„ç»‡åç§°å·²å­˜åœ¨");

        verify(organizationRepository).existsByName(dto.getName());
        verify(organizationRepository, never()).save(any());
    }

    @Test
    @DisplayName("æ›´æ–°ç»„ç»‡ - æˆåŠŸ")
    void updateOrganization_Success() {
        // Arrange
        UpdateOrganizationDTO dto = new UpdateOrganizationDTO();
        dto.setShortName("æ–°ç®€ç§°");
        dto.setContactPhone("010-12345678");

        OrganizationMember adminMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.ADMIN)
                .build();

        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(adminMember));
        when(organizationRepository.save(any(Organization.class)))
                .thenReturn(testOrganization);

        // Act
        OrganizationResponseDTO result = organizationService.updateOrganization(
                testOrgId, dto, testUserId
        );

        // Assert
        assertThat(result).isNotNull();

        verify(organizationRepository).findById(testOrgId);
        verify(memberRepository).findByOrganizationIdAndUserId(testOrgId, testUserId);
        verify(organizationRepository).save(any(Organization.class));
    }

    @Test
    @DisplayName("åˆ é™¤ç»„ç»‡ - æˆåŠŸ")
    void deleteOrganization_Success() {
        // Arrange
        OrganizationMember ownerMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.OWNER)
                .build();

        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(ownerMember));
        when(organizationRepository.findByParentId(testOrgId))
                .thenReturn(Collections.emptyList());

        // Act
        organizationService.deleteOrganization(testOrgId, testUserId);

        // Assert
        verify(organizationRepository).findById(testOrgId);
        verify(memberRepository).findByOrganizationIdAndUserId(testOrgId, testUserId);
        verify(organizationRepository).findByParentId(testOrgId);
        verify(organizationRepository).delete(testOrganization);
    }

    // ==================== æˆå‘˜ç®¡ç†æµ‹è¯• ====================

    @Test
    @DisplayName("æ·»åŠ ç»„ç»‡æˆå‘˜ - æˆåŠŸ")
    void addOrganizationMember_Success() {
        // Arrange
        UUID newUserId = UUID.randomUUID();
        AddMemberDTO dto = new AddMemberDTO();
        dto.setUserId(newUserId);
        dto.setRole(OrganizationRole.MEMBER);

        OrganizationMember adminMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.ADMIN)
                .build();

        OrganizationMember newMember = OrganizationMember.builder()
                .id(UUID.randomUUID())
                .organization(testOrganization)
                .userId(newUserId)
                .role(OrganizationRole.MEMBER)
                .build();

        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(adminMember));
        when(memberRepository.existsByOrganizationIdAndUserId(testOrgId, newUserId))
                .thenReturn(false);
        when(memberRepository.save(any(OrganizationMember.class)))
                .thenReturn(newMember);

        // Act
        OrganizationMemberResponseDTO result = organizationService.addOrganizationMember(
                testOrgId, dto, testUserId
        );

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getRole()).isEqualTo(OrganizationRole.MEMBER);

        verify(memberRepository).save(any(OrganizationMember.class));
    }

    @Test
    @DisplayName("ç§»é™¤ç»„ç»‡æˆå‘˜ - æˆåŠŸ")
    void removeOrganizationMember_Success() {
        // Arrange
        UUID memberId = UUID.randomUUID();
        UUID memberUserId = UUID.randomUUID();

        OrganizationMember adminMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.ADMIN)
                .build();

        OrganizationMember targetMember = OrganizationMember.builder()
                .id(memberId)
                .organization(testOrganization)
                .userId(memberUserId)
                .role(OrganizationRole.MEMBER)
                .build();

        when(memberRepository.findById(memberId))
                .thenReturn(Optional.of(targetMember));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(adminMember));

        // Act
        organizationService.removeOrganizationMember(testOrgId, memberId, testUserId);

        // Assert
        verify(memberRepository).delete(targetMember);
    }
}
```
