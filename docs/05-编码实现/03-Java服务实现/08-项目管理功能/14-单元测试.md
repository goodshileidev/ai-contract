# Java Spring Boot - JAVA-002 Part1 (组织管理: 数据+前端) - JAVA-002: 组织和项目管理模块 - 2.2.3: Java后端 - 单元测试

```java
package com.aibidcomposer.service;

import com.aibidcomposer.dto.project.CreateProjectDTO;
import com.aibidcomposer.dto.project.ProjectResponseDTO;
import com.aibidcomposer.dto.project.UpdateProjectDTO;
import com.aibidcomposer.entity.*;
import com.aibidcomposer.exception.BusinessException;
import com.aibidcomposer.exception.ResourceNotFoundException;
import com.aibidcomposer.repository.OrganizationRepository;
import com.aibidcomposer.repository.ProjectRepository;
import com.aibidcomposer.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Optional;
import java.util.UUID;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * ProjectService 单元测试
 * 需求编号: REQ-JAVA-002-2.2
 */
@ExtendWith(MockitoExtension.class)
@DisplayName("ProjectService 单元测试")
class ProjectServiceTest {

    @Mock
    private ProjectRepository projectRepository;

    @Mock
    private OrganizationRepository organizationRepository;

    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private ProjectService projectService;

    private UUID organizationId;
    private UUID userId;
    private Organization organization;
    private User user;
    private CreateProjectDTO createDTO;

    @BeforeEach
    void setUp() {
        organizationId = UUID.randomUUID();
        userId = UUID.randomUUID();

        // 创建测试组织
        organization = Organization.builder()
                .id(organizationId)
                .name("测试公司")
                .shortName("TEST")
                .build();

        // 创建测试用户
        user = User.builder()
                .id(userId)
                .username("testuser")
                .email("test@example.com")
                .organizationId(organizationId)
                .build();

        // 创建测试DTO
        createDTO = new CreateProjectDTO();
        createDTO.setName("测试项目");
        createDTO.setOrganizationId(organizationId);
        createDTO.setBiddingType(BiddingType.GOVERNMENT);
        createDTO.setBudgetAmount(new BigDecimal("1000000"));
        createDTO.setSubmissionDeadline(LocalDateTime.now().plusDays(30));
        createDTO.setPriority(ProjectPriority.HIGH);
    }

    @Test
    @DisplayName("创建项目 - 成功")
    void testCreateProject_Success() {
        // Given
        when(organizationRepository.findById(organizationId))
                .thenReturn(Optional.of(organization));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));
        when(projectRepository.existsByCodeAndDeletedAtIsNull(anyString()))
                .thenReturn(false);
        when(projectRepository.save(any(Project.class)))
                .thenAnswer(invocation -> {
                    Project project = invocation.getArgument(0);
                    project.setId(UUID.randomUUID());
                    return project;
                });

        // When
        ProjectResponseDTO response = projectService.createProject(createDTO, userId);

        // Then
        assertThat(response).isNotNull();
        assertThat(response.getName()).isEqualTo("测试项目");
        assertThat(response.getStatus()).isEqualTo(ProjectStatus.DRAFT);
        assertThat(response.getOrganizationId()).isEqualTo(organizationId);

        verify(projectRepository, times(1)).save(any(Project.class));
    }

    @Test
    @DisplayName("创建项目 - 组织不存在")
    void testCreateProject_OrganizationNotFound() {
        // Given
        when(organizationRepository.findById(organizationId))
                .thenReturn(Optional.empty());

        // When & Then
        assertThatThrownBy(() -> projectService.createProject(createDTO, userId))
                .isInstanceOf(ResourceNotFoundException.class)
                .hasMessageContaining("组织不存在");

        verify(projectRepository, never()).save(any(Project.class));
    }

    @Test
    @DisplayName("创建项目 - 用户不属于组织")
    void testCreateProject_UserNotInOrganization() {
        // Given
        User otherUser = User.builder()
                .id(userId)
                .organizationId(UUID.randomUUID()) // 不同的组织ID
                .build();

        when(organizationRepository.findById(organizationId))
                .thenReturn(Optional.of(organization));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(otherUser));

        // When & Then
        assertThatThrownBy(() -> projectService.createProject(createDTO, userId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("无权在该组织下创建项目");
    }

    @Test
    @DisplayName("创建项目 - 项目编号已存在")
    void testCreateProject_CodeAlreadyExists() {
        // Given
        createDTO.setCode("TEST-001");

        when(organizationRepository.findById(organizationId))
                .thenReturn(Optional.of(organization));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));
        when(projectRepository.existsByCodeAndDeletedAtIsNull("TEST-001"))
                .thenReturn(true);

        // When & Then
        assertThatThrownBy(() -> projectService.createProject(createDTO, userId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("项目编号已存在");
    }

    @Test
    @DisplayName("更新项目状态 - 成功")
    void testUpdateProjectStatus_Success() {
        // Given
        UUID projectId = UUID.randomUUID();

        Project project = Project.builder()
                .id(projectId)
                .organizationId(organizationId)
                .status(ProjectStatus.DRAFT)
                .build();

        ProjectMember owner = ProjectMember.builder()
                .user(user)
                .role(MemberRole.OWNER)
                .build();
        project.addMember(owner);

        when(projectRepository.findById(projectId))
                .thenReturn(Optional.of(project));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));

        // When
        projectService.updateProjectStatus(projectId, ProjectStatus.IN_PROGRESS, userId);

        // Then
        assertThat(project.getStatus()).isEqualTo(ProjectStatus.IN_PROGRESS);
        verify(projectRepository, times(1)).save(project);
    }

    @Test
    @DisplayName("更新项目状态 - 状态流转不合法")
    void testUpdateProjectStatus_InvalidTransition() {
        // Given
        UUID projectId = UUID.randomUUID();

        Project project = Project.builder()
                .id(projectId)
                .organizationId(organizationId)
                .status(ProjectStatus.DRAFT)
                .build();

        ProjectMember owner = ProjectMember.builder()
                .user(user)
                .role(MemberRole.OWNER)
                .build();
        project.addMember(owner);

        when(projectRepository.findById(projectId))
                .thenReturn(Optional.of(project));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));

        // When & Then
        assertThatThrownBy(() ->
                projectService.updateProjectStatus(projectId, ProjectStatus.WON, userId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("项目状态不能从");
    }

    @Test
    @DisplayName("更新项目状态 - 权限不足")
    void testUpdateProjectStatus_PermissionDenied() {
        // Given
        UUID projectId = UUID.randomUUID();

        Project project = Project.builder()
                .id(projectId)
                .organizationId(organizationId)
                .status(ProjectStatus.DRAFT)
                .build();

        ProjectMember viewer = ProjectMember.builder()
                .user(user)
                .role(MemberRole.VIEWER) // 只读角色
                .build();
        project.addMember(viewer);

        when(projectRepository.findById(projectId))
                .thenReturn(Optional.of(project));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));

        // When & Then
        assertThatThrownBy(() ->
                projectService.updateProjectStatus(projectId, ProjectStatus.IN_PROGRESS, userId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("权限不足");
    }

    @Test
    @DisplayName("删除项目 - 成功")
    void testDeleteProject_Success() {
        // Given
        UUID projectId = UUID.randomUUID();

        Project project = Project.builder()
                .id(projectId)
                .organizationId(organizationId)
                .status(ProjectStatus.DRAFT)
                .build();

        ProjectMember owner = ProjectMember.builder()
                .user(user)
                .role(MemberRole.OWNER)
                .build();
        project.addMember(owner);

        when(projectRepository.findById(projectId))
                .thenReturn(Optional.of(project));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));

        // When
        projectService.deleteProject(projectId, userId);

        // Then
        verify(projectRepository, times(1)).delete(project);
    }

    @Test
    @DisplayName("删除项目 - 已归档的项目不能删除")
    void testDeleteProject_ArchivedProjectCannotBeDeleted() {
        // Given
        UUID projectId = UUID.randomUUID();

        Project project = Project.builder()
                .id(projectId)
                .organizationId(organizationId)
                .status(ProjectStatus.ARCHIVED) // 已归档
                .build();

        ProjectMember owner = ProjectMember.builder()
                .user(user)
                .role(MemberRole.OWNER)
                .build();
        project.addMember(owner);

        when(projectRepository.findById(projectId))
                .thenReturn(Optional.of(project));
        when(userRepository.findById(userId))
                .thenReturn(Optional.of(user));

        // When & Then
        assertThatThrownBy(() -> projectService.deleteProject(projectId, userId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("已归档的项目不能删除");
    }
}
```
