# Java Spring Boot 服务任务详细计划 - JAVA-001 Part1 - 1.1 用户管理基础功能 - 1.1.4 Python后端

> **说明**: 用户管理功能主要由 Java 服务提供，Python AI 服务不直接处理用户 CRUD。
> 但 Python 服务需要能够调用 Java 服务的用户 API 来获取用户信息用于审计日志。

#### Python HTTP 客户端（调用 Java 服务）

```python
# backend/fastapi-ai-service/app/clients/java_client.py
"""
Java服务HTTP客户端
需求编号: REQ-JAVA-001
"""
import httpx
from typing import Optional, Dict, Any
from app.core.config import settings
from app.core.logging import logger

class JavaServiceClient:
    """
    Java Spring Boot服务HTTP客户端
    用于从Python AI服务调用Java服务的API
    """

    def __init__(self):
        self.base_url = settings.JAVA_SERVICE_URL  # http://backend-java:8080
        self.timeout = httpx.Timeout(30.0)
        self.client = httpx.AsyncClient(
            base_url=self.base_url,
            timeout=self.timeout
        )

    async def get_user_by_id(self, user_id: str, token: str) -> Optional[Dict[str, Any]]:
        """
        从Java服务获取用户信息

        Args:
            user_id: 用户ID
            token: JWT认证Token

        Returns:
            用户信息字典，如果失败返回None
        """
        try:
            response = await self.client.get(
                f"/api/v1/users/{user_id}",
                headers={"Authorization": f"Bearer {token}"}
            )

            if response.status_code == 200:
                data = response.json()
                return data.get("data")
            else:
                logger.warning(
                    f"从Java服务获取用户失败: user_id={user_id}, "
                    f"status={response.status_code}"
                )
                return None

        except httpx.HTTPError as e:
            logger.error(f"调用Java服务失败: {str(e)}")
            return None

    async def close(self):
        """关闭HTTP客户端"""
        await self.client.aclose()

# 全局实例
java_client = JavaServiceClient()
```

#### AI任务审计日志扩展

```python
# backend/fastapi-ai-service/app/services/ai/audit_logger.py
"""
AI任务审计日志服务
需求编号: REQ-JAVA-001, REQ-AI-001
"""
from typing import Dict, Any, Optional
from datetime import datetime
from app.clients.java_client import java_client
from app.core.logging import logger

class AIAuditLogger:
    """
    AI任务审计日志记录器
    记录AI操作的用户信息、操作类型、时间戳等
    """

    async def log_ai_operation(
        self,
        user_id: str,
        operation_type: str,
        task_id: str,
        details: Dict[str, Any],
        token: Optional[str] = None
    ) -> None:
        """
        记录AI操作日志

        Args:
            user_id: 用户ID
            operation_type: 操作类型（如"parse_document", "generate_content"）
            task_id: AI任务ID
            details: 操作详情
            token: JWT Token（用于获取用户信息）
        """
        # 从Java服务获取用户详细信息
        user_info = None
        if token:
            user_info = await java_client.get_user_by_id(user_id, token)

        # 构建审计日志
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "user_id": user_id,
            "username": user_info.get("username") if user_info else "unknown",
            "email": user_info.get("email") if user_info else "unknown",
            "operation_type": operation_type,
            "task_id": task_id,
            "details": details
        }

        # 记录到日志（实际项目中可能存储到Elasticsearch或数据库）
        logger.info(
            f"AI操作审计: user={log_entry['username']}, "
            f"operation={operation_type}, task={task_id}"
        )

        # TODO: 可选 - 将审计日志发送到Java服务存储到PostgreSQL
        # await self._send_audit_log_to_java(log_entry, token)

audit_logger = AIAuditLogger()
```

**验证标准**:
- [ ] Python HTTP 客户端能够成功调用 Java 服务 API
- [ ] Token 认证正确传递
- [ ] 错误处理健壮（网络失败、超时、认证失败）
- [ ] 审计日志记录完整
- [ ] 日志格式符合规范
