# Java Spring Boot 服务任务详细计划 - JAVA-001 Part3 - 1.5: 用户个人信息管理 - 1.6.1 数据定义 - 1.6.5 部署

**任务描述**: 配置Docker和Kubernetes环境，确保Flyway迁移在应用启动时自动执行

**关键实现**:

##### 1.6.5.1 Docker Compose配置

**文件**: `docker-compose.yml`

```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:14-alpine
    container_name: aibidcomposer-postgres
    environment:
      POSTGRES_DB: aibidcomposer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Java后端服务（包含Flyway迁移）
  backend-java:
    build:
      context: ./backend-java
      dockerfile: Dockerfile
    container_name: aibidcomposer-backend-java
    depends_on:
      postgres:
        condition: service_healthy  # 等待PostgreSQL就绪
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/aibidcomposer
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_FLYWAY_ENABLED: true
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: true
    ports:
      - "8080:8080"
    command: >
      sh -c "
        echo 'Waiting for PostgreSQL...' &&
        sleep 5 &&
        echo 'Starting Spring Boot application with Flyway migration...' &&
        java -jar app.jar
      "

volumes:
  postgres_data:
```

##### 1.6.5.2 Kubernetes部署配置

**文件**: `k8s/migrations/flyway-job.yaml`

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: flyway-migration
  namespace: aibidcomposer
spec:
  template:
    metadata:
      labels:
        app: flyway-migration
    spec:
      restartPolicy: OnFailure
      containers:
      - name: flyway
        image: flyway/flyway:9.22-alpine
        command:
        - flyway
        - -url=jdbc:postgresql://postgres-service:5432/aibidcomposer
        - -user=postgres
        - -password=${POSTGRES_PASSWORD}
        - -locations=filesystem:/flyway/sql
        - migrate
        volumeMounts:
        - name: migration-scripts
          mountPath: /flyway/sql
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
      volumes:
      - name: migration-scripts
        configMap:
          name: flyway-scripts
```

**ConfigMap for migration scripts**:

**文件**: `k8s/migrations/flyway-scripts-configmap.yaml`

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-scripts
  namespace: aibidcomposer
data:
  V1__create_users_table.sql: |
    -- 将完整的V1脚本内容放在这里
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    ...

  V2__create_roles_table.sql: |
    -- 将完整的V2脚本内容放在这里
    ...

  # 重复所有迁移脚本
```

##### 1.6.5.3 健康检查端点

**文件**: `backend-java/src/main/java/com/aibidcomposer/controller/HealthController.java`

```java
package com.aibidcomposer.controller;

import org.flywaydb.core.Flyway;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import lombok.RequiredArgsConstructor;

import java.util.HashMap;
import java.util.Map;

/**
 * 健康检查端点
 * 需求编号: REQ-JAVA-001
 */
@RestController
@RequestMapping("/actuator/health")
@RequiredArgsConstructor
public class HealthController {

    private final Flyway flyway;

    @GetMapping("/flyway")
    public ResponseEntity<Map<String, Object>> flywayHealth() {
        Map<String, Object> health = new HashMap<>();

        try {
            var info = flyway.info();
            var current = info.current();
            var pending = info.pending();

            health.put("status", pending.length == 0 ? "UP" : "WARNING");
            health.put("currentVersion", current != null ? current.getVersion().toString() : "无");
            health.put("pendingMigrations", pending.length);
            health.put("totalMigrations", info.all().length);

            return ResponseEntity.ok(health);
        } catch (Exception e) {
            health.put("status", "DOWN");
            health.put("error", e.getMessage());
            return ResponseEntity.status(503).body(health);
        }
    }
}
```

##### 1.6.5.4 应用启动流程

**启动顺序**:

```
1. PostgreSQL容器启动
   └─> healthcheck: pg_isready

2. Flyway迁移执行（作为initContainer或Job）
   └─> 应用所有迁移脚本
   └─> 插入初始数据

3. Java Spring Boot应用启动
   └─> Flyway.validate()验证迁移
   └─> JPA实体加载
   └─> 应用服务启动

4. 健康检查通过
   └─> /actuator/health/flyway返回UP
```

**验证检查清单**:

1. 部署 (100%)
   - [ ] Docker Compose可正常启动
   - [ ] PostgreSQL健康检查通过
   - [ ] Flyway迁移自动执行
   - [ ] 初始数据插入成功
   - [ ] Spring Boot应用启动成功
   - [ ] 健康检查端点返回正常
   - [ ] Kubernetes Job成功完成

---
