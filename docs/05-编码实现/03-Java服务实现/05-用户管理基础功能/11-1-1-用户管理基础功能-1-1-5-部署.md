# Java Spring Boot 服务任务详细计划 - JAVA-001 Part1 - 1.1 用户管理基础功能 - 1.1.5 部署

#### Docker Compose配置

```yaml
# docker-compose.yml（部分）
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:14-alpine
    container_name: aibidcomposer-postgres
    environment:
      POSTGRES_DB: aibidcomposer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend-java/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Java Spring Boot 服务
  backend-java:
    build:
      context: ./backend-java
      dockerfile: Dockerfile.dev
    container_name: aibidcomposer-backend-java
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/aibidcomposer
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis}
      JWT_SECRET: ${SECRET_KEY}
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_AIBIDCOMPOSER: DEBUG
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend-java/src:/app/src
      - ./backend-java/target:/app/target

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: aibidcomposer-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres_data:
  redis_data:
```

#### 环境变量配置

```bash
# .env.example
# 数据库配置
POSTGRES_PASSWORD=your_secure_password_here
DATABASE_URL=postgresql://postgres:your_secure_password_here@postgres:5432/aibidcomposer

# Redis配置
REDIS_PASSWORD=your_redis_password_here

# JWT配置
SECRET_KEY=your_jwt_secret_key_min_32_characters_long
JWT_EXPIRATION=3600
JWT_REFRESH_EXPIRATION=604800

# 应用配置
SPRING_PROFILES_ACTIVE=dev
LOGGING_LEVEL_ROOT=INFO
```

#### Spring Boot application.yml

```yaml
# backend-java/src/main/resources/application-dev.yml
spring:
  application:
    name: aibidcomposer-backend

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/aibidcomposer}
    username: ${SPRING_DATASOURCE_USERNAME:postgres}
    password: ${SPRING_DATASOURCE_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate  # 使用Flyway管理DDL
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          time_zone: UTC

  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  redis:
    host: ${SPRING_REDIS_HOST:localhost}
    port: 6379
    password: ${SPRING_REDIS_PASSWORD:redis}
    timeout: 5000
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms

# JWT配置
jwt:
  secret: ${JWT_SECRET:default_secret_key_for_development_only}
  expiration: ${JWT_EXPIRATION:3600}
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}

# 日志配置
logging:
  level:
    root: ${LOGGING_LEVEL_ROOT:INFO}
    com.aibidcomposer: ${LOGGING_LEVEL_COM_AIBIDCOMPOSER:DEBUG}
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

**验证标准**:
- [ ] docker-compose up -d 成功启动所有服务
- [ ] PostgreSQL 数据库连接成功
- [ ] Flyway 迁移脚本自动执行成功
- [ ] Redis 连接成功
- [ ] Java 服务健康检查通过（http://localhost:8080/actuator/health）
- [ ] 环境变量正确加载
- [ ] 日志输出正常
