---
ÊñáÊ°£Á±ªÂûã: Êû∂ÊûÑÊñáÊ°£
ÈúÄÊ±ÇÁºñÂè∑: DOC-2025-11-001
ÂàõÂª∫Êó•Êúü: 2025-11-15
ÂàõÂª∫ËÄÖ: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
ÊúÄÂêéÊõ¥Êñ∞: 2025-11-26
Êõ¥Êñ∞ËÄÖ: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
Áä∂ÊÄÅ: Â∑≤ÊâπÂáÜ
---

# AIÊ†á‰π¶Êô∫ËÉΩÂàõ‰ΩúÂπ≥Âè∞ - Êï∞ÊçÆÂ∫ìËÆæËÆ° - üìÑ Ê†á‰π¶Âüü

### 11. bid_documents (Ê†á‰π¶ÊñáÊ°£Ë°®)

```sql
CREATE TABLE bid_documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL,
    template_id UUID,
    title VARCHAR(200) NOT NULL,
    version VARCHAR(20) DEFAULT '1.0',
    document_type VARCHAR(50) DEFAULT 'main' CHECK (document_type IN ('main', 'technical', 'commercial', 'qualification', 'other')),
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'editing', 'review', 'approved', 'submitted', 'archived')),
    content_type VARCHAR(20) DEFAULT 'structured' CHECK (content_type IN ('structured', 'freeform', 'mixed')),
    content JSONB,
    plain_content TEXT,
    toc JSONB,
    word_count INTEGER DEFAULT 0,
    page_count INTEGER DEFAULT 0,
    last_edited_by UUID,
    last_edited_at TIMESTAMP WITH TIME ZONE,
    locked_by UUID,
    locked_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_by UUID NOT NULL,
    updated_by UUID,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (last_edited_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (locked_by) REFERENCES users(id) ON DELETE SET NULL
);

-- Á¥¢Âºï
CREATE INDEX idx_bid_documents_project_id ON bid_documents(project_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_bid_documents_template_id ON bid_documents(template_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_bid_documents_status ON bid_documents(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_bid_documents_created_by ON bid_documents(created_by);
CREATE INDEX idx_bid_documents_locked_by ON bid_documents(locked_by) WHERE locked_by IS NOT NULL;
CREATE INDEX idx_bid_documents_updated_at ON bid_documents(updated_at DESC);

-- ÂÖ®ÊñáÊêúÁ¥¢Á¥¢Âºï
CREATE INDEX idx_bid_documents_plain_content_fts ON bid_documents USING gin(to_tsvector('chinese', plain_content));

-- Ê≥®Èáä
COMMENT ON TABLE bid_documents IS 'Ê†á‰π¶ÊñáÊ°£Ë°®';
COMMENT ON COLUMN bid_documents.content IS 'ÁªìÊûÑÂåñÂÜÖÂÆπ(JSON)';
COMMENT ON COLUMN bid_documents.plain_content IS 'Á∫ØÊñáÊú¨ÂÜÖÂÆπ(Áî®‰∫éÊêúÁ¥¢)';
COMMENT ON COLUMN bid_documents.toc IS 'ÁõÆÂΩïÁªìÊûÑ(JSON)';
```

### 12. document_sections (ÊñáÊ°£Á´†ËäÇË°®)

```sql
CREATE TABLE document_sections (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    document_id UUID NOT NULL,
    parent_id UUID,
    title VARCHAR(200) NOT NULL,
    section_number VARCHAR(50),
    level INTEGER DEFAULT 1,
    content TEXT,
    content_type VARCHAR(20) DEFAULT 'text' CHECK (content_type IN ('text', 'table', 'image', 'chart', 'list', 'mixed')),
    order_index INTEGER NOT NULL,
    word_count INTEGER DEFAULT 0,
    is_required BOOLEAN DEFAULT FALSE,
    is_generated BOOLEAN DEFAULT FALSE,
    generated_by VARCHAR(50),
    generation_prompt TEXT,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES bid_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES document_sections(id) ON DELETE CASCADE
);

-- Á¥¢Âºï
CREATE INDEX idx_document_sections_document_id ON document_sections(document_id);
CREATE INDEX idx_document_sections_parent_id ON document_sections(parent_id);
CREATE INDEX idx_document_sections_order_index ON document_sections(document_id, order_index);

-- Ê≥®Èáä
COMMENT ON TABLE document_sections IS 'ÊñáÊ°£Á´†ËäÇË°®';
COMMENT ON COLUMN document_sections.level IS 'Á´†ËäÇÂ±ÇÁ∫ß';
COMMENT ON COLUMN document_sections.is_generated IS 'ÊòØÂê¶AIÁîüÊàê';
```

### 13. document_versions (ÊñáÊ°£ÁâàÊú¨Ë°®)

```sql
CREATE TABLE document_versions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    document_id UUID NOT NULL,
    version VARCHAR(20) NOT NULL,
    version_number INTEGER NOT NULL,
    title VARCHAR(200) NOT NULL,
    content JSONB NOT NULL,
    plain_content TEXT,
    change_summary TEXT,
    change_type VARCHAR(20) DEFAULT 'minor' CHECK (change_type IN ('major', 'minor', 'patch', 'draft')),
    word_count INTEGER DEFAULT 0,
    created_by UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES bid_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
    UNIQUE (document_id, version_number)
);

-- Á¥¢Âºï
CREATE INDEX idx_document_versions_document_id ON document_versions(document_id);
CREATE INDEX idx_document_versions_version_number ON document_versions(document_id, version_number DESC);
CREATE INDEX idx_document_versions_created_at ON document_versions(created_at DESC);

-- Ê≥®Èáä
COMMENT ON TABLE document_versions IS 'ÊñáÊ°£ÁâàÊú¨Ë°®';
COMMENT ON COLUMN document_versions.version_number IS 'ÁâàÊú¨Âè∑(ÈÄíÂ¢û)';
COMMENT ON COLUMN document_versions.change_type IS 'ÂèòÊõ¥Á±ªÂûã';
```

### 14. document_comments (ÊñáÊ°£ËØÑËÆ∫Ë°®)

```sql
CREATE TABLE document_comments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    document_id UUID NOT NULL,
    section_id UUID,
    parent_id UUID,
    content TEXT NOT NULL,
    comment_type VARCHAR(20) DEFAULT 'comment' CHECK (comment_type IN ('comment', 'suggestion', 'issue', 'approval')),
    status VARCHAR(20) DEFAULT 'open' CHECK (status IN ('open', 'resolved', 'archived')),
    selection_start INTEGER,
    selection_end INTEGER,
    position_data JSONB,
    is_resolved BOOLEAN DEFAULT FALSE,
    resolved_by UUID,
    resolved_at TIMESTAMP WITH TIME ZONE,
    created_by UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,
    FOREIGN KEY (document_id) REFERENCES bid_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (section_id) REFERENCES document_sections(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES document_comments(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (resolved_by) REFERENCES users(id) ON DELETE SET NULL
);

-- Á¥¢Âºï
CREATE INDEX idx_document_comments_document_id ON document_comments(document_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_document_comments_section_id ON document_comments(section_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_document_comments_parent_id ON document_comments(parent_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_document_comments_status ON document_comments(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_document_comments_created_at ON document_comments(created_at DESC);

-- Ê≥®Èáä
COMMENT ON TABLE document_comments IS 'ÊñáÊ°£ËØÑËÆ∫Ë°®';
COMMENT ON COLUMN document_comments.comment_type IS 'ËØÑËÆ∫Á±ªÂûã';
COMMENT ON COLUMN document_comments.position_data IS '‰ΩçÁΩÆÊï∞ÊçÆ(JSON)';
```
