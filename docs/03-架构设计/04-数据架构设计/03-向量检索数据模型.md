---
doc_type: Design
req_id: ARCH-2025-11-003-03
created_at: 2025-11-30 00:25
author: gemini-pro
updated_at: 2025-11-30 00:25
updater: gemini-pro
status: Draft
---

# 03-向量检索数据模型

## 1. 概述

本文档详细描述AI标书智能创作平台中向量检索数据模型的设计，主要基于Elasticsearch的向量搜索能力。它将支持对招标文件、企业能力、历史案例等文本内容的语义搜索和相似度匹配，为RAG（Retrieval-Augmented Generation）和智能匹配引擎提供高效的向量检索服务。

## 2. 设计原则

*   **统一存储**: 利用Elasticsearch统一存储文本内容和对应的向量，简化技术栈。
*   **高效检索**: 优化索引结构和查询参数，保证向量搜索的性能。
*   **语义丰富**: 结合NLP技术，确保向量能准确捕捉文本的语义信息。
*   **实时性**: 支持准实时的向量索引和更新。
*   **可扩展性**: 能够处理大规模的向量数据和高并发查询。

## 3. 核心向量索引设计

### 3.1 招标文件向量索引 (`tender_documents_vectors`)

*   **目的**: 存储招标文件的关键文本片段及其向量，用于快速匹配和检索相关需求。
*   **字段**:
    *   `id`: String (唯一标识符，对应MinIO中文件ID或PostgreSQL中文档ID)
    *   `project_id`: String (关联项目ID)
    *   `section_id`: String (文本片段所属的章节ID或段落ID)
    *   `content`: Text (原始文本片段)
    *   `embedding`: Dense Vector (文本片段对应的向量，例如1536维)
    *   `embedding_metadata`: JSON (向量相关的元数据，如 `embedding_model_version`, `chunk_size`)
    *   `metadata`: JSON (其他元数据，如 `document_type`, `language`, `source_url`)
*   **索引设置**:
    *   `number_of_shards`: 适当数量的分片以支持扩展。
    *   `number_of_replicas`: 副本数量以保证高可用和读吞吐。
    *   `codec`: 优化存储。
*   **映射 (Mappings)**:
    *   `content`: `text` 类型，标准分析器。
    *   `embedding`: `dense_vector` 类型，`dims` 需与嵌入模型维度一致，`similarity` 可选 `cosine` 或 `dot_product`。
    *   `id`, `project_id`, `section_id`: `keyword` 类型。
    *   `metadata`: `object` 类型，`enabled: false` 或按需定义子字段。

### 3.2 企业能力向量索引 (`enterprise_capabilities_vectors`)

*   **目的**: 存储企业产品、服务、项目案例、人员资质等能力的描述性文本及其向量，用于智能匹配。
*   **字段**:
    *   `id`: String (唯一标识符，对应PostgreSQL中能力实体ID)
    *   `capability_type`: String (能力类型，如“产品”、“服务”、“项目案例”、“人员技能”、“企业资质”)
    *   `name`: Text (能力名称)
    *   `description`: Text (能力详细描述)
    *   `embedding`: Dense Vector (文本描述对应的向量)
    *   `metadata`: JSON (其他元数据，如 `industry`, `tags`, `level`, `certifications`)
*   **映射 (Mappings)**:
    *   `name`, `description`: `text` 类型。
    *   `embedding`: `dense_vector` 类型。
    *   `id`, `capability_type`: `keyword` 类型。

### 3.3 历史标书内容向量索引 (`historical_bids_vectors`)

*   **目的**: 存储历史中标标书的关键章节内容及其向量，用于生成内容的参考和查重。
*   **字段**:
    *   `id`: String (唯一标识符，对应PostgreSQL中标书文档ID)
    *   `bid_section_id`: String (标书章节ID)
    *   `content`: Text (标书章节原始文本)
    *   `embedding`: Dense Vector (文本内容对应的向量)
    *   `metadata`: JSON (其他元数据，如 `project_id`, `template_id`, `outcome` (中标/未中标), `quality_score`)
*   **映射 (Mappings)**: 
    *   `content`: `text` 类型。
    *   `embedding`: `dense_vector` 类型。
    *   `id`, `bid_section_id`: `keyword` 类型。

## 4. 向量生成与更新

*   **嵌入模型**: 使用预训练的通用嵌入模型（如OpenAI `text-embedding-ada-002` 或智谱 `GLM Embedding`）生成文本向量。
*   **异步生成**: 文本内容向量化是一个计算密集型任务，应通过异步任务队列（如Celery）进行处理。
*   **增量更新**: 对于现有内容的修改，采用增量更新策略，只更新受影响的文本片段和其向量。
*   **批量处理**: 对于大规模数据导入，支持批量向量生成和索引。

## 5. 向量检索策略

*   **kNN (k-Nearest Neighbors) 搜索**: 使用Elasticsearch的近似最近邻搜索功能，快速检索最相似的向量。
    *   **参数**: `num_candidates`, `query_vector`, `k`。
*   **混合搜索 (Hybrid Search)**: 结合向量搜索（语义相关性）和全文搜索（关键词精确匹配），提供更全面和准确的检索结果。
    *   **实现**: 通过Elasticsearch的 `_search` API，结合 `query` 和 `knn` 查询。
*   **过滤器 (Filters)**: 检索时支持基于元数据的过滤，例如按 `project_id`、`document_type`、`industry` 等进行过滤。

## 6. 与RAG和智能匹配引擎的集成

*   **RAG**:
    *   在RAG流程中，根据用户查询（或招标文件需求），通过向量检索从相关索引中召回语义最相似的文本片段。
    *   召回的文本片段作为上下文，与Prompt一起输入LLM进行增强生成。
*   **智能匹配**:
    *   将招标文件需求向量和企业能力向量进行相似度计算，提供匹配分数。
    *   结合关键词匹配和元数据过滤，提升匹配精度。

---
