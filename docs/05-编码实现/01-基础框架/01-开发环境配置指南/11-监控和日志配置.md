# AIæ ‡ä¹¦æ™ºèƒ½åˆ›ä½œå¹³å° - å¼€å‘ç¯å¢ƒé…ç½®æŒ‡å— - ğŸ“ ç›‘æ§å’Œæ—¥å¿—é…ç½®

### åº”ç”¨ç›‘æ§
```python
# server/monitoring.py - ç›‘æ§æ¨¡å—é…ç½®
import structlog
import logging
import time
from typing import Dict, Any
from datetime import datetime

# é…ç½®ç›‘æ§æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)

# æ€§èƒ½ç›‘æ§è£…é¥°å™¨
def monitor_performance(func):
    def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = func(*args, **kwargs)
            end_time = time.time()
            duration = end_time - start_time

            # è®°å½•æ€§èƒ½æ•°æ®
            logging.info(
                f"Performance: {func.__name__}",
                f"Duration: {duration:.3f}s",
                f"Memory usage: {psutil.Process().memory_info().rss/1024/1024:.1f}MB"
            )
            return result
        except Exception as e:
            end_time = time.time()
            logging.error(
                f"Performance: {func.__name__}",
                f"Duration: {duration:.3f}s",
                f"Error: {str(e)}"
            )
            raise
    return wrapper

# APIæ€§èƒ½ç›‘æ§
@monitor_performance
async def measure_api_performance(endpoint: str, method: str, headers: Dict[str, Any] = None):
    start_time = time.time()

    # æ¨¡æ‹ŸAPIè°ƒç”¨
    await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´

    end_time = time.time()
    duration = end_time - start_time

    return {
        "endpoint": endpoint,
        "method": method,
        "duration": duration,
        "timestamp": datetime.utcnow().isoformat(),
        "status": "success"
    }

# ç³»ç»Ÿèµ„æºç›‘æ§
def get_system_metrics():
    import psutil

    return {
        "cpu_percent": psutil.cpu_percent(),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_usage": psutil.disk_usage('/'),
        "network_io": psutil.net_io_counters(),
        "process_count": len(psutil.pids()),
        "timestamp": datetime.utcnow().isoformat()
    }

# åº”ç”¨å¥åº·æ£€æŸ¥
async def check_application_health():
    health_status = {
        "status": "healthy",
        "database": "disconnected",
        "redis": "disconnected",
        "api": "disconnected",
        "frontend": "disconnected",
        "timestamp": datetime.utcnow().isoformat()
    }

    # æ£€æŸ¥æ•°æ®åº“
    try:
        async with engine.begin() as conn:
            await conn.execute("SELECT 1")
            health_status["database"] = "connected"
    except Exception as e:
        health_status["database"] = f"error: {e}"

    # æ£€æŸ¥Redis
    try:
        import redis
        r = redis.Redis(
            host=settings.REDIS_HOST,
            port=settings.REDIS_PORT,
            db=settings.REDIS_DB
        )
        r.ping()
        health_status["redis"] = "connected"
    except Exception as e:
        health_status["redis"] = f"error: {e}"

    # æ£€æŸ¥API
    try:
        response = await httpx.get(f"{settings.API_BASE_URL}/health", timeout=5)
        if response.status_code == 200:
            health_status["api"] = "healthy"
        else:
            health_status["api"] = f"error: HTTP {response.status_code}"
    except Exception as e:
        health_status["api"] = f"error: {e}"

    return health_status
```

### æ—¥å¿—é…ç½®
```python
# server/core/logging_config.py - æ—¥å¿—é…ç½®
import os
import logging
import sys
import structlog
from typing import Dict, Any

# æ—¥å¿—æ ¼å¼é…ç½®
class ColoredFormatter(logging.Formatter):
    """å½©è‰²æ—¥å¿—æ ¼å¼åŒ–å™¨"""

    COLORS = {
        'DEBUG': '\033[94m',      # è“è‰²
        'INFO': '\033[92m',       # ç»¿è‰²
        'WARNING': '\033[93m',     # é»„è‰²
        'ERROR': '\033[91m',      # çº¢è‰²
        'CRITICAL': '\033[90m',    # çº¢è‰²
        'RESET': '\033[0m',      # é»˜è®¤
    }

    def format(self, record):
        log_color = self.COLORS.get(record.levelname, self.COLORS['RESET'])
        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
        return f"{log_color}{formatter.format(record)}{self.COLORS['RESET']}"
    }

# æ—¥å¿—é…ç½®
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)

# ç»“æ„åŒ–æ—¥å¿—é…ç½®
structlog
    timestamp: str
    level: str
    message: str
    module: str
    function_name: str
    user_id: str | None
    session_id: str | None
    request_id: str | None
    duration: float | None
    extra: Dict[str, Any] | None
```
