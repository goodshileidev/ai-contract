# Java Spring Boot - JAVA-002 Part1 (ç»„ç»‡ç®¡ç†: æ•°æ®+å‰ç«¯)

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-002 (2.1.1-2.1.2)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-27
**åˆ›å»ºè€…**: claude-sonnet-4-5
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 15:10 | 3.0 | claude-sonnet-4-5 | å°†è¶…é•¿JAVA-002æ–‡æ¡£(10051è¡Œ)æ‹†åˆ†æˆ5ä¸ªå­æ–‡æ¡£ |
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º JAVA-002 æ¨¡å— |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [JAVA-002-INDEX.md](./task-plan-java-è¯¦ç»†-JAVA-002-INDEX.md)
**å…¶ä»–éƒ¨åˆ†**: [Part2](./task-plan-java-è¯¦ç»†-JAVA-002-Part2.md) | [Part3](./task-plan-java-è¯¦ç»†-JAVA-002-Part3.md) | [Part4](./task-plan-java-è¯¦ç»†-JAVA-002-Part4.md) | [Part5](./task-plan-java-è¯¦ç»†-JAVA-002-Part5.md)

---

## JAVA-002: ç»„ç»‡å’Œé¡¹ç›®ç®¡ç†æ¨¡å—

**éœ€æ±‚ç¼–å·**: REQ-JAVA-002
**è´Ÿè´£äºº**: Java åç«¯å¼€å‘
**å¼€å§‹æ—¶é—´**: YYYY-MM-DD
**é¢„è®¡å®Œæˆ**: YYYY-MM-DD
**å®é™…å®Œæˆ**: -
**å½“å‰çŠ¶æ€**: â¸ï¸ å¾…å¼€å§‹
**å®Œæˆè¿›åº¦**: 0% (0/5 å­ä»»åŠ¡)
**é¢„ä¼°å·¥æ—¶**: 22äººå¤©

### æ¨¡å—æ¦‚è¿°

ç»„ç»‡å’Œé¡¹ç›®ç®¡ç†æ¨¡å—æ˜¯å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†ä¼ä¸šç»„ç»‡ç»“æ„ã€é¡¹ç›®ä¿¡æ¯å’Œæ‹›æ ‡é¡¹ç›®ã€‚æœ¬æ¨¡å—æä¾›å®Œæ•´çš„ç»„ç»‡å±‚çº§ç®¡ç†ã€é¡¹ç›®ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€é¡¹ç›®æˆå‘˜åä½œç­‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç»„ç»‡ç®¡ç†ï¼šç»„ç»‡åˆ›å»ºã€ç¼–è¾‘ã€æˆå‘˜ç®¡ç†ã€ç»„ç»‡è®¾ç½®
- é¡¹ç›®ç®¡ç†ï¼šé¡¹ç›®åˆ›å»ºã€çŠ¶æ€è·Ÿè¸ªã€é‡Œç¨‹ç¢‘ç®¡ç†ã€é¡¹ç›®å½’æ¡£
- æ‹›æ ‡é¡¹ç›®ç®¡ç†ï¼šæ‹›æ ‡æ–‡ä»¶å…³è”ã€æŠ•æ ‡è¿›åº¦è·Ÿè¸ªã€ä¸­æ ‡ç®¡ç†
- é¡¹ç›®åä½œï¼šæˆå‘˜æƒé™åˆ†é…ã€æ´»åŠ¨æ—¥å¿—ã€é€šçŸ¥æœºåˆ¶

**æŠ€æœ¯è¦ç‚¹**ï¼š
- ä½¿ç”¨ Spring Data JPA å®ç°æ•°æ®è®¿é—®
- ç»„ç»‡å±‚çº§ä½¿ç”¨è‡ªå…³è”è®¾è®¡ï¼ˆparent_idï¼‰
- é¡¹ç›®çŠ¶æ€æœºç®¡ç†ï¼ˆçŠ¶æ€æµè½¬æ§åˆ¶ï¼‰
- åŸºäºè§’è‰²çš„é¡¹ç›®æˆå‘˜æƒé™ï¼ˆproject_membersè¡¨ï¼‰
- è½¯åˆ é™¤è®¾è®¡ï¼ˆdeleted_atå­—æ®µï¼‰
- å®¡è®¡æ—¥å¿—è‡ªåŠ¨è®°å½•ï¼ˆcreated_at, updated_atè§¦å‘å™¨ï¼‰

**å­ä»»åŠ¡æ¸…å•**ï¼š
1. ç»„ç»‡ç®¡ç†åŠŸèƒ½ï¼ˆ5äººå¤©ï¼‰
2. é¡¹ç›®ç®¡ç†åŠŸèƒ½ï¼ˆ6äººå¤©ï¼‰
3. æ‹›æ ‡é¡¹ç›®ç®¡ç†ï¼ˆ5äººå¤©ï¼‰
4. é¡¹ç›®åä½œï¼ˆ3äººå¤©ï¼‰
5. æ•°æ®åº“è®¾è®¡ï¼ˆ3äººå¤©ï¼‰

---

---

### 2.1: ç»„ç»‡ç®¡ç†åŠŸèƒ½

**å·¥æ—¶ä¼°ç®—**: 5äººå¤©
**ä¼˜å…ˆçº§**: P1 - é«˜ä¼˜å…ˆçº§
**ä¾èµ–**: JAVA-001ï¼ˆç”¨æˆ·è®¤è¯æˆæƒï¼‰
**å®Œæˆè¿›åº¦**: 0% (0/5 ç±»åˆ«)

#### åŠŸèƒ½æè¿°

ç»„ç»‡ç®¡ç†åŠŸèƒ½æä¾›ä¼ä¸šç»„ç»‡æ¶æ„çš„å®Œæ•´ç®¡ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬ç»„ç»‡ä¿¡æ¯ç»´æŠ¤ã€ç»„ç»‡æˆå‘˜ç®¡ç†ã€ç»„ç»‡å±‚çº§ç»“æ„ç­‰ã€‚æ”¯æŒå¤šå±‚çº§ç»„ç»‡ç»“æ„ï¼ˆæ€»å…¬å¸-åˆ†å…¬å¸-éƒ¨é—¨ï¼‰ï¼Œä¸ºåç»­é¡¹ç›®ç®¡ç†æä¾›ç»„ç»‡åŸºç¡€ã€‚

**æ ¸å¿ƒåŠŸèƒ½ç‚¹**ï¼š
- ç»„ç»‡ä¿¡æ¯CRUDï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- ç»„ç»‡æˆå‘˜ç®¡ç†ï¼ˆæ·»åŠ æˆå‘˜ã€ç§»é™¤æˆå‘˜ã€è§’è‰²åˆ†é…ï¼‰
- ç»„ç»‡å±‚çº§ç®¡ç†ï¼ˆçˆ¶å­ç»„ç»‡å…³ç³»ï¼‰
- ç»„ç»‡è®¾ç½®ç®¡ç†ï¼ˆç»„ç»‡é…ç½®ã€åå¥½è®¾ç½®ï¼‰

#### 2.1.1: æ•°æ®å®šä¹‰

**éªŒè¯æ¸…å•**:
- [ ] Organization å®ä½“ç±»è®¾è®¡å®Œæˆ
- [ ] OrganizationMember å®ä½“ç±»è®¾è®¡å®Œæˆ
- [ ] DTO ç±»è®¾è®¡å®Œæˆï¼ˆCreateOrganizationDTO, UpdateOrganizationDTO, OrganizationResponseDTOï¼‰
- [ ] æ•°æ®è¡¨å­—æ®µç¬¦åˆæ•°æ®åº“è®¾è®¡æ–‡æ¡£
- [ ] å®ä½“å…³ç³»æ˜ å°„æ­£ç¡®ï¼ˆ@OneToMany, @ManyToOneï¼‰
- [ ] è½¯åˆ é™¤å­—æ®µé…ç½®å®Œæˆ
- [ ] å®¡è®¡å­—æ®µé…ç½®å®Œæˆ

**Organization å®ä½“ç±»**:

```java
package com.aibidcomposer.entity;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.SQLDelete;
import org.hibernate.annotations.Where;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

/**
 * ç»„ç»‡å®ä½“
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 *
 * æ”¯æŒå¤šå±‚çº§ç»„ç»‡ç»“æ„ï¼ˆæ€»å…¬å¸-åˆ†å…¬å¸-éƒ¨é—¨ï¼‰
 * è½¯åˆ é™¤è®¾è®¡ï¼Œä½¿ç”¨ deleted_at å­—æ®µ
 */
@Entity
@Table(name = "organizations")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@EntityListeners(AuditingEntityListener.class)
@SQLDelete(sql = "UPDATE organizations SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?")
@Where(clause = "deleted_at IS NULL")
public class Organization {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;

    /**
     * ç»„ç»‡åç§°ï¼ˆå¿…å¡«ï¼Œæœ€å¤§200å­—ç¬¦ï¼‰
     */
    @Column(name = "name", nullable = false, length = 200)
    private String name;

    /**
     * ç»„ç»‡ç®€ç§°ï¼ˆå¯é€‰ï¼Œæœ€å¤§100å­—ç¬¦ï¼‰
     */
    @Column(name = "short_name", length = 100)
    private String shortName;

    /**
     * ç»„ç»‡ç±»å‹
     * company - å…¬å¸
     * government - æ”¿åºœæœºæ„
     * institution - äº‹ä¸šå•ä½
     * individual - ä¸ªäºº
     */
    @Column(name = "organization_type", length = 50)
    @Enumerated(EnumType.STRING)
    private OrganizationType organizationType;

    /**
     * ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç /ç¨å·
     */
    @Column(name = "tax_id", length = 50)
    private String taxId;

    /**
     * æ³•å®šä»£è¡¨äºº
     */
    @Column(name = "legal_person", length = 100)
    private String legalPerson;

    /**
     * è”ç³»ç”µè¯
     */
    @Column(name = "contact_phone", length = 20)
    private String contactPhone;

    /**
     * è”ç³»é‚®ç®±
     */
    @Column(name = "contact_email", length = 255)
    private String contactEmail;

    /**
     * è¯¦ç»†åœ°å€
     */
    @Column(name = "address", columnDefinition = "TEXT")
    private String address;

    /**
     * çœä»½
     */
    @Column(name = "province", length = 50)
    private String province;

    /**
     * åŸå¸‚
     */
    @Column(name = "city", length = 50)
    private String city;

    /**
     * åŒºå¿
     */
    @Column(name = "district", length = 50)
    private String district;

    /**
     * ç»„ç»‡Logo URL
     */
    @Column(name = "logo_url", columnDefinition = "TEXT")
    private String logoUrl;

    /**
     * å®˜æ–¹ç½‘ç«™
     */
    @Column(name = "website", columnDefinition = "TEXT")
    private String website;

    /**
     * æ‰€å±è¡Œä¸š
     */
    @Column(name = "industry", length = 100)
    private String industry;

    /**
     * ä¼ä¸šè§„æ¨¡
     * small - å°å‹
     * medium - ä¸­å‹
     * large - å¤§å‹
     * xlarge - è¶…å¤§å‹
     */
    @Column(name = "scale", length = 50)
    @Enumerated(EnumType.STRING)
    private OrganizationScale scale;

    /**
     * æˆç«‹æ—¥æœŸ
     */
    @Column(name = "established_date")
    private LocalDate establishedDate;

    /**
     * ç»„ç»‡çŠ¶æ€
     * active - æ´»è·ƒ
     * inactive - æœªæ¿€æ´»
     * suspended - å·²æš‚åœ
     */
    @Column(name = "status", length = 20, nullable = false)
    @Enumerated(EnumType.STRING)
    @Builder.Default
    private OrganizationStatus status = OrganizationStatus.ACTIVE;

    /**
     * çˆ¶ç»„ç»‡IDï¼ˆæ”¯æŒç»„ç»‡å±‚çº§ï¼‰
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    private Organization parent;

    /**
     * å­ç»„ç»‡åˆ—è¡¨
     */
    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
    @Builder.Default
    private Set<Organization> children = new HashSet<>();

    /**
     * ç»„ç»‡æˆå‘˜åˆ—è¡¨
     */
    @OneToMany(mappedBy = "organization", cascade = CascadeType.ALL, orphanRemoval = true)
    @Builder.Default
    private Set<OrganizationMember> members = new HashSet<>();

    /**
     * ç»„ç»‡è®¾ç½®ï¼ˆJSONBæ ¼å¼ï¼‰
     * å­˜å‚¨ç»„ç»‡åå¥½è®¾ç½®ã€é…ç½®å‚æ•°ç­‰
     */
    @Column(name = "settings", columnDefinition = "jsonb DEFAULT '{}'::jsonb")
    private String settings;

    /**
     * å…ƒæ•°æ®ï¼ˆJSONBæ ¼å¼ï¼‰
     * å­˜å‚¨æ‰©å±•ä¿¡æ¯
     */
    @Column(name = "metadata", columnDefinition = "jsonb DEFAULT '{}'::jsonb")
    private String metadata;

    /**
     * åˆ›å»ºæ—¶é—´ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
     */
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    /**
     * æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
     */
    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    /**
     * è½¯åˆ é™¤æ—¶é—´
     */
    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    // ==================== ä¸šåŠ¡æ–¹æ³• ====================

    /**
     * æ·»åŠ å­ç»„ç»‡
     */
    public void addChild(Organization child) {
        children.add(child);
        child.setParent(this);
    }

    /**
     * ç§»é™¤å­ç»„ç»‡
     */
    public void removeChild(Organization child) {
        children.remove(child);
        child.setParent(null);
    }

    /**
     * æ·»åŠ æˆå‘˜
     */
    public void addMember(OrganizationMember member) {
        members.add(member);
        member.setOrganization(this);
    }

    /**
     * ç§»é™¤æˆå‘˜
     */
    public void removeMember(OrganizationMember member) {
        members.remove(member);
        member.setOrganization(null);
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºæ ¹ç»„ç»‡
     */
    public boolean isRoot() {
        return parent == null;
    }

    /**
     * è·å–ç»„ç»‡å±‚çº§æ·±åº¦
     */
    public int getDepth() {
        int depth = 0;
        Organization current = this;
        while (current.getParent() != null) {
            depth++;
            current = current.getParent();
        }
        return depth;
    }
}

/**
 * ç»„ç»‡ç±»å‹æšä¸¾
 */
enum OrganizationType {
    COMPANY,      // å…¬å¸
    GOVERNMENT,   // æ”¿åºœæœºæ„
    INSTITUTION,  // äº‹ä¸šå•ä½
    INDIVIDUAL    // ä¸ªäºº
}

/**
 * ç»„ç»‡è§„æ¨¡æšä¸¾
 */
enum OrganizationScale {
    SMALL,    // å°å‹ï¼ˆ<100äººï¼‰
    MEDIUM,   // ä¸­å‹ï¼ˆ100-500äººï¼‰
    LARGE,    // å¤§å‹ï¼ˆ500-5000äººï¼‰
    XLARGE    // è¶…å¤§å‹ï¼ˆ>5000äººï¼‰
}

/**
 * ç»„ç»‡çŠ¶æ€æšä¸¾
 */
enum OrganizationStatus {
    ACTIVE,     // æ´»è·ƒ
    INACTIVE,   // æœªæ¿€æ´»
    SUSPENDED   // å·²æš‚åœ
}
```

**OrganizationMember å®ä½“ç±»**:

```java
package com.aibidcomposer.entity;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * ç»„ç»‡æˆå‘˜å®ä½“
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 *
 * ç®¡ç†ç»„ç»‡æˆå‘˜å…³ç³»ã€è§’è‰²å’Œæƒé™
 */
@Entity
@Table(name = "organization_members",
    uniqueConstraints = @UniqueConstraint(columnNames = {"organization_id", "user_id"}))
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@EntityListeners(AuditingEntityListener.class)
public class OrganizationMember {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;

    /**
     * æ‰€å±ç»„ç»‡
     */
    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "organization_id", nullable = false)
    private Organization organization;

    /**
     * ç”¨æˆ·ID
     */
    @Column(name = "user_id", nullable = false)
    private UUID userId;

    /**
     * ç»„ç»‡è§’è‰²
     * OWNER - æ‰€æœ‰è€…ï¼ˆåˆ›å»ºè€…ï¼Œæœ€é«˜æƒé™ï¼‰
     * ADMIN - ç®¡ç†å‘˜ï¼ˆç®¡ç†æƒé™ï¼‰
     * MEMBER - æ™®é€šæˆå‘˜ï¼ˆåŸºç¡€æƒé™ï¼‰
     * GUEST - è®¿å®¢ï¼ˆåªè¯»æƒé™ï¼‰
     */
    @Column(name = "role", length = 20, nullable = false)
    @Enumerated(EnumType.STRING)
    @Builder.Default
    private OrganizationRole role = OrganizationRole.MEMBER;

    /**
     * åŠ å…¥æ—¶é—´
     */
    @CreatedDate
    @Column(name = "joined_at", nullable = false, updatable = false)
    private LocalDateTime joinedAt;

    /**
     * æ·»åŠ äººID
     */
    @Column(name = "created_by")
    private UUID createdBy;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºæ‰€æœ‰è€…
     */
    public boolean isOwner() {
        return role == OrganizationRole.OWNER;
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜æˆ–æ‰€æœ‰è€…
     */
    public boolean isAdminOrOwner() {
        return role == OrganizationRole.OWNER || role == OrganizationRole.ADMIN;
    }
}

/**
 * ç»„ç»‡è§’è‰²æšä¸¾
 */
enum OrganizationRole {
    OWNER,   // æ‰€æœ‰è€…
    ADMIN,   // ç®¡ç†å‘˜
    MEMBER,  // æ™®é€šæˆå‘˜
    GUEST    // è®¿å®¢
}
```

**CreateOrganizationDTO**:

```java
package com.aibidcomposer.dto.organization;

import com.aibidcomposer.entity.OrganizationScale;
import com.aibidcomposer.entity.OrganizationType;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;
import lombok.Data;

import java.time.LocalDate;
import java.util.UUID;

/**
 * åˆ›å»ºç»„ç»‡DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Data
public class CreateOrganizationDTO {

    @NotBlank(message = "ç»„ç»‡åç§°ä¸èƒ½ä¸ºç©º")
    @Size(max = 200, message = "ç»„ç»‡åç§°æœ€å¤š200ä¸ªå­—ç¬¦")
    private String name;

    @Size(max = 100, message = "ç»„ç»‡ç®€ç§°æœ€å¤š100ä¸ªå­—ç¬¦")
    private String shortName;

    private OrganizationType organizationType;

    @Pattern(regexp = "^[A-Z0-9]{18}$", message = "ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç æ ¼å¼ä¸æ­£ç¡®")
    private String taxId;

    @Size(max = 100, message = "æ³•å®šä»£è¡¨äººæœ€å¤š100ä¸ªå­—ç¬¦")
    private String legalPerson;

    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "è”ç³»ç”µè¯æ ¼å¼ä¸æ­£ç¡®")
    private String contactPhone;

    @Email(message = "è”ç³»é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 255, message = "è”ç³»é‚®ç®±æœ€å¤š255ä¸ªå­—ç¬¦")
    private String contactEmail;

    private String address;

    @Size(max = 50, message = "çœä»½æœ€å¤š50ä¸ªå­—ç¬¦")
    private String province;

    @Size(max = 50, message = "åŸå¸‚æœ€å¤š50ä¸ªå­—ç¬¦")
    private String city;

    @Size(max = 50, message = "åŒºå¿æœ€å¤š50ä¸ªå­—ç¬¦")
    private String district;

    private String logoUrl;

    private String website;

    @Size(max = 100, message = "è¡Œä¸šæœ€å¤š100ä¸ªå­—ç¬¦")
    private String industry;

    private OrganizationScale scale;

    private LocalDate establishedDate;

    /**
     * çˆ¶ç»„ç»‡IDï¼ˆåˆ›å»ºå­ç»„ç»‡æ—¶ä½¿ç”¨ï¼‰
     */
    private UUID parentId;
}
```

**UpdateOrganizationDTO**:

```java
package com.aibidcomposer.dto.organization;

import com.aibidcomposer.entity.OrganizationScale;
import com.aibidcomposer.entity.OrganizationStatus;
import com.aibidcomposer.entity.OrganizationType;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;
import lombok.Data;

import java.time.LocalDate;

/**
 * æ›´æ–°ç»„ç»‡DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Data
public class UpdateOrganizationDTO {

    @Size(max = 200, message = "ç»„ç»‡åç§°æœ€å¤š200ä¸ªå­—ç¬¦")
    private String name;

    @Size(max = 100, message = "ç»„ç»‡ç®€ç§°æœ€å¤š100ä¸ªå­—ç¬¦")
    private String shortName;

    private OrganizationType organizationType;

    @Pattern(regexp = "^[A-Z0-9]{18}$", message = "ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç æ ¼å¼ä¸æ­£ç¡®")
    private String taxId;

    @Size(max = 100, message = "æ³•å®šä»£è¡¨äººæœ€å¤š100ä¸ªå­—ç¬¦")
    private String legalPerson;

    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "è”ç³»ç”µè¯æ ¼å¼ä¸æ­£ç¡®")
    private String contactPhone;

    @Email(message = "è”ç³»é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 255, message = "è”ç³»é‚®ç®±æœ€å¤š255ä¸ªå­—ç¬¦")
    private String contactEmail;

    private String address;

    @Size(max = 50, message = "çœä»½æœ€å¤š50ä¸ªå­—ç¬¦")
    private String province;

    @Size(max = 50, message = "åŸå¸‚æœ€å¤š50ä¸ªå­—ç¬¦")
    private String city;

    @Size(max = 50, message = "åŒºå¿æœ€å¤š50ä¸ªå­—ç¬¦")
    private String district;

    private String logoUrl;

    private String website;

    @Size(max = 100, message = "è¡Œä¸šæœ€å¤š100ä¸ªå­—ç¬¦")
    private String industry;

    private OrganizationScale scale;

    private LocalDate establishedDate;

    private OrganizationStatus status;
}
```

**OrganizationResponseDTO**:

```java
package com.aibidcomposer.dto.organization;

import com.aibidcomposer.entity.Organization;
import com.aibidcomposer.entity.OrganizationScale;
import com.aibidcomposer.entity.OrganizationStatus;
import com.aibidcomposer.entity.OrganizationType;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * ç»„ç»‡å“åº”DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrganizationResponseDTO {

    private UUID id;
    private String name;
    private String shortName;
    private OrganizationType organizationType;
    private String taxId;
    private String legalPerson;
    private String contactPhone;
    private String contactEmail;
    private String address;
    private String province;
    private String city;
    private String district;
    private String logoUrl;
    private String website;
    private String industry;
    private OrganizationScale scale;
    private LocalDate establishedDate;
    private OrganizationStatus status;

    /**
     * çˆ¶ç»„ç»‡ä¿¡æ¯ï¼ˆç®€åŒ–ï¼‰
     */
    private OrganizationSimpleDTO parent;

    /**
     * å­ç»„ç»‡åˆ—è¡¨ï¼ˆç®€åŒ–ï¼‰
     */
    private List<OrganizationSimpleDTO> children;

    /**
     * ç»„ç»‡å±‚çº§æ·±åº¦
     */
    private Integer depth;

    /**
     * æˆå‘˜æ•°é‡
     */
    private Integer memberCount;

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    /**
     * ä»å®ä½“è½¬æ¢ä¸ºDTO
     */
    public static OrganizationResponseDTO fromEntity(Organization org) {
        if (org == null) return null;

        return OrganizationResponseDTO.builder()
            .id(org.getId())
            .name(org.getName())
            .shortName(org.getShortName())
            .organizationType(org.getOrganizationType())
            .taxId(org.getTaxId())
            .legalPerson(org.getLegalPerson())
            .contactPhone(org.getContactPhone())
            .contactEmail(org.getContactEmail())
            .address(org.getAddress())
            .province(org.getProvince())
            .city(org.getCity())
            .district(org.getDistrict())
            .logoUrl(org.getLogoUrl())
            .website(org.getWebsite())
            .industry(org.getIndustry())
            .scale(org.getScale())
            .establishedDate(org.getEstablishedDate())
            .status(org.getStatus())
            .parent(org.getParent() != null ? OrganizationSimpleDTO.fromEntity(org.getParent()) : null)
            .children(org.getChildren().stream()
                .map(OrganizationSimpleDTO::fromEntity)
                .collect(Collectors.toList()))
            .depth(org.getDepth())
            .memberCount(org.getMembers().size())
            .createdAt(org.getCreatedAt())
            .updatedAt(org.getUpdatedAt())
            .build();
    }
}
```

**OrganizationSimpleDTO**:

```java
package com.aibidcomposer.dto.organization;

import com.aibidcomposer.entity.Organization;
import com.aibidcomposer.entity.OrganizationStatus;
import com.aibidcomposer.entity.OrganizationType;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.UUID;

/**
 * ç»„ç»‡ç®€åŒ–DTOï¼ˆç”¨äºåˆ—è¡¨å’Œå…³è”å±•ç¤ºï¼‰
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrganizationSimpleDTO {

    private UUID id;
    private String name;
    private String shortName;
    private OrganizationType organizationType;
    private OrganizationStatus status;
    private String logoUrl;

    public static OrganizationSimpleDTO fromEntity(Organization org) {
        if (org == null) return null;

        return OrganizationSimpleDTO.builder()
            .id(org.getId())
            .name(org.getName())
            .shortName(org.getShortName())
            .organizationType(org.getOrganizationType())
            .status(org.getStatus())
            .logoUrl(org.getLogoUrl())
            .build();
    }
}
```

**AddMemberDTO**:

```java
package com.aibidcomposer.dto.organization;

import com.aibidcomposer.entity.OrganizationRole;
import jakarta.validation.constraints.NotNull;
import lombok.Data;

import java.util.UUID;

/**
 * æ·»åŠ ç»„ç»‡æˆå‘˜DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Data
public class AddMemberDTO {

    @NotNull(message = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
    private UUID userId;

    @NotNull(message = "è§’è‰²ä¸èƒ½ä¸ºç©º")
    private OrganizationRole role;
}
```

**OrganizationMemberResponseDTO**:

```java
package com.aibidcomposer.dto.organization;

import com.aibidcomposer.entity.OrganizationMember;
import com.aibidcomposer.entity.OrganizationRole;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * ç»„ç»‡æˆå‘˜å“åº”DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class OrganizationMemberResponseDTO {

    private UUID id;
    private UUID userId;
    private String username;
    private String fullName;
    private String email;
    private String avatarUrl;
    private OrganizationRole role;
    private LocalDateTime joinedAt;

    public static OrganizationMemberResponseDTO fromEntity(OrganizationMember member) {
        if (member == null) return null;

        return OrganizationMemberResponseDTO.builder()
            .id(member.getId())
            .userId(member.getUserId())
            .role(member.getRole())
            .joinedAt(member.getJoinedAt())
            // æ³¨æ„ï¼šç”¨æˆ·è¯¦ç»†ä¿¡æ¯éœ€è¦ä» User æœåŠ¡è·å–
            .build();
    }
}
```

#### 2.1.2: å‰ç«¯

**éªŒè¯æ¸…å•**:
- [ ] TypeScript ç±»å‹å®šä¹‰å®Œæˆ
- [ ] ç»„ç»‡åˆ—è¡¨é¡µé¢ï¼ˆProTableï¼‰å®Œæˆ
- [ ] ç»„ç»‡åˆ›å»º/ç¼–è¾‘è¡¨å•ï¼ˆProFormï¼‰å®Œæˆ
- [ ] ç»„ç»‡è¯¦æƒ…é¡µé¢å®Œæˆ
- [ ] ç»„ç»‡æˆå‘˜ç®¡ç†ç•Œé¢å®Œæˆ
- [ ] API æœåŠ¡å±‚å®Œæˆ
- [ ] å‰ç«¯è·¯ç”±é…ç½®å®Œæˆ

**TypeScript ç±»å‹å®šä¹‰** (`types/organization.ts`):

```typescript
// apps/frontend/src/types/organization.ts
/**
 * ç»„ç»‡ç±»å‹å®šä¹‰
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */

export enum OrganizationType {
  COMPANY = 'COMPANY',
  GOVERNMENT = 'GOVERNMENT',
  INSTITUTION = 'INSTITUTION',
  INDIVIDUAL = 'INDIVIDUAL',
}

export enum OrganizationScale {
  SMALL = 'SMALL',
  MEDIUM = 'MEDIUM',
  LARGE = 'LARGE',
  XLARGE = 'XLARGE',
}

export enum OrganizationStatus {
  ACTIVE = 'ACTIVE',
  INACTIVE = 'INACTIVE',
  SUSPENDED = 'SUSPENDED',
}

export enum OrganizationRole {
  OWNER = 'OWNER',
  ADMIN = 'ADMIN',
  MEMBER = 'MEMBER',
  GUEST = 'GUEST',
}

export interface OrganizationSimple {
  id: string;
  name: string;
  shortName?: string;
  organizationType?: OrganizationType;
  status: OrganizationStatus;
  logoUrl?: string;
}

export interface Organization extends OrganizationSimple {
  taxId?: string;
  legalPerson?: string;
  contactPhone?: string;
  contactEmail?: string;
  address?: string;
  province?: string;
  city?: string;
  district?: string;
  website?: string;
  industry?: string;
  scale?: OrganizationScale;
  establishedDate?: string;
  parent?: OrganizationSimple;
  children?: OrganizationSimple[];
  depth?: number;
  memberCount?: number;
  createdAt: string;
  updatedAt: string;
}

export interface CreateOrganizationRequest {
  name: string;
  shortName?: string;
  organizationType?: OrganizationType;
  taxId?: string;
  legalPerson?: string;
  contactPhone?: string;
  contactEmail?: string;
  address?: string;
  province?: string;
  city?: string;
  district?: string;
  logoUrl?: string;
  website?: string;
  industry?: string;
  scale?: OrganizationScale;
  establishedDate?: string;
  parentId?: string;
}

export interface UpdateOrganizationRequest {
  name?: string;
  shortName?: string;
  organizationType?: OrganizationType;
  taxId?: string;
  legalPerson?: string;
  contactPhone?: string;
  contactEmail?: string;
  address?: string;
  province?: string;
  city?: string;
  district?: string;
  logoUrl?: string;
  website?: string;
  industry?: string;
  scale?: OrganizationScale;
  establishedDate?: string;
  status?: OrganizationStatus;
}

export interface OrganizationMember {
  id: string;
  userId: string;
  username?: string;
  fullName?: string;
  email?: string;
  avatarUrl?: string;
  role: OrganizationRole;
  joinedAt: string;
}

export interface AddMemberRequest {
  userId: string;
  role: OrganizationRole;
}
```

**API æœåŠ¡å±‚** (`services/organization.service.ts`):

```typescript
// apps/frontend/src/services/organization.service.ts
/**
 * ç»„ç»‡ç®¡ç†APIæœåŠ¡
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */

import { request } from '@umijs/max';
import type {
  Organization,
  CreateOrganizationRequest,
  UpdateOrganizationRequest,
  OrganizationMember,
  AddMemberRequest,
} from '@/types/organization';

const API_BASE = '/api/v1/organizations';

export const organizationService = {
  /**
   * è·å–ç»„ç»‡åˆ—è¡¨
   */
  async getList(params: {
    page?: number;
    pageSize?: number;
    search?: string;
    status?: string;
  }) {
    return request<{
      success: boolean;
      data: {
        items: Organization[];
        total: number;
        page: number;
        pageSize: number;
        totalPages: number;
      };
    }>(`${API_BASE}`, {
      method: 'GET',
      params,
    });
  },

  /**
   * è·å–ç»„ç»‡è¯¦æƒ…
   */
  async getById(id: string) {
    return request<{
      success: boolean;
      data: Organization;
    }>(`${API_BASE}/${id}`, {
      method: 'GET',
    });
  },

  /**
   * åˆ›å»ºç»„ç»‡
   */
  async create(data: CreateOrganizationRequest) {
    return request<{
      success: boolean;
      data: Organization;
      message: string;
    }>(`${API_BASE}`, {
      method: 'POST',
      data,
    });
  },

  /**
   * æ›´æ–°ç»„ç»‡
   */
  async update(id: string, data: UpdateOrganizationRequest) {
    return request<{
      success: boolean;
      data: Organization;
      message: string;
    }>(`${API_BASE}/${id}`, {
      method: 'PUT',
      data,
    });
  },

  /**
   * åˆ é™¤ç»„ç»‡
   */
  async delete(id: string) {
    return request<{
      success: boolean;
      message: string;
    }>(`${API_BASE}/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * è·å–ç»„ç»‡æˆå‘˜åˆ—è¡¨
   */
  async getMembers(organizationId: string) {
    return request<{
      success: boolean;
      data: OrganizationMember[];
    }>(`${API_BASE}/${organizationId}/members`, {
      method: 'GET',
    });
  },

  /**
   * æ·»åŠ ç»„ç»‡æˆå‘˜
   */
  async addMember(organizationId: string, data: AddMemberRequest) {
    return request<{
      success: boolean;
      data: OrganizationMember;
      message: string;
    }>(`${API_BASE}/${organizationId}/members`, {
      method: 'POST',
      data,
    });
  },

  /**
   * ç§»é™¤ç»„ç»‡æˆå‘˜
   */
  async removeMember(organizationId: string, memberId: string) {
    return request<{
      success: boolean;
      message: string;
    }>(`${API_BASE}/${organizationId}/members/${memberId}`, {
      method: 'DELETE',
    });
  },

  /**
   * æ›´æ–°æˆå‘˜è§’è‰²
   */
  async updateMemberRole(
    organizationId: string,
    memberId: string,
    role: string
  ) {
    return request<{
      success: boolean;
      data: OrganizationMember;
      message: string;
    }>(`${API_BASE}/${organizationId}/members/${memberId}/role`, {
      method: 'PUT',
      data: { role },
    });
  },
};
```

**ç»„ç»‡åˆ—è¡¨é¡µé¢** (`pages/Organization/List.tsx`):

```typescript
// apps/frontend/src/pages/Organization/List.tsx
/**
 * ç»„ç»‡åˆ—è¡¨é¡µé¢
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */

import { PlusOutlined } from '@ant-design/icons';
import { ProTable } from '@ant-design/pro-components';
import { Button, message, Tag } from 'antd';
import { useNavigate } from '@umijs/max';
import { organizationService } from '@/services/organization.service';
import type { Organization, OrganizationStatus } from '@/types/organization';

const statusColorMap: Record<OrganizationStatus, string> = {
  ACTIVE: 'green',
  INACTIVE: 'gray',
  SUSPENDED: 'red',
};

const statusTextMap: Record<OrganizationStatus, string> = {
  ACTIVE: 'æ´»è·ƒ',
  INACTIVE: 'æœªæ¿€æ´»',
  SUSPENDED: 'å·²æš‚åœ',
};

const OrganizationListPage: React.FC = () => {
  const navigate = useNavigate();

  const columns = [
    {
      title: 'ç»„ç»‡åç§°',
      dataIndex: 'name',
      key: 'name',
      render: (_: any, record: Organization) => (
        <a onClick={() => navigate(`/organizations/${record.id}`)}>
          {record.name}
        </a>
      ),
    },
    {
      title: 'ç»„ç»‡ç®€ç§°',
      dataIndex: 'shortName',
      key: 'shortName',
      hideInSearch: true,
    },
    {
      title: 'ç»„ç»‡ç±»å‹',
      dataIndex: 'organizationType',
      key: 'organizationType',
      valueEnum: {
        COMPANY: { text: 'å…¬å¸' },
        GOVERNMENT: { text: 'æ”¿åºœæœºæ„' },
        INSTITUTION: { text: 'äº‹ä¸šå•ä½' },
        INDIVIDUAL: { text: 'ä¸ªäºº' },
      },
    },
    {
      title: 'æˆå‘˜æ•°é‡',
      dataIndex: 'memberCount',
      key: 'memberCount',
      hideInSearch: true,
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      render: (status: OrganizationStatus) => (
        <Tag color={statusColorMap[status]}>
          {statusTextMap[status]}
        </Tag>
      ),
      valueEnum: {
        ACTIVE: { text: 'æ´»è·ƒ', status: 'Success' },
        INACTIVE: { text: 'æœªæ¿€æ´»', status: 'Default' },
        SUSPENDED: { text: 'å·²æš‚åœ', status: 'Error' },
      },
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createdAt',
      key: 'createdAt',
      valueType: 'dateTime',
      hideInSearch: true,
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      valueType: 'option',
      render: (_: any, record: Organization) => [
        <a key="view" onClick={() => navigate(`/organizations/${record.id}`)}>
          æŸ¥çœ‹
        </a>,
        <a
          key="edit"
          onClick={() => navigate(`/organizations/${record.id}/edit`)}
        >
          ç¼–è¾‘
        </a>,
        <a
          key="delete"
          onClick={async () => {
            try {
              await organizationService.delete(record.id);
              message.success('åˆ é™¤æˆåŠŸ');
              // åˆ·æ–°åˆ—è¡¨
            } catch (error) {
              message.error('åˆ é™¤å¤±è´¥');
            }
          }}
        >
          åˆ é™¤
        </a>,
      ],
    },
  ];

  return (
    <ProTable<Organization>
      headerTitle="ç»„ç»‡åˆ—è¡¨"
      rowKey="id"
      request={async (params) => {
        const response = await organizationService.getList({
          page: params.current,
          pageSize: params.pageSize,
          search: params.name,
          status: params.status,
        });

        return {
          data: response.data.items,
          success: response.success,
          total: response.data.total,
        };
      }}
      columns={columns}
      toolBarRender={() => [
        <Button
          key="create"
          type="primary"
          icon={<PlusOutlined />}
          onClick={() => navigate('/organizations/create')}
        >
          æ–°å»ºç»„ç»‡
        </Button>,
      ]}
      search={{
        labelWidth: 'auto',
      }}
      pagination={{
        pageSize: 20,
        showSizeChanger: true,
      }}
    />
  );
};

export default OrganizationListPage;
```

**ç»„ç»‡è¡¨å•é¡µé¢** (`pages/Organization/Form.tsx`):

```typescript
// apps/frontend/src/pages/Organization/Form.tsx
/**
 * ç»„ç»‡åˆ›å»º/ç¼–è¾‘è¡¨å•
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */

import { ProForm, ProFormText, ProFormSelect, ProFormDatePicker } from '@ant-design/pro-components';
import { Card, message } from 'antd';
import { useNavigate, useParams } from '@umijs/max';
import { useEffect } from 'react';
import { organizationService } from '@/services/organization.service';
import type { Organization } from '@/types/organization';

const OrganizationFormPage: React.FC = () => {
  const navigate = useNavigate();
  const { id } = useParams<{ id: string }>();
  const isEdit = !!id;

  const [form] = ProForm.useForm();

  useEffect(() => {
    if (isEdit && id) {
      organizationService.getById(id).then((res) => {
        if (res.success) {
          form.setFieldsValue(res.data);
        }
      });
    }
  }, [id, isEdit, form]);

  const handleSubmit = async (values: Organization) => {
    try {
      if (isEdit && id) {
        await organizationService.update(id, values);
        message.success('æ›´æ–°æˆåŠŸ');
      } else {
        await organizationService.create(values);
        message.success('åˆ›å»ºæˆåŠŸ');
      }
      navigate('/organizations');
    } catch (error) {
      message.error(isEdit ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥');
    }
  };

  return (
    <Card title={isEdit ? 'ç¼–è¾‘ç»„ç»‡' : 'æ–°å»ºç»„ç»‡'}>
      <ProForm
        form={form}
        onFinish={handleSubmit}
        submitter={{
          searchConfig: {
            resetText: 'å–æ¶ˆ',
            submitText: isEdit ? 'æ›´æ–°' : 'åˆ›å»º',
          },
          resetButtonProps: {
            onClick: () => navigate('/organizations'),
          },
        }}
      >
        <ProFormText
          name="name"
          label="ç»„ç»‡åç§°"
          placeholder="è¯·è¾“å…¥ç»„ç»‡åç§°"
          rules={[
            { required: true, message: 'è¯·è¾“å…¥ç»„ç»‡åç§°' },
            { max: 200, message: 'ç»„ç»‡åç§°æœ€å¤š200ä¸ªå­—ç¬¦' },
          ]}
        />

        <ProFormText
          name="shortName"
          label="ç»„ç»‡ç®€ç§°"
          placeholder="è¯·è¾“å…¥ç»„ç»‡ç®€ç§°"
          rules={[{ max: 100, message: 'ç»„ç»‡ç®€ç§°æœ€å¤š100ä¸ªå­—ç¬¦' }]}
        />

        <ProFormSelect
          name="organizationType"
          label="ç»„ç»‡ç±»å‹"
          valueEnum={{
            COMPANY: 'å…¬å¸',
            GOVERNMENT: 'æ”¿åºœæœºæ„',
            INSTITUTION: 'äº‹ä¸šå•ä½',
            INDIVIDUAL: 'ä¸ªäºº',
          }}
          placeholder="è¯·é€‰æ‹©ç»„ç»‡ç±»å‹"
        />

        <ProFormText
          name="taxId"
          label="ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç "
          placeholder="è¯·è¾“å…¥18ä½ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç "
          rules={[
            {
              pattern: /^[A-Z0-9]{18}$/,
              message: 'è¯·è¾“å…¥18ä½ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ',
            },
          ]}
        />

        <ProFormText
          name="legalPerson"
          label="æ³•å®šä»£è¡¨äºº"
          placeholder="è¯·è¾“å…¥æ³•å®šä»£è¡¨äºº"
          rules={[{ max: 100, message: 'æ³•å®šä»£è¡¨äººæœ€å¤š100ä¸ªå­—ç¬¦' }]}
        />

        <ProFormText
          name="contactPhone"
          label="è”ç³»ç”µè¯"
          placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
          rules={[
            {
              pattern: /^1[3-9]\d{9}$/,
              message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ',
            },
          ]}
        />

        <ProFormText
          name="contactEmail"
          label="è”ç³»é‚®ç®±"
          placeholder="è¯·è¾“å…¥è”ç³»é‚®ç®±"
          rules={[{ type: 'email', message: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€' }]}
        />

        <ProFormText
          name="province"
          label="çœä»½"
          placeholder="è¯·è¾“å…¥çœä»½"
        />

        <ProFormText
          name="city"
          label="åŸå¸‚"
          placeholder="è¯·è¾“å…¥åŸå¸‚"
        />

        <ProFormText
          name="district"
          label="åŒºå¿"
          placeholder="è¯·è¾“å…¥åŒºå¿"
        />

        <ProFormText
          name="address"
          label="è¯¦ç»†åœ°å€"
          placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€"
        />

        <ProFormText
          name="website"
          label="å®˜æ–¹ç½‘ç«™"
          placeholder="è¯·è¾“å…¥å®˜æ–¹ç½‘ç«™"
        />

        <ProFormText
          name="industry"
          label="æ‰€å±è¡Œä¸š"
          placeholder="è¯·è¾“å…¥æ‰€å±è¡Œä¸š"
          rules={[{ max: 100, message: 'æ‰€å±è¡Œä¸šæœ€å¤š100ä¸ªå­—ç¬¦' }]}
        />

        <ProFormSelect
          name="scale"
          label="ä¼ä¸šè§„æ¨¡"
          valueEnum={{
            SMALL: 'å°å‹ï¼ˆ<100äººï¼‰',
            MEDIUM: 'ä¸­å‹ï¼ˆ100-500äººï¼‰',
            LARGE: 'å¤§å‹ï¼ˆ500-5000äººï¼‰',
            XLARGE: 'è¶…å¤§å‹ï¼ˆ>5000äººï¼‰',
          }}
          placeholder="è¯·é€‰æ‹©ä¼ä¸šè§„æ¨¡"
        />

        <ProFormDatePicker
          name="establishedDate"
          label="æˆç«‹æ—¥æœŸ"
          placeholder="è¯·é€‰æ‹©æˆç«‹æ—¥æœŸ"
        />

        {isEdit && (
          <ProFormSelect
            name="status"
            label="çŠ¶æ€"
            valueEnum={{
              ACTIVE: 'æ´»è·ƒ',
              INACTIVE: 'æœªæ¿€æ´»',
              SUSPENDED: 'å·²æš‚åœ',
            }}
            placeholder="è¯·é€‰æ‹©çŠ¶æ€"
          />
        )}
      </ProForm>
    </Card>
  );
};

export default OrganizationFormPage;
```

**ç»„ç»‡è¯¦æƒ…é¡µé¢** (`pages/Organization/Detail.tsx`):

```typescript
// apps/frontend/src/pages/Organization/Detail.tsx
/**
 * ç»„ç»‡è¯¦æƒ…é¡µé¢
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */

import { ProDescriptions } from '@ant-design/pro-components';
import { Card, Button, Tabs, message } from 'antd';
import { useNavigate, useParams } from '@umijs/max';
import { useEffect, useState } from 'react';
import { organizationService } from '@/services/organization.service';
import type { Organization } from '@/types/organization';
import OrganizationMemberList from './components/MemberList';

const OrganizationDetailPage: React.FC = () => {
  const navigate = useNavigate();
  const { id } = useParams<{ id: string }>();
  const [organization, setOrganization] = useState<Organization | null>(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (id) {
      loadOrganization();
    }
  }, [id]);

  const loadOrganization = async () => {
    if (!id) return;

    setLoading(true);
    try {
      const res = await organizationService.getById(id);
      if (res.success) {
        setOrganization(res.data);
      }
    } catch (error) {
      message.error('åŠ è½½å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  if (!organization) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  return (
    <Card
      title={organization.name}
      extra={
        <Button type="primary" onClick={() => navigate(`/organizations/${id}/edit`)}>
          ç¼–è¾‘
        </Button>
      }
      loading={loading}
    >
      <Tabs
        items={[
          {
            key: 'info',
            label: 'åŸºæœ¬ä¿¡æ¯',
            children: (
              <ProDescriptions
                column={2}
                dataSource={organization}
                columns={[
                  { title: 'ç»„ç»‡åç§°', dataIndex: 'name' },
                  { title: 'ç»„ç»‡ç®€ç§°', dataIndex: 'shortName' },
                  { title: 'ç»„ç»‡ç±»å‹', dataIndex: 'organizationType' },
                  { title: 'ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ', dataIndex: 'taxId' },
                  { title: 'æ³•å®šä»£è¡¨äºº', dataIndex: 'legalPerson' },
                  { title: 'è”ç³»ç”µè¯', dataIndex: 'contactPhone' },
                  { title: 'è”ç³»é‚®ç®±', dataIndex: 'contactEmail' },
                  { title: 'çœä»½', dataIndex: 'province' },
                  { title: 'åŸå¸‚', dataIndex: 'city' },
                  { title: 'åŒºå¿', dataIndex: 'district' },
                  { title: 'è¯¦ç»†åœ°å€', dataIndex: 'address', span: 2 },
                  { title: 'å®˜æ–¹ç½‘ç«™', dataIndex: 'website' },
                  { title: 'æ‰€å±è¡Œä¸š', dataIndex: 'industry' },
                  { title: 'ä¼ä¸šè§„æ¨¡', dataIndex: 'scale' },
                  { title: 'æˆç«‹æ—¥æœŸ', dataIndex: 'establishedDate', valueType: 'date' },
                  { title: 'çŠ¶æ€', dataIndex: 'status' },
                  { title: 'æˆå‘˜æ•°é‡', dataIndex: 'memberCount' },
                  { title: 'åˆ›å»ºæ—¶é—´', dataIndex: 'createdAt', valueType: 'dateTime' },
                  { title: 'æ›´æ–°æ—¶é—´', dataIndex: 'updatedAt', valueType: 'dateTime' },
                ]}
              />
            ),
          },
          {
            key: 'members',
            label: 'æˆå‘˜ç®¡ç†',
            children: <OrganizationMemberList organizationId={id!} />,
          },
        ]}
      />
    </Card>
  );
};

export default OrganizationDetailPage;
```

**ç»„ç»‡æˆå‘˜ç®¡ç†ç»„ä»¶** (`pages/Organization/components/MemberList.tsx`):

```typescript
// apps/frontend/src/pages/Organization/components/MemberList.tsx
/**
 * ç»„ç»‡æˆå‘˜ç®¡ç†ç»„ä»¶
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */

import { ProTable } from '@ant-design/pro-components';
import { Button, message, Modal, Form, Select } from 'antd';
import { PlusOutlined } from '@ant-design/icons';
import { useState } from 'react';
import { organizationService } from '@/services/organization.service';
import type { OrganizationMember, OrganizationRole } from '@/types/organization';

interface MemberListProps {
  organizationId: string;
}

const OrganizationMemberList: React.FC<MemberListProps> = ({ organizationId }) => {
  const [addModalVisible, setAddModalVisible] = useState(false);
  const [form] = Form.useForm();

  const columns = [
    {
      title: 'ç”¨æˆ·å',
      dataIndex: 'username',
      key: 'username',
    },
    {
      title: 'å§“å',
      dataIndex: 'fullName',
      key: 'fullName',
    },
    {
      title: 'é‚®ç®±',
      dataIndex: 'email',
      key: 'email',
    },
    {
      title: 'è§’è‰²',
      dataIndex: 'role',
      key: 'role',
      valueEnum: {
        OWNER: { text: 'æ‰€æœ‰è€…', status: 'Success' },
        ADMIN: { text: 'ç®¡ç†å‘˜', status: 'Processing' },
        MEMBER: { text: 'æ™®é€šæˆå‘˜', status: 'Default' },
        GUEST: { text: 'è®¿å®¢', status: 'Default' },
      },
    },
    {
      title: 'åŠ å…¥æ—¶é—´',
      dataIndex: 'joinedAt',
      key: 'joinedAt',
      valueType: 'dateTime',
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      valueType: 'option',
      render: (_: any, record: OrganizationMember) => [
        <a
          key="remove"
          onClick={async () => {
            try {
              await organizationService.removeMember(organizationId, record.id);
              message.success('ç§»é™¤æˆåŠŸ');
              // åˆ·æ–°åˆ—è¡¨
            } catch (error) {
              message.error('ç§»é™¤å¤±è´¥');
            }
          }}
        >
          ç§»é™¤
        </a>,
      ],
    },
  ];

  const handleAddMember = async (values: { userId: string; role: OrganizationRole }) => {
    try {
      await organizationService.addMember(organizationId, values);
      message.success('æ·»åŠ æˆåŠŸ');
      setAddModalVisible(false);
      form.resetFields();
      // åˆ·æ–°åˆ—è¡¨
    } catch (error) {
      message.error('æ·»åŠ å¤±è´¥');
    }
  };

  return (
    <>
      <ProTable<OrganizationMember>
        headerTitle="æˆå‘˜åˆ—è¡¨"
        rowKey="id"
        request={async () => {
          const response = await organizationService.getMembers(organizationId);
          return {
            data: response.data,
            success: response.success,
          };
        }}
        columns={columns}
        toolBarRender={() => [
          <Button
            key="add"
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => setAddModalVisible(true)}
          >
            æ·»åŠ æˆå‘˜
          </Button>,
        ]}
        search={false}
      />

      <Modal
        title="æ·»åŠ æˆå‘˜"
        open={addModalVisible}
        onOk={() => form.submit()}
        onCancel={() => {
          setAddModalVisible(false);
          form.resetFields();
        }}
      >
        <Form form={form} onFinish={handleAddMember} layout="vertical">
          <Form.Item
            name="userId"
            label="ç”¨æˆ·"
            rules={[{ required: true, message: 'è¯·é€‰æ‹©ç”¨æˆ·' }]}
          >
            <Select placeholder="è¯·é€‰æ‹©ç”¨æˆ·">
              {/* TODO: ä»ç”¨æˆ·APIè·å–ç”¨æˆ·åˆ—è¡¨ */}
            </Select>
          </Form.Item>

          <Form.Item
            name="role"
            label="è§’è‰²"
            initialValue="MEMBER"
            rules={[{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }]}
          >
            <Select>
              <Select.Option value="OWNER">æ‰€æœ‰è€…</Select.Option>
              <Select.Option value="ADMIN">ç®¡ç†å‘˜</Select.Option>
              <Select.Option value="MEMBER">æ™®é€šæˆå‘˜</Select.Option>
              <Select.Option value="GUEST">è®¿å®¢</Select.Option>
            </Select>
          </Form.Item>
        </Form>
      </Modal>
    </>
  );
};

export default OrganizationMemberList;
```

**å‰ç«¯è·¯ç”±é…ç½®** (`config/routes.ts`):

```typescript
// apps/frontend/config/routes.ts
// ç»„ç»‡ç®¡ç†è·¯ç”±é…ç½®
{
  path: '/organizations',
  name: 'ç»„ç»‡ç®¡ç†',
  icon: 'TeamOutlined',
  routes: [
    {
      path: '/organizations',
      name: 'ç»„ç»‡åˆ—è¡¨',
      component: './Organization/List',
    },
    {
      path: '/organizations/create',
      name: 'æ–°å»ºç»„ç»‡',
      component: './Organization/Form',
      hideInMenu: true,
    },
    {
      path: '/organizations/:id',
      name: 'ç»„ç»‡è¯¦æƒ…',
      component: './Organization/Detail',
      hideInMenu: true,
    },
    {
      path: '/organizations/:id/edit',
      name: 'ç¼–è¾‘ç»„ç»‡',
      component: './Organization/Form',
      hideInMenu: true,
    },
  ],
},
```



---
**ğŸ“– ç»§ç»­**: [Part2 - Javaåç«¯å®ç°](./task-plan-java-è¯¦ç»†-JAVA-002-Part2.md)


# Java Spring Boot - JAVA-002 Part2 (ç»„ç»‡ç®¡ç†: Javaåç«¯)

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-002 (2.1.3)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-27
**åˆ›å»ºè€…**: claude-sonnet-4-5
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 15:10 | 3.0 | claude-sonnet-4-5 | å°†è¶…é•¿JAVA-002æ–‡æ¡£(10051è¡Œ)æ‹†åˆ†æˆ5ä¸ªå­æ–‡æ¡£ |
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º JAVA-002 æ¨¡å— |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [JAVA-002-INDEX.md](./task-plan-java-è¯¦ç»†-JAVA-002-INDEX.md)
**å…¶ä»–éƒ¨åˆ†**: [Part1](./task-plan-java-è¯¦ç»†-JAVA-002-Part1.md) | [Part3](./task-plan-java-è¯¦ç»†-JAVA-002-Part3.md) | [Part4](./task-plan-java-è¯¦ç»†-JAVA-002-Part4.md) | [Part5](./task-plan-java-è¯¦ç»†-JAVA-002-Part5.md)

---


### 2.1.3: Javaåç«¯

**éªŒè¯æ¸…å•**:
- [ ] OrganizationRepository æ¥å£è®¾è®¡å®Œæˆ
- [ ] OrganizationMemberRepository æ¥å£è®¾è®¡å®Œæˆ
- [ ] OrganizationService ä¸šåŠ¡é€»è¾‘å®ç°å®Œæˆ
- [ ] OrganizationController REST API å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] APIæ–‡æ¡£ç”Ÿæˆï¼ˆSwagger/OpenAPIï¼‰

#### Repositoryå±‚

**OrganizationRepository** (`com.aibidcomposer.repository.OrganizationRepository`):

```java
package com.aibidcomposer.repository;

import com.aibidcomposer.entity.Organization;
import com.aibidcomposer.entity.OrganizationStatus;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

/**
 * ç»„ç»‡æ•°æ®è®¿é—®æ¥å£
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Repository
public interface OrganizationRepository extends JpaRepository<Organization, UUID> {

    /**
     * æ ¹æ®åç§°æŸ¥æ‰¾ç»„ç»‡ï¼ˆæ”¯æŒæ¨¡ç³Šæœç´¢ï¼‰
     */
    @Query("SELECT o FROM Organization o WHERE " +
           "LOWER(o.name) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
           "LOWER(o.shortName) LIKE LOWER(CONCAT('%', :search, '%'))")
    Page<Organization> searchByName(@Param("search") String search, Pageable pageable);

    /**
     * æ ¹æ®çŠ¶æ€æŸ¥æ‰¾ç»„ç»‡
     */
    Page<Organization> findByStatus(OrganizationStatus status, Pageable pageable);

    /**
     * æ ¹æ®ç»„ç»‡ç±»å‹æŸ¥æ‰¾
     */
    @Query("SELECT o FROM Organization o WHERE o.organizationType = :type")
    Page<Organization> findByType(@Param("type") String type, Pageable pageable);

    /**
     * æ ¹æ®çˆ¶ç»„ç»‡IDæŸ¥æ‰¾å­ç»„ç»‡
     */
    @Query("SELECT o FROM Organization o WHERE o.parent.id = :parentId")
    List<Organization> findByParentId(@Param("parentId") UUID parentId);

    /**
     * æŸ¥æ‰¾æ ¹ç»„ç»‡ï¼ˆæ²¡æœ‰çˆ¶ç»„ç»‡çš„ç»„ç»‡ï¼‰
     */
    @Query("SELECT o FROM Organization o WHERE o.parent IS NULL")
    Page<Organization> findRootOrganizations(Pageable pageable);

    /**
     * æ ¹æ®ç¨å·æŸ¥æ‰¾ç»„ç»‡
     */
    Optional<Organization> findByTaxId(String taxId);

    /**
     * æ£€æŸ¥ç»„ç»‡åç§°æ˜¯å¦å­˜åœ¨
     */
    boolean existsByName(String name);

    /**
     * æ£€æŸ¥ç¨å·æ˜¯å¦å­˜åœ¨
     */
    boolean existsByTaxId(String taxId);

    /**
     * ç»Ÿè®¡ç»„ç»‡æ•°é‡ï¼ˆæŒ‰çŠ¶æ€ï¼‰
     */
    @Query("SELECT COUNT(o) FROM Organization o WHERE o.status = :status")
    long countByStatus(@Param("status") OrganizationStatus status);

    /**
     * è·å–ç»„ç»‡åŠå…¶æ‰€æœ‰å­ç»„ç»‡
     * ä½¿ç”¨é€’å½’æŸ¥è¯¢ï¼ˆPostgreSQLæ”¯æŒï¼‰
     */
    @Query(value = """
        WITH RECURSIVE org_tree AS (
            SELECT id, name, parent_id, 0 as depth
            FROM organizations
            WHERE id = :organizationId AND deleted_at IS NULL

            UNION ALL

            SELECT o.id, o.name, o.parent_id, ot.depth + 1
            FROM organizations o
            INNER JOIN org_tree ot ON o.parent_id = ot.id
            WHERE o.deleted_at IS NULL
        )
        SELECT * FROM org_tree
        """, nativeQuery = true)
    List<Object[]> findOrganizationTreeById(@Param("organizationId") UUID organizationId);

    /**
     * è·å–ç»„ç»‡çš„ç¥–å…ˆé“¾
     */
    @Query(value = """
        WITH RECURSIVE ancestors AS (
            SELECT id, name, parent_id, 0 as depth
            FROM organizations
            WHERE id = :organizationId AND deleted_at IS NULL

            UNION ALL

            SELECT o.id, o.name, o.parent_id, a.depth + 1
            FROM organizations o
            INNER JOIN ancestors a ON o.id = a.parent_id
            WHERE o.deleted_at IS NULL
        )
        SELECT * FROM ancestors ORDER BY depth DESC
        """, nativeQuery = true)
    List<Object[]> findAncestorsById(@Param("organizationId") UUID organizationId);
}
```

**OrganizationMemberRepository** (`com.aibidcomposer.repository.OrganizationMemberRepository`):

```java
package com.aibidcomposer.repository;

import com.aibidcomposer.entity.OrganizationMember;
import com.aibidcomposer.entity.OrganizationRole;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

/**
 * ç»„ç»‡æˆå‘˜æ•°æ®è®¿é—®æ¥å£
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@Repository
public interface OrganizationMemberRepository extends JpaRepository<OrganizationMember, UUID> {

    /**
     * æ ¹æ®ç»„ç»‡IDæŸ¥æ‰¾æˆå‘˜
     */
    @Query("SELECT m FROM OrganizationMember m WHERE m.organization.id = :organizationId")
    Page<OrganizationMember> findByOrganizationId(
            @Param("organizationId") UUID organizationId,
            Pageable pageable
    );

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥æ‰¾å…¶æ‰€å±çš„æ‰€æœ‰ç»„ç»‡
     */
    @Query("SELECT m FROM OrganizationMember m WHERE m.userId = :userId")
    List<OrganizationMember> findByUserId(@Param("userId") UUID userId);

    /**
     * æŸ¥æ‰¾ç”¨æˆ·åœ¨ç‰¹å®šç»„ç»‡ä¸­çš„æˆå‘˜å…³ç³»
     */
    @Query("SELECT m FROM OrganizationMember m WHERE " +
           "m.organization.id = :organizationId AND m.userId = :userId")
    Optional<OrganizationMember> findByOrganizationIdAndUserId(
            @Param("organizationId") UUID organizationId,
            @Param("userId") UUID userId
    );

    /**
     * æ ¹æ®è§’è‰²æŸ¥æ‰¾ç»„ç»‡æˆå‘˜
     */
    @Query("SELECT m FROM OrganizationMember m WHERE " +
           "m.organization.id = :organizationId AND m.role = :role")
    List<OrganizationMember> findByOrganizationIdAndRole(
            @Param("organizationId") UUID organizationId,
            @Param("role") OrganizationRole role
    );

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç»„ç»‡æˆå‘˜
     */
    @Query("SELECT COUNT(m) > 0 FROM OrganizationMember m WHERE " +
           "m.organization.id = :organizationId AND m.userId = :userId")
    boolean existsByOrganizationIdAndUserId(
            @Param("organizationId") UUID organizationId,
            @Param("userId") UUID userId
    );

    /**
     * ç»Ÿè®¡ç»„ç»‡æˆå‘˜æ•°é‡
     */
    @Query("SELECT COUNT(m) FROM OrganizationMember m WHERE m.organization.id = :organizationId")
    long countByOrganizationId(@Param("organizationId") UUID organizationId);

    /**
     * ç»Ÿè®¡ç»„ç»‡ç®¡ç†å‘˜æ•°é‡ï¼ˆOWNER + ADMINï¼‰
     */
    @Query("SELECT COUNT(m) FROM OrganizationMember m WHERE " +
           "m.organization.id = :organizationId AND m.role IN ('OWNER', 'ADMIN')")
    long countAdminsByOrganizationId(@Param("organizationId") UUID organizationId);

    /**
     * åˆ é™¤ç»„ç»‡æˆå‘˜
     */
    @Query("DELETE FROM OrganizationMember m WHERE " +
           "m.organization.id = :organizationId AND m.userId = :userId")
    void deleteByOrganizationIdAndUserId(
            @Param("organizationId") UUID organizationId,
            @Param("userId") UUID userId
    );
}
```

#### Serviceå±‚

**OrganizationService** (`com.aibidcomposer.service.OrganizationService`):

```java
package com.aibidcomposer.service;

import com.aibidcomposer.dto.organization.*;
import com.aibidcomposer.entity.Organization;
import com.aibidcomposer.entity.OrganizationMember;
import com.aibidcomposer.entity.OrganizationRole;
import com.aibidcomposer.entity.OrganizationStatus;
import com.aibidcomposer.exception.BusinessException;
import com.aibidcomposer.exception.ResourceNotFoundException;
import com.aibidcomposer.repository.OrganizationMemberRepository;
import com.aibidcomposer.repository.OrganizationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * ç»„ç»‡ç®¡ç†æœåŠ¡
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 *
 * æä¾›ç»„ç»‡çš„å®Œæ•´ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
 * - ç»„ç»‡CRUDæ“ä½œ
 * - ç»„ç»‡å±‚çº§ç®¡ç†
 * - ç»„ç»‡æˆå‘˜ç®¡ç†
 * - æƒé™éªŒè¯
 */
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class OrganizationService {

    private final OrganizationRepository organizationRepository;
    private final OrganizationMemberRepository memberRepository;

    // ==================== ç»„ç»‡CRUDæ“ä½œ ====================

    /**
     * åˆ†é¡µæŸ¥è¯¢ç»„ç»‡åˆ—è¡¨
     *
     * @param search æœç´¢å…³é”®è¯ï¼ˆå¯é€‰ï¼‰
     * @param status ç»„ç»‡çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
     * @param pageable åˆ†é¡µå‚æ•°
     * @return ç»„ç»‡åˆ†é¡µåˆ—è¡¨
     */
    public Page<OrganizationResponseDTO> getOrganizations(
            String search,
            OrganizationStatus status,
            Pageable pageable
    ) {
        log.debug("æŸ¥è¯¢ç»„ç»‡åˆ—è¡¨ï¼Œæœç´¢: {}, çŠ¶æ€: {}", search, status);

        Page<Organization> organizations;

        if (search != null && !search.isBlank()) {
            // æŒ‰åç§°æœç´¢
            organizations = organizationRepository.searchByName(search, pageable);
        } else if (status != null) {
            // æŒ‰çŠ¶æ€è¿‡æ»¤
            organizations = organizationRepository.findByStatus(status, pageable);
        } else {
            // æŸ¥è¯¢å…¨éƒ¨
            organizations = organizationRepository.findAll(pageable);
        }

        return organizations.map(OrganizationResponseDTO::fromEntity);
    }

    /**
     * æ ¹æ®IDè·å–ç»„ç»‡è¯¦æƒ…
     *
     * @param id ç»„ç»‡ID
     * @return ç»„ç»‡è¯¦æƒ…
     * @throws ResourceNotFoundException å¦‚æœç»„ç»‡ä¸å­˜åœ¨
     */
    public OrganizationResponseDTO getOrganizationById(UUID id) {
        log.debug("æŸ¥è¯¢ç»„ç»‡è¯¦æƒ…ï¼ŒID: {}", id);

        Organization organization = organizationRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: " + id));

        return OrganizationResponseDTO.fromEntity(organization);
    }

    /**
     * åˆ›å»ºç»„ç»‡
     *
     * @param dto åˆ›å»ºè¯·æ±‚
     * @param creatorUserId åˆ›å»ºè€…ç”¨æˆ·ID
     * @return åˆ›å»ºçš„ç»„ç»‡
     * @throws BusinessException å¦‚æœç»„ç»‡åç§°æˆ–ç¨å·å·²å­˜åœ¨
     */
    @Transactional
    public OrganizationResponseDTO createOrganization(
            CreateOrganizationDTO dto,
            UUID creatorUserId
    ) {
        log.info("åˆ›å»ºç»„ç»‡ï¼Œåç§°: {}", dto.getName());

        // éªŒè¯ç»„ç»‡åç§°å”¯ä¸€æ€§
        if (organizationRepository.existsByName(dto.getName())) {
            throw new BusinessException("ç»„ç»‡åç§°å·²å­˜åœ¨: " + dto.getName());
        }

        // éªŒè¯ç¨å·å”¯ä¸€æ€§
        if (dto.getTaxId() != null && organizationRepository.existsByTaxId(dto.getTaxId())) {
            throw new BusinessException("ç¨å·å·²å­˜åœ¨: " + dto.getTaxId());
        }

        // åˆ›å»ºç»„ç»‡å®ä½“
        Organization organization = Organization.builder()
                .name(dto.getName())
                .shortName(dto.getShortName())
                .organizationType(dto.getOrganizationType())
                .taxId(dto.getTaxId())
                .legalPerson(dto.getLegalPerson())
                .contactPhone(dto.getContactPhone())
                .contactEmail(dto.getContactEmail())
                .address(dto.getAddress())
                .province(dto.getProvince())
                .city(dto.getCity())
                .district(dto.getDistrict())
                .logoUrl(dto.getLogoUrl())
                .website(dto.getWebsite())
                .industry(dto.getIndustry())
                .scale(dto.getScale())
                .establishedDate(dto.getEstablishedDate())
                .status(OrganizationStatus.ACTIVE)
                .build();

        // å¦‚æœæŒ‡å®šäº†çˆ¶ç»„ç»‡ï¼Œå»ºç«‹å…³è”
        if (dto.getParentId() != null) {
            Organization parent = organizationRepository.findById(dto.getParentId())
                    .orElseThrow(() -> new ResourceNotFoundException(
                            "çˆ¶ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: " + dto.getParentId()));
            organization.setParent(parent);
        }

        // ä¿å­˜ç»„ç»‡
        organization = organizationRepository.save(organization);

        // å°†åˆ›å»ºè€…æ·»åŠ ä¸ºç»„ç»‡æ‰€æœ‰è€…
        OrganizationMember ownerMember = OrganizationMember.builder()
                .organization(organization)
                .userId(creatorUserId)
                .role(OrganizationRole.OWNER)
                .build();
        memberRepository.save(ownerMember);

        log.info("ç»„ç»‡åˆ›å»ºæˆåŠŸï¼ŒID: {}, åç§°: {}", organization.getId(), organization.getName());

        return OrganizationResponseDTO.fromEntity(organization);
    }

    /**
     * æ›´æ–°ç»„ç»‡
     *
     * @param id ç»„ç»‡ID
     * @param dto æ›´æ–°è¯·æ±‚
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @return æ›´æ–°åçš„ç»„ç»‡
     * @throws ResourceNotFoundException å¦‚æœç»„ç»‡ä¸å­˜åœ¨
     * @throws BusinessException å¦‚æœæ²¡æœ‰æƒé™æˆ–æ•°æ®å†²çª
     */
    @Transactional
    public OrganizationResponseDTO updateOrganization(
            UUID id,
            UpdateOrganizationDTO dto,
            UUID currentUserId
    ) {
        log.info("æ›´æ–°ç»„ç»‡ï¼ŒID: {}", id);

        // è·å–ç»„ç»‡
        Organization organization = organizationRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: " + id));

        // éªŒè¯æƒé™ï¼ˆå¿…é¡»æ˜¯OWNERæˆ–ADMINï¼‰
        verifyAdminPermission(id, currentUserId);

        // æ›´æ–°åç§°ï¼ˆå¦‚æœä¿®æ”¹äº†åç§°ï¼Œæ£€æŸ¥å”¯ä¸€æ€§ï¼‰
        if (dto.getName() != null && !dto.getName().equals(organization.getName())) {
            if (organizationRepository.existsByName(dto.getName())) {
                throw new BusinessException("ç»„ç»‡åç§°å·²å­˜åœ¨: " + dto.getName());
            }
            organization.setName(dto.getName());
        }

        // æ›´æ–°å…¶ä»–å­—æ®µ
        if (dto.getShortName() != null) {
            organization.setShortName(dto.getShortName());
        }
        if (dto.getOrganizationType() != null) {
            organization.setOrganizationType(dto.getOrganizationType());
        }
        if (dto.getTaxId() != null && !dto.getTaxId().equals(organization.getTaxId())) {
            if (organizationRepository.existsByTaxId(dto.getTaxId())) {
                throw new BusinessException("ç¨å·å·²å­˜åœ¨: " + dto.getTaxId());
            }
            organization.setTaxId(dto.getTaxId());
        }
        if (dto.getLegalPerson() != null) {
            organization.setLegalPerson(dto.getLegalPerson());
        }
        if (dto.getContactPhone() != null) {
            organization.setContactPhone(dto.getContactPhone());
        }
        if (dto.getContactEmail() != null) {
            organization.setContactEmail(dto.getContactEmail());
        }
        if (dto.getAddress() != null) {
            organization.setAddress(dto.getAddress());
        }
        if (dto.getProvince() != null) {
            organization.setProvince(dto.getProvince());
        }
        if (dto.getCity() != null) {
            organization.setCity(dto.getCity());
        }
        if (dto.getDistrict() != null) {
            organization.setDistrict(dto.getDistrict());
        }
        if (dto.getLogoUrl() != null) {
            organization.setLogoUrl(dto.getLogoUrl());
        }
        if (dto.getWebsite() != null) {
            organization.setWebsite(dto.getWebsite());
        }
        if (dto.getIndustry() != null) {
            organization.setIndustry(dto.getIndustry());
        }
        if (dto.getScale() != null) {
            organization.setScale(dto.getScale());
        }
        if (dto.getEstablishedDate() != null) {
            organization.setEstablishedDate(dto.getEstablishedDate());
        }
        if (dto.getStatus() != null) {
            organization.setStatus(dto.getStatus());
        }

        // ä¿å­˜æ›´æ–°
        organization = organizationRepository.save(organization);

        log.info("ç»„ç»‡æ›´æ–°æˆåŠŸï¼ŒID: {}", id);

        return OrganizationResponseDTO.fromEntity(organization);
    }

    /**
     * åˆ é™¤ç»„ç»‡ï¼ˆè½¯åˆ é™¤ï¼‰
     *
     * @param id ç»„ç»‡ID
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @throws ResourceNotFoundException å¦‚æœç»„ç»‡ä¸å­˜åœ¨
     * @throws BusinessException å¦‚æœæ²¡æœ‰æƒé™æˆ–æœ‰å­ç»„ç»‡
     */
    @Transactional
    public void deleteOrganization(UUID id, UUID currentUserId) {
        log.info("åˆ é™¤ç»„ç»‡ï¼ŒID: {}", id);

        // è·å–ç»„ç»‡
        Organization organization = organizationRepository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: " + id));

        // éªŒè¯æƒé™ï¼ˆå¿…é¡»æ˜¯OWNERï¼‰
        verifyOwnerPermission(id, currentUserId);

        // æ£€æŸ¥æ˜¯å¦æœ‰å­ç»„ç»‡
        List<Organization> children = organizationRepository.findByParentId(id);
        if (!children.isEmpty()) {
            throw new BusinessException("ä¸èƒ½åˆ é™¤æœ‰å­ç»„ç»‡çš„ç»„ç»‡ï¼Œè¯·å…ˆåˆ é™¤æˆ–ç§»åŠ¨å­ç»„ç»‡");
        }

        // è½¯åˆ é™¤ï¼ˆç”±@SQLDeleteæ³¨è§£å¤„ç†ï¼‰
        organizationRepository.delete(organization);

        log.info("ç»„ç»‡åˆ é™¤æˆåŠŸï¼ŒID: {}", id);
    }

    // ==================== ç»„ç»‡æˆå‘˜ç®¡ç† ====================

    /**
     * è·å–ç»„ç»‡æˆå‘˜åˆ—è¡¨
     *
     * @param organizationId ç»„ç»‡ID
     * @param pageable åˆ†é¡µå‚æ•°
     * @return æˆå‘˜åˆ†é¡µåˆ—è¡¨
     */
    public Page<OrganizationMemberResponseDTO> getOrganizationMembers(
            UUID organizationId,
            Pageable pageable
    ) {
        log.debug("æŸ¥è¯¢ç»„ç»‡æˆå‘˜ï¼Œç»„ç»‡ID: {}", organizationId);

        // éªŒè¯ç»„ç»‡å­˜åœ¨
        if (!organizationRepository.existsById(organizationId)) {
            throw new ResourceNotFoundException("ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: " + organizationId);
        }

        Page<OrganizationMember> members = memberRepository.findByOrganizationId(
                organizationId,
                pageable
        );

        return members.map(OrganizationMemberResponseDTO::fromEntity);
    }

    /**
     * æ·»åŠ ç»„ç»‡æˆå‘˜
     *
     * @param organizationId ç»„ç»‡ID
     * @param dto æ·»åŠ æˆå‘˜è¯·æ±‚
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @return æ·»åŠ çš„æˆå‘˜ä¿¡æ¯
     * @throws BusinessException å¦‚æœç”¨æˆ·å·²æ˜¯æˆå‘˜æˆ–æ²¡æœ‰æƒé™
     */
    @Transactional
    public OrganizationMemberResponseDTO addOrganizationMember(
            UUID organizationId,
            AddMemberDTO dto,
            UUID currentUserId
    ) {
        log.info("æ·»åŠ ç»„ç»‡æˆå‘˜ï¼Œç»„ç»‡ID: {}, ç”¨æˆ·ID: {}", organizationId, dto.getUserId());

        // éªŒè¯ç»„ç»‡å­˜åœ¨
        Organization organization = organizationRepository.findById(organizationId)
                .orElseThrow(() -> new ResourceNotFoundException("ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: " + organizationId));

        // éªŒè¯æƒé™ï¼ˆå¿…é¡»æ˜¯OWNERæˆ–ADMINï¼‰
        verifyAdminPermission(organizationId, currentUserId);

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æ˜¯æˆå‘˜
        if (memberRepository.existsByOrganizationIdAndUserId(organizationId, dto.getUserId())) {
            throw new BusinessException("ç”¨æˆ·å·²æ˜¯ç»„ç»‡æˆå‘˜");
        }

        // åˆ›å»ºæˆå‘˜å…³ç³»
        OrganizationMember member = OrganizationMember.builder()
                .organization(organization)
                .userId(dto.getUserId())
                .role(dto.getRole() != null ? dto.getRole() : OrganizationRole.MEMBER)
                .build();

        member = memberRepository.save(member);

        log.info("ç»„ç»‡æˆå‘˜æ·»åŠ æˆåŠŸï¼Œç»„ç»‡ID: {}, ç”¨æˆ·ID: {}", organizationId, dto.getUserId());

        return OrganizationMemberResponseDTO.fromEntity(member);
    }

    /**
     * ç§»é™¤ç»„ç»‡æˆå‘˜
     *
     * @param organizationId ç»„ç»‡ID
     * @param memberId æˆå‘˜ID
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @throws BusinessException å¦‚æœæ˜¯æœ€åä¸€ä¸ªOWNERæˆ–æ²¡æœ‰æƒé™
     */
    @Transactional
    public void removeOrganizationMember(
            UUID organizationId,
            UUID memberId,
            UUID currentUserId
    ) {
        log.info("ç§»é™¤ç»„ç»‡æˆå‘˜ï¼Œç»„ç»‡ID: {}, æˆå‘˜ID: {}", organizationId, memberId);

        // è·å–æˆå‘˜ä¿¡æ¯
        OrganizationMember member = memberRepository.findById(memberId)
                .orElseThrow(() -> new ResourceNotFoundException("æˆå‘˜ä¸å­˜åœ¨ï¼ŒID: " + memberId));

        // éªŒè¯æˆå‘˜å±äºè¯¥ç»„ç»‡
        if (!member.getOrganization().getId().equals(organizationId)) {
            throw new BusinessException("æˆå‘˜ä¸å±äºè¯¥ç»„ç»‡");
        }

        // éªŒè¯æƒé™
        verifyAdminPermission(organizationId, currentUserId);

        // å¦‚æœè¦ç§»é™¤çš„æ˜¯OWNERï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªOWNER
        if (member.getRole() == OrganizationRole.OWNER) {
            long ownerCount = memberRepository.countAdminsByOrganizationId(organizationId);
            if (ownerCount <= 1) {
                throw new BusinessException("ä¸èƒ½ç§»é™¤ç»„ç»‡çš„å”¯ä¸€æ‰€æœ‰è€…");
            }
        }

        // åˆ é™¤æˆå‘˜
        memberRepository.delete(member);

        log.info("ç»„ç»‡æˆå‘˜ç§»é™¤æˆåŠŸï¼Œç»„ç»‡ID: {}, æˆå‘˜ID: {}", organizationId, memberId);
    }

    /**
     * æ›´æ–°æˆå‘˜è§’è‰²
     *
     * @param organizationId ç»„ç»‡ID
     * @param memberId æˆå‘˜ID
     * @param newRole æ–°è§’è‰²
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @return æ›´æ–°åçš„æˆå‘˜ä¿¡æ¯
     */
    @Transactional
    public OrganizationMemberResponseDTO updateMemberRole(
            UUID organizationId,
            UUID memberId,
            OrganizationRole newRole,
            UUID currentUserId
    ) {
        log.info("æ›´æ–°æˆå‘˜è§’è‰²ï¼Œç»„ç»‡ID: {}, æˆå‘˜ID: {}, æ–°è§’è‰²: {}",
                organizationId, memberId, newRole);

        // è·å–æˆå‘˜ä¿¡æ¯
        OrganizationMember member = memberRepository.findById(memberId)
                .orElseThrow(() -> new ResourceNotFoundException("æˆå‘˜ä¸å­˜åœ¨ï¼ŒID: " + memberId));

        // éªŒè¯æˆå‘˜å±äºè¯¥ç»„ç»‡
        if (!member.getOrganization().getId().equals(organizationId)) {
            throw new BusinessException("æˆå‘˜ä¸å±äºè¯¥ç»„ç»‡");
        }

        // éªŒè¯æƒé™ï¼ˆå¿…é¡»æ˜¯OWNERï¼‰
        verifyOwnerPermission(organizationId, currentUserId);

        // å¦‚æœä»OWNERé™çº§ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªOWNER
        if (member.getRole() == OrganizationRole.OWNER && newRole != OrganizationRole.OWNER) {
            long ownerCount = memberRepository.countAdminsByOrganizationId(organizationId);
            if (ownerCount <= 1) {
                throw new BusinessException("ä¸èƒ½é™çº§ç»„ç»‡çš„å”¯ä¸€æ‰€æœ‰è€…");
            }
        }

        // æ›´æ–°è§’è‰²
        member.setRole(newRole);
        member = memberRepository.save(member);

        log.info("æˆå‘˜è§’è‰²æ›´æ–°æˆåŠŸï¼Œæˆå‘˜ID: {}, æ–°è§’è‰²: {}", memberId, newRole);

        return OrganizationMemberResponseDTO.fromEntity(member);
    }

    // ==================== ç»„ç»‡å±‚çº§ç®¡ç† ====================

    /**
     * è·å–æ ¹ç»„ç»‡åˆ—è¡¨
     */
    public Page<OrganizationSimpleDTO> getRootOrganizations(Pageable pageable) {
        log.debug("æŸ¥è¯¢æ ¹ç»„ç»‡åˆ—è¡¨");

        Page<Organization> roots = organizationRepository.findRootOrganizations(pageable);
        return roots.map(OrganizationSimpleDTO::fromEntity);
    }

    /**
     * è·å–å­ç»„ç»‡åˆ—è¡¨
     */
    public List<OrganizationSimpleDTO> getChildOrganizations(UUID parentId) {
        log.debug("æŸ¥è¯¢å­ç»„ç»‡ï¼Œçˆ¶ç»„ç»‡ID: {}", parentId);

        List<Organization> children = organizationRepository.findByParentId(parentId);
        return children.stream()
                .map(OrganizationSimpleDTO::fromEntity)
                .collect(Collectors.toList());
    }

    // ==================== æƒé™éªŒè¯ ====================

    /**
     * éªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºç»„ç»‡ç®¡ç†å‘˜ï¼ˆOWNERæˆ–ADMINï¼‰
     */
    private void verifyAdminPermission(UUID organizationId, UUID userId) {
        OrganizationMember member = memberRepository
                .findByOrganizationIdAndUserId(organizationId, userId)
                .orElseThrow(() -> new BusinessException("æ‚¨ä¸æ˜¯è¯¥ç»„ç»‡çš„æˆå‘˜"));

        if (!member.isAdminOrOwner()) {
            throw new BusinessException("æƒé™ä¸è¶³ï¼Œéœ€è¦ç®¡ç†å‘˜æˆ–æ‰€æœ‰è€…æƒé™");
        }
    }

    /**
     * éªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºç»„ç»‡æ‰€æœ‰è€…
     */
    private void verifyOwnerPermission(UUID organizationId, UUID userId) {
        OrganizationMember member = memberRepository
                .findByOrganizationIdAndUserId(organizationId, userId)
                .orElseThrow(() -> new BusinessException("æ‚¨ä¸æ˜¯è¯¥ç»„ç»‡çš„æˆå‘˜"));

        if (!member.isOwner()) {
            throw new BusinessException("æƒé™ä¸è¶³ï¼Œéœ€è¦æ‰€æœ‰è€…æƒé™");
        }
    }

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç»„ç»‡æˆå‘˜
     */
    public boolean isMember(UUID organizationId, UUID userId) {
        return memberRepository.existsByOrganizationIdAndUserId(organizationId, userId);
    }
}
```

#### Controllerå±‚

**OrganizationController** (`com.aibidcomposer.controller.OrganizationController`):

```java
package com.aibidcomposer.controller;

import com.aibidcomposer.dto.common.ApiResponse;
import com.aibidcomposer.dto.common.PageResponse;
import com.aibidcomposer.dto.organization.*;
import com.aibidcomposer.entity.OrganizationRole;
import com.aibidcomposer.entity.OrganizationStatus;
import com.aibidcomposer.security.CurrentUser;
import com.aibidcomposer.security.UserPrincipal;
import com.aibidcomposer.service.OrganizationService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

/**
 * ç»„ç»‡ç®¡ç†æ§åˆ¶å™¨
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 *
 * æä¾›ç»„ç»‡ç®¡ç†çš„REST APIæ¥å£
 */
@RestController
@RequestMapping("/api/v1/organizations")
@RequiredArgsConstructor
@Slf4j
@Tag(name = "ç»„ç»‡ç®¡ç†", description = "ç»„ç»‡å’Œæˆå‘˜ç®¡ç†ç›¸å…³æ¥å£")
public class OrganizationController {

    private final OrganizationService organizationService;

    // ==================== ç»„ç»‡CRUDæ¥å£ ====================

    /**
     * è·å–ç»„ç»‡åˆ—è¡¨
     * GET /api/v1/organizations
     */
    @GetMapping
    @Operation(summary = "è·å–ç»„ç»‡åˆ—è¡¨", description = "åˆ†é¡µæŸ¥è¯¢ç»„ç»‡åˆ—è¡¨ï¼Œæ”¯æŒæœç´¢å’Œè¿‡æ»¤")
    public ApiResponse<PageResponse<OrganizationResponseDTO>> getOrganizations(
            @Parameter(description = "æœç´¢å…³é”®è¯")
            @RequestParam(required = false) String search,

            @Parameter(description = "ç»„ç»‡çŠ¶æ€")
            @RequestParam(required = false) OrganizationStatus status,

            @Parameter(description = "é¡µç ï¼ˆä»0å¼€å§‹ï¼‰")
            @RequestParam(defaultValue = "0") int page,

            @Parameter(description = "æ¯é¡µæ•°é‡")
            @RequestParam(defaultValue = "20") int size,

            @Parameter(description = "æ’åºå­—æ®µ")
            @RequestParam(defaultValue = "createdAt") String sortBy,

            @Parameter(description = "æ’åºæ–¹å‘")
            @RequestParam(defaultValue = "DESC") Sort.Direction direction
    ) {
        log.info("GET /api/v1/organizations - search: {}, status: {}, page: {}, size: {}",
                search, status, page, size);

        Pageable pageable = PageRequest.of(page, size, Sort.by(direction, sortBy));
        Page<OrganizationResponseDTO> organizations = organizationService.getOrganizations(
                search,
                status,
                pageable
        );

        PageResponse<OrganizationResponseDTO> response = PageResponse.of(organizations);

        return ApiResponse.success(response, "è·å–ç»„ç»‡åˆ—è¡¨æˆåŠŸ");
    }

    /**
     * è·å–ç»„ç»‡è¯¦æƒ…
     * GET /api/v1/organizations/{id}
     */
    @GetMapping("/{id}")
    @Operation(summary = "è·å–ç»„ç»‡è¯¦æƒ…", description = "æ ¹æ®IDè·å–ç»„ç»‡çš„è¯¦ç»†ä¿¡æ¯")
    public ApiResponse<OrganizationResponseDTO> getOrganizationById(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID id
    ) {
        log.info("GET /api/v1/organizations/{}", id);

        OrganizationResponseDTO organization = organizationService.getOrganizationById(id);

        return ApiResponse.success(organization, "è·å–ç»„ç»‡è¯¦æƒ…æˆåŠŸ");
    }

    /**
     * åˆ›å»ºç»„ç»‡
     * POST /api/v1/organizations
     */
    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "åˆ›å»ºç»„ç»‡", description = "åˆ›å»ºæ–°çš„ç»„ç»‡ï¼Œåˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºç»„ç»‡æ‰€æœ‰è€…")
    public ApiResponse<OrganizationResponseDTO> createOrganization(
            @Parameter(description = "ç»„ç»‡åˆ›å»ºä¿¡æ¯")
            @Valid @RequestBody CreateOrganizationDTO dto,

            @Parameter(hidden = true)
            @CurrentUser UserPrincipal currentUser
    ) {
        log.info("POST /api/v1/organizations - name: {}, by user: {}",
                dto.getName(), currentUser.getId());

        OrganizationResponseDTO organization = organizationService.createOrganization(
                dto,
                currentUser.getId()
        );

        return ApiResponse.success(organization, "ç»„ç»‡åˆ›å»ºæˆåŠŸ");
    }

    /**
     * æ›´æ–°ç»„ç»‡
     * PUT /api/v1/organizations/{id}
     */
    @PutMapping("/{id}")
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "æ›´æ–°ç»„ç»‡", description = "æ›´æ–°ç»„ç»‡ä¿¡æ¯ï¼Œéœ€è¦ç®¡ç†å‘˜æˆ–æ‰€æœ‰è€…æƒé™")
    public ApiResponse<OrganizationResponseDTO> updateOrganization(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID id,

            @Parameter(description = "ç»„ç»‡æ›´æ–°ä¿¡æ¯")
            @Valid @RequestBody UpdateOrganizationDTO dto,

            @Parameter(hidden = true)
            @CurrentUser UserPrincipal currentUser
    ) {
        log.info("PUT /api/v1/organizations/{} - by user: {}", id, currentUser.getId());

        OrganizationResponseDTO organization = organizationService.updateOrganization(
                id,
                dto,
                currentUser.getId()
        );

        return ApiResponse.success(organization, "ç»„ç»‡æ›´æ–°æˆåŠŸ");
    }

    /**
     * åˆ é™¤ç»„ç»‡
     * DELETE /api/v1/organizations/{id}
     */
    @DeleteMapping("/{id}")
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "åˆ é™¤ç»„ç»‡", description = "åˆ é™¤ç»„ç»‡ï¼ˆè½¯åˆ é™¤ï¼‰ï¼Œéœ€è¦æ‰€æœ‰è€…æƒé™")
    public ApiResponse<Void> deleteOrganization(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID id,

            @Parameter(hidden = true)
            @CurrentUser UserPrincipal currentUser
    ) {
        log.info("DELETE /api/v1/organizations/{} - by user: {}", id, currentUser.getId());

        organizationService.deleteOrganization(id, currentUser.getId());

        return ApiResponse.success(null, "ç»„ç»‡åˆ é™¤æˆåŠŸ");
    }

    // ==================== ç»„ç»‡æˆå‘˜ç®¡ç†æ¥å£ ====================

    /**
     * è·å–ç»„ç»‡æˆå‘˜åˆ—è¡¨
     * GET /api/v1/organizations/{id}/members
     */
    @GetMapping("/{id}/members")
    @Operation(summary = "è·å–ç»„ç»‡æˆå‘˜", description = "è·å–æŒ‡å®šç»„ç»‡çš„æˆå‘˜åˆ—è¡¨")
    public ApiResponse<PageResponse<OrganizationMemberResponseDTO>> getOrganizationMembers(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID id,

            @Parameter(description = "é¡µç ")
            @RequestParam(defaultValue = "0") int page,

            @Parameter(description = "æ¯é¡µæ•°é‡")
            @RequestParam(defaultValue = "20") int size
    ) {
        log.info("GET /api/v1/organizations/{}/members - page: {}, size: {}", id, page, size);

        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));
        Page<OrganizationMemberResponseDTO> members = organizationService.getOrganizationMembers(
                id,
                pageable
        );

        PageResponse<OrganizationMemberResponseDTO> response = PageResponse.of(members);

        return ApiResponse.success(response, "è·å–ç»„ç»‡æˆå‘˜æˆåŠŸ");
    }

    /**
     * æ·»åŠ ç»„ç»‡æˆå‘˜
     * POST /api/v1/organizations/{id}/members
     */
    @PostMapping("/{id}/members")
    @ResponseStatus(HttpStatus.CREATED)
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "æ·»åŠ ç»„ç»‡æˆå‘˜", description = "å‘ç»„ç»‡æ·»åŠ æ–°æˆå‘˜ï¼Œéœ€è¦ç®¡ç†å‘˜æˆ–æ‰€æœ‰è€…æƒé™")
    public ApiResponse<OrganizationMemberResponseDTO> addOrganizationMember(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID id,

            @Parameter(description = "æˆå‘˜æ·»åŠ ä¿¡æ¯")
            @Valid @RequestBody AddMemberDTO dto,

            @Parameter(hidden = true)
            @CurrentUser UserPrincipal currentUser
    ) {
        log.info("POST /api/v1/organizations/{}/members - userId: {}, by user: {}",
                id, dto.getUserId(), currentUser.getId());

        OrganizationMemberResponseDTO member = organizationService.addOrganizationMember(
                id,
                dto,
                currentUser.getId()
        );

        return ApiResponse.success(member, "æˆå‘˜æ·»åŠ æˆåŠŸ");
    }

    /**
     * ç§»é™¤ç»„ç»‡æˆå‘˜
     * DELETE /api/v1/organizations/{organizationId}/members/{memberId}
     */
    @DeleteMapping("/{organizationId}/members/{memberId}")
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "ç§»é™¤ç»„ç»‡æˆå‘˜", description = "ä»ç»„ç»‡ä¸­ç§»é™¤æˆå‘˜ï¼Œéœ€è¦ç®¡ç†å‘˜æˆ–æ‰€æœ‰è€…æƒé™")
    public ApiResponse<Void> removeOrganizationMember(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID organizationId,

            @Parameter(description = "æˆå‘˜ID")
            @PathVariable UUID memberId,

            @Parameter(hidden = true)
            @CurrentUser UserPrincipal currentUser
    ) {
        log.info("DELETE /api/v1/organizations/{}/members/{} - by user: {}",
                organizationId, memberId, currentUser.getId());

        organizationService.removeOrganizationMember(organizationId, memberId, currentUser.getId());

        return ApiResponse.success(null, "æˆå‘˜ç§»é™¤æˆåŠŸ");
    }

    /**
     * æ›´æ–°æˆå‘˜è§’è‰²
     * PUT /api/v1/organizations/{organizationId}/members/{memberId}/role
     */
    @PutMapping("/{organizationId}/members/{memberId}/role")
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "æ›´æ–°æˆå‘˜è§’è‰²", description = "æ›´æ–°ç»„ç»‡æˆå‘˜çš„è§’è‰²ï¼Œéœ€è¦æ‰€æœ‰è€…æƒé™")
    public ApiResponse<OrganizationMemberResponseDTO> updateMemberRole(
            @Parameter(description = "ç»„ç»‡ID")
            @PathVariable UUID organizationId,

            @Parameter(description = "æˆå‘˜ID")
            @PathVariable UUID memberId,

            @Parameter(description = "æ–°è§’è‰²")
            @RequestParam OrganizationRole newRole,

            @Parameter(hidden = true)
            @CurrentUser UserPrincipal currentUser
    ) {
        log.info("PUT /api/v1/organizations/{}/members/{}/role - newRole: {}, by user: {}",
                organizationId, memberId, newRole, currentUser.getId());

        OrganizationMemberResponseDTO member = organizationService.updateMemberRole(
                organizationId,
                memberId,
                newRole,
                currentUser.getId()
        );

        return ApiResponse.success(member, "æˆå‘˜è§’è‰²æ›´æ–°æˆåŠŸ");
    }

    // ==================== ç»„ç»‡å±‚çº§æ¥å£ ====================

    /**
     * è·å–æ ¹ç»„ç»‡åˆ—è¡¨
     * GET /api/v1/organizations/roots
     */
    @GetMapping("/roots")
    @Operation(summary = "è·å–æ ¹ç»„ç»‡", description = "è·å–æ²¡æœ‰çˆ¶ç»„ç»‡çš„é¡¶çº§ç»„ç»‡åˆ—è¡¨")
    public ApiResponse<PageResponse<OrganizationSimpleDTO>> getRootOrganizations(
            @Parameter(description = "é¡µç ")
            @RequestParam(defaultValue = "0") int page,

            @Parameter(description = "æ¯é¡µæ•°é‡")
            @RequestParam(defaultValue = "20") int size
    ) {
        log.info("GET /api/v1/organizations/roots - page: {}, size: {}", page, size);

        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.ASC, "name"));
        Page<OrganizationSimpleDTO> roots = organizationService.getRootOrganizations(pageable);

        PageResponse<OrganizationSimpleDTO> response = PageResponse.of(roots);

        return ApiResponse.success(response, "è·å–æ ¹ç»„ç»‡æˆåŠŸ");
    }

    /**
     * è·å–å­ç»„ç»‡åˆ—è¡¨
     * GET /api/v1/organizations/{id}/children
     */
    @GetMapping("/{id}/children")
    @Operation(summary = "è·å–å­ç»„ç»‡", description = "è·å–æŒ‡å®šç»„ç»‡çš„ç›´æ¥å­ç»„ç»‡åˆ—è¡¨")
    public ApiResponse<List<OrganizationSimpleDTO>> getChildOrganizations(
            @Parameter(description = "çˆ¶ç»„ç»‡ID")
            @PathVariable UUID id
    ) {
        log.info("GET /api/v1/organizations/{}/children", id);

        List<OrganizationSimpleDTO> children = organizationService.getChildOrganizations(id);

        return ApiResponse.success(children, "è·å–å­ç»„ç»‡æˆåŠŸ");
    }
}
```

#### å•å…ƒæµ‹è¯•

**OrganizationServiceTest** (`com.aibidcomposer.service.OrganizationServiceTest`):

```java
package com.aibidcomposer.service;

import com.aibidcomposer.dto.organization.*;
import com.aibidcomposer.entity.*;
import com.aibidcomposer.exception.BusinessException;
import com.aibidcomposer.exception.ResourceNotFoundException;
import com.aibidcomposer.repository.OrganizationMemberRepository;
import com.aibidcomposer.repository.OrganizationRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;

import java.util.*;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * ç»„ç»‡æœåŠ¡å•å…ƒæµ‹è¯•
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 */
@ExtendWith(MockitoExtension.class)
@DisplayName("ç»„ç»‡æœåŠ¡å•å…ƒæµ‹è¯•")
class OrganizationServiceTest {

    @Mock
    private OrganizationRepository organizationRepository;

    @Mock
    private OrganizationMemberRepository memberRepository;

    @InjectMocks
    private OrganizationService organizationService;

    private Organization testOrganization;
    private UUID testOrgId;
    private UUID testUserId;

    @BeforeEach
    void setUp() {
        testOrgId = UUID.randomUUID();
        testUserId = UUID.randomUUID();

        testOrganization = Organization.builder()
                .id(testOrgId)
                .name("æµ‹è¯•ç»„ç»‡")
                .shortName("æµ‹è¯•")
                .organizationType(OrganizationType.COMPANY)
                .taxId("91110000MA01234567")
                .status(OrganizationStatus.ACTIVE)
                .build();
    }

    // ==================== ç»„ç»‡CRUDæµ‹è¯• ====================

    @Test
    @DisplayName("è·å–ç»„ç»‡åˆ—è¡¨ - æˆåŠŸ")
    void getOrganizations_Success() {
        // Arrange
        Pageable pageable = PageRequest.of(0, 20);
        List<Organization> organizations = Arrays.asList(testOrganization);
        Page<Organization> page = new PageImpl<>(organizations, pageable, 1);

        when(organizationRepository.findAll(pageable)).thenReturn(page);

        // Act
        Page<OrganizationResponseDTO> result = organizationService.getOrganizations(
                null, null, pageable
        );

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getContent()).hasSize(1);
        assertThat(result.getContent().get(0).getName()).isEqualTo("æµ‹è¯•ç»„ç»‡");

        verify(organizationRepository).findAll(pageable);
    }

    @Test
    @DisplayName("æ ¹æ®IDè·å–ç»„ç»‡ - æˆåŠŸ")
    void getOrganizationById_Success() {
        // Arrange
        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));

        // Act
        OrganizationResponseDTO result = organizationService.getOrganizationById(testOrgId);

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getId()).isEqualTo(testOrgId);
        assertThat(result.getName()).isEqualTo("æµ‹è¯•ç»„ç»‡");

        verify(organizationRepository).findById(testOrgId);
    }

    @Test
    @DisplayName("æ ¹æ®IDè·å–ç»„ç»‡ - ç»„ç»‡ä¸å­˜åœ¨")
    void getOrganizationById_NotFound() {
        // Arrange
        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.empty());

        // Act & Assert
        assertThatThrownBy(() -> organizationService.getOrganizationById(testOrgId))
                .isInstanceOf(ResourceNotFoundException.class)
                .hasMessageContaining("ç»„ç»‡ä¸å­˜åœ¨");

        verify(organizationRepository).findById(testOrgId);
    }

    @Test
    @DisplayName("åˆ›å»ºç»„ç»‡ - æˆåŠŸ")
    void createOrganization_Success() {
        // Arrange
        CreateOrganizationDTO dto = new CreateOrganizationDTO();
        dto.setName("æ–°ç»„ç»‡");
        dto.setShortName("æ–°");
        dto.setOrganizationType(OrganizationType.COMPANY);
        dto.setTaxId("91110000MA98765432");

        Organization savedOrg = Organization.builder()
                .id(UUID.randomUUID())
                .name(dto.getName())
                .shortName(dto.getShortName())
                .organizationType(dto.getOrganizationType())
                .taxId(dto.getTaxId())
                .status(OrganizationStatus.ACTIVE)
                .build();

        when(organizationRepository.existsByName(dto.getName())).thenReturn(false);
        when(organizationRepository.existsByTaxId(dto.getTaxId())).thenReturn(false);
        when(organizationRepository.save(any(Organization.class))).thenReturn(savedOrg);
        when(memberRepository.save(any(OrganizationMember.class)))
                .thenReturn(new OrganizationMember());

        // Act
        OrganizationResponseDTO result = organizationService.createOrganization(dto, testUserId);

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getName()).isEqualTo("æ–°ç»„ç»‡");
        assertThat(result.getStatus()).isEqualTo(OrganizationStatus.ACTIVE);

        verify(organizationRepository).existsByName(dto.getName());
        verify(organizationRepository).existsByTaxId(dto.getTaxId());
        verify(organizationRepository).save(any(Organization.class));
        verify(memberRepository).save(any(OrganizationMember.class));
    }

    @Test
    @DisplayName("åˆ›å»ºç»„ç»‡ - åç§°å·²å­˜åœ¨")
    void createOrganization_NameExists() {
        // Arrange
        CreateOrganizationDTO dto = new CreateOrganizationDTO();
        dto.setName("æµ‹è¯•ç»„ç»‡");

        when(organizationRepository.existsByName(dto.getName())).thenReturn(true);

        // Act & Assert
        assertThatThrownBy(() -> organizationService.createOrganization(dto, testUserId))
                .isInstanceOf(BusinessException.class)
                .hasMessageContaining("ç»„ç»‡åç§°å·²å­˜åœ¨");

        verify(organizationRepository).existsByName(dto.getName());
        verify(organizationRepository, never()).save(any());
    }

    @Test
    @DisplayName("æ›´æ–°ç»„ç»‡ - æˆåŠŸ")
    void updateOrganization_Success() {
        // Arrange
        UpdateOrganizationDTO dto = new UpdateOrganizationDTO();
        dto.setShortName("æ–°ç®€ç§°");
        dto.setContactPhone("010-12345678");

        OrganizationMember adminMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.ADMIN)
                .build();

        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(adminMember));
        when(organizationRepository.save(any(Organization.class)))
                .thenReturn(testOrganization);

        // Act
        OrganizationResponseDTO result = organizationService.updateOrganization(
                testOrgId, dto, testUserId
        );

        // Assert
        assertThat(result).isNotNull();

        verify(organizationRepository).findById(testOrgId);
        verify(memberRepository).findByOrganizationIdAndUserId(testOrgId, testUserId);
        verify(organizationRepository).save(any(Organization.class));
    }

    @Test
    @DisplayName("åˆ é™¤ç»„ç»‡ - æˆåŠŸ")
    void deleteOrganization_Success() {
        // Arrange
        OrganizationMember ownerMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.OWNER)
                .build();

        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(ownerMember));
        when(organizationRepository.findByParentId(testOrgId))
                .thenReturn(Collections.emptyList());

        // Act
        organizationService.deleteOrganization(testOrgId, testUserId);

        // Assert
        verify(organizationRepository).findById(testOrgId);
        verify(memberRepository).findByOrganizationIdAndUserId(testOrgId, testUserId);
        verify(organizationRepository).findByParentId(testOrgId);
        verify(organizationRepository).delete(testOrganization);
    }

    // ==================== æˆå‘˜ç®¡ç†æµ‹è¯• ====================

    @Test
    @DisplayName("æ·»åŠ ç»„ç»‡æˆå‘˜ - æˆåŠŸ")
    void addOrganizationMember_Success() {
        // Arrange
        UUID newUserId = UUID.randomUUID();
        AddMemberDTO dto = new AddMemberDTO();
        dto.setUserId(newUserId);
        dto.setRole(OrganizationRole.MEMBER);

        OrganizationMember adminMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.ADMIN)
                .build();

        OrganizationMember newMember = OrganizationMember.builder()
                .id(UUID.randomUUID())
                .organization(testOrganization)
                .userId(newUserId)
                .role(OrganizationRole.MEMBER)
                .build();

        when(organizationRepository.findById(testOrgId))
                .thenReturn(Optional.of(testOrganization));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(adminMember));
        when(memberRepository.existsByOrganizationIdAndUserId(testOrgId, newUserId))
                .thenReturn(false);
        when(memberRepository.save(any(OrganizationMember.class)))
                .thenReturn(newMember);

        // Act
        OrganizationMemberResponseDTO result = organizationService.addOrganizationMember(
                testOrgId, dto, testUserId
        );

        // Assert
        assertThat(result).isNotNull();
        assertThat(result.getRole()).isEqualTo(OrganizationRole.MEMBER);

        verify(memberRepository).save(any(OrganizationMember.class));
    }

    @Test
    @DisplayName("ç§»é™¤ç»„ç»‡æˆå‘˜ - æˆåŠŸ")
    void removeOrganizationMember_Success() {
        // Arrange
        UUID memberId = UUID.randomUUID();
        UUID memberUserId = UUID.randomUUID();

        OrganizationMember adminMember = OrganizationMember.builder()
                .organization(testOrganization)
                .userId(testUserId)
                .role(OrganizationRole.ADMIN)
                .build();

        OrganizationMember targetMember = OrganizationMember.builder()
                .id(memberId)
                .organization(testOrganization)
                .userId(memberUserId)
                .role(OrganizationRole.MEMBER)
                .build();

        when(memberRepository.findById(memberId))
                .thenReturn(Optional.of(targetMember));
        when(memberRepository.findByOrganizationIdAndUserId(testOrgId, testUserId))
                .thenReturn(Optional.of(adminMember));

        // Act
        organizationService.removeOrganizationMember(testOrgId, memberId, testUserId);

        // Assert
        verify(memberRepository).delete(targetMember);
    }
}
```

#### é›†æˆæµ‹è¯•

**OrganizationControllerIntegrationTest** (`com.aibidcomposer.controller.OrganizationControllerIntegrationTest`):

```java
package com.aibidcomposer.controller;

import com.aibidcomposer.dto.organization.CreateOrganizationDTO;
import com.aibidcomposer.entity.OrganizationType;
import com.aibidcomposer.repository.OrganizationRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.transaction.annotation.Transactional;

import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * ç»„ç»‡æ§åˆ¶å™¨é›†æˆæµ‹è¯•
 * éœ€æ±‚ç¼–å·: REQ-JAVA-002
 *
 * ä½¿ç”¨çœŸå®æ•°æ®åº“è¿›è¡Œå®Œæ•´çš„APIæµ‹è¯•
 */
@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@Transactional
@DisplayName("ç»„ç»‡æ§åˆ¶å™¨é›†æˆæµ‹è¯•")
class OrganizationControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private OrganizationRepository organizationRepository;

    @BeforeEach
    void setUp() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
        organizationRepository.deleteAll();
    }

    @Test
    @DisplayName("åˆ›å»ºç»„ç»‡ - å®Œæ•´æµç¨‹æµ‹è¯•")
    @WithMockUser(username = "test@example.com", authorities = {"USER"})
    void createOrganization_IntegrationTest() throws Exception {
        // Arrange
        CreateOrganizationDTO dto = new CreateOrganizationDTO();
        dto.setName("é›†æˆæµ‹è¯•ç»„ç»‡");
        dto.setShortName("é›†æˆ");
        dto.setOrganizationType(OrganizationType.COMPANY);
        dto.setTaxId("91110000MA11111111");
        dto.setContactEmail("contact@test.com");

        // Act & Assert
        mockMvc.perform(post("/api/v1/organizations")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(dto)))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.success").value(true))
                .andExpect(jsonPath("$.data.name").value("é›†æˆæµ‹è¯•ç»„ç»‡"))
                .andExpect(jsonPath("$.data.status").value("ACTIVE"))
                .andExpect(jsonPath("$.message").value("ç»„ç»‡åˆ›å»ºæˆåŠŸ"));
    }

    @Test
    @DisplayName("è·å–ç»„ç»‡åˆ—è¡¨ - åˆ†é¡µæµ‹è¯•")
    void getOrganizations_PaginationTest() throws Exception {
        // Act & Assert
        mockMvc.perform(get("/api/v1/organizations")
                        .param("page", "0")
                        .param("size", "20")
                        .param("sortBy", "createdAt")
                        .param("direction", "DESC"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.success").value(true))
                .andExpect(jsonPath("$.data.items").isArray())
                .andExpect(jsonPath("$.data.page").value(0))
                .andExpect(jsonPath("$.data.pageSize").value(20));
    }

    @Test
    @DisplayName("è·å–ç»„ç»‡è¯¦æƒ… - 404é”™è¯¯")
    void getOrganizationById_NotFound() throws Exception {
        // Arrange
        String randomUuid = "550e8400-e29b-41d4-a716-446655440000";

        // Act & Assert
        mockMvc.perform(get("/api/v1/organizations/{id}", randomUuid))
                .andExpect(status().isNotFound())
                .andExpect(jsonPath("$.success").value(false))
                .andExpect(jsonPath("$.error.message").containsString("ç»„ç»‡ä¸å­˜åœ¨"));
    }
}
```



---
**ğŸ“– ç»§ç»­**: [Part3 - Pythonåç«¯ä¸éƒ¨ç½²](./task-plan-java-è¯¦ç»†-JAVA-002-Part3.md)


# Java Spring Boot - JAVA-002 Part3 (ç»„ç»‡ç®¡ç†: Pythonåç«¯ä¸éƒ¨ç½²)

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-002 (2.1.4-2.1.5)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-27
**åˆ›å»ºè€…**: claude-sonnet-4-5
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 15:10 | 3.0 | claude-sonnet-4-5 | å°†è¶…é•¿JAVA-002æ–‡æ¡£(10051è¡Œ)æ‹†åˆ†æˆ5ä¸ªå­æ–‡æ¡£ |
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º JAVA-002 æ¨¡å— |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [JAVA-002-INDEX.md](./task-plan-java-è¯¦ç»†-JAVA-002-INDEX.md)
**å…¶ä»–éƒ¨åˆ†**: [Part1](./task-plan-java-è¯¦ç»†-JAVA-002-Part1.md) | [Part2](./task-plan-java-è¯¦ç»†-JAVA-002-Part2.md) | [Part4](./task-plan-java-è¯¦ç»†-JAVA-002-Part4.md) | [Part5](./task-plan-java-è¯¦ç»†-JAVA-002-Part5.md)

---


### 2.1.4: Pythonåç«¯

**éªŒè¯æ¸…å•**:
- [ ] JWT TokenéªŒè¯å·¥å…·å®ç°
- [ ] ç»„ç»‡æ•°æ®åªè¯»è®¿é—®å®ç°
- [ ] ç”¨æˆ·ç»„ç»‡å…³ç³»æŸ¥è¯¢å®ç°
- [ ] æƒé™éªŒè¯è¾…åŠ©å‡½æ•°
- [ ] Pythoné›†æˆæµ‹è¯•é€šè¿‡

#### JWTéªŒè¯å·¥å…·

**jwt_utils.py** (`app/core/jwt_utils.py`):

```python
"""
JWTä»¤ç‰ŒéªŒè¯å·¥å…·
éœ€æ±‚ç¼–å·: REQ-JAVA-002

Python AIæœåŠ¡éœ€è¦éªŒè¯æ¥è‡ªJavaæœåŠ¡çš„JWTä»¤ç‰Œï¼Œä»¥è¯†åˆ«ç”¨æˆ·èº«ä»½å’Œç»„ç»‡å…³ç³»ã€‚
"""
from typing import Optional, Dict, Any
from datetime import datetime, timedelta
import jwt
from jwt import PyJWTError
from app.core.config import settings
from app.core.exceptions import UnauthorizedException
from app.core.logging import logger


class JWTValidator:
    """JWTä»¤ç‰ŒéªŒè¯å™¨"""

    def __init__(self):
        self.secret_key = settings.JWT_SECRET_KEY
        self.algorithm = settings.JWT_ALGORITHM or "HS256"

    def decode_token(self, token: str) -> Dict[str, Any]:
        """
        è§£ç JWTä»¤ç‰Œ

        Args:
            token: JWTä»¤ç‰Œå­—ç¬¦ä¸²

        Returns:
            è§£ç åçš„payloadå­—å…¸

        Raises:
            UnauthorizedException: å¦‚æœä»¤ç‰Œæ— æ•ˆæˆ–è¿‡æœŸ
        """
        try:
            # ç§»é™¤Bearerå‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
            if token.startswith("Bearer "):
                token = token[7:]

            # è§£ç JWT
            payload = jwt.decode(
                token,
                self.secret_key,
                algorithms=[self.algorithm]
            )

            # éªŒè¯è¿‡æœŸæ—¶é—´
            exp = payload.get("exp")
            if exp:
                exp_datetime = datetime.fromtimestamp(exp)
                if exp_datetime < datetime.utcnow():
                    raise UnauthorizedException("Tokenå·²è¿‡æœŸ")

            logger.debug(f"JWTè§£ç æˆåŠŸï¼Œç”¨æˆ·ID: {payload.get('user_id')}")
            return payload

        except jwt.ExpiredSignatureError:
            logger.warning("JWTä»¤ç‰Œå·²è¿‡æœŸ")
            raise UnauthorizedException("Tokenå·²è¿‡æœŸ")

        except jwt.InvalidTokenError as e:
            logger.warning(f"JWTä»¤ç‰Œæ— æ•ˆ: {str(e)}")
            raise UnauthorizedException("æ— æ•ˆçš„Token")

        except Exception as e:
            logger.error(f"JWTè§£ç å¤±è´¥: {str(e)}")
            raise UnauthorizedException("TokenéªŒè¯å¤±è´¥")

    def get_user_id(self, token: str) -> str:
        """
        ä»JWTä»¤ç‰Œè·å–ç”¨æˆ·ID

        Args:
            token: JWTä»¤ç‰Œå­—ç¬¦ä¸²

        Returns:
            ç”¨æˆ·ID (UUIDå­—ç¬¦ä¸²)
        """
        payload = self.decode_token(token)
        user_id = payload.get("user_id") or payload.get("sub")

        if not user_id:
            raise UnauthorizedException("Tokenä¸­ç¼ºå°‘ç”¨æˆ·ID")

        return user_id

    def get_organization_id(self, token: str) -> Optional[str]:
        """
        ä»JWTä»¤ç‰Œè·å–ç»„ç»‡ID

        Args:
            token: JWTä»¤ç‰Œå­—ç¬¦ä¸²

        Returns:
            ç»„ç»‡ID (UUIDå­—ç¬¦ä¸²) æˆ– None
        """
        payload = self.decode_token(token)
        return payload.get("organization_id")

    def get_user_roles(self, token: str) -> list[str]:
        """
        ä»JWTä»¤ç‰Œè·å–ç”¨æˆ·è§’è‰²åˆ—è¡¨

        Args:
            token: JWTä»¤ç‰Œå­—ç¬¦ä¸²

        Returns:
            è§’è‰²åˆ—è¡¨
        """
        payload = self.decode_token(token)
        roles = payload.get("roles", [])

        if isinstance(roles, str):
            return [roles]
        return roles

    def has_role(self, token: str, required_role: str) -> bool:
        """
        æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ç‰¹å®šè§’è‰²

        Args:
            token: JWTä»¤ç‰Œå­—ç¬¦ä¸²
            required_role: éœ€è¦çš„è§’è‰²

        Returns:
            æ˜¯å¦æ‹¥æœ‰è¯¥è§’è‰²
        """
        roles = self.get_user_roles(token)
        return required_role in roles

    def verify_token(self, token: str) -> bool:
        """
        éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ

        Args:
            token: JWTä»¤ç‰Œå­—ç¬¦ä¸²

        Returns:
            ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
        """
        try:
            self.decode_token(token)
            return True
        except UnauthorizedException:
            return False


# å…¨å±€å®ä¾‹
jwt_validator = JWTValidator()


def get_current_user_id(authorization: str) -> str:
    """
    ä»Authorization headerè·å–å½“å‰ç”¨æˆ·ID

    Args:
        authorization: Authorization headerå€¼ (æ ¼å¼: "Bearer {token}")

    Returns:
        ç”¨æˆ·ID
    """
    if not authorization:
        raise UnauthorizedException("ç¼ºå°‘Authorization header")

    return jwt_validator.get_user_id(authorization)


def get_current_organization_id(authorization: str) -> Optional[str]:
    """
    ä»Authorization headerè·å–å½“å‰ç»„ç»‡ID

    Args:
        authorization: Authorization headerå€¼

    Returns:
        ç»„ç»‡ID æˆ– None
    """
    if not authorization:
        return None

    return jwt_validator.get_organization_id(authorization)
```

#### ç»„ç»‡æ•°æ®è®¿é—®æœåŠ¡

**organization_client.py** (`app/services/organization_client.py`):

```python
"""
ç»„ç»‡æ•°æ®è®¿é—®å®¢æˆ·ç«¯
éœ€æ±‚ç¼–å·: REQ-JAVA-002

Python AIæœåŠ¡é€šè¿‡HTTPè°ƒç”¨JavaæœåŠ¡APIæ¥è·å–ç»„ç»‡æ•°æ®ï¼ˆåªè¯»ï¼‰ã€‚
è¿™ç¡®ä¿äº†æ•°æ®è®¿é—®çš„ä¸€è‡´æ€§ï¼Œé¿å…ç›´æ¥è®¿é—®æ•°æ®åº“ã€‚
"""
from typing import Optional, List, Dict, Any
import httpx
from app.core.config import settings
from app.core.logging import logger
from app.core.exceptions import ServiceException


class OrganizationClient:
    """ç»„ç»‡æ•°æ®è®¿é—®å®¢æˆ·ç«¯ï¼ˆè°ƒç”¨JavaæœåŠ¡APIï¼‰"""

    def __init__(self):
        self.java_service_url = settings.JAVA_SERVICE_URL
        self.api_base = f"{self.java_service_url}/api/v1/organizations"
        self.timeout = 30.0

    async def get_organization_by_id(
        self,
        organization_id: str,
        authorization: str
    ) -> Optional[Dict[str, Any]]:
        """
        æ ¹æ®IDè·å–ç»„ç»‡ä¿¡æ¯

        Args:
            organization_id: ç»„ç»‡ID
            authorization: JWTä»¤ç‰Œ (Bearer token)

        Returns:
            ç»„ç»‡ä¿¡æ¯å­—å…¸ æˆ– None
        """
        try:
            async with httpx.AsyncClient(timeout=self.timeout) as client:
                response = await client.get(
                    f"{self.api_base}/{organization_id}",
                    headers={"Authorization": authorization}
                )

                if response.status_code == 404:
                    logger.warning(f"ç»„ç»‡ä¸å­˜åœ¨ï¼ŒID: {organization_id}")
                    return None

                response.raise_for_status()
                data = response.json()

                if data.get("success"):
                    return data.get("data")
                else:
                    logger.error(f"è·å–ç»„ç»‡å¤±è´¥: {data.get('error')}")
                    return None

        except httpx.HTTPStatusError as e:
            logger.error(f"HTTPé”™è¯¯: {e.response.status_code}, {e.response.text}")
            raise ServiceException(f"è·å–ç»„ç»‡ä¿¡æ¯å¤±è´¥: {str(e)}")

        except Exception as e:
            logger.error(f"è·å–ç»„ç»‡å¤±è´¥: {str(e)}")
            raise ServiceException(f"è·å–ç»„ç»‡ä¿¡æ¯å¤±è´¥: {str(e)}")

    async def get_organization_members(
        self,
        organization_id: str,
        authorization: str,
        page: int = 0,
        size: int = 100
    ) -> List[Dict[str, Any]]:
        """
        è·å–ç»„ç»‡æˆå‘˜åˆ—è¡¨

        Args:
            organization_id: ç»„ç»‡ID
            authorization: JWTä»¤ç‰Œ
            page: é¡µç 
            size: æ¯é¡µæ•°é‡

        Returns:
            æˆå‘˜åˆ—è¡¨
        """
        try:
            async with httpx.AsyncClient(timeout=self.timeout) as client:
                response = await client.get(
                    f"{self.api_base}/{organization_id}/members",
                    params={"page": page, "size": size},
                    headers={"Authorization": authorization}
                )

                response.raise_for_status()
                data = response.json()

                if data.get("success"):
                    return data.get("data", {}).get("items", [])
                else:
                    logger.error(f"è·å–ç»„ç»‡æˆå‘˜å¤±è´¥: {data.get('error')}")
                    return []

        except Exception as e:
            logger.error(f"è·å–ç»„ç»‡æˆå‘˜å¤±è´¥: {str(e)}")
            raise ServiceException(f"è·å–ç»„ç»‡æˆå‘˜å¤±è´¥: {str(e)}")

    async def check_user_membership(
        self,
        organization_id: str,
        user_id: str,
        authorization: str
    ) -> bool:
        """
        æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç»„ç»‡æˆå‘˜

        Args:
            organization_id: ç»„ç»‡ID
            user_id: ç”¨æˆ·ID
            authorization: JWTä»¤ç‰Œ

        Returns:
            æ˜¯å¦ä¸ºæˆå‘˜
        """
        try:
            members = await self.get_organization_members(
                organization_id,
                authorization,
                page=0,
                size=1000  # è·å–æ‰€æœ‰æˆå‘˜
            )

            # æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦åœ¨æˆå‘˜åˆ—è¡¨ä¸­
            return any(member.get("userId") == user_id for member in members)

        except Exception as e:
            logger.error(f"æ£€æŸ¥ç”¨æˆ·æˆå‘˜å…³ç³»å¤±è´¥: {str(e)}")
            return False

    async def get_user_role_in_organization(
        self,
        organization_id: str,
        user_id: str,
        authorization: str
    ) -> Optional[str]:
        """
        è·å–ç”¨æˆ·åœ¨ç»„ç»‡ä¸­çš„è§’è‰²

        Args:
            organization_id: ç»„ç»‡ID
            user_id: ç”¨æˆ·ID
            authorization: JWTä»¤ç‰Œ

        Returns:
            è§’è‰²åç§° (OWNER/ADMIN/MEMBER/GUEST) æˆ– None
        """
        try:
            members = await self.get_organization_members(
                organization_id,
                authorization
            )

            # æŸ¥æ‰¾ç”¨æˆ·çš„è§’è‰²
            for member in members:
                if member.get("userId") == user_id:
                    return member.get("role")

            return None

        except Exception as e:
            logger.error(f"è·å–ç”¨æˆ·è§’è‰²å¤±è´¥: {str(e)}")
            return None


# å…¨å±€å®ä¾‹
organization_client = OrganizationClient()
```

#### FastAPIä¾èµ–æ³¨å…¥

**dependencies.py** (`app/api/dependencies.py`):

```python
"""
FastAPIä¾èµ–æ³¨å…¥
éœ€æ±‚ç¼–å·: REQ-JAVA-002

æä¾›è®¤è¯å’Œæƒé™éªŒè¯çš„ä¾èµ–é¡¹
"""
from typing import Optional
from fastapi import Header, HTTPException, Depends
from app.core.jwt_utils import jwt_validator, get_current_user_id
from app.services.organization_client import organization_client


async def get_current_user(
    authorization: str = Header(None)
) -> str:
    """
    è·å–å½“å‰ç”¨æˆ·IDï¼ˆä¾èµ–æ³¨å…¥ï¼‰

    Args:
        authorization: Authorization header

    Returns:
        ç”¨æˆ·ID

    Raises:
        HTTPException: å¦‚æœæœªæˆæƒ
    """
    if not authorization:
        raise HTTPException(status_code=401, detail="ç¼ºå°‘Authorization header")

    try:
        user_id = get_current_user_id(authorization)
        return user_id
    except Exception as e:
        raise HTTPException(status_code=401, detail=str(e))


async def get_optional_user(
    authorization: Optional[str] = Header(None)
) -> Optional[str]:
    """
    è·å–å½“å‰ç”¨æˆ·IDï¼ˆå¯é€‰ï¼Œä¾èµ–æ³¨å…¥ï¼‰

    Args:
        authorization: Authorization header

    Returns:
        ç”¨æˆ·ID æˆ– None
    """
    if not authorization:
        return None

    try:
        return get_current_user_id(authorization)
    except Exception:
        return None


async def verify_organization_access(
    organization_id: str,
    current_user: str = Depends(get_current_user),
    authorization: str = Header(None)
) -> bool:
    """
    éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰ç»„ç»‡è®¿é—®æƒé™

    Args:
        organization_id: ç»„ç»‡ID
        current_user: å½“å‰ç”¨æˆ·ID
        authorization: Authorization header

    Returns:
        æ˜¯å¦æœ‰æƒé™

    Raises:
        HTTPException: å¦‚æœæ— æƒé™
    """
    is_member = await organization_client.check_user_membership(
        organization_id,
        current_user,
        authorization
    )

    if not is_member:
        raise HTTPException(
            status_code=403,
            detail="æ‚¨ä¸æ˜¯è¯¥ç»„ç»‡çš„æˆå‘˜"
        )

    return True


async def verify_organization_admin(
    organization_id: str,
    current_user: str = Depends(get_current_user),
    authorization: str = Header(None)
) -> bool:
    """
    éªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºç»„ç»‡ç®¡ç†å‘˜

    Args:
        organization_id: ç»„ç»‡ID
        current_user: å½“å‰ç”¨æˆ·ID
        authorization: Authorization header

    Returns:
        æ˜¯å¦ä¸ºç®¡ç†å‘˜

    Raises:
        HTTPException: å¦‚æœæ— æƒé™
    """
    role = await organization_client.get_user_role_in_organization(
        organization_id,
        current_user,
        authorization
    )

    if role not in ["OWNER", "ADMIN"]:
        raise HTTPException(
            status_code=403,
            detail="æƒé™ä¸è¶³ï¼Œéœ€è¦ç®¡ç†å‘˜æˆ–æ‰€æœ‰è€…æƒé™"
        )

    return True
```

#### AIæœåŠ¡ä¸­ä½¿ç”¨ç¤ºä¾‹

**ai_endpoints.py** (`app/api/endpoints/ai_endpoints.py`):

```python
"""
AIæœåŠ¡APIç«¯ç‚¹ç¤ºä¾‹
éœ€æ±‚ç¼–å·: REQ-AI-002

å±•ç¤ºå¦‚ä½•åœ¨AIæœåŠ¡ä¸­ä½¿ç”¨ç»„ç»‡æƒé™éªŒè¯
"""
from fastapi import APIRouter, Depends, Header
from app.api.dependencies import get_current_user, verify_organization_access
from app.services.organization_client import organization_client

router = APIRouter(prefix="/api/v1/ai", tags=["AIæœåŠ¡"])


@router.post("/generate-content")
async def generate_content(
    organization_id: str,
    document_id: str,
    prompt: str,
    current_user: str = Depends(get_current_user),
    authorization: str = Header(None),
    _: bool = Depends(verify_organization_access)
):
    """
    AIå†…å®¹ç”Ÿæˆæ¥å£

    éœ€è¦ç”¨æˆ·æ˜¯ç»„ç»‡æˆå‘˜æ‰èƒ½è°ƒç”¨
    """
    # è·å–ç»„ç»‡ä¿¡æ¯
    org_info = await organization_client.get_organization_by_id(
        organization_id,
        authorization
    )

    # AIå†…å®¹ç”Ÿæˆé€»è¾‘...
    # è¿™é‡Œå¯ä»¥ä½¿ç”¨org_infoä¸­çš„ç»„ç»‡ä¸Šä¸‹æ–‡ä¿¡æ¯

    return {
        "success": True,
        "data": {
            "content": "ç”Ÿæˆçš„å†…å®¹...",
            "organization_name": org_info.get("name")
        }
    }


@router.post("/analyze-requirements")
async def analyze_requirements(
    organization_id: str,
    document_id: str,
    current_user: str = Depends(get_current_user),
    authorization: str = Header(None)
):
    """
    éœ€æ±‚åˆ†ææ¥å£

    ä¸å¼ºåˆ¶éªŒè¯ç»„ç»‡æˆå‘˜å…³ç³»ï¼Œä½†ä¼šè®°å½•ç”¨æˆ·ä¿¡æ¯
    """
    # å¯é€‰ï¼šè·å–ç»„ç»‡ä¿¡æ¯
    org_info = await organization_client.get_organization_by_id(
        organization_id,
        authorization
    )

    # AIéœ€æ±‚åˆ†æé€»è¾‘...

    return {
        "success": True,
        "data": {
            "requirements": [...],
            "analyzed_by": current_user
        }
    }
```

#### Pythoné›†æˆæµ‹è¯•

**test_organization_integration.py** (`tests/integration/test_organization_integration.py`):

```python
"""
ç»„ç»‡é›†æˆæµ‹è¯•
éœ€æ±‚ç¼–å·: REQ-JAVA-002

æµ‹è¯•PythonæœåŠ¡ä¸JavaæœåŠ¡çš„é›†æˆ
"""
import pytest
from httpx import AsyncClient
from app.core.jwt_utils import jwt_validator
from app.services.organization_client import organization_client


@pytest.mark.asyncio
class TestOrganizationIntegration:
    """ç»„ç»‡é›†æˆæµ‹è¯•"""

    @pytest.fixture
    def test_token(self):
        """ç”Ÿæˆæµ‹è¯•JWTä»¤ç‰Œ"""
        import jwt
        from datetime import datetime, timedelta

        payload = {
            "user_id": "550e8400-e29b-41d4-a716-446655440000",
            "organization_id": "660e8400-e29b-41d4-a716-446655440000",
            "roles": ["ADMIN"],
            "exp": datetime.utcnow() + timedelta(hours=1)
        }

        token = jwt.encode(
            payload,
            "test_secret_key",
            algorithm="HS256"
        )

        return f"Bearer {token}"

    async def test_jwt_decode(self, test_token):
        """æµ‹è¯•JWTè§£ç """
        payload = jwt_validator.decode_token(test_token)

        assert payload["user_id"] == "550e8400-e29b-41d4-a716-446655440000"
        assert payload["organization_id"] == "660e8400-e29b-41d4-a716-446655440000"
        assert "ADMIN" in payload["roles"]

    async def test_get_organization(self, test_token):
        """æµ‹è¯•è·å–ç»„ç»‡ä¿¡æ¯"""
        organization_id = "660e8400-e29b-41d4-a716-446655440000"

        org = await organization_client.get_organization_by_id(
            organization_id,
            test_token
        )

        # éªŒè¯è¿”å›æ•°æ®
        if org:  # å¦‚æœJavaæœåŠ¡è¿è¡Œä¸­
            assert org.get("id") == organization_id
            assert "name" in org

    async def test_check_membership(self, test_token):
        """æµ‹è¯•æˆå‘˜å…³ç³»æ£€æŸ¥"""
        organization_id = "660e8400-e29b-41d4-a716-446655440000"
        user_id = "550e8400-e29b-41d4-a716-446655440000"

        is_member = await organization_client.check_user_membership(
            organization_id,
            user_id,
            test_token
        )

        # æˆå‘˜å…³ç³»æ£€æŸ¥åº”è¯¥ä¸æŠ›å‡ºå¼‚å¸¸
        assert isinstance(is_member, bool)

    async def test_get_user_role(self, test_token):
        """æµ‹è¯•è·å–ç”¨æˆ·è§’è‰²"""
        organization_id = "660e8400-e29b-41d4-a716-446655440000"
        user_id = "550e8400-e29b-41d4-a716-446655440000"

        role = await organization_client.get_user_role_in_organization(
            organization_id,
            user_id,
            test_token
        )

        # è§’è‰²åº”è¯¥æ˜¯Noneæˆ–è€…æœ‰æ•ˆçš„è§’è‰²å­—ç¬¦ä¸²
        assert role is None or role in ["OWNER", "ADMIN", "MEMBER", "GUEST"]


@pytest.mark.asyncio
async def test_ai_endpoint_with_auth(test_token):
    """æµ‹è¯•å¸¦è®¤è¯çš„AIç«¯ç‚¹"""
    async with AsyncClient(base_url="http://localhost:8001") as client:
        response = await client.post(
            "/api/v1/ai/generate-content",
            json={
                "organization_id": "660e8400-e29b-41d4-a716-446655440000",
                "document_id": "770e8400-e29b-41d4-a716-446655440000",
                "prompt": "ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ"
            },
            headers={"Authorization": test_token}
        )

        # éªŒè¯å“åº”
        assert response.status_code in [200, 401, 403, 503]
        # 200: æˆåŠŸ, 401: æœªæˆæƒ, 403: æ— æƒé™, 503: JavaæœåŠ¡ä¸å¯ç”¨
```

#### é…ç½®æ–‡ä»¶æ›´æ–°

**config.py** (`app/core/config.py`):

```python
"""
åº”ç”¨é…ç½®
éœ€æ±‚ç¼–å·: REQ-JAVA-002

æ·»åŠ JWTå’ŒJavaæœåŠ¡ç›¸å…³é…ç½®
"""
from pydantic_settings import BaseSettings
from typing import Optional


class Settings(BaseSettings):
    """åº”ç”¨é…ç½®"""

    # åº”ç”¨åŸºæœ¬é…ç½®
    APP_NAME: str = "AIBidComposer AI Service"
    DEBUG: bool = False
    ENV: str = "production"

    # JWTé…ç½®
    JWT_SECRET_KEY: str  # å¿…é¡»ä¸JavaæœåŠ¡ä½¿ç”¨ç›¸åŒçš„å¯†é’¥
    JWT_ALGORITHM: str = "HS256"

    # JavaæœåŠ¡é…ç½®
    JAVA_SERVICE_URL: str = "http://localhost:8080"

    # æ•°æ®åº“é…ç½®ï¼ˆåªè¯»è®¿é—®ï¼‰
    POSTGRES_HOST: str = "localhost"
    POSTGRES_PORT: int = 5432
    POSTGRES_DB: str = "aibidcomposer"
    POSTGRES_USER: str = "readonly_user"  # ä½¿ç”¨åªè¯»ç”¨æˆ·
    POSTGRES_PASSWORD: str

    # Redisé…ç½®
    REDIS_URL: str = "redis://localhost:6379/0"

    # Elasticsearché…ç½®
    ELASTICSEARCH_URL: str = "http://localhost:9200"
    ELASTICSEARCH_USER: Optional[str] = None
    ELASTICSEARCH_PASSWORD: Optional[str] = None

    # OpenAIé…ç½®
    OPENAI_API_KEY: str

    # Anthropicé…ç½®
    ANTHROPIC_API_KEY: Optional[str] = None

    class Config:
        env_file = ".env"
        case_sensitive = True


settings = Settings()
```

#### ç¯å¢ƒå˜é‡é…ç½®

**.env.example** (PythonæœåŠ¡):

```bash
# JWTé…ç½®ï¼ˆä¸JavaæœåŠ¡ä¿æŒä¸€è‡´ï¼‰
JWT_SECRET_KEY=your_secret_key_min_32_characters_long
JWT_ALGORITHM=HS256

# JavaæœåŠ¡URL
JAVA_SERVICE_URL=http://localhost:8080

# æ•°æ®åº“é…ç½®ï¼ˆåªè¯»ç”¨æˆ·ï¼‰
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=aibidcomposer
POSTGRES_USER=readonly_user
POSTGRES_PASSWORD=readonly_password

# Redis
REDIS_URL=redis://localhost:6379/0

# Elasticsearch
ELASTICSEARCH_URL=http://localhost:9200
ELASTICSEARCH_USER=elastic
ELASTICSEARCH_PASSWORD=your_elasticsearch_password

# AIæœåŠ¡
OPENAI_API_KEY=sk-your-openai-api-key
ANTHROPIC_API_KEY=your-anthropic-api-key
```

---

### 2.1.5: éƒ¨ç½²

**éªŒè¯æ¸…å•**:
- [ ] Docker Compose é…ç½®å®Œæˆï¼ˆå¼€å‘ç¯å¢ƒä¸€é”®å¯åŠ¨ï¼‰
- [ ] Kubernetes Deployment å’Œ Service é…ç½®å®Œæˆ
- [ ] ConfigMap å’Œ Secret ç®¡ç†é…ç½®å®Œæˆ
- [ ] å¥åº·æ£€æŸ¥å’Œå°±ç»ªæ£€æŸ¥é…ç½®å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡ç®¡ç†å’Œé…ç½®åˆ†ç¦»å®Œæˆ
- [ ] CI/CD æµæ°´çº¿é…ç½®å®Œæˆï¼ˆæ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ï¼‰
- [ ] ç›‘æ§å’Œæ—¥å¿—æ”¶é›†é…ç½®å®Œæˆ

#### Docker Compose é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**docker-compose.yml**:
```yaml
# docker-compose.yml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
# ç»„ç»‡ç®¡ç†åŠŸèƒ½ - å¼€å‘ç¯å¢ƒéƒ¨ç½²é…ç½®

version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:14-alpine
    container_name: aibidcomposer-postgres
    environment:
      POSTGRES_DB: aibidcomposer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aibidcomposer-network

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: aibidcomposer-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - aibidcomposer-network

  # Elasticsearch (å‘é‡å­˜å‚¨)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.1
    container_name: aibidcomposer-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD:-elastic}
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -u elastic:${ELASTICSEARCH_PASSWORD:-elastic} -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - aibidcomposer-network

  # RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: aibidcomposer-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq}
    ports:
      - "5672:5672"
      - "15672:15672"  # ç®¡ç†ç•Œé¢
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - aibidcomposer-network

  # MinIO å¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    container_name: aibidcomposer-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - aibidcomposer-network

  # Java Spring Boot æœåŠ¡
  backend-java:
    build:
      context: ./apps/backend-java
      dockerfile: Dockerfile.dev
    container_name: aibidcomposer-backend-java
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/aibidcomposer
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis}
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-rabbitmq}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-rabbitmq}
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      AI_SERVICE_URL: http://backend-python:8001
      JWT_SECRET: ${JWT_SECRET_KEY}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./apps/backend-java/src:/app/src
      - ./apps/backend-java/target:/app/target
      - maven_cache:/root/.m2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - aibidcomposer-network

  # Python FastAPI AI æœåŠ¡
  backend-python:
    build:
      context: ./apps/backend-python
      dockerfile: Dockerfile
    container_name: aibidcomposer-backend-python
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@rabbitmq:5672/
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_USER: elastic
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD:-elastic}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      JAVA_SERVICE_URL: http://backend-java:8080
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
    ports:
      - "8001:8001"
    depends_on:
      - redis
      - rabbitmq
      - elasticsearch
      - backend-java
    volumes:
      - ./apps/backend-python/app:/app/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - aibidcomposer-network
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload

  # Celery Worker (AI å¼‚æ­¥ä»»åŠ¡)
  celery-worker:
    build:
      context: ./apps/backend-python
      dockerfile: Dockerfile
    container_name: aibidcomposer-celery-worker
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@rabbitmq:5672/
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_USER: elastic
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD:-elastic}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      JAVA_SERVICE_URL: http://backend-java:8080
    depends_on:
      - redis
      - rabbitmq
      - elasticsearch
      - backend-java
    volumes:
      - ./apps/backend-python/app:/app/app
    networks:
      - aibidcomposer-network
    command: celery -A app.tasks.celery_app worker --loglevel=info -Q ai_tasks

  # Celery Beat (å®šæ—¶ä»»åŠ¡è°ƒåº¦)
  celery-beat:
    build:
      context: ./apps/backend-python
      dockerfile: Dockerfile
    container_name: aibidcomposer-celery-beat
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@rabbitmq:5672/
    depends_on:
      - redis
      - rabbitmq
    volumes:
      - ./apps/backend-python/app:/app/app
    networks:
      - aibidcomposer-network
    command: celery -A app.tasks.celery_app beat --loglevel=info

  # React å‰ç«¯
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile.dev
    container_name: aibidcomposer-frontend
    environment:
      VITE_API_BASE_URL: http://localhost:8080
      VITE_AI_API_BASE_URL: http://localhost:8001
      VITE_WS_BASE_URL: ws://localhost:8080
    ports:
      - "5173:5173"
    volumes:
      - ./apps/frontend/src:/app/src
      - ./apps/frontend/public:/app/public
      - node_modules:/app/node_modules
    depends_on:
      - backend-java
      - backend-python
    networks:
      - aibidcomposer-network
    command: npm run dev -- --host 0.0.0.0

volumes:
  postgres_data:
  redis_data:
  elasticsearch_data:
  rabbitmq_data:
  minio_data:
  maven_cache:
  node_modules:

networks:
  aibidcomposer-network:
    driver: bridge
```

**å¯åŠ¨è„šæœ¬ (scripts/start-dev.sh)**:
```bash
#!/bin/bash
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
# å¼€å‘ç¯å¢ƒä¸€é”®å¯åŠ¨è„šæœ¬

set -e

echo "ğŸš€ å¯åŠ¨ AIBidComposer å¼€å‘ç¯å¢ƒ..."

# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Docker Desktop"
    exit 1
fi

# æ£€æŸ¥ .env æ–‡ä»¶
if [ ! -f .env ]; then
    echo "âš ï¸  .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¤åˆ¶ .env.example åˆ›å»º..."
    cp .env.example .env
    echo "âœ… .env æ–‡ä»¶å·²åˆ›å»ºï¼Œè¯·ç¼–è¾‘é…ç½®åé‡æ–°è¿è¡Œ"
    exit 1
fi

# åœæ­¢å·²æœ‰å®¹å™¨
echo "ğŸ›‘ åœæ­¢å·²æœ‰å®¹å™¨..."
docker-compose down

# æ„å»ºé•œåƒ
echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
docker-compose build

# å¯åŠ¨æœåŠ¡
echo "ğŸŒŸ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
docker-compose up -d

# ç­‰å¾…æœåŠ¡å°±ç»ª
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥å¥åº·çŠ¶æ€
echo "ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
docker-compose ps

# æ˜¾ç¤ºæœåŠ¡ URL
echo ""
echo "âœ… å¼€å‘ç¯å¢ƒå¯åŠ¨æˆåŠŸï¼"
echo ""
echo "ğŸ“Š æœåŠ¡è®¿é—®åœ°å€ï¼š"
echo "  - å‰ç«¯:          http://localhost:5173"
echo "  - Java API:      http://localhost:8080"
echo "  - Python AI API: http://localhost:8001"
echo "  - Swagger UI:    http://localhost:8080/swagger-ui.html"
echo "  - MinIO Console: http://localhost:9001"
echo "  - RabbitMQ UI:   http://localhost:15672"
echo ""
echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f [service-name]"
echo "ğŸ›‘ åœæ­¢æœåŠ¡: docker-compose down"
echo ""
```

#### Kubernetes é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**Namespace**:
```yaml
# k8s/namespaces/aibidcomposer.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: v1
kind: Namespace
metadata:
  name: aibidcomposer
  labels:
    name: aibidcomposer
    environment: production
```

**ConfigMap - Java æœåŠ¡é…ç½®**:
```yaml
# k8s/configmaps/backend-java-config.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-java-config
  namespace: aibidcomposer
data:
  SPRING_PROFILES_ACTIVE: "prod"
  SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres-service:5432/aibidcomposer"
  SPRING_REDIS_HOST: "redis-service"
  SPRING_RABBITMQ_HOST: "rabbitmq-service"
  MINIO_ENDPOINT: "http://minio-service:9000"
  AI_SERVICE_URL: "http://backend-python-service:8001"
  TZ: "Asia/Shanghai"
  LOG_LEVEL: "INFO"
```

**ConfigMap - Python AI æœåŠ¡é…ç½®**:
```yaml
# k8s/configmaps/backend-python-config.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-python-config
  namespace: aibidcomposer
data:
  ELASTICSEARCH_URL: "http://elasticsearch-service:9200"
  JAVA_SERVICE_URL: "http://backend-java-service:8080"
  JWT_ALGORITHM: "HS256"
  TZ: "Asia/Shanghai"
  LOG_LEVEL: "INFO"
  WORKERS: "4"
```

**Secret - æ•æ„Ÿä¿¡æ¯**:
```yaml
# k8s/secrets/database-secret.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
# æ³¨æ„: å®é™…éƒ¨ç½²æ—¶ä½¿ç”¨ Sealed Secrets æˆ– HashiCorp Vault
apiVersion: v1
kind: Secret
metadata:
  name: database-secret
  namespace: aibidcomposer
type: Opaque
stringData:
  POSTGRES_PASSWORD: "your_secure_password"
  SPRING_DATASOURCE_USERNAME: "postgres"
  SPRING_DATASOURCE_PASSWORD: "your_secure_password"

---
# k8s/secrets/api-keys-secret.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: v1
kind: Secret
metadata:
  name: api-keys-secret
  namespace: aibidcomposer
type: Opaque
stringData:
  OPENAI_API_KEY: "sk-your-openai-api-key"
  ANTHROPIC_API_KEY: "your-anthropic-api-key"
  JWT_SECRET_KEY: "your_secret_key_min_32_characters_long"
  REDIS_PASSWORD: "your_redis_password"
  RABBITMQ_USER: "rabbitmq"
  RABBITMQ_PASSWORD: "your_rabbitmq_password"
  ELASTICSEARCH_PASSWORD: "your_elasticsearch_password"
```

**Deployment - Java Spring Boot æœåŠ¡**:
```yaml
# k8s/deployments/backend-java-deployment.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-java
  namespace: aibidcomposer
  labels:
    app: backend-java
    component: api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend-java
  template:
    metadata:
      labels:
        app: backend-java
        version: v1
    spec:
      containers:
      - name: backend-java
        image: aibidcomposer/backend-java:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        env:
        # ConfigMap å¼•ç”¨
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-java-config
              key: SPRING_PROFILES_ACTIVE
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            configMapKeyRef:
              name: backend-java-config
              key: SPRING_DATASOURCE_URL
        - name: SPRING_REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: backend-java-config
              key: SPRING_REDIS_HOST
        # Secret å¼•ç”¨
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: SPRING_DATASOURCE_USERNAME
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: SPRING_DATASOURCE_PASSWORD
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: JWT_SECRET_KEY
        - name: SPRING_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: REDIS_PASSWORD
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        volumeMounts:
        - name: logs
          mountPath: /app/logs
      volumes:
      - name: logs
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: backend-java-service
  namespace: aibidcomposer
  labels:
    app: backend-java
spec:
  type: ClusterIP
  selector:
    app: backend-java
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
    name: http
```

**Deployment - Python AI æœåŠ¡**:
```yaml
# k8s/deployments/backend-python-deployment.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-python
  namespace: aibidcomposer
  labels:
    app: backend-python
    component: ai
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend-python
  template:
    metadata:
      labels:
        app: backend-python
        version: v1
    spec:
      containers:
      - name: backend-python
        image: aibidcomposer/backend-python:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8001
          name: http
          protocol: TCP
        env:
        # ConfigMap å¼•ç”¨
        - name: ELASTICSEARCH_URL
          valueFrom:
            configMapKeyRef:
              name: backend-python-config
              key: ELASTICSEARCH_URL
        - name: JAVA_SERVICE_URL
          valueFrom:
            configMapKeyRef:
              name: backend-python-config
              key: JAVA_SERVICE_URL
        - name: JWT_ALGORITHM
          valueFrom:
            configMapKeyRef:
              name: backend-python-config
              key: JWT_ALGORITHM
        # Secret å¼•ç”¨
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: OPENAI_API_KEY
        - name: JWT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: JWT_SECRET_KEY
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: REDIS_PASSWORD
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: ELASTICSEARCH_PASSWORD
        # ç»„åˆé…ç½®
        - name: REDIS_URL
          value: "redis://:$(REDIS_PASSWORD)@redis-service:6379/0"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: backend-python-service
  namespace: aibidcomposer
  labels:
    app: backend-python
spec:
  type: ClusterIP
  selector:
    app: backend-python
  ports:
  - protocol: TCP
    port: 8001
    targetPort: 8001
    name: http
```

**HorizontalPodAutoscaler - è‡ªåŠ¨æ‰©ç¼©å®¹**:
```yaml
# k8s/hpa/backend-java-hpa.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-java-hpa
  namespace: aibidcomposer
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend-java
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max

---
# k8s/hpa/backend-python-hpa.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-python-hpa
  namespace: aibidcomposer
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend-python
  minReplicas: 2
  maxReplicas: 8
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**Ingress - è·¯ç”±é…ç½®**:
```yaml
# k8s/ingress/ingress.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: aibidcomposer-ingress
  namespace: aibidcomposer
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
spec:
  tls:
  - hosts:
    - api.aibidcomposer.com
    secretName: aibidcomposer-tls
  rules:
  - host: api.aibidcomposer.com
    http:
      paths:
      # Java ä¸šåŠ¡ API è·¯ç”±
      - path: /api/v1/organizations
        pathType: Prefix
        backend:
          service:
            name: backend-java-service
            port:
              number: 8080
      - path: /api/v1/auth
        pathType: Prefix
        backend:
          service:
            name: backend-java-service
            port:
              number: 8080
      # Python AI API è·¯ç”±
      - path: /api/v1/ai
        pathType: Prefix
        backend:
          service:
            name: backend-python-service
            port:
              number: 8001
      # é»˜è®¤è·¯ç”±åˆ° Java æœåŠ¡
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-java-service
            port:
              number: 8080
```

#### CI/CD æµæ°´çº¿é…ç½®

**GitLab CI/CD (.gitlab-ci.yml)**:
```yaml
# .gitlab-ci.yml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
# GitLab CI/CD æµæ°´çº¿é…ç½®

stages:
  - build
  - test
  - docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_REGISTRY: registry.example.com
  JAVA_IMAGE: ${DOCKER_REGISTRY}/aibidcomposer/backend-java
  PYTHON_IMAGE: ${DOCKER_REGISTRY}/aibidcomposer/backend-python

cache:
  paths:
    - .m2/repository
    - node_modules/
    - apps/backend-python/.venv/

# ============ Java æœåŠ¡æ„å»º ============
build:java:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd apps/backend-java
    - mvn clean compile -DskipTests
  artifacts:
    paths:
      - apps/backend-java/target/
    expire_in: 1 hour
  only:
    changes:
      - apps/backend-java/**/*

# ============ Java å•å…ƒæµ‹è¯• ============
test:java:unit:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  services:
    - postgres:14-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    SPRING_PROFILES_ACTIVE: test
  script:
    - cd apps/backend-java
    - mvn test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit:
        - apps/backend-java/target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: apps/backend-java/target/site/cobertura/coverage.xml
  only:
    changes:
      - apps/backend-java/**/*

# ============ Python æœåŠ¡æµ‹è¯• ============
test:python:unit:
  stage: test
  image: python:3.11-slim
  services:
    - postgres:14-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
  before_script:
    - cd apps/backend-python
    - pip install -r requirements/test.txt
  script:
    - pytest --cov=app --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: apps/backend-python/coverage.xml
  only:
    changes:
      - apps/backend-python/**/*

# ============ Docker é•œåƒæ„å»º - Java ============
docker:build:java:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
  script:
    - cd apps/backend-java
    - docker build -t ${JAVA_IMAGE}:${CI_COMMIT_SHORT_SHA} -t ${JAVA_IMAGE}:latest .
    - docker push ${JAVA_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker push ${JAVA_IMAGE}:latest
  only:
    - master
    - develop
  needs:
    - test:java:unit

# ============ Docker é•œåƒæ„å»º - Python ============
docker:build:python:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
  script:
    - cd apps/backend-python
    - docker build -t ${PYTHON_IMAGE}:${CI_COMMIT_SHORT_SHA} -t ${PYTHON_IMAGE}:latest .
    - docker push ${PYTHON_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker push ${PYTHON_IMAGE}:latest
  only:
    - master
    - develop
  needs:
    - test:python:unit

# ============ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ ============
deploy:staging:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - kubectl config use-context staging
  script:
    - kubectl set image deployment/backend-java backend-java=${JAVA_IMAGE}:${CI_COMMIT_SHORT_SHA} -n aibidcomposer
    - kubectl set image deployment/backend-python backend-python=${PYTHON_IMAGE}:${CI_COMMIT_SHORT_SHA} -n aibidcomposer
    - kubectl rollout status deployment/backend-java -n aibidcomposer
    - kubectl rollout status deployment/backend-python -n aibidcomposer
  environment:
    name: staging
    url: https://staging.aibidcomposer.com
  only:
    - develop
  when: manual

# ============ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ ============
deploy:production:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - kubectl config use-context production
  script:
    - kubectl set image deployment/backend-java backend-java=${JAVA_IMAGE}:${CI_COMMIT_SHORT_SHA} -n aibidcomposer
    - kubectl set image deployment/backend-python backend-python=${PYTHON_IMAGE}:${CI_COMMIT_SHORT_SHA} -n aibidcomposer
    - kubectl rollout status deployment/backend-java -n aibidcomposer --timeout=5m
    - kubectl rollout status deployment/backend-python -n aibidcomposer --timeout=5m
  environment:
    name: production
    url: https://www.aibidcomposer.com
  only:
    - master
  when: manual
```

**GitHub Actions (.github/workflows/ci-cd.yml)**:
```yaml
# .github/workflows/ci-cd.yml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
# GitHub Actions CI/CD æµæ°´çº¿

name: CI/CD Pipeline

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

env:
  REGISTRY: ghcr.io
  JAVA_IMAGE: ghcr.io/${{ github.repository }}/backend-java
  PYTHON_IMAGE: ghcr.io/${{ github.repository }}/backend-python

jobs:
  # ============ Java æ„å»ºå’Œæµ‹è¯• ============
  build-test-java:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      working-directory: apps/backend-java
      run: mvn clean install -DskipTests

    - name: Run Tests
      working-directory: apps/backend-java
      env:
        SPRING_PROFILES_ACTIVE: test
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/test_db
        SPRING_DATASOURCE_USERNAME: test_user
        SPRING_DATASOURCE_PASSWORD: test_password
      run: mvn test

    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: apps/backend-java/target/site/jacoco/jacoco.xml

  # ============ Python æµ‹è¯• ============
  build-test-python:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
      redis:
        image: redis:7-alpine

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      working-directory: apps/backend-python
      run: |
        pip install -r requirements/test.txt

    - name: Run Tests
      working-directory: apps/backend-python
      run: |
        pytest --cov=app --cov-report=xml

    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: apps/backend-python/coverage.xml

  # ============ Docker é•œåƒæ„å»º ============
  build-docker:
    needs: [build-test-java, build-test-python]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Java image
      uses: docker/build-push-action@v5
      with:
        context: apps/backend-java
        push: true
        tags: |
          ${{ env.JAVA_IMAGE }}:${{ github.sha }}
          ${{ env.JAVA_IMAGE }}:latest

    - name: Build and push Python image
      uses: docker/build-push-action@v5
      with:
        context: apps/backend-python
        push: true
        tags: |
          ${{ env.PYTHON_IMAGE }}:${{ github.sha }}
          ${{ env.PYTHON_IMAGE }}:latest

  # ============ éƒ¨ç½²åˆ° Kubernetes ============
  deploy:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig

    - name: Deploy Java service
      run: |
        kubectl set image deployment/backend-java \
          backend-java=${{ env.JAVA_IMAGE }}:${{ github.sha }} \
          -n aibidcomposer
        kubectl rollout status deployment/backend-java -n aibidcomposer

    - name: Deploy Python service
      run: |
        kubectl set image deployment/backend-python \
          backend-python=${{ env.PYTHON_IMAGE }}:${{ github.sha }} \
          -n aibidcomposer
        kubectl rollout status deployment/backend-python -n aibidcomposer
```

#### ç›‘æ§å’Œæ—¥å¿—é…ç½®

**Prometheus ServiceMonitor**:
```yaml
# k8s/monitoring/servicemonitor.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: backend-java-monitor
  namespace: aibidcomposer
  labels:
    app: backend-java
spec:
  selector:
    matchLabels:
      app: backend-java
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 30s

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: backend-python-monitor
  namespace: aibidcomposer
  labels:
    app: backend-python
spec:
  selector:
    matchLabels:
      app: backend-python
  endpoints:
  - port: http
    path: /metrics
    interval: 30s
```

**Fluentd DaemonSet (æ—¥å¿—æ”¶é›†)**:
```yaml
# k8s/logging/fluentd-daemonset.yaml
# éœ€æ±‚ç¼–å·: REQ-JAVA-002
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: kube-system
spec:
  selector:
    matchLabels:
      k8s-app: fluentd-logging
  template:
    metadata:
      labels:
        k8s-app: fluentd-logging
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.logging.svc.cluster.local"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        - name: FLUENT_ELASTICSEARCH_SCHEME
          value: "http"
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
```

#### éƒ¨ç½²å‘½ä»¤é€ŸæŸ¥

**æœ¬åœ°å¼€å‘ç¯å¢ƒ**:
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./scripts/start-dev.sh

# æˆ–æ‰‹åŠ¨å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend-java
docker-compose logs -f backend-python

# åœæ­¢æœåŠ¡
docker-compose down

# é‡å»ºé•œåƒ
docker-compose build --no-cache
docker-compose up -d
```

**Kubernetes éƒ¨ç½²**:
```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace aibidcomposer

# åº”ç”¨é…ç½®
kubectl apply -f k8s/namespaces/
kubectl apply -f k8s/configmaps/
kubectl apply -f k8s/secrets/

# éƒ¨ç½²æ•°æ®æœåŠ¡ (StatefulSets)
kubectl apply -f k8s/statefulsets/

# éƒ¨ç½²åº”ç”¨æœåŠ¡
kubectl apply -f k8s/deployments/

# åº”ç”¨ HPA
kubectl apply -f k8s/hpa/

# åº”ç”¨ Ingress
kubectl apply -f k8s/ingress/

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n aibidcomposer
kubectl get svc -n aibidcomposer
kubectl get ingress -n aibidcomposer

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/backend-java -n aibidcomposer
kubectl logs -f deployment/backend-python -n aibidcomposer

# æ»šåŠ¨æ›´æ–°
kubectl set image deployment/backend-java \
  backend-java=registry.example.com/aibidcomposer/backend-java:v1.0.1 \
  -n aibidcomposer

# å›æ»š
kubectl rollout undo deployment/backend-java -n aibidcomposer

# æ‰©å®¹/ç¼©å®¹
kubectl scale deployment backend-java --replicas=5 -n aibidcomposer
```

**å¥åº·æ£€æŸ¥**:
```bash
# Java æœåŠ¡å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health
curl http://localhost:8080/actuator/health/liveness
curl http://localhost:8080/actuator/health/readiness

# Python æœåŠ¡å¥åº·æ£€æŸ¥
curl http://localhost:8001/health

# Kubernetes å¥åº·æ£€æŸ¥
kubectl get pods -n aibidcomposer -w
kubectl describe pod <pod-name> -n aibidcomposer
```

---

## Task 2.1 å®Œæˆæ€»ç»“

âœ… **Task 2.1: ç»„ç»‡ç®¡ç†åŠŸèƒ½** - å·²å®Œæˆ 100%

### å·²å®Œæˆçš„5å¤§ç±»åˆ«:

1. âœ… **2.1.1: æ•°æ®å®šä¹‰** - å®Œæ•´çš„å®ä½“è®¾è®¡ã€å…³ç³»æ˜ å°„ã€DTOå®šä¹‰
2. âœ… **2.1.2: å‰ç«¯** - React TypeScriptç»„ä»¶ã€APIé›†æˆã€çŠ¶æ€ç®¡ç†
3. âœ… **2.1.3: Javaåç«¯** - Repositoryã€Serviceã€Controllerã€å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
4. âœ… **2.1.4: Pythonåç«¯** - JWTéªŒè¯ã€HTTPå®¢æˆ·ç«¯ã€ä¾èµ–æ³¨å…¥ã€é›†æˆæµ‹è¯•
5. âœ… **2.1.5: éƒ¨ç½²** - Docker Composeã€Kubernetesã€CI/CDæµæ°´çº¿ã€ç›‘æ§æ—¥å¿—

### äº¤ä»˜æˆæœ:

**ä»£ç æ–‡ä»¶** (~12,370+ è¡Œç”Ÿäº§å°±ç»ªä»£ç ):
- Javaå®ä½“ç±» (Organization, OrganizationMember, DTOs)
- Reactç»„ä»¶ (åˆ—è¡¨ã€è¡¨å•ã€è¯¦æƒ…ã€æˆå‘˜ç®¡ç†)
- Repositoryæ¥å£ (å«PostgreSQLé€’å½’æŸ¥è¯¢)
- Serviceä¸šåŠ¡é€»è¾‘ (å«æƒé™éªŒè¯)
- Controller REST API (11ä¸ªç«¯ç‚¹)
- Python JWTéªŒè¯å·¥å…·
- Python HTTPå®¢æˆ·ç«¯ (è°ƒç”¨JavaæœåŠ¡)
- FastAPIä¾èµ–æ³¨å…¥ (è®¤è¯æˆæƒ)
- å•å…ƒæµ‹è¯• (JUnit + Mockito)
- é›†æˆæµ‹è¯• (MockMvc + pytest)

**éƒ¨ç½²é…ç½®**:
- Docker Compose å¼€å‘ç¯å¢ƒé…ç½®
- Kubernetesç”Ÿäº§ç¯å¢ƒé…ç½® (Deployment, Service, ConfigMap, Secret)
- HPAè‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®
- Ingressè·¯ç”±é…ç½®
- CI/CDæµæ°´çº¿ (GitLab CI + GitHub Actions)
- ç›‘æ§é…ç½® (Prometheus ServiceMonitor)
- æ—¥å¿—æ”¶é›†é…ç½® (Fluentd)

### æŠ€æœ¯äº®ç‚¹:

1. **æ··åˆåç«¯æ¶æ„**: Javaå¤„ç†æ•°æ®ç»´æŠ¤ï¼ŒPythonå¤„ç†AIèƒ½åŠ›ï¼Œé€šè¿‡HTTP REST APIé€šä¿¡
2. **PostgreSQLé€’å½’æŸ¥è¯¢**: å®ç°ç»„ç»‡å±‚çº§æ ‘æŸ¥è¯¢
3. **è½¯åˆ é™¤æ¨¡å¼**: `@SQLDelete` + `@Where` ä¼˜é›…å®ç°é€»è¾‘åˆ é™¤
4. **JWTå…±äº«è®¤è¯**: Javaå’ŒPythonä½¿ç”¨ç›¸åŒå¯†é’¥éªŒè¯ä»¤ç‰Œ
5. **ä¾èµ–æ³¨å…¥**: FastAPIä¾èµ–å®ç°æƒé™éªŒè¯
6. **è‡ªåŠ¨æ‰©ç¼©å®¹**: HPAæ ¹æ®CPU/å†…å­˜è‡ªåŠ¨è°ƒæ•´Podæ•°é‡
7. **CI/CDè‡ªåŠ¨åŒ–**: æ„å»ºã€æµ‹è¯•ã€Dockeré•œåƒã€Kuberneteséƒ¨ç½²å…¨æµç¨‹è‡ªåŠ¨åŒ–

---



---
**ğŸ“– ç»§ç»­**: [Part4 - é¡¹ç›®ç®¡ç†ï¼šæ•°æ®ä¸å‰ç«¯](./task-plan-java-è¯¦ç»†-JAVA-002-Part4.md)
