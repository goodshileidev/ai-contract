# Java Spring Boot æœåŠ¡ä»»åŠ¡è¯¦ç»†è®¡åˆ’ - JAVA-001 Part1

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-001 (å­ä»»åŠ¡ 1.1-1.3)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-26
**åˆ›å»ºè€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º Part1 (å­ä»»åŠ¡1.1-1.3) |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [task-plan-java-è¯¦ç»†-INDEX.md](./task-plan-java-è¯¦ç»†-INDEX.md)

**å…¶ä»–éƒ¨åˆ†**:
- [Part2: å­ä»»åŠ¡ 1.4](./task-plan-java-è¯¦ç»†-JAVA-001-Part2.md)
- [Part3: å­ä»»åŠ¡ 1.5-1.6](./task-plan-java-è¯¦ç»†-JAVA-001-Part3.md)

---

## æ¨¡å—æ¦‚è¿°

æœ¬æ–‡æ¡£åŒ…å« **JAVA-001: ç”¨æˆ·è®¤è¯æˆæƒæ¨¡å—** çš„å‰3ä¸ªå­ä»»åŠ¡ï¼š
- 1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½
- 1.2 Spring Security é›†æˆ
- 1.3 ç™»å½•æ³¨å†ŒåŠŸèƒ½

**æŠ€æœ¯æ ˆ**: Java 17 LTS + Spring Boot 3.2.x + Spring Data JPA + Spring Security 6.x

---

## JAVA-001: ç”¨æˆ·è®¤è¯æˆæƒæ¨¡å—

**éœ€æ±‚ç¼–å·**: REQ-JAVA-001
**è´Ÿè´£äºº**: Java åç«¯å¼€å‘
**ä¼˜å…ˆçº§**: P1 - é«˜ä¼˜å…ˆçº§
**å¼€å§‹æ—¶é—´**: YYYY-MM-DD
**é¢„è®¡å®Œæˆ**: YYYY-MM-DD
**å®é™…å®Œæˆ**: -
**å½“å‰çŠ¶æ€**: â¸ï¸ å¾…å¼€å§‹
**å®Œæˆè¿›åº¦**: 0% (0/6 å­ä»»åŠ¡)

### æ¨¡å—ç›®æ ‡

å®ç°å®Œæ•´çš„ç”¨æˆ·è®¤è¯æˆæƒç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
- JWT Token è®¤è¯æœºåˆ¶
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹
- ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†
- å¯†ç å®‰å…¨ç®¡ç†
- Token åˆ·æ–°å’Œå¤±æ•ˆæœºåˆ¶

### æŠ€æœ¯æ¶æ„

```
å‰ç«¯ (React)
    â†“ POST /api/auth/login
Java Controller (UserController, AuthController)
    â†“
Spring Security Filter Chain
    â†“
JWT Token Service
    â†“
UserDetailsService â†’ PostgreSQL (users, roles, permissions)
    â†“
Redis (Token Storage, Blacklist)
```

### æ ¸å¿ƒæŠ€æœ¯æŒ‘æˆ˜

1. **å®‰å…¨æ€§**: å¯†ç åŠ å¯†ï¼ˆBCryptï¼‰ã€Token å®‰å…¨å­˜å‚¨ã€é˜²æ­¢æš´åŠ›ç ´è§£
2. **æ€§èƒ½**: Token éªŒè¯é«˜é¢‘è°ƒç”¨ã€Redis ç¼“å­˜ä¼˜åŒ–
3. **æ‰©å±•æ€§**: æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆOAuth2ã€SSOï¼‰çš„é¢„ç•™æ¥å£
4. **å¯é æ€§**: Token åˆ·æ–°æœºåˆ¶ã€ä¼˜é›…çš„è¿‡æœŸå¤„ç†

---

## 1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½

**é¢„è®¡å·¥ä½œé‡**: 5 äººå¤©
**ä¼˜å…ˆçº§**: P1
**ä¾èµ–**: æ— 

### æŠ€æœ¯å®ç°æ¦‚è¿°

å®ç°ç”¨æˆ·å®ä½“æ¨¡å‹ã€æ•°æ®è®¿é—®å±‚å’ŒåŸºç¡€ä¸šåŠ¡é€»è¾‘ï¼Œä¸ºè®¤è¯æˆæƒæä¾›æ•°æ®åŸºç¡€ã€‚

---

### 1.1.1 æ•°æ®å®šä¹‰

#### PostgreSQL æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- Flyway è¿ç§»è„šæœ¬: V1__create_user_tables.sql
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001

-- users è¡¨ï¼ˆç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼‰
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(200),
    hashed_password VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    avatar_url TEXT,

    -- çŠ¶æ€å­—æ®µ
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,

    -- ç™»å½•ä¿¡æ¯
    last_login_at TIMESTAMP WITH TIME ZONE,
    last_login_ip INET,
    login_count INTEGER DEFAULT 0,
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP WITH TIME ZONE,

    -- ç»„ç»‡å…³è”
    organization_id UUID,

    -- æ‰©å±•å­—æ®µ
    settings JSONB DEFAULT '{}'::jsonb,
    metadata JSONB DEFAULT '{}'::jsonb,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,

    -- å¤–é”®
    FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE SET NULL
);

-- ç´¢å¼•
CREATE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_username ON users(username) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_organization_id ON users(organization_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_status ON users(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_created_at ON users(created_at DESC);

-- æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨ - éœ€æ±‚ç¼–å·: REQ-JAVA-001';
COMMENT ON COLUMN users.status IS 'ç”¨æˆ·çŠ¶æ€: active-æ´»è·ƒ, inactive-æœªæ¿€æ´», suspended-å·²æš‚åœ';
COMMENT ON COLUMN users.settings IS 'ç”¨æˆ·è®¾ç½®(JSON)';
```

#### JPA å®ä½“ç±»è®¾è®¡

```java
// src/main/java/com/aibidcomposer/domain/User.java
package com.aibidcomposer.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.GenericGenerator;
import org.hibernate.annotations.Type;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;
import java.util.Map;
import java.util.UUID;

/**
 * ç”¨æˆ·å®ä½“
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 *
 * @author AIBidComposer Team
 * @since 1.0.0
 */
@Entity
@Table(name = "users")
@EntityListeners(AuditingEntityListener.class)
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class User {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(name = "UUID", strategy = "org.hibernate.id.UUIDGenerator")
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;

    @Column(name = "email", unique = true, nullable = false, length = 255)
    private String email;

    @Column(name = "username", unique = true, nullable = false, length = 100)
    private String username;

    @Column(name = "full_name", length = 200)
    private String fullName;

    @JsonIgnore
    @Column(name = "hashed_password", nullable = false)
    private String hashedPassword;

    @Column(name = "phone", length = 20)
    private String phone;

    @Column(name = "avatar_url")
    private String avatarUrl;

    @Enumerated(EnumType.STRING)
    @Column(name = "status", length = 20, nullable = false)
    private UserStatus status = UserStatus.ACTIVE;

    @Column(name = "email_verified")
    private Boolean emailVerified = false;

    @Column(name = "phone_verified")
    private Boolean phoneVerified = false;

    @Column(name = "last_login_at")
    private LocalDateTime lastLoginAt;

    @Column(name = "last_login_ip")
    private String lastLoginIp;

    @Column(name = "login_count")
    private Integer loginCount = 0;

    @Column(name = "failed_login_attempts")
    private Integer failedLoginAttempts = 0;

    @Column(name = "locked_until")
    private LocalDateTime lockedUntil;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "organization_id")
    private Organization organization;

    @Type(JsonBinaryType.class)
    @Column(name = "settings", columnDefinition = "jsonb")
    private Map<String, Object> settings;

    @Type(JsonBinaryType.class)
    @Column(name = "metadata", columnDefinition = "jsonb")
    private Map<String, Object> metadata;

    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    // ä¸šåŠ¡æ–¹æ³•

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«é”å®š
     */
    public boolean isLocked() {
        return lockedUntil != null && lockedUntil.isAfter(LocalDateTime.now());
    }

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ´»è·ƒ
     */
    public boolean isActive() {
        return status == UserStatus.ACTIVE && !isLocked() && deletedAt == null;
    }

    /**
     * å¢åŠ å¤±è´¥ç™»å½•æ¬¡æ•°
     */
    public void incrementFailedLoginAttempts() {
        this.failedLoginAttempts = (this.failedLoginAttempts == null ? 0 : this.failedLoginAttempts) + 1;

        // è¶…è¿‡5æ¬¡å¤±è´¥å°è¯•ï¼Œé”å®šè´¦å·30åˆ†é’Ÿ
        if (this.failedLoginAttempts >= 5) {
            this.lockedUntil = LocalDateTime.now().plusMinutes(30);
        }
    }

    /**
     * é‡ç½®å¤±è´¥ç™»å½•æ¬¡æ•°
     */
    public void resetFailedLoginAttempts() {
        this.failedLoginAttempts = 0;
        this.lockedUntil = null;
    }

    /**
     * è®°å½•ç™»å½•ä¿¡æ¯
     */
    public void recordLogin(String ipAddress) {
        this.lastLoginAt = LocalDateTime.now();
        this.lastLoginIp = ipAddress;
        this.loginCount = (this.loginCount == null ? 0 : this.loginCount) + 1;
        resetFailedLoginAttempts();
    }
}
```

```java
// src/main/java/com/aibidcomposer/domain/enums/UserStatus.java
package com.aibidcomposer.domain.enums;

/**
 * ç”¨æˆ·çŠ¶æ€æšä¸¾
 */
public enum UserStatus {
    ACTIVE("active", "æ´»è·ƒ"),
    INACTIVE("inactive", "æœªæ¿€æ´»"),
    SUSPENDED("suspended", "å·²æš‚åœ");

    private final String code;
    private final String description;

    UserStatus(String code, String description) {
        this.code = code;
        this.description = description;
    }

    public String getCode() {
        return code;
    }

    public String getDescription() {
        return description;
    }
}
```

#### DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰è®¾è®¡

```java
// src/main/java/com/aibidcomposer/dto/user/UserResponse.java
package com.aibidcomposer.dto.user;

import com.aibidcomposer.domain.User;
import com.aibidcomposer.domain.enums.UserStatus;
import lombok.Builder;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.Map;
import java.util.UUID;

/**
 * ç”¨æˆ·å“åº”DTO
 */
@Data
@Builder
public class UserResponse {
    private UUID id;
    private String email;
    private String username;
    private String fullName;
    private String phone;
    private String avatarUrl;
    private UserStatus status;
    private Boolean emailVerified;
    private Boolean phoneVerified;
    private LocalDateTime lastLoginAt;
    private Integer loginCount;
    private UUID organizationId;
    private String organizationName;
    private Map<String, Object> settings;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    /**
     * ä»Userå®ä½“è½¬æ¢ä¸ºUserResponse
     */
    public static UserResponse from(User user) {
        return UserResponse.builder()
                .id(user.getId())
                .email(user.getEmail())
                .username(user.getUsername())
                .fullName(user.getFullName())
                .phone(user.getPhone())
                .avatarUrl(user.getAvatarUrl())
                .status(user.getStatus())
                .emailVerified(user.getEmailVerified())
                .phoneVerified(user.getPhoneVerified())
                .lastLoginAt(user.getLastLoginAt())
                .loginCount(user.getLoginCount())
                .organizationId(user.getOrganization() != null ? user.getOrganization().getId() : null)
                .organizationName(user.getOrganization() != null ? user.getOrganization().getName() : null)
                .settings(user.getSettings())
                .createdAt(user.getCreatedAt())
                .updatedAt(user.getUpdatedAt())
                .build();
    }
}
```

```java
// src/main/java/com/aibidcomposer/dto/user/UpdateUserRequest.java
package com.aibidcomposer.dto.user;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.Size;
import lombok.Data;

/**
 * æ›´æ–°ç”¨æˆ·è¯·æ±‚DTO
 */
@Data
public class UpdateUserRequest {

    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    @Size(min = 2, max = 100, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨2-100ä¹‹é—´")
    private String username;

    @Size(max = 200, message = "å…¨åé•¿åº¦ä¸èƒ½è¶…è¿‡200")
    private String fullName;

    @Size(max = 20, message = "æ‰‹æœºå·é•¿åº¦ä¸èƒ½è¶…è¿‡20")
    private String phone;

    private String avatarUrl;
}
```

**éªŒè¯æ ‡å‡†**:
- [ ] Flyway è¿ç§»è„šæœ¬æˆåŠŸæ‰§è¡Œ
- [ ] users è¡¨åˆ›å»ºæˆåŠŸï¼Œæ‰€æœ‰ç´¢å¼•å’Œçº¦æŸæ­£ç¡®
- [ ] JPA å®ä½“ç±»é€šè¿‡ç¼–è¯‘ï¼Œæ— è¯­æ³•é”™è¯¯
- [ ] å®ä½“ç±»æ˜ å°„å…³ç³»æ­£ç¡®ï¼ˆéªŒè¯é€šè¿‡ Hibernate DDL éªŒè¯ï¼‰
- [ ] DTO è½¬æ¢æ–¹æ³•æµ‹è¯•é€šè¿‡
- [ ] æšä¸¾ç±»å‹å®šä¹‰å®Œæ•´

### 1.1.2 å‰ç«¯

#### ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆProTableï¼‰

```typescript
// frontend/src/pages/User/UserList.tsx
import React, { useRef } from 'react';
import { ProTable, ProColumns, ActionType } from '@ant-design/pro-components';
import { Button, Tag, Space, message, Modal } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, LockOutlined, UnlockOutlined } from '@ant-design/icons';
import { UserResponse, UserStatus } from '@/services/user';
import { userService } from '@/services/user.service';

/**
 * ç”¨æˆ·åˆ—è¡¨é¡µé¢
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
const UserList: React.FC = () => {
  const actionRef = useRef<ActionType>();

  const columns: ProColumns<UserResponse>[] = [
    {
      title: 'ç”¨æˆ·å',
      dataIndex: 'username',
      copyable: true,
      ellipsis: true,
      width: 150,
    },
    {
      title: 'é‚®ç®±',
      dataIndex: 'email',
      copyable: true,
      ellipsis: true,
      width: 200,
    },
    {
      title: 'å…¨å',
      dataIndex: 'fullName',
      ellipsis: true,
      hideInSearch: true,
      width: 150,
    },
    {
      title: 'æ‰‹æœº',
      dataIndex: 'phone',
      hideInSearch: true,
      width: 120,
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      valueType: 'select',
      valueEnum: {
        'ACTIVE': { text: 'æ´»è·ƒ', status: 'Success' },
        'INACTIVE': { text: 'æœªæ¿€æ´»', status: 'Warning' },
        'SUSPENDED': { text: 'å·²æš‚åœ', status: 'Error' },
      },
      width: 100,
      render: (_, record) => {
        const statusMap = {
          ACTIVE: { color: 'success', text: 'æ´»è·ƒ' },
          INACTIVE: { color: 'warning', text: 'æœªæ¿€æ´»' },
          SUSPENDED: { color: 'error', text: 'å·²æš‚åœ' },
        };
        const status = statusMap[record.status] || { color: 'default', text: record.status };
        return <Tag color={status.color}>{status.text}</Tag>;
      },
    },
    {
      title: 'é‚®ç®±éªŒè¯',
      dataIndex: 'emailVerified',
      valueType: 'select',
      valueEnum: {
        true: { text: 'å·²éªŒè¯', status: 'Success' },
        false: { text: 'æœªéªŒè¯', status: 'Default' },
      },
      hideInSearch: true,
      width: 100,
      render: (_, record) => (
        <Tag color={record.emailVerified ? 'success' : 'default'}>
          {record.emailVerified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}
        </Tag>
      ),
    },
    {
      title: 'ç™»å½•æ¬¡æ•°',
      dataIndex: 'loginCount',
      hideInSearch: true,
      sorter: true,
      width: 100,
    },
    {
      title: 'æœ€åç™»å½•',
      dataIndex: 'lastLoginAt',
      valueType: 'dateTime',
      hideInSearch: true,
      width: 180,
    },
    {
      title: 'ç»„ç»‡',
      dataIndex: 'organizationName',
      ellipsis: true,
      hideInSearch: true,
      width: 150,
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createdAt',
      valueType: 'dateTime',
      hideInSearch: true,
      sorter: true,
      width: 180,
    },
    {
      title: 'æ“ä½œ',
      valueType: 'option',
      width: 200,
      fixed: 'right',
      render: (text, record, _, action) => [
        <a
          key="edit"
          onClick={() => {
            // TODO: æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
            message.info('ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½å¾…å®ç°');
          }}
        >
          <EditOutlined /> ç¼–è¾‘
        </a>,
        <a
          key="suspend"
          onClick={async () => {
            const newStatus = record.status === 'ACTIVE' ? 'SUSPENDED' : 'ACTIVE';
            try {
              await userService.updateUserStatus(record.id, newStatus);
              message.success(`ç”¨æˆ·å·²${newStatus === 'SUSPENDED' ? 'æš‚åœ' : 'æ¿€æ´»'}`);
              action?.reload();
            } catch (error) {
              message.error('æ“ä½œå¤±è´¥');
            }
          }}
        >
          {record.status === 'ACTIVE' ? <LockOutlined /> : <UnlockOutlined />}
          {record.status === 'ACTIVE' ? 'æš‚åœ' : 'æ¿€æ´»'}
        </a>,
        <a
          key="delete"
          onClick={() => {
            Modal.confirm({
              title: 'ç¡®è®¤åˆ é™¤',
              content: `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${record.username}" å—ï¼Ÿ`,
              okText: 'ç¡®è®¤',
              cancelText: 'å–æ¶ˆ',
              okButtonProps: { danger: true },
              onOk: async () => {
                try {
                  await userService.deleteUser(record.id);
                  message.success('ç”¨æˆ·å·²åˆ é™¤');
                  action?.reload();
                } catch (error) {
                  message.error('åˆ é™¤å¤±è´¥');
                }
              },
            });
          }}
        >
          <DeleteOutlined /> åˆ é™¤
        </a>,
      ],
    },
  ];

  return (
    <ProTable<UserResponse>
      columns={columns}
      actionRef={actionRef}
      cardBordered
      request={async (params, sort, filter) => {
        // è°ƒç”¨APIè·å–ç”¨æˆ·åˆ—è¡¨
        const response = await userService.getUsers({
          page: params.current || 1,
          pageSize: params.pageSize || 20,
          username: params.username,
          email: params.email,
          status: params.status,
          sortBy: sort && Object.keys(sort)[0],
          sortOrder: sort && Object.values(sort)[0] === 'ascend' ? 'asc' : 'desc',
        });

        return {
          data: response.data.items,
          success: response.success,
          total: response.data.total,
        };
      }}
      rowKey="id"
      search={{
        labelWidth: 'auto',
      }}
      options={{
        setting: {
          listsHeight: 400,
        },
      }}
      pagination={{
        pageSize: 20,
        showSizeChanger: true,
        showQuickJumper: true,
      }}
      dateFormatter="string"
      headerTitle="ç”¨æˆ·åˆ—è¡¨"
      toolBarRender={() => [
        <Button
          key="button"
          icon={<PlusOutlined />}
          onClick={() => {
            // TODO: æ‰“å¼€åˆ›å»ºç”¨æˆ·å¯¹è¯æ¡†
            message.info('åˆ›å»ºç”¨æˆ·åŠŸèƒ½å¾…å®ç°');
          }}
          type="primary"
        >
          æ–°å»ºç”¨æˆ·
        </Button>,
      ]}
    />
  );
};

export default UserList;
```

#### ç”¨æˆ·æœåŠ¡ï¼ˆAPI Clientï¼‰

```typescript
// frontend/src/services/user.service.ts
import axios from 'axios';

/**
 * ç”¨æˆ·å“åº”æ¥å£
 */
export interface UserResponse {
  id: string;
  email: string;
  username: string;
  fullName: string;
  phone: string;
  avatarUrl: string;
  status: 'ACTIVE' | 'INACTIVE' | 'SUSPENDED';
  emailVerified: boolean;
  phoneVerified: boolean;
  lastLoginAt: string;
  loginCount: number;
  organizationId: string;
  organizationName: string;
  settings: Record<string, any>;
  createdAt: string;
  updatedAt: string;
}

/**
 * åˆ†é¡µå“åº”æ¥å£
 */
export interface PaginatedResponse<T> {
  success: boolean;
  data: {
    items: T[];
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  };
  message?: string;
  timestamp: string;
}

/**
 * ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢å‚æ•°
 */
export interface GetUsersParams {
  page?: number;
  pageSize?: number;
  username?: string;
  email?: string;
  status?: string;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}

/**
 * ç”¨æˆ·æœåŠ¡ç±»
 */
class UserService {
  private baseURL = 'http://localhost:8080/api/v1';

  /**
   * è·å–ç”¨æˆ·åˆ—è¡¨
   */
  async getUsers(params: GetUsersParams): Promise<PaginatedResponse<UserResponse>> {
    const response = await axios.get<PaginatedResponse<UserResponse>>(
      `${this.baseURL}/users`,
      { params }
    );
    return response.data;
  }

  /**
   * è·å–ç”¨æˆ·è¯¦æƒ…
   */
  async getUserById(id: string): Promise<UserResponse> {
    const response = await axios.get<{ success: boolean; data: UserResponse }>(
      `${this.baseURL}/users/${id}`
    );
    return response.data.data;
  }

  /**
   * æ›´æ–°ç”¨æˆ·çŠ¶æ€
   */
  async updateUserStatus(id: string, status: string): Promise<void> {
    await axios.patch(`${this.baseURL}/users/${id}/status`, { status });
  }

  /**
   * åˆ é™¤ç”¨æˆ·
   */
  async deleteUser(id: string): Promise<void> {
    await axios.delete(`${this.baseURL}/users/${id}`);
  }
}

export const userService = new UserService();
```

**éªŒè¯æ ‡å‡†**:
- [ ] ProTable ç»„ä»¶æ­£ç¡®æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
- [ ] åˆ†é¡µã€æ’åºã€ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] çŠ¶æ€æ ‡ç­¾é¢œè‰²æ­£ç¡®ï¼ˆæ´»è·ƒ=ç»¿è‰²ã€æš‚åœ=çº¢è‰²ï¼‰
- [ ] æ“ä½œæŒ‰é’®åŠŸèƒ½æ­£å¸¸ï¼ˆç¼–è¾‘ã€æš‚åœ/æ¿€æ´»ã€åˆ é™¤ï¼‰
- [ ] API è°ƒç”¨æˆåŠŸè¿”å›æ•°æ®
- [ ] é”™è¯¯å¤„ç†å’Œæç¤ºä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

### 1.1.3 Javaåç«¯

#### Repository å±‚

```java
// src/main/java/com/aibidcomposer/repository/UserRepository.java
package com.aibidcomposer.repository;

import com.aibidcomposer.domain.User;
import com.aibidcomposer.domain.enums.UserStatus;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.UUID;

/**
 * ç”¨æˆ·æ•°æ®è®¿é—®å±‚
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 *
 * @author AIBidComposer Team
 */
@Repository
public interface UserRepository extends JpaRepository<User, UUID>, JpaSpecificationExecutor<User> {

    /**
     * æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·ï¼ˆå¿½ç•¥è½¯åˆ é™¤ï¼‰
     */
    @Query("SELECT u FROM User u WHERE u.email = :email AND u.deletedAt IS NULL")
    Optional<User> findByEmail(@Param("email") String email);

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·ï¼ˆå¿½ç•¥è½¯åˆ é™¤ï¼‰
     */
    @Query("SELECT u FROM User u WHERE u.username = :username AND u.deletedAt IS NULL")
    Optional<User> findByUsername(@Param("username") String username);

    /**
     * æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
     */
    @Query("SELECT COUNT(u) > 0 FROM User u WHERE u.email = :email AND u.deletedAt IS NULL")
    boolean existsByEmail(@Param("email") String email);

    /**
     * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
     */
    @Query("SELECT COUNT(u) > 0 FROM User u WHERE u.username = :username AND u.deletedAt IS NULL")
    boolean existsByUsername(@Param("username") String username);

    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    Page<User> findByStatusAndDeletedAtIsNull(UserStatus status, Pageable pageable);

    /**
     * æ ¹æ®ç»„ç»‡IDæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    @Query("SELECT u FROM User u WHERE u.organization.id = :organizationId AND u.deletedAt IS NULL")
    Page<User> findByOrganizationId(@Param("organizationId") UUID organizationId, Pageable pageable);

    /**
     * æœç´¢ç”¨æˆ·ï¼ˆç”¨æˆ·åæˆ–é‚®ç®±åŒ…å«å…³é”®å­—ï¼‰
     */
    @Query("SELECT u FROM User u WHERE " +
           "(LOWER(u.username) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
           "LOWER(u.email) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
           "LOWER(u.fullName) LIKE LOWER(CONCAT('%', :keyword, '%'))) AND " +
           "u.deletedAt IS NULL")
    Page<User> searchUsers(@Param("keyword") String keyword, Pageable pageable);
}
```

#### Service å±‚

```java
// src/main/java/com/aibidcomposer/service/UserService.java
package com.aibidcomposer.service;

import com.aibidcomposer.domain.User;
import com.aibidcomposer.domain.enums.UserStatus;
import com.aibidcomposer.dto.user.UpdateUserRequest;
import com.aibidcomposer.dto.user.UserResponse;
import com.aibidcomposer.exception.ResourceNotFoundException;
import com.aibidcomposer.exception.ValidationException;
import com.aibidcomposer.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * ç”¨æˆ·ä¸šåŠ¡é€»è¾‘æœåŠ¡
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 *
 * @author AIBidComposer Team
 */
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class UserService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
     *
     * @param page é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
     * @param pageSize æ¯é¡µå¤§å°
     * @param status çŠ¶æ€ç­›é€‰ï¼ˆå¯é€‰ï¼‰
     * @param keyword æœç´¢å…³é”®å­—ï¼ˆå¯é€‰ï¼‰
     * @param sortBy æ’åºå­—æ®µ
     * @param sortOrder æ’åºæ–¹å‘
     * @return ç”¨æˆ·åˆ†é¡µæ•°æ®
     */
    @Transactional(readOnly = true)
    public Page<UserResponse> getUsers(
            int page,
            int pageSize,
            UserStatus status,
            String keyword,
            String sortBy,
            String sortOrder
    ) {
        log.debug("è·å–ç”¨æˆ·åˆ—è¡¨: page={}, pageSize={}, status={}, keyword={}",
                  page, pageSize, status, keyword);

        // æ„å»ºåˆ†é¡µå’Œæ’åº
        Sort sort = Sort.by(
            "desc".equalsIgnoreCase(sortOrder) ? Sort.Direction.DESC : Sort.Direction.ASC,
            sortBy != null ? sortBy : "createdAt"
        );
        Pageable pageable = PageRequest.of(page - 1, pageSize, sort);

        Page<User> userPage;

        // æ ¹æ®æ¡ä»¶æŸ¥è¯¢
        if (keyword != null && !keyword.isEmpty()) {
            userPage = userRepository.searchUsers(keyword, pageable);
        } else if (status != null) {
            userPage = userRepository.findByStatusAndDeletedAtIsNull(status, pageable);
        } else {
            userPage = userRepository.findAll(pageable);
        }

        return userPage.map(UserResponse::from);
    }

    /**
     * æ ¹æ®IDè·å–ç”¨æˆ·è¯¦æƒ…
     *
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯
     * @throws ResourceNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     */
    @Transactional(readOnly = true)
    public UserResponse getUserById(UUID userId) {
        log.debug("è·å–ç”¨æˆ·è¯¦æƒ…: userId={}", userId);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        if (user.getDeletedAt() != null) {
            throw new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }

        return UserResponse.from(user);
    }

    /**
     * æ ¹æ®é‚®ç®±è·å–ç”¨æˆ·
     *
     * @param email é‚®ç®±åœ°å€
     * @return ç”¨æˆ·ä¿¡æ¯
     * @throws ResourceNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     */
    @Transactional(readOnly = true)
    public User getUserByEmail(String email) {
        return userRepository.findByEmail(email)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
    }

    /**
     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·
     *
     * @param username ç”¨æˆ·å
     * @return ç”¨æˆ·ä¿¡æ¯
     * @throws ResourceNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     */
    @Transactional(readOnly = true)
    public User getUserByUsername(String username) {
        return userRepository.findByUsername(username)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     *
     * @param userId ç”¨æˆ·ID
     * @param request æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
     * @throws ResourceNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     * @throws ValidationException éªŒè¯å¤±è´¥
     */
    public UserResponse updateUser(UUID userId, UpdateUserRequest request) {
        log.info("æ›´æ–°ç”¨æˆ·ä¿¡æ¯: userId={}", userId);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§
        if (request.getEmail() != null && !request.getEmail().equals(user.getEmail())) {
            if (userRepository.existsByEmail(request.getEmail())) {
                throw new ValidationException("é‚®ç®±å·²è¢«ä½¿ç”¨");
            }
            user.setEmail(request.getEmail());
            user.setEmailVerified(false); // é‡ç½®é‚®ç®±éªŒè¯çŠ¶æ€
        }

        // æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§
        if (request.getUsername() != null && !request.getUsername().equals(user.getUsername())) {
            if (userRepository.existsByUsername(request.getUsername())) {
                throw new ValidationException("ç”¨æˆ·åå·²è¢«ä½¿ç”¨");
            }
            user.setUsername(request.getUsername());
        }

        // æ›´æ–°å…¶ä»–å­—æ®µ
        if (request.getFullName() != null) {
            user.setFullName(request.getFullName());
        }
        if (request.getPhone() != null) {
            user.setPhone(request.getPhone());
            user.setPhoneVerified(false); // é‡ç½®æ‰‹æœºéªŒè¯çŠ¶æ€
        }
        if (request.getAvatarUrl() != null) {
            user.setAvatarUrl(request.getAvatarUrl());
        }

        User savedUser = userRepository.save(user);
        log.info("ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ: userId={}", userId);

        return UserResponse.from(savedUser);
    }

    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€
     *
     * @param userId ç”¨æˆ·ID
     * @param newStatus æ–°çŠ¶æ€
     * @throws ResourceNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     */
    public void updateUserStatus(UUID userId, UserStatus newStatus) {
        log.info("æ›´æ–°ç”¨æˆ·çŠ¶æ€: userId={}, newStatus={}", userId, newStatus);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        user.setStatus(newStatus);
        userRepository.save(user);

        log.info("ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ: userId={}, newStatus={}", userId, newStatus);
    }

    /**
     * åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
     *
     * @param userId ç”¨æˆ·ID
     * @throws ResourceNotFoundException ç”¨æˆ·ä¸å­˜åœ¨
     */
    public void deleteUser(UUID userId) {
        log.info("åˆ é™¤ç”¨æˆ·: userId={}", userId);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        user.setDeletedAt(LocalDateTime.now());
        userRepository.save(user);

        log.info("ç”¨æˆ·åˆ é™¤æˆåŠŸ: userId={}", userId);
    }

    /**
     * è®°å½•ç”¨æˆ·ç™»å½•
     *
     * @param userId ç”¨æˆ·ID
     * @param ipAddress IPåœ°å€
     */
    public void recordLogin(UUID userId, String ipAddress) {
        log.debug("è®°å½•ç”¨æˆ·ç™»å½•: userId={}, ip={}", userId, ipAddress);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        user.recordLogin(ipAddress);
        userRepository.save(user);
    }

    /**
     * å¢åŠ å¤±è´¥ç™»å½•æ¬¡æ•°
     *
     * @param userId ç”¨æˆ·ID
     */
    public void incrementFailedLoginAttempts(UUID userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        user.incrementFailedLoginAttempts();
        userRepository.save(user);

        log.warn("ç”¨æˆ·ç™»å½•å¤±è´¥æ¬¡æ•°å¢åŠ : userId={}, attempts={}",
                 userId, user.getFailedLoginAttempts());
    }
}
```

#### Controller å±‚

```java
// src/main/java/com/aibidcomposer/controller/UserController.java
package com.aibidcomposer.controller;

import com.aibidcomposer.domain.enums.UserStatus;
import com.aibidcomposer.dto.common.ApiResponse;
import com.aibidcomposer.dto.common.PaginatedResponse;
import com.aibidcomposer.dto.user.UpdateUserRequest;
import com.aibidcomposer.dto.user.UpdateUserStatusRequest;
import com.aibidcomposer.dto.user.UserResponse;
import com.aibidcomposer.service.UserService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.UUID;

/**
 * ç”¨æˆ·ç®¡ç† REST API
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 *
 * @author AIBidComposer Team
 */
@RestController
@RequestMapping("/api/v1/users")
@RequiredArgsConstructor
@Slf4j
public class UserController {

    private final UserService userService;

    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨
     *
     * GET /api/v1/users
     *
     * @param page é¡µç ï¼ˆä»1å¼€å§‹ï¼Œé»˜è®¤1ï¼‰
     * @param pageSize æ¯é¡µå¤§å°ï¼ˆé»˜è®¤20ï¼‰
     * @param status çŠ¶æ€ç­›é€‰ï¼ˆå¯é€‰ï¼‰
     * @param keyword æœç´¢å…³é”®å­—ï¼ˆå¯é€‰ï¼‰
     * @param sortBy æ’åºå­—æ®µï¼ˆé»˜è®¤createdAtï¼‰
     * @param sortOrder æ’åºæ–¹å‘ï¼ˆasc/descï¼Œé»˜è®¤descï¼‰
     * @return åˆ†é¡µç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping
    @PreAuthorize("hasAuthority('user:read')")
    public ResponseEntity<PaginatedResponse<UserResponse>> getUsers(
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int pageSize,
            @RequestParam(required = false) UserStatus status,
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder
    ) {
        log.info("APIè¯·æ±‚: GET /api/v1/users, page={}, pageSize={}", page, pageSize);

        Page<UserResponse> userPage = userService.getUsers(
                page, pageSize, status, keyword, sortBy, sortOrder
        );

        return ResponseEntity.ok(PaginatedResponse.from(userPage, "è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸ"));
    }

    /**
     * è·å–ç”¨æˆ·è¯¦æƒ…
     *
     * GET /api/v1/users/{userId}
     *
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·è¯¦æƒ…
     */
    @GetMapping("/{userId}")
    @PreAuthorize("hasAuthority('user:read')")
    public ResponseEntity<ApiResponse<UserResponse>> getUserById(
            @PathVariable UUID userId
    ) {
        log.info("APIè¯·æ±‚: GET /api/v1/users/{}", userId);

        UserResponse user = userService.getUserById(userId);
        return ResponseEntity.ok(ApiResponse.success(user, "è·å–ç”¨æˆ·è¯¦æƒ…æˆåŠŸ"));
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     *
     * PUT /api/v1/users/{userId}
     *
     * @param userId ç”¨æˆ·ID
     * @param request æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
     */
    @PutMapping("/{userId}")
    @PreAuthorize("hasAuthority('user:update')")
    public ResponseEntity<ApiResponse<UserResponse>> updateUser(
            @PathVariable UUID userId,
            @Valid @RequestBody UpdateUserRequest request
    ) {
        log.info("APIè¯·æ±‚: PUT /api/v1/users/{}", userId);

        UserResponse user = userService.updateUser(userId, request);
        return ResponseEntity.ok(ApiResponse.success(user, "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ"));
    }

    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€
     *
     * PATCH /api/v1/users/{userId}/status
     *
     * @param userId ç”¨æˆ·ID
     * @param request çŠ¶æ€æ›´æ–°è¯·æ±‚
     * @return æˆåŠŸå“åº”
     */
    @PatchMapping("/{userId}/status")
    @PreAuthorize("hasAuthority('user:update')")
    public ResponseEntity<ApiResponse<Void>> updateUserStatus(
            @PathVariable UUID userId,
            @Valid @RequestBody UpdateUserStatusRequest request
    ) {
        log.info("APIè¯·æ±‚: PATCH /api/v1/users/{}/status, newStatus={}", userId, request.getStatus());

        userService.updateUserStatus(userId, request.getStatus());
        return ResponseEntity.ok(ApiResponse.success(null, "ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ"));
    }

    /**
     * åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
     *
     * DELETE /api/v1/users/{userId}
     *
     * @param userId ç”¨æˆ·ID
     * @return æˆåŠŸå“åº”
     */
    @DeleteMapping("/{userId}")
    @PreAuthorize("hasAuthority('user:delete')")
    public ResponseEntity<ApiResponse<Void>> deleteUser(
            @PathVariable UUID userId
    ) {
        log.info("APIè¯·æ±‚: DELETE /api/v1/users/{}", userId);

        userService.deleteUser(userId);
        return ResponseEntity.ok(ApiResponse.success(null, "ç”¨æˆ·åˆ é™¤æˆåŠŸ"));
    }
}
```

**éªŒè¯æ ‡å‡†**:
- [ ] Repository å±‚æ‰€æœ‰æŸ¥è¯¢æ–¹æ³•æµ‹è¯•é€šè¿‡
- [ ] Service å±‚ä¸šåŠ¡é€»è¾‘å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >80%
- [ ] Controller å±‚ API æµ‹è¯•é€šè¿‡ï¼ˆä½¿ç”¨ MockMvcï¼‰
- [ ] è½¯åˆ é™¤é€»è¾‘æ­£ç¡®ï¼ˆdeletedAt å­—æ®µï¼‰
- [ ] åˆ†é¡µå’Œæ’åºåŠŸèƒ½æ­£å¸¸
- [ ] å¼‚å¸¸å¤„ç†æ­£ç¡®ï¼ˆResourceNotFoundException, ValidationExceptionï¼‰
- [ ] æ—¥å¿—è®°å½•å®Œæ•´
- [ ] æƒé™æ³¨è§£æ­£ç¡®é…ç½®

### 1.1.4 Pythonåç«¯

> **è¯´æ˜**: ç”¨æˆ·ç®¡ç†åŠŸèƒ½ä¸»è¦ç”± Java æœåŠ¡æä¾›ï¼ŒPython AI æœåŠ¡ä¸ç›´æ¥å¤„ç†ç”¨æˆ· CRUDã€‚
> ä½† Python æœåŠ¡éœ€è¦èƒ½å¤Ÿè°ƒç”¨ Java æœåŠ¡çš„ç”¨æˆ· API æ¥è·å–ç”¨æˆ·ä¿¡æ¯ç”¨äºå®¡è®¡æ—¥å¿—ã€‚

#### Python HTTP å®¢æˆ·ç«¯ï¼ˆè°ƒç”¨ Java æœåŠ¡ï¼‰

```python
# backend/fastapi-ai-service/app/clients/java_client.py
"""
JavaæœåŠ¡HTTPå®¢æˆ·ç«¯
éœ€æ±‚ç¼–å·: REQ-JAVA-001
"""
import httpx
from typing import Optional, Dict, Any
from app.core.config import settings
from app.core.logging import logger

class JavaServiceClient:
    """
    Java Spring BootæœåŠ¡HTTPå®¢æˆ·ç«¯
    ç”¨äºä»Python AIæœåŠ¡è°ƒç”¨JavaæœåŠ¡çš„API
    """

    def __init__(self):
        self.base_url = settings.JAVA_SERVICE_URL  # http://backend-java:8080
        self.timeout = httpx.Timeout(30.0)
        self.client = httpx.AsyncClient(
            base_url=self.base_url,
            timeout=self.timeout
        )

    async def get_user_by_id(self, user_id: str, token: str) -> Optional[Dict[str, Any]]:
        """
        ä»JavaæœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯

        Args:
            user_id: ç”¨æˆ·ID
            token: JWTè®¤è¯Token

        Returns:
            ç”¨æˆ·ä¿¡æ¯å­—å…¸ï¼Œå¦‚æœå¤±è´¥è¿”å›None
        """
        try:
            response = await self.client.get(
                f"/api/v1/users/{user_id}",
                headers={"Authorization": f"Bearer {token}"}
            )

            if response.status_code == 200:
                data = response.json()
                return data.get("data")
            else:
                logger.warning(
                    f"ä»JavaæœåŠ¡è·å–ç”¨æˆ·å¤±è´¥: user_id={user_id}, "
                    f"status={response.status_code}"
                )
                return None

        except httpx.HTTPError as e:
            logger.error(f"è°ƒç”¨JavaæœåŠ¡å¤±è´¥: {str(e)}")
            return None

    async def close(self):
        """å…³é—­HTTPå®¢æˆ·ç«¯"""
        await self.client.aclose()

# å…¨å±€å®ä¾‹
java_client = JavaServiceClient()
```

#### AIä»»åŠ¡å®¡è®¡æ—¥å¿—æ‰©å±•

```python
# backend/fastapi-ai-service/app/services/ai/audit_logger.py
"""
AIä»»åŠ¡å®¡è®¡æ—¥å¿—æœåŠ¡
éœ€æ±‚ç¼–å·: REQ-JAVA-001, REQ-AI-001
"""
from typing import Dict, Any, Optional
from datetime import datetime
from app.clients.java_client import java_client
from app.core.logging import logger

class AIAuditLogger:
    """
    AIä»»åŠ¡å®¡è®¡æ—¥å¿—è®°å½•å™¨
    è®°å½•AIæ“ä½œçš„ç”¨æˆ·ä¿¡æ¯ã€æ“ä½œç±»å‹ã€æ—¶é—´æˆ³ç­‰
    """

    async def log_ai_operation(
        self,
        user_id: str,
        operation_type: str,
        task_id: str,
        details: Dict[str, Any],
        token: Optional[str] = None
    ) -> None:
        """
        è®°å½•AIæ“ä½œæ—¥å¿—

        Args:
            user_id: ç”¨æˆ·ID
            operation_type: æ“ä½œç±»å‹ï¼ˆå¦‚"parse_document", "generate_content"ï¼‰
            task_id: AIä»»åŠ¡ID
            details: æ“ä½œè¯¦æƒ…
            token: JWT Tokenï¼ˆç”¨äºè·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
        """
        # ä»JavaæœåŠ¡è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
        user_info = None
        if token:
            user_info = await java_client.get_user_by_id(user_id, token)

        # æ„å»ºå®¡è®¡æ—¥å¿—
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "user_id": user_id,
            "username": user_info.get("username") if user_info else "unknown",
            "email": user_info.get("email") if user_info else "unknown",
            "operation_type": operation_type,
            "task_id": task_id,
            "details": details
        }

        # è®°å½•åˆ°æ—¥å¿—ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½å­˜å‚¨åˆ°Elasticsearchæˆ–æ•°æ®åº“ï¼‰
        logger.info(
            f"AIæ“ä½œå®¡è®¡: user={log_entry['username']}, "
            f"operation={operation_type}, task={task_id}"
        )

        # TODO: å¯é€‰ - å°†å®¡è®¡æ—¥å¿—å‘é€åˆ°JavaæœåŠ¡å­˜å‚¨åˆ°PostgreSQL
        # await self._send_audit_log_to_java(log_entry, token)

audit_logger = AIAuditLogger()
```

**éªŒè¯æ ‡å‡†**:
- [ ] Python HTTP å®¢æˆ·ç«¯èƒ½å¤ŸæˆåŠŸè°ƒç”¨ Java æœåŠ¡ API
- [ ] Token è®¤è¯æ­£ç¡®ä¼ é€’
- [ ] é”™è¯¯å¤„ç†å¥å£®ï¼ˆç½‘ç»œå¤±è´¥ã€è¶…æ—¶ã€è®¤è¯å¤±è´¥ï¼‰
- [ ] å®¡è®¡æ—¥å¿—è®°å½•å®Œæ•´
- [ ] æ—¥å¿—æ ¼å¼ç¬¦åˆè§„èŒƒ

### 1.1.5 éƒ¨ç½²

#### Docker Composeé…ç½®

```yaml
# docker-compose.ymlï¼ˆéƒ¨åˆ†ï¼‰
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:14-alpine
    container_name: aibidcomposer-postgres
    environment:
      POSTGRES_DB: aibidcomposer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend-java/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Java Spring Boot æœåŠ¡
  backend-java:
    build:
      context: ./backend-java
      dockerfile: Dockerfile.dev
    container_name: aibidcomposer-backend-java
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/aibidcomposer
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis}
      JWT_SECRET: ${SECRET_KEY}
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_AIBIDCOMPOSER: DEBUG
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend-java/src:/app/src
      - ./backend-java/target:/app/target

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: aibidcomposer-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres_data:
  redis_data:
```

#### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.example
# æ•°æ®åº“é…ç½®
POSTGRES_PASSWORD=your_secure_password_here
DATABASE_URL=postgresql://postgres:your_secure_password_here@postgres:5432/aibidcomposer

# Redisé…ç½®
REDIS_PASSWORD=your_redis_password_here

# JWTé…ç½®
SECRET_KEY=your_jwt_secret_key_min_32_characters_long
JWT_EXPIRATION=3600
JWT_REFRESH_EXPIRATION=604800

# åº”ç”¨é…ç½®
SPRING_PROFILES_ACTIVE=dev
LOGGING_LEVEL_ROOT=INFO
```

#### Spring Boot application.yml

```yaml
# backend-java/src/main/resources/application-dev.yml
spring:
  application:
    name: aibidcomposer-backend

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/aibidcomposer}
    username: ${SPRING_DATASOURCE_USERNAME:postgres}
    password: ${SPRING_DATASOURCE_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate  # ä½¿ç”¨Flywayç®¡ç†DDL
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          time_zone: UTC

  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  redis:
    host: ${SPRING_REDIS_HOST:localhost}
    port: 6379
    password: ${SPRING_REDIS_PASSWORD:redis}
    timeout: 5000
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms

# JWTé…ç½®
jwt:
  secret: ${JWT_SECRET:default_secret_key_for_development_only}
  expiration: ${JWT_EXPIRATION:3600}
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}

# æ—¥å¿—é…ç½®
logging:
  level:
    root: ${LOGGING_LEVEL_ROOT:INFO}
    com.aibidcomposer: ${LOGGING_LEVEL_COM_AIBIDCOMPOSER:DEBUG}
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

**éªŒè¯æ ‡å‡†**:
- [ ] docker-compose up -d æˆåŠŸå¯åŠ¨æ‰€æœ‰æœåŠ¡
- [ ] PostgreSQL æ•°æ®åº“è¿æ¥æˆåŠŸ
- [ ] Flyway è¿ç§»è„šæœ¬è‡ªåŠ¨æ‰§è¡ŒæˆåŠŸ
- [ ] Redis è¿æ¥æˆåŠŸ
- [ ] Java æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆhttp://localhost:8080/actuator/healthï¼‰
- [ ] ç¯å¢ƒå˜é‡æ­£ç¡®åŠ è½½
- [ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸

### å­ä»»åŠ¡æ€»ç»“

#### å®Œæˆæ ‡å‡†

**1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½** è¢«è®¤ä¸ºå®Œæˆéœ€è¦æ»¡è¶³ï¼š

1. **æ•°æ®å®šä¹‰** (100%)
   - [ ] Flyway è¿ç§»è„šæœ¬æˆåŠŸæ‰§è¡Œï¼Œusers è¡¨åˆ›å»º
   - [ ] JPA å®ä½“ç±»æ˜ å°„æ­£ç¡®
   - [ ] DTO è½¬æ¢æ–¹æ³•æµ‹è¯•é€šè¿‡

2. **å‰ç«¯** (100%)
   - [ ] ProTable ç”¨æˆ·åˆ—è¡¨é¡µé¢æ­£å¸¸æ¸²æŸ“
   - [ ] åˆ†é¡µã€ç­›é€‰ã€æ’åºåŠŸèƒ½æ­£å¸¸
   - [ ] API è°ƒç”¨æˆåŠŸ

3. **Javaåç«¯** (100%)
   - [ ] Repository æŸ¥è¯¢æ–¹æ³•æµ‹è¯•é€šè¿‡
   - [ ] Service ä¸šåŠ¡é€»è¾‘å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >80%
   - [ ] Controller API é›†æˆæµ‹è¯•é€šè¿‡
   - [ ] è½¯åˆ é™¤é€»è¾‘æ­£ç¡®

4. **Pythonåç«¯** (100%)
   - [ ] Java æœåŠ¡ HTTP å®¢æˆ·ç«¯æµ‹è¯•é€šè¿‡
   - [ ] å®¡è®¡æ—¥å¿—è®°å½•æ­£å¸¸

5. **éƒ¨ç½²** (100%)
   - [ ] Docker Compose æˆåŠŸå¯åŠ¨
   - [ ] æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
   - [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®

#### é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

è®°å½•å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼š

1. **é—®é¢˜**: _ï¼ˆå¾…å¡«å†™ï¼‰_
   - **è§£å†³æ–¹æ¡ˆ**: _ï¼ˆå¾…å¡«å†™ï¼‰_

---

## 1.2 Spring Security é›†æˆ

**é¢„è®¡å·¥ä½œé‡**: 4 äººå¤©
**ä¼˜å…ˆçº§**: P1
**ä¾èµ–**: 1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½

### æŠ€æœ¯å®ç°æ¦‚è¿°

é›†æˆ Spring Security 6.xï¼Œå®ç°åŸºäº JWT Token çš„æ— çŠ¶æ€è®¤è¯æœºåˆ¶ï¼Œé…ç½®å®‰å…¨è¿‡æ»¤å™¨é“¾å’Œè®¤è¯ç®¡ç†å™¨ã€‚
