---
æ–‡æ¡£ç±»å‹: æ¶æ„æ–‡æ¡£
éœ€æ±‚ç¼–å·: DOC-2025-11-002
åˆ›å»ºæ—¥æœŸ: 2025-11-15
åˆ›å»ºè€…: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
æœ€åæ›´æ–°: 2025-11-26
æ›´æ–°è€…: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
çŠ¶æ€: å·²æ‰¹å‡†
---

# AIæ ‡ä¹¦æ™ºèƒ½åˆ›ä½œå¹³å° - æŠ€æœ¯æ¶æ„è¯¦ç»†å®ç° - ğŸ’¾ æ•°æ®åº“è®¾è®¡è¯¦ç»†å®ç°

### PostgreSQLæ•°æ®åº“æ¶æ„
```sql
-- æ•°æ®åº“æ¶æ„è¯¦ç»†è®¾è®¡
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE aibidcomposer;

-- ä½¿ç”¨ä¸»æ•°æ®åº“
\c aibidcomposer;

-- åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- ä¼ä¸šä¿¡æ¯è¡¨
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(200) NOT NULL,
    display_name VARCHAR(200),
    description TEXT,
    industry VARCHAR(100),
    company_size VARCHAR(50),
    website VARCHAR(500),
    logo_url VARCHAR(500),
    contact_email VARCHAR(200),
    contact_phone VARCHAR(50),

    -- è®¢é˜…ä¿¡æ¯
    subscription_tier VARCHAR(20) DEFAULT 'basic',
    subscription_status VARCHAR(20) DEFAULT 'active',
    subscription_expires_at TIMESTAMP,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT companies_name_unique UNIQUE (name)
);

-- ç”¨æˆ·è¡¨ï¼ˆå¦‚å‰æ‰€ç¤ºï¼‰
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(200) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    is_active BOOLEAN DEFAULT true,
    is_verified BOOLEAN DEFAULT false,
    avatar_url VARCHAR(500),
    phone VARCHAR(20),
    department VARCHAR(100),
    position VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,

    CONSTRAINT users_username_unique UNIQUE (username),
    CONSTRAINT users_email_unique UNIQUE (email)
);

-- é¡¹ç›®è¡¨
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    created_by UUID NOT NULL REFERENCES users(id),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    project_number VARCHAR(100),
    client_name VARCHAR(200),
    project_type VARCHAR(50),
    tender_document_url VARCHAR(500),
    submission_deadline TIMESTAMP,
    budget_amount DECIMAL(15,2),
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    priority VARCHAR(20) DEFAULT 'medium',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT projects_status_check CHECK (
        status IN ('draft', 'in_progress', 'review', 'approved', 'submitted', 'won', 'lost', 'cancelled')
    )
);

-- æ¨¡æ¿è¡¨
CREATE TABLE templates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
    created_by UUID NOT NULL REFERENCES users(id),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL,
    industry VARCHAR(100),
    content JSONB NOT NULL,
    structure JSONB,
    variables JSONB DEFAULT '{}',
    is_public BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    usage_count INTEGER DEFAULT 0,
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ–‡æ¡£è¡¨
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    template_id UUID REFERENCES templates(id),
    created_by UUID NOT NULL REFERENCES users(id),
    title VARCHAR(200) NOT NULL,
    document_type VARCHAR(50) NOT NULL,
    file_path VARCHAR(1000),
    file_size BIGINT,
    content JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    quality_score DECIMAL(5,2),
    ai_generated BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT documents_status_check CHECK (
        status IN ('draft', 'review', 'approved', 'final', 'archived')
    )
);

-- ä¼ä¸šèƒ½åŠ›åº“è¡¨ï¼ˆå‘é‡å­˜å‚¨åœ¨Elasticsearchï¼‰
CREATE TABLE enterprise_capabilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    created_by UUID NOT NULL REFERENCES users(id),
    name VARCHAR(200) NOT NULL,
    type VARCHAR(50) NOT NULL,
    description TEXT,
    metadata JSONB,
    tags TEXT[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT capabilities_type_check CHECK (
        type IN ('product', 'service', 'project', 'personnel', 'technology', 'certification')
    )
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_company_id ON users(company_id);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_projects_company_id ON projects(company_id);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_documents_project_id ON documents(project_id);
CREATE INDEX idx_capabilities_company_id ON enterprise_capabilities(company_id);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_companies_updated_at BEFORE UPDATE ON companies
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON projects
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### Elasticsearchå‘é‡æ•°æ®åº“é…ç½®
```python
# core/elasticsearch_config.py
from elasticsearch import AsyncElasticsearch
from typing import Optional

from app.config.settings import settings

_es_client: Optional[AsyncElasticsearch] = None

async def initialize_elasticsearch():
    """åˆå§‹åŒ–Elasticsearchè¿æ¥"""
    global _es_client

    _es_client = AsyncElasticsearch(
        hosts=[settings.ELASTICSEARCH_URL],
        max_retries=3,
        retry_on_timeout=True
    )

    # åˆ›å»ºç´¢å¼•æ˜ å°„
    await create_vector_indexes()

    print("Elasticsearchåˆå§‹åŒ–å®Œæˆ")

async def create_vector_indexes():
    """åˆ›å»ºå‘é‡ç´¢å¼•"""

    # èƒ½åŠ›åº“å‘é‡ç´¢å¼•
    capabilities_mapping = {
        "mappings": {
            "properties": {
                "id": {"type": "keyword"},
                "type": {"type": "keyword"},
                "name": {"type": "text"},
                "description": {"type": "text"},
                "embedding": {
                    "type": "dense_vector",
                    "dims": 1536,
                    "similarity": "cosine"
                },
                "metadata": {
                    "properties": {
                        "industry": {"type": "keyword"},
                        "tags": {"type": "keyword"},
                        "experience": {"type": "integer"}
                    }
                }
            }
        }
    }

    index_name = f"{settings.ELASTICSEARCH_INDEX_PREFIX}capabilities"
    if not await _es_client.indices.exists(index=index_name):
        await _es_client.indices.create(
            index=index_name,
            body=capabilities_mapping
        )
        print(f"åˆ›å»ºç´¢å¼•: {index_name}")

def get_elasticsearch_client() -> AsyncElasticsearch:
    """è·å–Elasticsearchå®¢æˆ·ç«¯"""
    return _es_client
```
