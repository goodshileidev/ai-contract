# Python FastAPI AI 服务任务详细计划 - AI-004 - AI-004: 智能匹配分析 - 二级任务 4.2: 竞争优势分析

**工作量估算**: 4 人天
**优先级**: P2 - 中优先级
**技术难点**:
- 优势识别算法
- 差距量化分析
- 改进建议生成

#### 1) 数据定义

##### Pydantic模型
```python
# app/models/competitive_analysis.py
class CompetitiveAdvantage(BaseModel):
    """竞争优势模型"""
    advantage_type: str = Field(..., description="技术/商务/品牌/成本")
    title: str = Field(..., description="优势标题")
    description: str = Field(..., description="优势描述")
    strength_score: Decimal = Field(..., ge=0, le=10, description="优势强度 (0-10)")
    supporting_capabilities: List[str] = Field(default_factory=list, description="支撑能力")
    supporting_cases: List[str] = Field(default_factory=list, description="支撑案例")

class CompetitiveGap(BaseModel):
    """竞争差距模型"""
    gap_type: str = Field(..., description="能力/资质/经验/资源")
    requirement_id: str = Field(..., description="关联需求ID")
    gap_description: str = Field(..., description="差距描述")
    severity: str = Field(..., description="high|medium|low")
    impact_score: Decimal = Field(..., ge=0, le=10, description="影响程度")
    improvement_suggestions: List[str] = Field(default_factory=list)
    estimated_effort: Optional[str] = Field(None, description="改进预估工作量")

class CompetitiveAnalysisResult(BaseModel):
    """竞争分析结果"""
    project_id: str
    organization_id: str

    # 优势列表
    advantages: List[CompetitiveAdvantage] = Field(default_factory=list)
    advantage_summary: str = Field(..., description="优势总结")

    # 差距列表
    gaps: List[CompetitiveGap] = Field(default_factory=list)
    gap_summary: str = Field(..., description="差距总结")

    # 综合评估
    competitiveness_score: Decimal = Field(..., description="竞争力评分 (0-100)")
    win_probability: Decimal = Field(..., description="中标概率 (0-100)")

    # 战略建议
    strategic_recommendations: List[str] = Field(default_factory=list)

    generated_at: datetime = Field(default_factory=datetime.utcnow)
```

**验证标准**:
- [ ] 模型验证通过
- [ ] 评分范围正确

#### 2) 前端

```typescript
// src/components/Matching/CompetitiveAnalysis.tsx
export default function CompetitiveAnalysis({ projectId }: Props) {
  const [analysis, setAnalysis] = useState<CompetitiveAnalysisResult | null>(null);

  useEffect(() => {
    fetchAnalysis();
  }, [projectId]);

  const fetchAnalysis = async () => {
    const response = await fetch(`http://localhost:8001/api/v1/ai/match/competitive-analysis`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_id: projectId })
    });
    const result = await response.json();
    setAnalysis(result.data);
  };

  return (
    <Space direction="vertical" size="large" style={{ width: '100%' }}>
      {/* 竞争力评估 */}
      <Card title="竞争力评估">
        <Row gutter={24}>
          <Col span={12}>
            <Statistic
              title="竞争力评分"
              value={analysis?.competitivenessScore}
              suffix="/ 100"
              valueStyle={{ color: getScoreColor(analysis?.competitivenessScore) }}
            />
          </Col>
          <Col span={12}>
            <Statistic
              title="中标概率"
              value={analysis?.winProbability}
              suffix="%"
              valueStyle={{ color: getScoreColor(analysis?.winProbability) }}
            />
          </Col>
        </Row>
      </Card>

      {/* 竞争优势 */}
      <Card title="竞争优势">
        <List
          dataSource={analysis?.advantages}
          renderItem={(adv) => (
            <List.Item>
              <Card.Meta
                avatar={<Trophy style={{ fontSize: 32, color: '#faad14' }} />}
                title={<Space><Tag color="gold">{adv.advantageType}</Tag>{adv.title}</Space>}
                description={
                  <>
                    <p>{adv.description}</p>
                    <Space>
                      <Rate disabled value={adv.strengthScore / 2} />
                      <span>强度: {adv.strengthScore}/10</span>
                    </Space>
                  </>
                }
              />
            </List.Item>
          )}
        />
      </Card>

      {/* 能力差距 */}
      <Card title="能力差距">
        <List
          dataSource={analysis?.gaps}
          renderItem={(gap) => (
            <List.Item>
              <Alert
                type={gap.severity === 'high' ? 'error' : gap.severity === 'medium' ? 'warning' : 'info'}
                message={<Space><Tag>{gap.gapType}</Tag>{gap.gapDescription}</Space>}
                description={
                  <Space direction="vertical">
                    <span>影响程度: {gap.impactScore}/10</span>
                    <div>
                      <strong>改进建议:</strong>
                      <ul>
                        {gap.improvementSuggestions.map((s, idx) => (
                          <li key={idx}>{s}</li>
                        ))}
                      </ul>
                    </div>
                    {gap.estimatedEffort && (
                      <Tag color="blue">预估工作量: {gap.estimatedEffort}</Tag>
                    )}
                  </Space>
                }
              />
            </List.Item>
          )}
        />
      </Card>

      {/* 战略建议 */}
      <Card title="战略建议">
        <Timeline>
          {analysis?.strategicRecommendations.map((rec, idx) => (
            <Timeline.Item key={idx}>{rec}</Timeline.Item>
          ))}
        </Timeline>
      </Card>
    </Space>
  );
}
```

**验证标准**:
- [ ] 优势和差距可视化展示正确
- [ ] 评分仪表盘颜色动态变化
- [ ] 战略建议展示清晰

#### 3) Java后端

```java
@Service
public class CompetitiveAnalysisService {

    /**
     * 触发竞争分析
     * 需求编号: REQ-AI-004
     */
    public CompetitiveAnalysisResult triggerAnalysis(String projectId) {
        // 调用Python AI服务
        String url = "http://backend-python:8001/api/v1/ai/match/competitive-analysis";

        CompetitiveAnalysisRequest request = CompetitiveAnalysisRequest.builder()
            .projectId(projectId)
            .build();

        ResponseEntity<ApiResponse<CompetitiveAnalysisResult>> response =
            restTemplate.postForEntity(url, request, ...);

        return response.getBody().getData();
    }
}
```

**验证标准**:
- [ ] 调用Python服务成功
- [ ] 结果正确返回

#### 4) Python后端

```python
# app/services/ai/competitive_analysis_service.py
class CompetitiveAnalysisService:
    """竞争分析服务"""

    async def analyze_competitiveness(
        self,
        project_id: str,
        organization_id: str
    ) -> CompetitiveAnalysisResult:
        """执行竞争分析"""

        # 1. 获取匹配矩阵
        matching_service = MatchingService()
        matching_matrix = await matching_service.analyze_matching(
            MatchingRequest(
                project_id=project_id,
                organization_id=organization_id
            )
        )

        # 2. 识别竞争优势
        advantages = await self._identify_advantages(matching_matrix)

        # 3. 识别能力差距
        gaps = await self._identify_gaps(matching_matrix)

        # 4. 计算竞争力评分
        competitiveness_score = self._calculate_competitiveness_score(
            matching_matrix, advantages, gaps
        )

        # 5. 估算中标概率
        win_probability = self._estimate_win_probability(
            competitiveness_score, matching_matrix
        )

        # 6. 生成战略建议
        strategic_recommendations = await self._generate_strategic_recommendations(
            advantages, gaps, matching_matrix
        )

        return CompetitiveAnalysisResult(
            project_id=project_id,
            organization_id=organization_id,
            advantages=advantages,
            advantage_summary=f"识别到 {len(advantages)} 项竞争优势",
            gaps=gaps,
            gap_summary=f"发现 {len(gaps)} 项能力差距",
            competitiveness_score=competitiveness_score,
            win_probability=win_probability,
            strategic_recommendations=strategic_recommendations
        )

    async def _identify_advantages(
        self,
        matching_matrix: MatchingMatrix
    ) -> List[CompetitiveAdvantage]:
        """识别竞争优势（匹配度高的需求）"""
        advantages = []

        for req_match in matching_matrix.requirements:
            if req_match.match_score >= 85:  # 高匹配度视为优势
                advantages.append(CompetitiveAdvantage(
                    advantage_type="technical",
                    title=f"在 '{req_match.requirement_title}' 方面具有强大能力",
                    description=f"匹配度高达 {req_match.match_score}%",
                    strength_score=Decimal(req_match.match_score / 10),
                    supporting_capabilities=[
                        cap['name'] for cap in req_match.matched_capabilities[:3]
                    ]
                ))

        return advantages

    async def _identify_gaps(
        self,
        matching_matrix: MatchingMatrix
    ) -> List[CompetitiveGap]:
        """识别能力差距（匹配度低的需求）"""
        gaps = []

        for req_match in matching_matrix.requirements:
            if req_match.match_score < 60:  # 低匹配度视为差距
                severity = "high" if req_match.is_mandatory else "medium"

                gaps.append(CompetitiveGap(
                    gap_type="capability",
                    requirement_id=req_match.requirement_id,
                    gap_description=f"在 '{req_match.requirement_title}' 方面能力不足",
                    severity=severity,
                    impact_score=Decimal((100 - req_match.match_score) / 10),
                    improvement_suggestions=req_match.suggestions,
                    estimated_effort="2-4周" if severity == "high" else "1-2周"
                ))

        return gaps
```

**验证标准**:
- [ ] 优势识别准确
- [ ] 差距分析合理
- [ ] 中标概率估算有参考价值

#### 5) 部署

```yaml
# 无特殊部署要求，使用现有Python服务即可
```

---
