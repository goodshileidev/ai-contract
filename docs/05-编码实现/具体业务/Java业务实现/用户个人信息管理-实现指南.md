# Java Spring Boot æœåŠ¡ä»»åŠ¡è¯¦ç»†è®¡åˆ’ - JAVA-001 Part3

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-001 (å­ä»»åŠ¡ 1.5-1.6)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-26
**åˆ›å»ºè€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º Part3 (å­ä»»åŠ¡1.5-1.6+æ€»ç»“) |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [task-plan-java-è¯¦ç»†-INDEX.md](./task-plan-java-è¯¦ç»†-INDEX.md)

**å…¶ä»–éƒ¨åˆ†**:
- [Part1: å­ä»»åŠ¡ 1.1-1.3](./task-plan-java-è¯¦ç»†-JAVA-001-Part1.md)
- [Part2: å­ä»»åŠ¡ 1.4](./task-plan-java-è¯¦ç»†-JAVA-001-Part2.md)

---

## æ¨¡å—æ¦‚è¿°

æœ¬æ–‡æ¡£åŒ…å« **JAVA-001: ç”¨æˆ·è®¤è¯æˆæƒæ¨¡å—** çš„æœ€å2ä¸ªå­ä»»åŠ¡åŠæ¨¡å—æ€»ç»“ï¼š
- 1.5 ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†
- 1.6 æ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- JAVA-001 æ¨¡å—å®Œæˆæ€»ç»“

**æŠ€æœ¯æ ˆ**: Java 17 LTS + Spring Boot 3.2.x + Spring Data JPA + Spring Security 6.x

---

## 1.5: ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†

**å­ä»»åŠ¡ç¼–å·**: JAVA-001-1.5
**é¢„è®¡å·¥æ—¶**: 3äººå¤©
**è´Ÿè´£äºº**: Javaåç«¯å¼€å‘ + å‰ç«¯å¼€å‘
**ä¾èµ–**: 1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½ã€1.2 Spring Security é›†æˆ
**è¾“å‡º**: ç”¨æˆ·ä¸ªäººä¸­å¿ƒå®Œæ•´åŠŸèƒ½

### ä»»åŠ¡ç›®æ ‡

å®ç°ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬:
- æŸ¥çœ‹ä¸ªäººèµ„æ–™
- æ›´æ–°ä¸ªäººèµ„æ–™
- ä¿®æ”¹å¯†ç 
- å¤´åƒä¸Šä¼ 
- å®‰å…¨è®¾ç½®ï¼ˆé‚®ç®±éªŒè¯ã€æ‰‹æœºéªŒè¯ï¼‰
- ç™»å½•å†å²æŸ¥çœ‹

---

### 1.5.1 æ•°æ®å®šä¹‰

**éªŒè¯æ¸…å•**:
- [ ] DTOç±»å®šä¹‰å®Œæˆ
- [ ] æ•°æ®éªŒè¯è§„åˆ™æ­£ç¡®
- [ ] æ–‡ä»¶ä¸Šä¼ é™åˆ¶é…ç½®

#### DTOç±»

```java
// backend-java/src/main/java/com/aibidcomposer/dto/user/UserProfileResponse.java
package com.aibidcomposer.dto.user;

import com.aibidcomposer.domain.User;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * ç”¨æˆ·ä¸ªäººèµ„æ–™å“åº”DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserProfileResponse {

    private UUID id;
    private String email;
    private String username;
    private String fullName;
    private String phone;
    private String avatarUrl;
    private String status;
    private Boolean emailVerified;
    private Boolean phoneVerified;
    private LocalDateTime lastLoginAt;
    private Integer loginCount;

    // ç»„ç»‡ä¿¡æ¯
    private UUID organizationId;
    private String organizationName;

    // è§’è‰²å’Œæƒé™
    private Set<String> roles;
    private Set<String> permissions;

    // ç”¨æˆ·è®¾ç½®
    private Object settings;

    // ç»Ÿè®¡ä¿¡æ¯
    private Integer projectsCount;
    private Integer documentsCount;

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    public static UserProfileResponse from(User user) {
        return UserProfileResponse.builder()
                .id(user.getId())
                .email(user.getEmail())
                .username(user.getUsername())
                .fullName(user.getFullName())
                .phone(user.getPhone())
                .avatarUrl(user.getAvatarUrl())
                .status(user.getStatus().name())
                .emailVerified(user.getEmailVerified())
                .phoneVerified(user.getPhoneVerified())
                .lastLoginAt(user.getLastLoginAt())
                .loginCount(user.getLoginCount())
                .organizationId(user.getOrganization() != null ?
                        user.getOrganization().getId() : null)
                .organizationName(user.getOrganization() != null ?
                        user.getOrganization().getName() : null)
                .createdAt(user.getCreatedAt())
                .updatedAt(user.getUpdatedAt())
                .build();
    }
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/dto/user/UpdateProfileRequest.java
package com.aibidcomposer.dto.user;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.Size;
import lombok.Data;

/**
 * æ›´æ–°ä¸ªäººèµ„æ–™è¯·æ±‚DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
public class UpdateProfileRequest {

    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    @Size(max = 255, message = "é‚®ç®±é•¿åº¦ä¸èƒ½è¶…è¿‡255ä¸ªå­—ç¬¦")
    private String email;

    @Size(max = 200, message = "å…¨åé•¿åº¦ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦")
    private String fullName;

    @Size(max = 20, message = "æ‰‹æœºå·é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦")
    private String phone;

    private Object settings;
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/dto/user/ChangePasswordRequest.java
package com.aibidcomposer.dto.user;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Data;

/**
 * ä¿®æ”¹å¯†ç è¯·æ±‚DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
public class ChangePasswordRequest {

    @NotBlank(message = "å½“å‰å¯†ç ä¸èƒ½ä¸ºç©º")
    private String oldPassword;

    @NotBlank(message = "æ–°å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 8, max = 100, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨8-100ä¸ªå­—ç¬¦ä¹‹é—´")
    private String newPassword;

    @NotBlank(message = "ç¡®è®¤å¯†ç ä¸èƒ½ä¸ºç©º")
    private String confirmPassword;
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/dto/user/LoginHistoryResponse.java
package com.aibidcomposer.dto.user;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

/**
 * ç™»å½•å†å²å“åº”DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class LoginHistoryResponse {

    private LocalDateTime loginAt;
    private String ipAddress;
    private String userAgent;
    private String location;
    private Boolean success;
}
```

### 1.5.2 å‰ç«¯

**éªŒè¯æ¸…å•**:
- [ ] ä¸ªäººä¸­å¿ƒé¡µé¢å¼€å‘å®Œæˆ
- [ ] èµ„æ–™ç¼–è¾‘è¡¨å•æ­£å¸¸
- [ ] å¤´åƒä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] å¯†ç ä¿®æ”¹åŠŸèƒ½æ­£å¸¸

#### ä¸ªäººä¸­å¿ƒé¡µé¢

```typescript
// frontend/src/pages/User/Profile/index.tsx
import React, { useEffect, useState } from 'react';
import { Card, Avatar, Descriptions, Button, message, Tabs, Badge } from 'antd';
import { UserOutlined, EditOutlined, SafetyOutlined, HistoryOutlined } from '@ant-design/icons';
import type { UserProfileResponse } from '@/services/user.service';
import { userService } from '@/services/user.service';
import EditProfileModal from './EditProfileModal';
import ChangePasswordModal from './ChangePasswordModal';
import LoginHistory from './LoginHistory';

/**
 * ä¸ªäººä¸­å¿ƒé¡µé¢
 * éœ€æ±‚ç¼–å·: REQ-FRONT-002
 */
const UserProfile: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [profile, setProfile] = useState<UserProfileResponse | null>(null);
  const [editModalVisible, setEditModalVisible] = useState(false);
  const [passwordModalVisible, setPasswordModalVisible] = useState(false);

  useEffect(() => {
    loadProfile();
  }, []);

  const loadProfile = async () => {
    setLoading(true);
    try {
      const response = await userService.getProfile();
      setProfile(response.data);
    } catch (error: any) {
      message.error(error.message || 'åŠ è½½å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  const handleAvatarUpload = async (file: File) => {
    try {
      const response = await userService.uploadAvatar(file);
      message.success('å¤´åƒä¸Šä¼ æˆåŠŸ');
      setProfile({ ...profile!, avatarUrl: response.data.avatarUrl });
    } catch (error: any) {
      message.error(error.message || 'å¤´åƒä¸Šä¼ å¤±è´¥');
    }
  };

  return (
    <div className="user-profile">
      <Card loading={loading}>
        <div style={{ display: 'flex', marginBottom: 24 }}>
          <Avatar
            size={100}
            src={profile?.avatarUrl}
            icon={<UserOutlined />}
            style={{ marginRight: 24 }}
          />
          <div style={{ flex: 1 }}>
            <h2>{profile?.fullName || profile?.username}</h2>
            <p>{profile?.email}</p>
            <div>
              <Badge
                status={profile?.status === 'ACTIVE' ? 'success' : 'default'}
                text={profile?.status === 'ACTIVE' ? 'æ´»è·ƒ' : 'æœªæ¿€æ´»'}
              />
              {profile?.emailVerified && (
                <Badge status="success" text="é‚®ç®±å·²éªŒè¯" style={{ marginLeft: 16 }} />
              )}
              {profile?.phoneVerified && (
                <Badge status="success" text="æ‰‹æœºå·²éªŒè¯" style={{ marginLeft: 16 }} />
              )}
            </div>
            <div style={{ marginTop: 16 }}>
              <Button
                icon={<EditOutlined />}
                onClick={() => setEditModalVisible(true)}
                style={{ marginRight: 8 }}
              >
                ç¼–è¾‘èµ„æ–™
              </Button>
              <Button
                icon={<SafetyOutlined />}
                onClick={() => setPasswordModalVisible(true)}
              >
                ä¿®æ”¹å¯†ç 
              </Button>
            </div>
          </div>
        </div>

        <Tabs
          items={[
            {
              key: 'info',
              label: 'åŸºæœ¬ä¿¡æ¯',
              icon: <UserOutlined />,
              children: (
                <Descriptions column={2} bordered>
                  <Descriptions.Item label="ç”¨æˆ·å">{profile?.username}</Descriptions.Item>
                  <Descriptions.Item label="é‚®ç®±">{profile?.email}</Descriptions.Item>
                  <Descriptions.Item label="å…¨å">{profile?.fullName || '-'}</Descriptions.Item>
                  <Descriptions.Item label="æ‰‹æœº">{profile?.phone || '-'}</Descriptions.Item>
                  <Descriptions.Item label="ç»„ç»‡">{profile?.organizationName || '-'}</Descriptions.Item>
                  <Descriptions.Item label="ä¸Šæ¬¡ç™»å½•">{profile?.lastLoginAt || '-'}</Descriptions.Item>
                  <Descriptions.Item label="ç™»å½•æ¬¡æ•°">{profile?.loginCount}</Descriptions.Item>
                  <Descriptions.Item label="æ³¨å†Œæ—¶é—´">{profile?.createdAt}</Descriptions.Item>
                </Descriptions>
              ),
            },
            {
              key: 'security',
              label: 'å®‰å…¨è®¾ç½®',
              icon: <SafetyOutlined />,
              children: (
                <div>
                  <p>é‚®ç®±éªŒè¯: {profile?.emailVerified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}</p>
                  <p>æ‰‹æœºéªŒè¯: {profile?.phoneVerified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}</p>
                </div>
              ),
            },
            {
              key: 'history',
              label: 'ç™»å½•å†å²',
              icon: <HistoryOutlined />,
              children: <LoginHistory />,
            },
          ]}
        />
      </Card>

      <EditProfileModal
        visible={editModalVisible}
        profile={profile}
        onCancel={() => setEditModalVisible(false)}
        onSuccess={() => {
          setEditModalVisible(false);
          loadProfile();
        }}
      />

      <ChangePasswordModal
        visible={passwordModalVisible}
        onCancel={() => setPasswordModalVisible(false)}
        onSuccess={() => {
          setPasswordModalVisible(false);
          message.success('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
        }}
      />
    </div>
  );
};

export default UserProfile;
```

#### ç¼–è¾‘èµ„æ–™å¼¹çª—

```typescript
// frontend/src/pages/User/Profile/EditProfileModal.tsx
import React, { useEffect } from 'react';
import { Modal, message } from 'antd';
import { ProForm, ProFormText } from '@ant-design/pro-form';
import type { UserProfileResponse, UpdateProfileRequest } from '@/services/user.service';
import { userService } from '@/services/user.service';

interface EditProfileModalProps {
  visible: boolean;
  profile: UserProfileResponse | null;
  onCancel: () => void;
  onSuccess: () => void;
}

/**
 * ç¼–è¾‘èµ„æ–™å¼¹çª—
 * éœ€æ±‚ç¼–å·: REQ-FRONT-002
 */
const EditProfileModal: React.FC<EditProfileModalProps> = ({
  visible,
  profile,
  onCancel,
  onSuccess,
}) => {
  const [form] = ProForm.useForm();

  useEffect(() => {
    if (visible && profile) {
      form.setFieldsValue({
        email: profile.email,
        fullName: profile.fullName,
        phone: profile.phone,
      });
    }
  }, [visible, profile, form]);

  const handleSubmit = async (values: UpdateProfileRequest) => {
    try {
      await userService.updateProfile(values);
      message.success('èµ„æ–™æ›´æ–°æˆåŠŸ');
      onSuccess();
      return true;
    } catch (error: any) {
      message.error(error.message || 'æ›´æ–°å¤±è´¥');
      return false;
    }
  };

  return (
    <Modal
      title="ç¼–è¾‘ä¸ªäººèµ„æ–™"
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={600}
    >
      <ProForm
        form={form}
        onFinish={handleSubmit}
      >
        <ProFormText
          name="email"
          label="é‚®ç®±"
          placeholder="è¯·è¾“å…¥é‚®ç®±"
          rules={[
            { required: true, message: 'è¯·è¾“å…¥é‚®ç®±' },
            { type: 'email', message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' },
          ]}
        />

        <ProFormText
          name="fullName"
          label="å…¨å"
          placeholder="è¯·è¾“å…¥å…¨å"
          rules={[
            { max: 200, message: 'å…¨åä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦' },
          ]}
        />

        <ProFormText
          name="phone"
          label="æ‰‹æœºå·"
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
          rules={[
            { max: 20, message: 'æ‰‹æœºå·ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦' },
          ]}
        />
      </ProForm>
    </Modal>
  );
};

export default EditProfileModal;
```

#### ä¿®æ”¹å¯†ç å¼¹çª—

```typescript
// frontend/src/pages/User/Profile/ChangePasswordModal.tsx
import React from 'react';
import { Modal, message } from 'antd';
import { ProForm, ProFormText } from '@ant-design/pro-form';
import type { ChangePasswordRequest } from '@/services/user.service';
import { userService } from '@/services/user.service';

interface ChangePasswordModalProps {
  visible: boolean;
  onCancel: () => void;
  onSuccess: () => void;
}

/**
 * ä¿®æ”¹å¯†ç å¼¹çª—
 * éœ€æ±‚ç¼–å·: REQ-FRONT-002
 */
const ChangePasswordModal: React.FC<ChangePasswordModalProps> = ({
  visible,
  onCancel,
  onSuccess,
}) => {
  const [form] = ProForm.useForm();

  const handleSubmit = async (values: ChangePasswordRequest) => {
    if (values.newPassword !== values.confirmPassword) {
      message.error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return false;
    }

    try {
      await userService.changePassword(values);
      onSuccess();
      return true;
    } catch (error: any) {
      message.error(error.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
      return false;
    }
  };

  return (
    <Modal
      title="ä¿®æ”¹å¯†ç "
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={500}
    >
      <ProForm
        form={form}
        onFinish={handleSubmit}
      >
        <ProFormText.Password
          name="oldPassword"
          label="å½“å‰å¯†ç "
          placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
          rules={[
            { required: true, message: 'è¯·è¾“å…¥å½“å‰å¯†ç ' },
          ]}
        />

        <ProFormText.Password
          name="newPassword"
          label="æ–°å¯†ç "
          placeholder="è¯·è¾“å…¥æ–°å¯†ç "
          rules={[
            { required: true, message: 'è¯·è¾“å…¥æ–°å¯†ç ' },
            { min: 8, message: 'å¯†ç è‡³å°‘8ä¸ªå­—ç¬¦' },
          ]}
        />

        <ProFormText.Password
          name="confirmPassword"
          label="ç¡®è®¤å¯†ç "
          placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
          rules={[
            { required: true, message: 'è¯·ç¡®è®¤æ–°å¯†ç ' },
          ]}
        />
      </ProForm>
    </Modal>
  );
};

export default ChangePasswordModal;
```

#### APIå®¢æˆ·ç«¯æ‰©å±•

```typescript
// frontend/src/services/user.service.ts (æ‰©å±•)
export const userService = {
  // ... å‰é¢çš„æ–¹æ³• ...

  /**
   * è·å–å½“å‰ç”¨æˆ·ä¸ªäººèµ„æ–™
   */
  getProfile: (): Promise<ApiResponse<UserProfileResponse>> => {
    return axios.get('/api/v1/users/me/profile');
  },

  /**
   * æ›´æ–°ä¸ªäººèµ„æ–™
   */
  updateProfile: (data: UpdateProfileRequest): Promise<ApiResponse<void>> => {
    return axios.put('/api/v1/users/me/profile', data);
  },

  /**
   * ä¿®æ”¹å¯†ç 
   */
  changePassword: (data: ChangePasswordRequest): Promise<ApiResponse<void>> => {
    return axios.put('/api/v1/users/me/password', data);
  },

  /**
   * ä¸Šä¼ å¤´åƒ
   */
  uploadAvatar: (file: File): Promise<ApiResponse<{ avatarUrl: string }>> => {
    const formData = new FormData();
    formData.append('file', file);

    return axios.post('/api/v1/users/me/avatar', formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    });
  },

  /**
   * è·å–ç™»å½•å†å²
   */
  getLoginHistory: (params: {
    page?: number;
    pageSize?: number;
  }): Promise<ApiResponse<PaginatedResponse<LoginHistoryResponse>>> => {
    return axios.get('/api/v1/users/me/login-history', { params });
  },
};
```

### 1.5.3 Javaåç«¯

**éªŒè¯æ¸…å•**:
- [ ] UserServiceä¸šåŠ¡é€»è¾‘æ‰©å±•å®Œæˆ
- [ ] UserController APIæ‰©å±•å®Œæˆ
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½é›†æˆMinIO
- [ ] å¯†ç éªŒè¯é€»è¾‘æ­£ç¡®
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%

#### Serviceå±‚æ‰©å±•

```java
// backend-java/src/main/java/com/aibidcomposer/service/UserService.java (æ‰©å±•)
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class UserService {

    // ... å‰é¢çš„ä¾èµ–å’Œæ–¹æ³• ...

    private final PasswordEncoder passwordEncoder;
    private final FileStorageService fileStorageService;

    /**
     * è·å–ç”¨æˆ·ä¸ªäººèµ„æ–™
     */
    @Transactional(readOnly = true)
    public UserProfileResponse getUserProfile(UUID userId) {
        log.info("Getting profile for user: {}", userId);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        UserProfileResponse response = UserProfileResponse.from(user);

        // è·å–ç”¨æˆ·è§’è‰²
        Set<Role> roles = roleService.getUserRoles(userId);
        response.setRoles(roles.stream()
                .map(Role::getCode)
                .collect(Collectors.toSet()));

        // è·å–ç”¨æˆ·æƒé™
        Set<String> permissions = roles.stream()
                .flatMap(role -> role.getPermissions().stream())
                .map(Permission::getCode)
                .collect(Collectors.toSet());
        response.setPermissions(permissions);

        // TODO: è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆé¡¹ç›®æ•°ã€æ–‡æ¡£æ•°ï¼‰

        return response;
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä¸ªäººèµ„æ–™
     */
    public void updateUserProfile(UUID userId, UpdateProfileRequest request) {
        log.info("Updating profile for user: {}", userId);

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§
        if (request.getEmail() != null &&
                !request.getEmail().equals(user.getEmail()) &&
                userRepository.existsByEmail(request.getEmail())) {
            throw new ValidationException("é‚®ç®±å·²è¢«ä½¿ç”¨");
        }

        // æ›´æ–°å­—æ®µ
        if (request.getEmail() != null) {
            user.setEmail(request.getEmail());
            user.setEmailVerified(false); // é‚®ç®±å˜æ›´åéœ€è¦é‡æ–°éªŒè¯
        }

        if (request.getFullName() != null) {
            user.setFullName(request.getFullName());
        }

        if (request.getPhone() != null) {
            user.setPhone(request.getPhone());
            if (!request.getPhone().equals(user.getPhone())) {
                user.setPhoneVerified(false); // æ‰‹æœºå˜æ›´åéœ€è¦é‡æ–°éªŒè¯
            }
        }

        if (request.getSettings() != null) {
            user.setSettings(request.getSettings());
        }

        userRepository.save(user);
        log.info("Profile updated successfully for user: {}", userId);
    }

    /**
     * ä¿®æ”¹å¯†ç 
     */
    public void changePassword(UUID userId, ChangePasswordRequest request) {
        log.info("Changing password for user: {}", userId);

        // éªŒè¯æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸€è‡´
        if (!request.getNewPassword().equals(request.getConfirmPassword())) {
            throw new ValidationException("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´");
        }

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // éªŒè¯å½“å‰å¯†ç 
        if (!passwordEncoder.matches(request.getOldPassword(), user.getHashedPassword())) {
            throw new ValidationException("å½“å‰å¯†ç ä¸æ­£ç¡®");
        }

        // æ£€æŸ¥æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ
        if (passwordEncoder.matches(request.getNewPassword(), user.getHashedPassword())) {
            throw new ValidationException("æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ");
        }

        // æ›´æ–°å¯†ç 
        user.setHashedPassword(passwordEncoder.encode(request.getNewPassword()));
        userRepository.save(user);

        log.info("Password changed successfully for user: {}", userId);
    }

    /**
     * ä¸Šä¼ å¤´åƒ
     */
    public String uploadAvatar(UUID userId, MultipartFile file) {
        log.info("Uploading avatar for user: {}", userId);

        // éªŒè¯æ–‡ä»¶ç±»å‹
        String contentType = file.getContentType();
        if (contentType == null || !contentType.startsWith("image/")) {
            throw new ValidationException("åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶");
        }

        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
        if (file.getSize() > 5 * 1024 * 1024) {
            throw new ValidationException("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB");
        }

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        // ä¸Šä¼ åˆ°MinIO
        String avatarUrl = fileStorageService.uploadFile(
                file,
                "avatars",
                userId.toString()
        );

        // åˆ é™¤æ—§å¤´åƒï¼ˆå¦‚æœå­˜åœ¨ä¸”ä¸æ˜¯é»˜è®¤å¤´åƒï¼‰
        if (user.getAvatarUrl() != null && !user.getAvatarUrl().contains("default")) {
            fileStorageService.deleteFile(user.getAvatarUrl());
        }

        // æ›´æ–°ç”¨æˆ·å¤´åƒURL
        user.setAvatarUrl(avatarUrl);
        userRepository.save(user);

        log.info("Avatar uploaded successfully for user: {}", userId);
        return avatarUrl;
    }

    /**
     * è·å–ç™»å½•å†å²
     * TODO: éœ€è¦å®ç°ç™»å½•å†å²è®°å½•åŠŸèƒ½
     */
    @Transactional(readOnly = true)
    public Page<LoginHistoryResponse> getLoginHistory(UUID userId, Pageable pageable) {
        log.info("Getting login history for user: {}", userId);

        // TODO: ä»ç™»å½•å†å²è¡¨æŸ¥è¯¢
        // æš‚æ—¶è¿”å›ç©ºåˆ—è¡¨
        return Page.empty(pageable);
    }
}
```

#### Controllerå±‚æ‰©å±•

```java
// backend-java/src/main/java/com/aibidcomposer/controller/UserController.java (æ‰©å±•)
@RestController
@RequestMapping("/api/v1/users")
@RequiredArgsConstructor
@Slf4j
public class UserController {

    // ... å‰é¢çš„ä¾èµ–å’Œæ–¹æ³• ...

    /**
     * è·å–å½“å‰ç”¨æˆ·ä¸ªäººèµ„æ–™
     */
    @GetMapping("/me/profile")
    public ResponseEntity<ApiResponse<UserProfileResponse>> getMyProfile(
            @CurrentUser UserPrincipal currentUser
    ) {
        UserProfileResponse profile = userService.getUserProfile(currentUser.getId());
        return ResponseEntity.ok(ApiResponse.success(profile));
    }

    /**
     * æ›´æ–°ä¸ªäººèµ„æ–™
     */
    @PutMapping("/me/profile")
    public ResponseEntity<ApiResponse<Void>> updateMyProfile(
            @CurrentUser UserPrincipal currentUser,
            @Valid @RequestBody UpdateProfileRequest request
    ) {
        userService.updateUserProfile(currentUser.getId(), request);
        return ResponseEntity.ok(ApiResponse.success(null, "èµ„æ–™æ›´æ–°æˆåŠŸ"));
    }

    /**
     * ä¿®æ”¹å¯†ç 
     */
    @PutMapping("/me/password")
    public ResponseEntity<ApiResponse<Void>> changePassword(
            @CurrentUser UserPrincipal currentUser,
            @Valid @RequestBody ChangePasswordRequest request
    ) {
        userService.changePassword(currentUser.getId(), request);
        return ResponseEntity.ok(ApiResponse.success(null, "å¯†ç ä¿®æ”¹æˆåŠŸ"));
    }

    /**
     * ä¸Šä¼ å¤´åƒ
     */
    @PostMapping("/me/avatar")
    public ResponseEntity<ApiResponse<Map<String, String>>> uploadAvatar(
            @CurrentUser UserPrincipal currentUser,
            @RequestParam("file") MultipartFile file
    ) {
        String avatarUrl = userService.uploadAvatar(currentUser.getId(), file);

        Map<String, String> result = new HashMap<>();
        result.put("avatarUrl", avatarUrl);

        return ResponseEntity.ok(ApiResponse.success(result, "å¤´åƒä¸Šä¼ æˆåŠŸ"));
    }

    /**
     * è·å–ç™»å½•å†å²
     */
    @GetMapping("/me/login-history")
    public ResponseEntity<ApiResponse<PagedResponse<LoginHistoryResponse>>> getLoginHistory(
            @CurrentUser UserPrincipal currentUser,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int pageSize
    ) {
        Pageable pageable = PageRequest.of(page - 1, pageSize, Sort.by(Sort.Direction.DESC, "loginAt"));

        Page<LoginHistoryResponse> history = userService.getLoginHistory(currentUser.getId(), pageable);

        PagedResponse<LoginHistoryResponse> pagedResponse = new PagedResponse<>(
                history.getContent(),
                history.getTotalElements(),
                page,
                pageSize,
                history.getTotalPages()
        );

        return ResponseEntity.ok(ApiResponse.success(pagedResponse, "è·å–æˆåŠŸ"));
    }
}
```

#### æ–‡ä»¶å­˜å‚¨æœåŠ¡

```java
// backend-java/src/main/java/com/aibidcomposer/service/FileStorageService.java
package com.aibidcomposer.service;

import io.minio.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.InputStream;
import java.util.UUID;

/**
 * æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆMinIOï¼‰
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class FileStorageService {

    private final MinioClient minioClient;

    @Value("${minio.bucket-name}")
    private String bucketName;

    @Value("${minio.endpoint}")
    private String endpoint;

    /**
     * ä¸Šä¼ æ–‡ä»¶
     *
     * @param file æ–‡ä»¶
     * @param folder æ–‡ä»¶å¤¹
     * @param fileName æ–‡ä»¶å
     * @return æ–‡ä»¶URL
     */
    public String uploadFile(MultipartFile file, String folder, String fileName) {
        try {
            // ç¡®ä¿bucketå­˜åœ¨
            boolean found = minioClient.bucketExists(
                    BucketExistsArgs.builder().bucket(bucketName).build()
            );
            if (!found) {
                minioClient.makeBucket(
                        MakeBucketArgs.builder().bucket(bucketName).build()
                );
            }

            // ç”Ÿæˆæ–‡ä»¶å
            String originalFilename = file.getOriginalFilename();
            String extension = originalFilename != null && originalFilename.contains(".") ?
                    originalFilename.substring(originalFilename.lastIndexOf(".")) : "";
            String objectName = folder + "/" + fileName + "-" + UUID.randomUUID() + extension;

            // ä¸Šä¼ æ–‡ä»¶
            try (InputStream inputStream = file.getInputStream()) {
                minioClient.putObject(
                        PutObjectArgs.builder()
                                .bucket(bucketName)
                                .object(objectName)
                                .stream(inputStream, file.getSize(), -1)
                                .contentType(file.getContentType())
                                .build()
                );
            }

            // è¿”å›æ–‡ä»¶URL
            String fileUrl = endpoint + "/" + bucketName + "/" + objectName;
            log.info("File uploaded successfully: {}", fileUrl);

            return fileUrl;

        } catch (Exception e) {
            log.error("Failed to upload file", e);
            throw new RuntimeException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * åˆ é™¤æ–‡ä»¶
     *
     * @param fileUrl æ–‡ä»¶URL
     */
    public void deleteFile(String fileUrl) {
        try {
            // ä»URLæå–objectName
            String objectName = fileUrl.replace(endpoint + "/" + bucketName + "/", "");

            minioClient.removeObject(
                    RemoveObjectArgs.builder()
                            .bucket(bucketName)
                            .object(objectName)
                            .build()
            );

            log.info("File deleted successfully: {}", fileUrl);

        } catch (Exception e) {
            log.error("Failed to delete file: {}", fileUrl, e);
            // åˆ é™¤å¤±è´¥ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œåªè®°å½•æ—¥å¿—
        }
    }
}
```

### 1.5.4 Pythonåç«¯

**éªŒè¯æ¸…å•**:
- [ ] PythonæœåŠ¡æ— éœ€é¢å¤–å®ç°ï¼ˆç”¨æˆ·ç®¡ç†ç”±JavaæœåŠ¡è´Ÿè´£ï¼‰

> **è¯´æ˜**: ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†å®Œå…¨ç”±JavaæœåŠ¡å¤„ç†ï¼ŒPython AIæœåŠ¡ä¸éœ€è¦å‚ä¸ã€‚

### 1.5.5 éƒ¨ç½²

**éªŒè¯æ¸…å•**:
- [ ] MinIOé…ç½®æ­£ç¡®
- [ ] æ–‡ä»¶ä¸Šä¼ é™åˆ¶é…ç½®
- [ ] å¤´åƒå­˜å‚¨bucketåˆ›å»º

#### MinIOé…ç½®

```yaml
# docker-compose.yml - MinIOé…ç½®
services:
  minio:
    image: minio/minio:latest
    container_name: aibidcomposer-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  backend-java:
    environment:
      # MinIOé…ç½®
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET_NAME=aibidcomposer

      # æ–‡ä»¶ä¸Šä¼ é…ç½®
      - SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=10MB
      - SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=10MB
```

#### application.ymlé…ç½®

```yaml
# backend-java/src/main/resources/application.yml
spring:
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 10MB

minio:
  endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
  access-key: ${MINIO_ACCESS_KEY:minioadmin}
  secret-key: ${MINIO_SECRET_KEY:minioadmin}
  bucket-name: ${MINIO_BUCKET_NAME:aibidcomposer}
```

#### MinIOé…ç½®Bean

```java
// backend-java/src/main/java/com/aibidcomposer/config/MinioConfig.java
package com.aibidcomposer.config;

import io.minio.MinioClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MinIOé…ç½®
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Configuration
public class MinioConfig {

    @Value("${minio.endpoint}")
    private String endpoint;

    @Value("${minio.access-key}")
    private String accessKey;

    @Value("${minio.secret-key}")
    private String secretKey;

    @Bean
    public MinioClient minioClient() {
        return MinioClient.builder()
                .endpoint(endpoint)
                .credentials(accessKey, secretKey)
                .build();
    }
}
```

### å­ä»»åŠ¡æ€»ç»“

#### å®Œæˆæ ‡å‡†

**1.5 ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç†** è¢«è®¤ä¸ºå®Œæˆéœ€è¦æ»¡è¶³ï¼š

1. **æ•°æ®å®šä¹‰** (100%)
   - [ ] DTOç±»å®šä¹‰å®Œæ•´
   - [ ] æ•°æ®éªŒè¯è§„åˆ™æ­£ç¡®

2. **å‰ç«¯** (100%)
   - [ ] ä¸ªäººä¸­å¿ƒé¡µé¢æ­£å¸¸
   - [ ] èµ„æ–™ç¼–è¾‘åŠŸèƒ½æ­£å¸¸
   - [ ] å¤´åƒä¸Šä¼ åŠŸèƒ½æ­£å¸¸
   - [ ] å¯†ç ä¿®æ”¹åŠŸèƒ½æ­£å¸¸
   - [ ] ç™»å½•å†å²å±•ç¤ºæ­£å¸¸

3. **Javaåç«¯** (100%)
   - [ ] UserServiceæ‰©å±•å®Œæˆ
   - [ ] UserController APIå®Œæˆ
   - [ ] FileStorageServiceé›†æˆMinIO
   - [ ] å¯†ç éªŒè¯é€»è¾‘æ­£ç¡®
   - [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%

4. **Pythonåç«¯** (100%)
   - [ ] æ— éœ€å®ç°ï¼ˆN/Aï¼‰

5. **éƒ¨ç½²** (100%)
   - [ ] MinIOé…ç½®æ­£ç¡®
   - [ ] æ–‡ä»¶ä¸Šä¼ æ­£å¸¸
   - [ ] Bucketè‡ªåŠ¨åˆ›å»º

---

## 1.6 æ•°æ®åº“è®¾è®¡å’Œè¿ç§»

**å·¥ä½œé‡**: 3äººå¤©

### æ¦‚è¿°

å®Œæˆç”¨æˆ·è®¤è¯æˆæƒæ¨¡å—çš„æ•°æ®åº“è®¾è®¡å’ŒFlywayè¿ç§»è„šæœ¬ï¼Œç¡®ä¿æ‰€æœ‰è¡¨ç»“æ„ã€ç´¢å¼•ã€çº¦æŸå’Œåˆå§‹æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚

### ç»†åˆ†ä»»åŠ¡ï¼ˆ5ç±»åˆ«ï¼‰

#
