# Java Spring Boot æœåŠ¡ä»»åŠ¡è¯¦ç»†è®¡åˆ’ - JAVA-001 Part2

**æ–‡æ¡£ç±»å‹**: å®æ–½æ–‡æ¡£
**éœ€æ±‚ç¼–å·**: REQ-JAVA-001 (å­ä»»åŠ¡ 1.4)
**åˆ›å»ºæ—¥æœŸ**: 2025-11-26
**åˆ›å»ºè€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**æœ€åæ›´æ–°**: 2025-11-27
**æ›´æ–°è€…**: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
**çŠ¶æ€**: å¾…å¼€å§‹

---

## ä¿®æ”¹å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | ä¿®æ”¹è€… | ä¿®æ”¹å†…å®¹æ¦‚è¦ |
|------|------|--------|-------------|
| 2025-11-27 14:50 | 2.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | ä» task-plan-java-è¯¦ç»†.md æ‹†åˆ†å‡º Part2 (å­ä»»åŠ¡1.4) |
| 2025-11-26 | 1.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | åˆ›å»ºJavaæœåŠ¡è¯¦ç»†ä»»åŠ¡è®¡åˆ’ |

---

## ğŸ“‘ æ–‡æ¡£å¯¼èˆª

**è¿”å›ç´¢å¼•**: [task-plan-java-è¯¦ç»†-INDEX.md](./task-plan-java-è¯¦ç»†-INDEX.md)

**å…¶ä»–éƒ¨åˆ†**:
- [Part1: å­ä»»åŠ¡ 1.1-1.3](./task-plan-java-è¯¦ç»†-JAVA-001-Part1.md)
- [Part3: å­ä»»åŠ¡ 1.5-1.6](./task-plan-java-è¯¦ç»†-JAVA-001-Part3.md)

---

## æ¨¡å—æ¦‚è¿°

æœ¬æ–‡æ¡£åŒ…å« **JAVA-001: ç”¨æˆ·è®¤è¯æˆæƒæ¨¡å—** çš„ç¬¬4ä¸ªå­ä»»åŠ¡ï¼š
- 1.4 æƒé™æ§åˆ¶

**æŠ€æœ¯æ ˆ**: Java 17 LTS + Spring Boot 3.2.x + Spring Data JPA + Spring Security 6.x

---

## 1.4: æƒé™æ§åˆ¶

**å­ä»»åŠ¡ç¼–å·**: JAVA-001-1.4
**é¢„è®¡å·¥æ—¶**: 5äººå¤©
**è´Ÿè´£äºº**: Javaåç«¯å¼€å‘ + å‰ç«¯å¼€å‘
**ä¾èµ–**: 1.1 ç”¨æˆ·ç®¡ç†åŸºç¡€åŠŸèƒ½ã€1.2 Spring Security é›†æˆ
**è¾“å‡º**: å®Œæ•´çš„RBACæƒé™æ§åˆ¶ç³»ç»Ÿ

### ä»»åŠ¡ç›®æ ‡

å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- è§’è‰²ç®¡ç†ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è§’è‰²ï¼‰
- æƒé™ç®¡ç†ï¼ˆå®šä¹‰å’Œåˆ†é…æƒé™ï¼‰
- ç”¨æˆ·è§’è‰²åˆ†é…
- æ–¹æ³•çº§æƒé™æ§åˆ¶ï¼ˆ@PreAuthorizeï¼‰
- åŠ¨æ€æƒé™æ£€æŸ¥

---

### 1.4.1 æ•°æ®å®šä¹‰

**éªŒè¯æ¸…å•**:
- [ ] æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰å®Œæ•´
- [ ] JPA å®ä½“ç±»ç¼–å†™å®Œæˆ
- [ ] DTO ç±»å®šä¹‰å®Œæˆ
- [ ] æ•°æ®éªŒè¯è§„åˆ™æ­£ç¡®

#### æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- Flyway è¿ç§»è„šæœ¬: V2__create_role_permission_tables.sql
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,

    -- ç»„ç»‡å…³è”ï¼ˆNULLè¡¨ç¤ºç³»ç»Ÿè§’è‰²ï¼‰
    organization_id UUID,

    -- ç³»ç»Ÿè§’è‰²æ ‡è¯†
    is_system BOOLEAN DEFAULT FALSE,

    -- è§’è‰²å±‚çº§ï¼ˆç”¨äºæƒé™ç»§æ‰¿ï¼‰
    level INTEGER DEFAULT 0,

    -- æ‰©å±•å­—æ®µ
    metadata JSONB DEFAULT '{}'::jsonb,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,

    FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE CASCADE
);

-- æƒé™è¡¨
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,

    -- æƒé™åˆ†ç±»
    category VARCHAR(50),

    -- èµ„æºå’Œæ“ä½œ
    resource VARCHAR(100) NOT NULL,  -- å¦‚ 'user', 'project', 'document'
    action VARCHAR(50) NOT NULL,     -- å¦‚ 'create', 'read', 'update', 'delete'

    -- ç³»ç»Ÿæƒé™æ ‡è¯†
    is_system BOOLEAN DEFAULT FALSE,

    -- æ‰©å±•å­—æ®µ
    metadata JSONB DEFAULT '{}'::jsonb,

    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL,
    role_id UUID NOT NULL,

    -- æˆäºˆä¿¡æ¯
    granted_by UUID,
    granted_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
    expires_at TIMESTAMP WITH TIME ZONE,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id) ON DELETE SET NULL,

    UNIQUE (user_id, role_id)
);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    role_id UUID NOT NULL,
    permission_id UUID NOT NULL,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,

    UNIQUE (role_id, permission_id)
);

-- ç´¢å¼•
CREATE INDEX idx_roles_code ON roles(code) WHERE deleted_at IS NULL;
CREATE INDEX idx_roles_organization_id ON roles(organization_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_permissions_code ON permissions(code);
CREATE INDEX idx_permissions_resource ON permissions(resource);
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);

-- æ³¨é‡Š
COMMENT ON TABLE roles IS 'è§’è‰²è¡¨';
COMMENT ON TABLE permissions IS 'æƒé™è¡¨';
COMMENT ON TABLE user_roles IS 'ç”¨æˆ·è§’è‰²å…³è”è¡¨';
COMMENT ON TABLE role_permissions IS 'è§’è‰²æƒé™å…³è”è¡¨';

COMMENT ON COLUMN roles.is_system IS 'ç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤';
COMMENT ON COLUMN roles.level IS 'è§’è‰²å±‚çº§ï¼Œæ•°å€¼è¶Šå¤§æƒé™è¶Šé«˜';
COMMENT ON COLUMN permissions.resource IS 'èµ„æºç±»å‹ï¼šuser, project, documentç­‰';
COMMENT ON COLUMN permissions.action IS 'æ“ä½œç±»å‹ï¼šcreate, read, update, delete, executeç­‰';
```

#### JPA å®ä½“ç±»

```java
// backend-java/src/main/java/com/aibidcomposer/domain/Role.java
package com.aibidcomposer.domain;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

/**
 * è§’è‰²å®ä½“
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Entity
@Table(name = "roles")
@EntityListeners(AuditingEntityListener.class)
@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder
public class Role {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(name = "UUID", strategy = "org.hibernate.id.UUIDGenerator")
    private UUID id;

    @Column(name = "name", nullable = false, length = 100)
    private String name;

    @Column(name = "code", unique = true, nullable = false, length = 50)
    private String code;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "organization_id")
    private Organization organization;

    @Column(name = "is_system", nullable = false)
    private Boolean isSystem = false;

    @Column(name = "level", nullable = false)
    private Integer level = 0;

    @ManyToMany(fetch = FetchType.LAZY)
    @JoinTable(
        name = "role_permissions",
        joinColumns = @JoinColumn(name = "role_id"),
        inverseJoinColumns = @JoinColumn(name = "permission_id")
    )
    @Builder.Default
    private Set<Permission> permissions = new HashSet<>();

    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    // ä¸šåŠ¡æ–¹æ³•
    public boolean hasPermission(String permissionCode) {
        return permissions.stream()
                .anyMatch(p -> p.getCode().equals(permissionCode));
    }

    public void addPermission(Permission permission) {
        this.permissions.add(permission);
    }

    public void removePermission(Permission permission) {
        this.permissions.remove(permission);
    }
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/domain/Permission.java
package com.aibidcomposer.domain;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * æƒé™å®ä½“
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Entity
@Table(name = "permissions")
@EntityListeners(AuditingEntityListener.class)
@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder
public class Permission {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(name = "UUID", strategy = "org.hibernate.id.UUIDGenerator")
    private UUID id;

    @Column(name = "name", nullable = false, length = 100)
    private String name;

    @Column(name = "code", unique = true, nullable = false, length = 50)
    private String code;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "category", length = 50)
    private String category;

    @Column(name = "resource", nullable = false, length = 100)
    private String resource;

    @Column(name = "action", nullable = false, length = 50)
    private String action;

    @Column(name = "is_system", nullable = false)
    private Boolean isSystem = false;

    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/domain/UserRole.java
package com.aibidcomposer.domain;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * ç”¨æˆ·è§’è‰²å…³è”å®ä½“
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Entity
@Table(name = "user_roles")
@EntityListeners(AuditingEntityListener.class)
@Getter @Setter @NoArgsConstructor @AllArgsConstructor @Builder
public class UserRole {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(name = "UUID", strategy = "org.hibernate.id.UUIDGenerator")
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "role_id", nullable = false)
    private Role role;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "granted_by")
    private User grantedBy;

    @Column(name = "granted_at", nullable = false)
    private LocalDateTime grantedAt;

    @Column(name = "expires_at")
    private LocalDateTime expiresAt;

    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    // ä¸šåŠ¡æ–¹æ³•
    public boolean isExpired() {
        return expiresAt != null && expiresAt.isBefore(LocalDateTime.now());
    }
}
```

#### DTO ç±»

```java
// backend-java/src/main/java/com/aibidcomposer/dto/role/RoleRequest.java
package com.aibidcomposer.dto.role;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;
import lombok.Data;

import java.util.Set;
import java.util.UUID;

/**
 * è§’è‰²åˆ›å»º/æ›´æ–°è¯·æ±‚DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
public class RoleRequest {

    @NotBlank(message = "è§’è‰²åç§°ä¸èƒ½ä¸ºç©º")
    @Size(max = 100, message = "è§’è‰²åç§°ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    private String name;

    @NotBlank(message = "è§’è‰²ä»£ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^[A-Z_]+$", message = "è§’è‰²ä»£ç åªèƒ½åŒ…å«å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿")
    @Size(max = 50, message = "è§’è‰²ä»£ç ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    private String code;

    @Size(max = 500, message = "æè¿°ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦")
    private String description;

    private UUID organizationId;

    private Integer level = 0;

    private Set<UUID> permissionIds;
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/dto/role/RoleResponse.java
package com.aibidcomposer.dto.role;

import com.aibidcomposer.domain.Role;
import com.aibidcomposer.dto.permission.PermissionResponse;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * è§’è‰²å“åº”DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class RoleResponse {

    private UUID id;
    private String name;
    private String code;
    private String description;
    private UUID organizationId;
    private Boolean isSystem;
    private Integer level;
    private Set<PermissionResponse> permissions;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    public static RoleResponse from(Role role) {
        return RoleResponse.builder()
                .id(role.getId())
                .name(role.getName())
                .code(role.getCode())
                .description(role.getDescription())
                .organizationId(role.getOrganization() != null ? role.getOrganization().getId() : null)
                .isSystem(role.getIsSystem())
                .level(role.getLevel())
                .permissions(role.getPermissions().stream()
                        .map(PermissionResponse::from)
                        .collect(Collectors.toSet()))
                .createdAt(role.getCreatedAt())
                .updatedAt(role.getUpdatedAt())
                .build();
    }
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/dto/permission/PermissionResponse.java
package com.aibidcomposer.dto.permission;

import com.aibidcomposer.domain.Permission;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * æƒé™å“åº”DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PermissionResponse {

    private UUID id;
    private String name;
    private String code;
    private String description;
    private String category;
    private String resource;
    private String action;
    private Boolean isSystem;
    private LocalDateTime createdAt;

    public static PermissionResponse from(Permission permission) {
        return PermissionResponse.builder()
                .id(permission.getId())
                .name(permission.getName())
                .code(permission.getCode())
                .description(permission.getDescription())
                .category(permission.getCategory())
                .resource(permission.getResource())
                .action(permission.getAction())
                .isSystem(permission.getIsSystem())
                .createdAt(permission.getCreatedAt())
                .build();
    }
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/dto/role/AssignRoleRequest.java
package com.aibidcomposer.dto.role;

import jakarta.validation.constraints.NotNull;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.Set;
import java.util.UUID;

/**
 * åˆ†é…è§’è‰²è¯·æ±‚DTO
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Data
public class AssignRoleRequest {

    @NotNull(message = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
    private UUID userId;

    @NotNull(message = "è§’è‰²IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º")
    private Set<UUID> roleIds;

    private LocalDateTime expiresAt;
}
```

### 1.4.2 å‰ç«¯

**éªŒè¯æ¸…å•**:
- [ ] è§’è‰²ç®¡ç†é¡µé¢å¼€å‘å®Œæˆ
- [ ] æƒé™ç®¡ç†é¡µé¢å¼€å‘å®Œæˆ
- [ ] ç”¨æˆ·è§’è‰²åˆ†é…åŠŸèƒ½æ­£å¸¸
- [ ] æƒé™æ£€æŸ¥é€»è¾‘æ­£ç¡®

#### è§’è‰²ç®¡ç†é¡µé¢

```typescript
// frontend/src/pages/System/Role/RoleList.tsx
import React, { useRef, useState } from 'react';
import { ProTable, ProColumns, ActionType } from '@ant-design/pro-table';
import { Button, message, Modal, Tag, Space, Tooltip } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, SafetyOutlined } from '@ant-design/icons';
import type { RoleResponse } from '@/services/role.service';
import { roleService } from '@/services/role.service';
import RoleForm from './RoleForm';
import PermissionAssign from './PermissionAssign';

/**
 * è§’è‰²ç®¡ç†åˆ—è¡¨é¡µé¢
 * éœ€æ±‚ç¼–å·: REQ-FRONT-002
 */
const RoleList: React.FC = () => {
  const actionRef = useRef<ActionType>();
  const [createModalVisible, setCreateModalVisible] = useState(false);
  const [updateModalVisible, setUpdateModalVisible] = useState(false);
  const [permissionModalVisible, setPermissionModalVisible] = useState(false);
  const [currentRole, setCurrentRole] = useState<RoleResponse | null>(null);

  const columns: ProColumns<RoleResponse>[] = [
    {
      title: 'è§’è‰²åç§°',
      dataIndex: 'name',
      width: 150,
      fixed: 'left',
    },
    {
      title: 'è§’è‰²ä»£ç ',
      dataIndex: 'code',
      width: 150,
      copyable: true,
    },
    {
      title: 'æè¿°',
      dataIndex: 'description',
      ellipsis: true,
      search: false,
    },
    {
      title: 'å±‚çº§',
      dataIndex: 'level',
      width: 80,
      sorter: true,
      render: (text) => <Tag color="blue">{text}</Tag>,
    },
    {
      title: 'ç³»ç»Ÿè§’è‰²',
      dataIndex: 'isSystem',
      width: 100,
      valueType: 'select',
      valueEnum: {
        true: { text: 'æ˜¯', status: 'Success' },
        false: { text: 'å¦', status: 'Default' },
      },
      render: (_, record) => (
        <Tag color={record.isSystem ? 'gold' : 'default'}>
          {record.isSystem ? 'ç³»ç»Ÿ' : 'è‡ªå®šä¹‰'}
        </Tag>
      ),
    },
    {
      title: 'æƒé™æ•°é‡',
      dataIndex: 'permissions',
      width: 100,
      search: false,
      render: (_, record) => (
        <Tooltip title="ç‚¹å‡»æŸ¥çœ‹æƒé™è¯¦æƒ…">
          <Tag color="geekblue" style={{ cursor: 'pointer' }}>
            {record.permissions?.length || 0} ä¸ª
          </Tag>
        </Tooltip>
      ),
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createdAt',
      valueType: 'dateTime',
      width: 180,
      sorter: true,
      search: false,
    },
    {
      title: 'æ“ä½œ',
      valueType: 'option',
      width: 200,
      fixed: 'right',
      render: (text, record, _, action) => [
        <a
          key="edit"
          onClick={() => {
            setCurrentRole(record);
            setUpdateModalVisible(true);
          }}
          disabled={record.isSystem}
        >
          <EditOutlined /> ç¼–è¾‘
        </a>,
        <a
          key="permissions"
          onClick={() => {
            setCurrentRole(record);
            setPermissionModalVisible(true);
          }}
        >
          <SafetyOutlined /> æƒé™
        </a>,
        <a
          key="delete"
          onClick={async () => {
            Modal.confirm({
              title: 'ç¡®è®¤åˆ é™¤',
              content: `ç¡®å®šè¦åˆ é™¤è§’è‰²"${record.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
              okText: 'ç¡®å®š',
              cancelText: 'å–æ¶ˆ',
              okType: 'danger',
              onOk: async () => {
                try {
                  await roleService.deleteRole(record.id);
                  message.success('è§’è‰²åˆ é™¤æˆåŠŸ');
                  action?.reload();
                } catch (error: any) {
                  message.error(error.message || 'åˆ é™¤å¤±è´¥');
                }
              },
            });
          }}
          disabled={record.isSystem}
        >
          <DeleteOutlined /> åˆ é™¤
        </a>,
      ],
    },
  ];

  return (
    <>
      <ProTable<RoleResponse>
        columns={columns}
        actionRef={actionRef}
        request={async (params, sort, filter) => {
          const response = await roleService.getRoles({
            page: params.current || 1,
            pageSize: params.pageSize || 20,
            name: params.name,
            code: params.code,
            isSystem: params.isSystem,
            sortBy: sort && Object.keys(sort)[0],
            sortOrder: sort && Object.values(sort)[0] === 'ascend' ? 'asc' : 'desc',
          });
          return {
            data: response.data.items,
            success: response.success,
            total: response.data.total,
          };
        }}
        rowKey="id"
        pagination={{
          pageSize: 20,
          showSizeChanger: true,
          showQuickJumper: true,
        }}
        search={{
          labelWidth: 'auto',
        }}
        dateFormatter="string"
        headerTitle="è§’è‰²åˆ—è¡¨"
        toolBarRender={() => [
          <Button
            key="button"
            icon={<PlusOutlined />}
            type="primary"
            onClick={() => {
              setCurrentRole(null);
              setCreateModalVisible(true);
            }}
          >
            æ–°å»ºè§’è‰²
          </Button>,
        ]}
      />

      {/* åˆ›å»ºè§’è‰²å¼¹çª— */}
      <RoleForm
        visible={createModalVisible}
        onCancel={() => setCreateModalVisible(false)}
        onSuccess={() => {
          setCreateModalVisible(false);
          actionRef.current?.reload();
        }}
      />

      {/* ç¼–è¾‘è§’è‰²å¼¹çª— */}
      <RoleForm
        visible={updateModalVisible}
        role={currentRole}
        onCancel={() => setUpdateModalVisible(false)}
        onSuccess={() => {
          setUpdateModalVisible(false);
          actionRef.current?.reload();
        }}
      />

      {/* æƒé™åˆ†é…å¼¹çª— */}
      <PermissionAssign
        visible={permissionModalVisible}
        role={currentRole}
        onCancel={() => setPermissionModalVisible(false)}
        onSuccess={() => {
          setPermissionModalVisible(false);
          actionRef.current?.reload();
        }}
      />
    </>
  );
};

export default RoleList;
```

#### è§’è‰²è¡¨å•ç»„ä»¶

```typescript
// frontend/src/pages/System/Role/RoleForm.tsx
import React, { useEffect } from 'react';
import { Modal, message } from 'antd';
import { ProForm, ProFormText, ProFormTextArea, ProFormDigit, ProFormSelect } from '@ant-design/pro-form';
import type { RoleResponse, RoleRequest } from '@/services/role.service';
import { roleService } from '@/services/role.service';

interface RoleFormProps {
  visible: boolean;
  role?: RoleResponse | null;
  onCancel: () => void;
  onSuccess: () => void;
}

/**
 * è§’è‰²åˆ›å»º/ç¼–è¾‘è¡¨å•
 * éœ€æ±‚ç¼–å·: REQ-FRONT-002
 */
const RoleForm: React.FC<RoleFormProps> = ({ visible, role, onCancel, onSuccess }) => {
  const [form] = ProForm.useForm();

  useEffect(() => {
    if (visible && role) {
      form.setFieldsValue({
        name: role.name,
        code: role.code,
        description: role.description,
        level: role.level,
      });
    } else {
      form.resetFields();
    }
  }, [visible, role, form]);

  const handleSubmit = async (values: RoleRequest) => {
    try {
      if (role) {
        await roleService.updateRole(role.id, values);
        message.success('è§’è‰²æ›´æ–°æˆåŠŸ');
      } else {
        await roleService.createRole(values);
        message.success('è§’è‰²åˆ›å»ºæˆåŠŸ');
      }
      onSuccess();
      return true;
    } catch (error: any) {
      message.error(error.message || 'æ“ä½œå¤±è´¥');
      return false;
    }
  };

  return (
    <Modal
      title={role ? 'ç¼–è¾‘è§’è‰²' : 'æ–°å»ºè§’è‰²'}
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={600}
      destroyOnClose
    >
      <ProForm
        form={form}
        onFinish={handleSubmit}
        submitter={{
          searchConfig: {
            submitText: role ? 'æ›´æ–°' : 'åˆ›å»º',
          },
        }}
      >
        <ProFormText
          name="name"
          label="è§’è‰²åç§°"
          placeholder="è¯·è¾“å…¥è§’è‰²åç§°"
          rules={[
            { required: true, message: 'è¯·è¾“å…¥è§’è‰²åç§°' },
            { max: 100, message: 'è§’è‰²åç§°ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦' },
          ]}
        />

        <ProFormText
          name="code"
          label="è§’è‰²ä»£ç "
          placeholder="è¯·è¾“å…¥è§’è‰²ä»£ç ï¼ˆå¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼‰"
          disabled={!!role}
          rules={[
            { required: true, message: 'è¯·è¾“å…¥è§’è‰²ä»£ç ' },
            { pattern: /^[A-Z_]+$/, message: 'åªèƒ½åŒ…å«å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿' },
            { max: 50, message: 'è§’è‰²ä»£ç ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦' },
          ]}
          tooltip="è§’è‰²ä»£ç åˆ›å»ºåä¸å¯ä¿®æ”¹"
        />

        <ProFormTextArea
          name="description"
          label="æè¿°"
          placeholder="è¯·è¾“å…¥è§’è‰²æè¿°"
          rules={[{ max: 500, message: 'æè¿°ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦' }]}
          fieldProps={{ rows: 4 }}
        />

        <ProFormDigit
          name="level"
          label="è§’è‰²å±‚çº§"
          placeholder="è¯·è¾“å…¥è§’è‰²å±‚çº§"
          min={0}
          max={100}
          initialValue={0}
          tooltip="å±‚çº§è¶Šé«˜æƒé™è¶Šå¤§ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¸º100"
        />
      </ProForm>
    </Modal>
  );
};

export default RoleForm;
```

#### æƒé™åˆ†é…ç»„ä»¶

```typescript
// frontend/src/pages/System/Role/PermissionAssign.tsx
import React, { useEffect, useState } from 'react';
import { Modal, Tree, message, Spin } from 'antd';
import type { DataNode } from 'antd/es/tree';
import type { RoleResponse } from '@/services/role.service';
import type { PermissionResponse } from '@/services/permission.service';
import { roleService } from '@/services/role.service';
import { permissionService } from '@/services/permission.service';

interface PermissionAssignProps {
  visible: boolean;
  role: RoleResponse | null;
  onCancel: () => void;
  onSuccess: () => void;
}

/**
 * æƒé™åˆ†é…ç»„ä»¶
 * éœ€æ±‚ç¼–å·: REQ-FRONT-002
 */
const PermissionAssign: React.FC<PermissionAssignProps> = ({ visible, role, onCancel, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [permissions, setPermissions] = useState<PermissionResponse[]>([]);
  const [checkedKeys, setCheckedKeys] = useState<string[]>([]);
  const [treeData, setTreeData] = useState<DataNode[]>([]);

  useEffect(() => {
    if (visible && role) {
      loadPermissions();
    }
  }, [visible, role]);

  const loadPermissions = async () => {
    setLoading(true);
    try {
      const response = await permissionService.getAllPermissions();
      setPermissions(response.data);

      // æ„å»ºæƒé™æ ‘
      const tree = buildPermissionTree(response.data);
      setTreeData(tree);

      // è®¾ç½®å·²é€‰ä¸­çš„æƒé™
      const checked = role?.permissions?.map((p) => p.id) || [];
      setCheckedKeys(checked);
    } catch (error: any) {
      message.error(error.message || 'åŠ è½½æƒé™å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  const buildPermissionTree = (permissions: PermissionResponse[]): DataNode[] => {
    const categoryMap: Record<string, PermissionResponse[]> = {};

    permissions.forEach((permission) => {
      const category = permission.category || 'å…¶ä»–';
      if (!categoryMap[category]) {
        categoryMap[category] = [];
      }
      categoryMap[category].push(permission);
    });

    return Object.entries(categoryMap).map(([category, perms]) => ({
      title: category,
      key: category,
      children: perms.map((p) => ({
        title: `${p.name} (${p.code})`,
        key: p.id,
      })),
    }));
  };

  const handleSubmit = async () => {
    if (!role) return;

    setLoading(true);
    try {
      await roleService.assignPermissions(role.id, {
        permissionIds: checkedKeys,
      });
      message.success('æƒé™åˆ†é…æˆåŠŸ');
      onSuccess();
    } catch (error: any) {
      message.error(error.message || 'æƒé™åˆ†é…å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Modal
      title={`åˆ†é…æƒé™ - ${role?.name}`}
      open={visible}
      onCancel={onCancel}
      onOk={handleSubmit}
      confirmLoading={loading}
      width={600}
      okText="ä¿å­˜"
      cancelText="å–æ¶ˆ"
    >
      <Spin spinning={loading}>
        <Tree
          checkable
          checkedKeys={checkedKeys}
          onCheck={(checked: any) => setCheckedKeys(checked)}
          treeData={treeData}
          defaultExpandAll
        />
      </Spin>
    </Modal>
  );
};

export default PermissionAssign;
```

#### API å®¢æˆ·ç«¯

```typescript
// frontend/src/services/role.service.ts
import axios from '@/utils/axios';
import type { PaginatedResponse, ApiResponse } from '@/types/api';

export interface RoleResponse {
  id: string;
  name: string;
  code: string;
  description: string;
  organizationId?: string;
  isSystem: boolean;
  level: number;
  permissions: PermissionResponse[];
  createdAt: string;
  updatedAt: string;
}

export interface RoleRequest {
  name: string;
  code: string;
  description?: string;
  organizationId?: string;
  level?: number;
  permissionIds?: string[];
}

export interface AssignPermissionsRequest {
  permissionIds: string[];
}

export const roleService = {
  /**
   * è·å–è§’è‰²åˆ—è¡¨
   */
  getRoles: (params: {
    page?: number;
    pageSize?: number;
    name?: string;
    code?: string;
    isSystem?: boolean;
    sortBy?: string;
    sortOrder?: 'asc' | 'desc';
  }): Promise<ApiResponse<PaginatedResponse<RoleResponse>>> => {
    return axios.get('/api/v1/roles', { params });
  },

  /**
   * è·å–è§’è‰²è¯¦æƒ…
   */
  getRoleById: (id: string): Promise<ApiResponse<RoleResponse>> => {
    return axios.get(`/api/v1/roles/${id}`);
  },

  /**
   * åˆ›å»ºè§’è‰²
   */
  createRole: (data: RoleRequest): Promise<ApiResponse<RoleResponse>> => {
    return axios.post('/api/v1/roles', data);
  },

  /**
   * æ›´æ–°è§’è‰²
   */
  updateRole: (id: string, data: RoleRequest): Promise<ApiResponse<RoleResponse>> => {
    return axios.put(`/api/v1/roles/${id}`, data);
  },

  /**
   * åˆ é™¤è§’è‰²
   */
  deleteRole: (id: string): Promise<ApiResponse<void>> => {
    return axios.delete(`/api/v1/roles/${id}`);
  },

  /**
   * åˆ†é…æƒé™ç»™è§’è‰²
   */
  assignPermissions: (id: string, data: AssignPermissionsRequest): Promise<ApiResponse<RoleResponse>> => {
    return axios.post(`/api/v1/roles/${id}/permissions`, data);
  },

  /**
   * åˆ†é…è§’è‰²ç»™ç”¨æˆ·
   */
  assignRolesToUser: (userId: string, roleIds: string[]): Promise<ApiResponse<void>> => {
    return axios.post(`/api/v1/users/${userId}/roles`, { roleIds });
  },
};
```

### 1.4.3 Javaåç«¯

**éªŒè¯æ¸…å•**:
- [ ] RoleRepository å®ç°å®Œæˆ
- [ ] PermissionRepository å®ç°å®Œæˆ
- [ ] RoleService ä¸šåŠ¡é€»è¾‘å®Œæˆ
- [ ] PermissionService ä¸šåŠ¡é€»è¾‘å®Œæˆ
- [ ] RoleController API å®Œæˆ
- [ ] @PreAuthorize æƒé™æ³¨è§£é…ç½®
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%

#### Repository å±‚

```java
// backend-java/src/main/java/com/aibidcomposer/repository/RoleRepository.java
package com.aibidcomposer.repository;

import com.aibidcomposer.domain.Role;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.Set;
import java.util.UUID;

/**
 * è§’è‰²Repository
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Repository
public interface RoleRepository extends JpaRepository<Role, UUID> {

    /**
     * æ ¹æ®ä»£ç æŸ¥è¯¢è§’è‰²
     */
    Optional<Role> findByCode(String code);

    /**
     * æ£€æŸ¥è§’è‰²ä»£ç æ˜¯å¦å­˜åœ¨
     */
    boolean existsByCode(String code);

    /**
     * åˆ†é¡µæŸ¥è¯¢è§’è‰²ï¼ˆæœªè½¯åˆ é™¤ï¼‰
     */
    @Query("SELECT r FROM Role r WHERE r.deletedAt IS NULL " +
           "AND (:name IS NULL OR r.name LIKE %:name%) " +
           "AND (:code IS NULL OR r.code LIKE %:code%) " +
           "AND (:isSystem IS NULL OR r.isSystem = :isSystem)")
    Page<Role> findAllActive(String name, String code, Boolean isSystem, Pageable pageable);

    /**
     * æ ¹æ®ç»„ç»‡IDæŸ¥è¯¢è§’è‰²
     */
    @Query("SELECT r FROM Role r WHERE r.deletedAt IS NULL " +
           "AND r.organization.id = :organizationId")
    Set<Role> findByOrganizationId(UUID organizationId);

    /**
     * æŸ¥è¯¢ç³»ç»Ÿè§’è‰²
     */
    @Query("SELECT r FROM Role r WHERE r.deletedAt IS NULL AND r.isSystem = true")
    Set<Role> findSystemRoles();
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/repository/PermissionRepository.java
package com.aibidcomposer.repository;

import com.aibidcomposer.domain.Permission;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;

/**
 * æƒé™Repository
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Repository
public interface PermissionRepository extends JpaRepository<Permission, UUID> {

    /**
     * æ ¹æ®ä»£ç æŸ¥è¯¢æƒé™
     */
    Optional<Permission> findByCode(String code);

    /**
     * æ£€æŸ¥æƒé™ä»£ç æ˜¯å¦å­˜åœ¨
     */
    boolean existsByCode(String code);

    /**
     * æ ¹æ®åˆ†ç±»æŸ¥è¯¢æƒé™
     */
    List<Permission> findByCategory(String category);

    /**
     * æ ¹æ®èµ„æºå’Œæ“ä½œæŸ¥è¯¢æƒé™
     */
    Optional<Permission> findByResourceAndAction(String resource, String action);

    /**
     * æ ¹æ®IDåˆ—è¡¨æŸ¥è¯¢æƒé™
     */
    @Query("SELECT p FROM Permission p WHERE p.id IN :ids")
    Set<Permission> findByIdIn(Set<UUID> ids);

    /**
     * æŸ¥è¯¢æ‰€æœ‰æƒé™ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼‰
     */
    @Query("SELECT p FROM Permission p ORDER BY p.category, p.resource, p.action")
    List<Permission> findAllOrderByCategory();
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/repository/UserRoleRepository.java
package com.aibidcomposer.repository;

import com.aibidcomposer.domain.UserRole;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Set;
import java.util.UUID;

/**
 * ç”¨æˆ·è§’è‰²Repository
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Repository
public interface UserRoleRepository extends JpaRepository<UserRole, UUID> {

    /**
     * æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²ï¼ˆæœªè¿‡æœŸï¼‰
     */
    @Query("SELECT ur FROM UserRole ur WHERE ur.user.id = :userId " +
           "AND (ur.expiresAt IS NULL OR ur.expiresAt > CURRENT_TIMESTAMP)")
    List<UserRole> findActiveByUserId(UUID userId);

    /**
     * åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
     */
    void deleteByUserId(UUID userId);

    /**
     * åˆ é™¤ç”¨æˆ·çš„ç‰¹å®šè§’è‰²
     */
    void deleteByUserIdAndRoleId(UUID userId, UUID roleId);
}
```

#### Service å±‚

```java
// backend-java/src/main/java/com/aibidcomposer/service/RoleService.java
package com.aibidcomposer.service;

import com.aibidcomposer.domain.Permission;
import com.aibidcomposer.domain.Role;
import com.aibidcomposer.domain.User;
import com.aibidcomposer.domain.UserRole;
import com.aibidcomposer.dto.role.AssignRoleRequest;
import com.aibidcomposer.dto.role.RoleRequest;
import com.aibidcomposer.dto.role.RoleResponse;
import com.aibidcomposer.exception.ResourceNotFoundException;
import com.aibidcomposer.exception.ValidationException;
import com.aibidcomposer.repository.PermissionRepository;
import com.aibidcomposer.repository.RoleRepository;
import com.aibidcomposer.repository.UserRepository;
import com.aibidcomposer.repository.UserRoleRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * è§’è‰²æœåŠ¡
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class RoleService {

    private final RoleRepository roleRepository;
    private final PermissionRepository permissionRepository;
    private final UserRepository userRepository;
    private final UserRoleRepository userRoleRepository;

    /**
     * åˆ›å»ºè§’è‰²
     */
    public UUID createRole(RoleRequest request) {
        log.info("Creating role: {}", request.getCode());

        // æ£€æŸ¥è§’è‰²ä»£ç å”¯ä¸€æ€§
        if (roleRepository.existsByCode(request.getCode())) {
            throw new ValidationException("è§’è‰²ä»£ç å·²å­˜åœ¨: " + request.getCode());
        }

        // æ„å»ºè§’è‰²å®ä½“
        Role role = Role.builder()
                .name(request.getName())
                .code(request.getCode())
                .description(request.getDescription())
                .level(request.getLevel() != null ? request.getLevel() : 0)
                .isSystem(false)
                .build();

        // åˆ†é…æƒé™
        if (request.getPermissionIds() != null && !request.getPermissionIds().isEmpty()) {
            Set<Permission> permissions = permissionRepository.findByIdIn(request.getPermissionIds());
            role.setPermissions(permissions);
        }

        Role savedRole = roleRepository.save(role);
        log.info("Role created successfully: {}", savedRole.getId());

        return savedRole.getId();
    }

    /**
     * æ›´æ–°è§’è‰²
     */
    public void updateRole(UUID roleId, RoleRequest request) {
        log.info("Updating role: {}", roleId);

        Role role = roleRepository.findById(roleId)
                .orElseThrow(() -> new ResourceNotFoundException("è§’è‰²ä¸å­˜åœ¨"));

        // ç³»ç»Ÿè§’è‰²ä¸å¯ä¿®æ”¹
        if (role.getIsSystem()) {
            throw new ValidationException("ç³»ç»Ÿè§’è‰²ä¸å¯ä¿®æ”¹");
        }

        // æ›´æ–°åŸºæœ¬ä¿¡æ¯
        role.setName(request.getName());
        role.setDescription(request.getDescription());
        if (request.getLevel() != null) {
            role.setLevel(request.getLevel());
        }

        // æ›´æ–°æƒé™
        if (request.getPermissionIds() != null) {
            Set<Permission> permissions = permissionRepository.findByIdIn(request.getPermissionIds());
            role.setPermissions(permissions);
        }

        roleRepository.save(role);
        log.info("Role updated successfully: {}", roleId);
    }

    /**
     * åˆ é™¤è§’è‰²ï¼ˆè½¯åˆ é™¤ï¼‰
     */
    public void deleteRole(UUID roleId) {
        log.info("Deleting role: {}", roleId);

        Role role = roleRepository.findById(roleId)
                .orElseThrow(() -> new ResourceNotFoundException("è§’è‰²ä¸å­˜åœ¨"));

        // ç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤
        if (role.getIsSystem()) {
            throw new ValidationException("ç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤");
        }

        // è½¯åˆ é™¤
        role.setDeletedAt(LocalDateTime.now());
        roleRepository.save(role);

        log.info("Role deleted successfully: {}", roleId);
    }

    /**
     * åˆ†é…æƒé™ç»™è§’è‰²
     */
    public void assignPermissions(UUID roleId, Set<UUID> permissionIds) {
        log.info("Assigning permissions to role: {}", roleId);

        Role role = roleRepository.findById(roleId)
                .orElseThrow(() -> new ResourceNotFoundException("è§’è‰²ä¸å­˜åœ¨"));

        Set<Permission> permissions = permissionRepository.findByIdIn(permissionIds);
        role.setPermissions(permissions);

        roleRepository.save(role);
        log.info("Permissions assigned successfully to role: {}", roleId);
    }

    /**
     * åˆ†é…è§’è‰²ç»™ç”¨æˆ·
     */
    public void assignRolesToUser(AssignRoleRequest request, UUID grantedBy) {
        log.info("Assigning roles to user: {}", request.getUserId());

        User user = userRepository.findById(request.getUserId())
                .orElseThrow(() -> new ResourceNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        User grantor = userRepository.findById(grantedBy)
                .orElseThrow(() -> new ResourceNotFoundException("æˆæƒäººä¸å­˜åœ¨"));

        // åˆ é™¤ç”¨æˆ·ç°æœ‰è§’è‰²
        userRoleRepository.deleteByUserId(request.getUserId());

        // åˆ†é…æ–°è§’è‰²
        for (UUID roleId : request.getRoleIds()) {
            Role role = roleRepository.findById(roleId)
                    .orElseThrow(() -> new ResourceNotFoundException("è§’è‰²ä¸å­˜åœ¨: " + roleId));

            UserRole userRole = UserRole.builder()
                    .user(user)
                    .role(role)
                    .grantedBy(grantor)
                    .grantedAt(LocalDateTime.now())
                    .expiresAt(request.getExpiresAt())
                    .build();

            userRoleRepository.save(userRole);
        }

        log.info("Roles assigned successfully to user: {}", request.getUserId());
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢è§’è‰²
     */
    @Transactional(readOnly = true)
    public Page<RoleResponse> getRoles(String name, String code, Boolean isSystem, Pageable pageable) {
        Page<Role> roles = roleRepository.findAllActive(name, code, isSystem, pageable);
        return roles.map(RoleResponse::from);
    }

    /**
     * æ ¹æ®IDæŸ¥è¯¢è§’è‰²
     */
    @Transactional(readOnly = true)
    public RoleResponse getRoleById(UUID roleId) {
        Role role = roleRepository.findById(roleId)
                .orElseThrow(() -> new ResourceNotFoundException("è§’è‰²ä¸å­˜åœ¨"));
        return RoleResponse.from(role);
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
     */
    @Transactional(readOnly = true)
    public Set<Role> getUserRoles(UUID userId) {
        List<UserRole> userRoles = userRoleRepository.findActiveByUserId(userId);
        return userRoles.stream()
                .map(UserRole::getRole)
                .collect(Collectors.toSet());
    }
}
```

```java
// backend-java/src/main/java/com/aibidcomposer/service/PermissionService.java
package com.aibidcomposer.service;

import com.aibidcomposer.domain.Permission;
import com.aibidcomposer.dto.permission.PermissionResponse;
import com.aibidcomposer.repository.PermissionRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

/**
 * æƒé™æœåŠ¡
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class PermissionService {

    private final PermissionRepository permissionRepository;

    /**
     * æŸ¥è¯¢æ‰€æœ‰æƒé™
     */
    public List<PermissionResponse> getAllPermissions() {
        List<Permission> permissions = permissionRepository.findAllOrderByCategory();
        return permissions.stream()
                .map(PermissionResponse::from)
                .collect(Collectors.toList());
    }

    /**
     * æ ¹æ®åˆ†ç±»æŸ¥è¯¢æƒé™
     */
    public List<PermissionResponse> getPermissionsByCategory(String category) {
        List<Permission> permissions = permissionRepository.findByCategory(category);
        return permissions.stream()
                .map(PermissionResponse::from)
                .collect(Collectors.toList());
    }
}
```

#### Controller å±‚

```java
// backend-java/src/main/java/com/aibidcomposer/controller/RoleController.java
package com.aibidcomposer.controller;

import com.aibidcomposer.dto.common.ApiResponse;
import com.aibidcomposer.dto.common.PagedResponse;
import com.aibidcomposer.dto.role.AssignRoleRequest;
import com.aibidcomposer.dto.role.RoleRequest;
import com.aibidcomposer.dto.role.RoleResponse;
import com.aibidcomposer.service.RoleService;
import com.aibidcomposer.security.CurrentUser;
import com.aibidcomposer.security.UserPrincipal;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.Set;
import java.util.UUID;

/**
 * è§’è‰²ç®¡ç†Controller
 * éœ€æ±‚ç¼–å·: REQ-JAVA-001
 */
@RestController
@RequestMapping("/api/v1/roles")
@RequiredArgsConstructor
@Slf4j
public class RoleController {

    private final RoleService roleService;

    /**
     * è·å–è§’è‰²åˆ—è¡¨
     */
    @GetMapping
    @PreAuthorize("hasAuthority('role:read')")
    public ResponseEntity<ApiResponse<PagedResponse<RoleResponse>>> getRoles(
            @RequestParam(required = false) String name,
            @RequestParam(required = false) String code,
            @RequestParam(required = false) Boolean isSystem,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int pageSize,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder
    ) {
        Sort.Direction direction = sortOrder.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC;
        Pageable pageable = PageRequest.of(page - 1, pageSize, Sort.by(direction, sortBy));

        Page<RoleResponse> roles = roleService.getRoles(name, code, isSystem, pageable);

        PagedResponse<RoleResponse> pagedResponse = new PagedResponse<>(
                roles.getContent(),
                roles.getTotalElements(),
                page,
                pageSize,
                roles.getTotalPages()
        );

        return ResponseEntity.ok(ApiResponse.success(pagedResponse, "è·å–æˆåŠŸ"));
    }

    /**
     * è·å–è§’è‰²è¯¦æƒ…
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasAuthority('role:read')")
    public ResponseEntity<ApiResponse<RoleResponse>> getRoleById(@PathVariable UUID id) {
        RoleResponse role = roleService.getRoleById(id);
        return ResponseEntity.ok(ApiResponse.success(role));
    }

    /**
     * åˆ›å»ºè§’è‰²
     */
    @PostMapping
    @PreAuthorize("hasAuthority('role:create')")
    public ResponseEntity<ApiResponse<UUID>> createRole(
            @Valid @RequestBody RoleRequest request
    ) {
        UUID roleId = roleService.createRole(request);
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(ApiResponse.success(roleId, "è§’è‰²åˆ›å»ºæˆåŠŸ"));
    }

    /**
     * æ›´æ–°è§’è‰²
     */
    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('role:update')")
    public ResponseEntity<ApiResponse<Void>> updateRole(
            @PathVariable UUID id,
            @Valid @RequestBody RoleRequest request
    ) {
        roleService.updateRole(id, request);
        return ResponseEntity.ok(ApiResponse.success(null, "è§’è‰²æ›´æ–°æˆåŠŸ"));
    }

    /**
     * åˆ é™¤è§’è‰²
     */
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('role:delete')")
    public ResponseEntity<ApiResponse<Void>> deleteRole(@PathVariable UUID id) {
        roleService.deleteRole(id);
        return ResponseEntity.ok(ApiResponse.success(null, "è§’è‰²åˆ é™¤æˆåŠŸ"));
    }

    /**
     * åˆ†é…æƒé™ç»™è§’è‰²
     */
    @PostMapping("/{id}/permissions")
    @PreAuthorize("hasAuthority('role:update')")
    public ResponseEntity<ApiResponse<Void>> assignPermissions(
            @PathVariable UUID id,
            @RequestBody Set<UUID> permissionIds
    ) {
        roleService.assignPermissions(id, permissionIds);
        return ResponseEntity.ok(ApiResponse.success(null, "æƒé™åˆ†é…æˆåŠŸ"));
    }

    /**
     * åˆ†é…è§’è‰²ç»™ç”¨æˆ·
     */
    @PostMapping("/assign")
    @PreAuthorize("hasAuthority('role:assign')")
    public ResponseEntity<ApiResponse<Void>> assignRolesToUser(
            @Valid @RequestBody AssignRoleRequest request,
            @CurrentUser UserPrincipal currentUser
    ) {
        roleService.assignRolesToUser(request, currentUser.getId());
        return ResponseEntity.ok(ApiResponse.success(null, "è§’è‰²åˆ†é…æˆåŠŸ"));
    }
}
```

#### æƒé™æ³¨è§£ä½¿ç”¨ç¤ºä¾‹

```java
// åœ¨éœ€è¦æƒé™æ§åˆ¶çš„Controlleræ–¹æ³•ä¸Šä½¿ç”¨@PreAuthorize

// ç¤ºä¾‹1: æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šæƒé™
@PreAuthorize("hasAuthority('user:create')")
public ResponseEntity<ApiResponse<UUID>> createUser(...) { }

// ç¤ºä¾‹2: æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä¸€æƒé™
@PreAuthorize("hasAnyAuthority('user:update', 'user:admin')")
public ResponseEntity<ApiResponse<Void>> updateUser(...) { }

// ç¤ºä¾‹3: æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šè§’è‰²
@PreAuthorize("hasRole('ADMIN')")
public ResponseEntity<ApiResponse<Void>> deleteUser(...) { }

// ç¤ºä¾‹4: å¤æ‚æƒé™è¡¨è¾¾å¼
@PreAuthorize("hasAuthority('project:read') and #userId == principal.id")
public ResponseEntity<ApiResponse<ProjectResponse>> getProject(@PathVariable UUID userId) { }
```

### 1.4.4 Pythonåç«¯

**éªŒè¯æ¸…å•**:
- [ ] JWTæƒé™éªŒè¯ä¸­é—´ä»¶å®ç°
- [ ] è§’è‰²æƒé™æ£€æŸ¥è£…é¥°å™¨å®ç°

#### æƒé™æ£€æŸ¥è£…é¥°å™¨

```python
# backend-python/app/core/security.py
from functools import wraps
from typing import List, Optional
from fastapi import HTTPException, status, Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from jose import jwt, JWTError
from app.core.config import settings
from app.models.user import User

# JWT Bearer TokenéªŒè¯
security = HTTPBearer()

def decode_token(token: str) -> dict:
    """
    è§£ç JWT Token
    éœ€æ±‚ç¼–å·: REQ-JAVA-001
    """
    try:
        payload = jwt.decode(
            token,
            settings.JWT_SECRET_KEY,
            algorithms=[settings.JWT_ALGORITHM]
        )
        return payload
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æ— æ•ˆçš„Token"
        )

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> dict:
    """
    ä»Tokenè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    éœ€æ±‚ç¼–å·: REQ-JAVA-001
    """
    token = credentials.credentials
    payload = decode_token(token)

    user_id = payload.get("sub")
    if not user_id:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Tokenä¸­ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯"
        )

    return payload

def require_permissions(required_permissions: List[str]):
    """
    æƒé™æ£€æŸ¥è£…é¥°å™¨

    ä½¿ç”¨ç¤ºä¾‹:
    @router.post("/documents")
    @require_permissions(["document:create"])
    async def create_document(current_user: dict = Depends(get_current_user)):
        ...

    éœ€æ±‚ç¼–å·: REQ-JAVA-001
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # ä»ä¾èµ–æ³¨å…¥è·å–current_user
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="æœªç™»å½•"
                )

            # æ£€æŸ¥æƒé™
            user_permissions = current_user.get('permissions', [])

            missing_permissions = [
                perm for perm in required_permissions
                if perm not in user_permissions
            ]

            if missing_permissions:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"ç¼ºå°‘æƒé™: {', '.join(missing_permissions)}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator

def require_roles(required_roles: List[str]):
    """
    è§’è‰²æ£€æŸ¥è£…é¥°å™¨

    ä½¿ç”¨ç¤ºä¾‹:
    @router.delete("/users/{user_id}")
    @require_roles(["ADMIN"])
    async def delete_user(user_id: str, current_user: dict = Depends(get_current_user)):
        ...

    éœ€æ±‚ç¼–å·: REQ-JAVA-001
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="æœªç™»å½•"
                )

            # æ£€æŸ¥è§’è‰²
            user_roles = current_user.get('roles', [])

            has_required_role = any(role in user_roles for role in required_roles)

            if not has_required_role:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€: {', '.join(required_roles)}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

#### AIæœåŠ¡æƒé™æ£€æŸ¥ç¤ºä¾‹

```python
# backend-python/app/api/v1/ai.py
from fastapi import APIRouter, Depends, UploadFile, File
from app.core.security import get_current_user, require_permissions
from app.services.ai.document_parser import DocumentParser

router = APIRouter()

@router.post("/parse-document")
@require_permissions(["document:parse"])
async def parse_document(
    file: UploadFile = File(...),
    current_user: dict = Depends(get_current_user)
):
    """
    è§£ææ‹›æ ‡æ–‡ä»¶ï¼ˆéœ€è¦ document:parse æƒé™ï¼‰
    éœ€æ±‚ç¼–å·: REQ-AI-001
    """
    parser = DocumentParser()
    result = await parser.parse(file, user_id=current_user['sub'])

    return {
        "success": True,
        "data": result
    }

@router.post("/generate-content")
@require_permissions(["document:generate"])
async def generate_content(
    document_id: str,
    section_id: str,
    current_user: dict = Depends(get_current_user)
):
    """
    ç”Ÿæˆå†…å®¹ï¼ˆéœ€è¦ document:generate æƒé™ï¼‰
    éœ€æ±‚ç¼–å·: REQ-AI-002
    """
    # AIå†…å®¹ç”Ÿæˆé€»è¾‘
    pass
```

### 1.4.5 éƒ¨ç½²

**éªŒè¯æ¸…å•**:
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] åˆå§‹æƒé™æ•°æ®å¯¼å…¥å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æƒé™éªŒè¯æ­£å¸¸å·¥ä½œ

#### åˆå§‹æƒé™æ•°æ®

```sql
-- Flyway è¿ç§»è„šæœ¬: V3__insert_initial_permissions.sql
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001

-- æ’å…¥ç³»ç»Ÿæƒé™
INSERT INTO permissions (id, name, code, description, category, resource, action, is_system) VALUES
-- ç”¨æˆ·ç®¡ç†æƒé™
(uuid_generate_v4(), 'ç”¨æˆ·æŸ¥çœ‹', 'user:read', 'æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯', 'ç”¨æˆ·ç®¡ç†', 'user', 'read', true),
(uuid_generate_v4(), 'ç”¨æˆ·åˆ›å»º', 'user:create', 'åˆ›å»ºæ–°ç”¨æˆ·', 'ç”¨æˆ·ç®¡ç†', 'user', 'create', true),
(uuid_generate_v4(), 'ç”¨æˆ·æ›´æ–°', 'user:update', 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯', 'ç”¨æˆ·ç®¡ç†', 'user', 'update', true),
(uuid_generate_v4(), 'ç”¨æˆ·åˆ é™¤', 'user:delete', 'åˆ é™¤ç”¨æˆ·', 'ç”¨æˆ·ç®¡ç†', 'user', 'delete', true),

-- è§’è‰²ç®¡ç†æƒé™
(uuid_generate_v4(), 'è§’è‰²æŸ¥çœ‹', 'role:read', 'æŸ¥çœ‹è§’è‰²ä¿¡æ¯', 'è§’è‰²ç®¡ç†', 'role', 'read', true),
(uuid_generate_v4(), 'è§’è‰²åˆ›å»º', 'role:create', 'åˆ›å»ºæ–°è§’è‰²', 'è§’è‰²ç®¡ç†', 'role', 'create', true),
(uuid_generate_v4(), 'è§’è‰²æ›´æ–°', 'role:update', 'æ›´æ–°è§’è‰²ä¿¡æ¯', 'è§’è‰²ç®¡ç†', 'role', 'update', true),
(uuid_generate_v4(), 'è§’è‰²åˆ é™¤', 'role:delete', 'åˆ é™¤è§’è‰²', 'è§’è‰²ç®¡ç†', 'role', 'delete', true),
(uuid_generate_v4(), 'è§’è‰²åˆ†é…', 'role:assign', 'åˆ†é…è§’è‰²ç»™ç”¨æˆ·', 'è§’è‰²ç®¡ç†', 'role', 'assign', true),

-- é¡¹ç›®ç®¡ç†æƒé™
(uuid_generate_v4(), 'é¡¹ç›®æŸ¥çœ‹', 'project:read', 'æŸ¥çœ‹é¡¹ç›®ä¿¡æ¯', 'é¡¹ç›®ç®¡ç†', 'project', 'read', true),
(uuid_generate_v4(), 'é¡¹ç›®åˆ›å»º', 'project:create', 'åˆ›å»ºæ–°é¡¹ç›®', 'é¡¹ç›®ç®¡ç†', 'project', 'create', true),
(uuid_generate_v4(), 'é¡¹ç›®æ›´æ–°', 'project:update', 'æ›´æ–°é¡¹ç›®ä¿¡æ¯', 'é¡¹ç›®ç®¡ç†', 'project', 'update', true),
(uuid_generate_v4(), 'é¡¹ç›®åˆ é™¤', 'project:delete', 'åˆ é™¤é¡¹ç›®', 'é¡¹ç›®ç®¡ç†', 'project', 'delete', true),

-- æ–‡æ¡£ç®¡ç†æƒé™
(uuid_generate_v4(), 'æ–‡æ¡£æŸ¥çœ‹', 'document:read', 'æŸ¥çœ‹æ–‡æ¡£å†…å®¹', 'æ–‡æ¡£ç®¡ç†', 'document', 'read', true),
(uuid_generate_v4(), 'æ–‡æ¡£åˆ›å»º', 'document:create', 'åˆ›å»ºæ–°æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'create', true),
(uuid_generate_v4(), 'æ–‡æ¡£æ›´æ–°', 'document:update', 'æ›´æ–°æ–‡æ¡£å†…å®¹', 'æ–‡æ¡£ç®¡ç†', 'document', 'update', true),
(uuid_generate_v4(), 'æ–‡æ¡£åˆ é™¤', 'document:delete', 'åˆ é™¤æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'delete', true),
(uuid_generate_v4(), 'æ–‡æ¡£è§£æ', 'document:parse', 'è§£ææ‹›æ ‡æ–‡æ¡£', 'æ–‡æ¡£ç®¡ç†', 'document', 'parse', true),
(uuid_generate_v4(), 'æ–‡æ¡£ç”Ÿæˆ', 'document:generate', 'AIç”Ÿæˆæ–‡æ¡£å†…å®¹', 'æ–‡æ¡£ç®¡ç†', 'document', 'generate', true),

-- æ¨¡æ¿ç®¡ç†æƒé™
(uuid_generate_v4(), 'æ¨¡æ¿æŸ¥çœ‹', 'template:read', 'æŸ¥çœ‹æ¨¡æ¿å†…å®¹', 'æ¨¡æ¿ç®¡ç†', 'template', 'read', true),
(uuid_generate_v4(), 'æ¨¡æ¿åˆ›å»º', 'template:create', 'åˆ›å»ºæ–°æ¨¡æ¿', 'æ¨¡æ¿ç®¡ç†', 'template', 'create', true),
(uuid_generate_v4(), 'æ¨¡æ¿æ›´æ–°', 'template:update', 'æ›´æ–°æ¨¡æ¿å†…å®¹', 'æ¨¡æ¿ç®¡ç†', 'template', 'update', true),
(uuid_generate_v4(), 'æ¨¡æ¿åˆ é™¤', 'template:delete', 'åˆ é™¤æ¨¡æ¿', 'æ¨¡æ¿ç®¡ç†', 'template', 'delete', true);
```

```sql
-- Flyway è¿ç§»è„šæœ¬: V4__insert_initial_roles.sql
-- éœ€æ±‚ç¼–å·: REQ-JAVA-001

-- æ’å…¥ç³»ç»Ÿè§’è‰²
INSERT INTO roles (id, name, code, description, is_system, level) VALUES
(uuid_generate_v4(), 'è¶…çº§ç®¡ç†å‘˜', 'SUPER_ADMIN', 'æ‹¥æœ‰æ‰€æœ‰æƒé™çš„è¶…çº§ç®¡ç†å‘˜', true, 100),
(uuid_generate_v4(), 'ç®¡ç†å‘˜', 'ADMIN', 'ç»„ç»‡ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰å¤§éƒ¨åˆ†æƒé™', true, 80),
(uuid_generate_v4(), 'é¡¹ç›®ç»ç†', 'PROJECT_MANAGER', 'é¡¹ç›®ç»ç†ï¼Œè´Ÿè´£é¡¹ç›®ç®¡ç†', true, 60),
(uuid_generate_v4(), 'æ™®é€šæˆå‘˜', 'MEMBER', 'æ™®é€šæˆå‘˜ï¼ŒåŸºç¡€æƒé™', true, 40),
(uuid_generate_v4(), 'è®¿å®¢', 'GUEST', 'è®¿å®¢ï¼Œåªè¯»æƒé™', true, 20);

-- ä¸ºè¶…çº§ç®¡ç†å‘˜åˆ†é…æ‰€æœ‰æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
CROSS JOIN permissions p
WHERE r.code = 'SUPER_ADMIN';

-- ä¸ºç®¡ç†å‘˜åˆ†é…æƒé™ï¼ˆé™¤è§’è‰²åˆ é™¤å¤–ï¼‰
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
CROSS JOIN permissions p
WHERE r.code = 'ADMIN'
AND p.code NOT IN ('role:delete');

-- ä¸ºé¡¹ç›®ç»ç†åˆ†é…æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
CROSS JOIN permissions p
WHERE r.code = 'PROJECT_MANAGER'
AND p.code IN (
    'project:read', 'project:create', 'project:update',
    'document:read', 'document:create', 'document:update',
    'document:parse', 'document:generate',
    'template:read', 'template:create'
);

-- ä¸ºæ™®é€šæˆå‘˜åˆ†é…æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
CROSS JOIN permissions p
WHERE r.code = 'MEMBER'
AND p.code IN (
    'project:read',
    'document:read', 'document:create', 'document:update',
    'template:read'
);

-- ä¸ºè®¿å®¢åˆ†é…æƒé™
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r
CROSS JOIN permissions p
WHERE r.code = 'GUEST'
AND p.code IN (
    'project:read',
    'document:read',
    'template:read'
);
```

#### Dockerç¯å¢ƒå˜é‡

```yaml
# docker-compose.yml - æƒé™ç›¸å…³ç¯å¢ƒå˜é‡
services:
  backend-java:
    environment:
      # RBACé…ç½®
      - RBAC_ENABLED=true
      - RBAC_DEFAULT_ROLE=MEMBER

      # è¶…çº§ç®¡ç†å‘˜åˆå§‹åŒ–
      - SUPER_ADMIN_EMAIL=admin@aibidcomposer.com
      - SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}

  backend-python:
    environment:
      # JWTéªŒè¯é…ç½®
      - JWT_SECRET_KEY=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
```

### å­ä»»åŠ¡æ€»ç»“

#### å®Œæˆæ ‡å‡†

**1.4 æƒé™æ§åˆ¶** è¢«è®¤ä¸ºå®Œæˆéœ€è¦æ»¡è¶³ï¼š

1. **æ•°æ®å®šä¹‰** (100%)
   - [ ] æ•°æ®åº“è¡¨ç»“æ„åˆ›å»ºå®Œæˆï¼ˆroles, permissions, user_roles, role_permissionsï¼‰
   - [ ] JPAå®ä½“ç±»å®šä¹‰å®Œæ•´
   - [ ] DTOç±»å®šä¹‰å®Œæ•´
   - [ ] åˆå§‹æƒé™å’Œè§’è‰²æ•°æ®å¯¼å…¥

2. **å‰ç«¯** (100%)
   - [ ] è§’è‰²ç®¡ç†é¡µé¢æ­£å¸¸ï¼ˆåˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
   - [ ] æƒé™åˆ†é…åŠŸèƒ½æ­£å¸¸
   - [ ] ç”¨æˆ·è§’è‰²åˆ†é…åŠŸèƒ½æ­£å¸¸
   - [ ] æƒé™æ ‘å±•ç¤ºæ­£ç¡®

3. **Javaåç«¯** (100%)
   - [ ] RoleRepositoryã€PermissionRepositoryã€UserRoleRepositoryå®Œæˆ
   - [ ] RoleServiceã€PermissionServiceä¸šåŠ¡é€»è¾‘å®Œæˆ
   - [ ] RoleController APIæµ‹è¯•é€šè¿‡
   - [ ] @PreAuthorizeæƒé™æ³¨è§£æ­£ç¡®å·¥ä½œ
   - [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>80%

4. **Pythonåç«¯** (100%)
   - [ ] JWTæƒé™éªŒè¯ä¸­é—´ä»¶æ­£å¸¸
   - [ ] æƒé™æ£€æŸ¥è£…é¥°å™¨æ­£å¸¸å·¥ä½œ
   - [ ] AIæœåŠ¡æƒé™æ§åˆ¶ç”Ÿæ•ˆ

5. **éƒ¨ç½²** (100%)
   - [ ] æ•°æ®åº“è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
   - [ ] åˆå§‹æƒé™å’Œè§’è‰²æ•°æ®å¯¼å…¥
   - [ ] æƒé™éªŒè¯åœ¨æ‰€æœ‰ç¯å¢ƒæ­£å¸¸

---


---

**ğŸ“– ç»§ç»­é˜…è¯»**: [Part3 - å­ä»»åŠ¡ 1.5-1.6](./task-plan-java-è¯¦ç»†-JAVA-001-Part3.md)
