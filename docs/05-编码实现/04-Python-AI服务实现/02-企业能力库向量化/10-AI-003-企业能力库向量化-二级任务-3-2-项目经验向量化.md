# Python FastAPI AI 服务任务详细计划 - AI-003 - AI-003: 企业能力库向量化 - 二级任务 3.2: 项目经验向量化

**工作量估算**: 4 人天
**优先级**: P2 - 高优先级
**技术难点**:
- 项目案例的多维度信息提取
- 成果量化数据的处理
- 客户评价的情感分析

#### 1) 数据定义

##### Pydantic模型
```python
# app/models/project_case.py
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any
from datetime import date, datetime
from decimal import Decimal

class ProjectCase(BaseModel):
    """项目案例模型"""
    id: str = Field(..., description="案例ID")
    organization_id: str = Field(..., description="组织ID")

    # 项目基本信息
    project_name: str = Field(..., description="项目名称")
    client_name: str = Field(..., description="客户名称")
    client_industry: Optional[str] = Field(None, description="客户行业")
    project_category: Optional[str] = Field(None, description="项目类别")
    project_type: Optional[str] = Field(None, description="项目类型")

    # 项目规模
    contract_amount: Optional[Decimal] = Field(None, description="合同金额")
    start_date: Optional[date] = Field(None, description="开始日期")
    end_date: Optional[date] = Field(None, description="结束日期")
    duration_months: Optional[int] = Field(None, description="持续月数")
    team_size: Optional[int] = Field(None, description="团队规模")

    # 项目描述
    project_description: str = Field(..., description="项目描述")
    challenges: Optional[str] = Field(None, description="面临的挑战")
    solutions: Optional[str] = Field(None, description="解决方案")

    # 项目成果
    achievements: List[str] = Field(default_factory=list, description="成果亮点")
    customer_satisfaction: Optional[Decimal] = Field(None, description="客户满意度")
    customer_feedback: Optional[str] = Field(None, description="客户评价")

    # 技术相关
    technologies_used: List[str] = Field(default_factory=list, description="使用的技术")
    project_role: Optional[str] = Field(None, description="项目角色")

    # 向量化相关
    embedding: Optional[List[float]] = Field(None, description="向量")
    embedding_model: str = Field("text-embedding-ada-002")
    vectorized_at: Optional[datetime] = Field(None)

    # 元数据
    tags: List[str] = Field(default_factory=list)
    is_reference: bool = Field(True, description="是否可作为参考案例")
    is_public: bool = Field(False, description="是否公开")
    created_at: datetime = Field(default_factory=datetime.utcnow)
```

##### Java实体
```java
@Data
@TableName("project_cases")
public class ProjectCase {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;

    private String organizationId;
    private String projectName;
    private String clientName;
    private String clientIndustry;
    private String projectCategory;

    private BigDecimal contractAmount;
    private LocalDate startDate;
    private LocalDate endDate;
    private Integer durationMonths;
    private Integer teamSize;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private String projectDescription;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> achievements;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> technologiesUsed;

    private String embeddingStatus;
    private LocalDateTime vectorizedAt;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> tags;

    private Boolean isReference;
    private Boolean isPublic;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;
}
```

**验证标准**:
- [ ] Pydantic模型验证通过
- [ ] 数据库表创建成功
- [ ] 客户满意度等数值字段精度正确

#### 2) 前端

```typescript
// src/pages/Capability/CaseList.tsx
export default function CaseList() {
  const columns: ProColumns<ProjectCase>[] = [
    {
      title: '项目名称',
      dataIndex: 'projectName',
      width: 200,
      render: (text, record) => (
        <a onClick={() => handleViewCase(record)}>{text}</a>
      ),
    },
    {
      title: '客户',
      dataIndex: 'clientName',
      width: 150,
    },
    {
      title: '行业',
      dataIndex: 'clientIndustry',
      width: 120,
      valueType: 'select',
      valueEnum: {
        finance: '金融',
        government: '政府',
        education: '教育',
        healthcare: '医疗',
      },
    },
    {
      title: '合同金额',
      dataIndex: 'contractAmount',
      width: 120,
      valueType: 'money',
      search: false,
    },
    {
      title: '项目周期',
      dataIndex: 'durationMonths',
      width: 100,
      search: false,
      render: (_, record) => `${record.durationMonths}个月`,
    },
    {
      title: '客户满意度',
      dataIndex: 'customerSatisfaction',
      width: 120,
      search: false,
      render: (_, record) => (
        <Rate disabled value={record.customerSatisfaction} />
      ),
    },
    {
      title: '技术栈',
      dataIndex: 'technologiesUsed',
      width: 200,
      search: false,
      render: (_, record) => (
        <>
          {record.technologiesUsed.slice(0, 3).map(tech => (
            <Tag key={tech} color="blue">{tech}</Tag>
          ))}
        </>
      ),
    },
    {
      title: '向量化状态',
      dataIndex: 'embeddingStatus',
      width: 120,
      valueEnum: {
        pending: { text: '待处理', status: 'Default' },
        completed: { text: '已完成', status: 'Success' },
        failed: { text: '失败', status: 'Error' },
      },
    },
  ];

  return (
    <ProTable<ProjectCase>
      headerTitle="项目案例库"
      columns={columns}
      request={async (params) => {
        const response = await fetch(`http://localhost:8080/api/v1/capabilities/cases?page=${params.current}`);
        const result = await response.json();
        return {
          data: result.data.items,
          total: result.data.total,
          success: true,
        };
      }}
    />
  );
}
```

**验证标准**:
- [ ] 案例列表正常展示
- [ ] 客户满意度星级展示正确
- [ ] 技术栈标签展示完整

#### 3) Java后端

```java
@Service
public class ProjectCaseService {

    /**
     * 创建项目案例
     * 需求编号: REQ-AI-003
     */
    public ProjectCase createCase(CreateProjectCaseRequest request) {
        ProjectCase projectCase = new ProjectCase();
        // 设置基本信息
        projectCase.setOrganizationId(request.getOrganizationId());
        projectCase.setProjectName(request.getProjectName());
        projectCase.setClientName(request.getClientName());
        projectCase.setClientIndustry(request.getClientIndustry());

        // 设置项目规模
        projectCase.setContractAmount(request.getContractAmount());
        projectCase.setStartDate(request.getStartDate());
        projectCase.setEndDate(request.getEndDate());
        projectCase.setDurationMonths(request.getDurationMonths());

        // 设置成果和技术
        projectCase.setAchievements(request.getAchievements());
        projectCase.setTechnologiesUsed(request.getTechnologiesUsed());

        projectCase.setEmbeddingStatus("pending");
        projectCaseMapper.insert(projectCase);

        // 发送向量化消息
        VectorizeMessage message = VectorizeMessage.builder()
            .capabilityId(projectCase.getId())
            .capabilityType("case")
            .organizationId(projectCase.getOrganizationId())
            .build();

        rabbitTemplate.convertAndSend(
            "ai.vectorize.exchange",
            "vectorize.case",
            message
        );

        return projectCase;
    }
}
```

**验证标准**:
- [ ] 案例创建成功
- [ ] 向量化消息发送成功
- [ ] 金额、日期字段存储正确

#### 4) Python后端

```python
# app/services/ai/case_vectorization_service.py
class CaseVectorizationService:
    """项目案例向量化服务"""

    async def vectorize_case(
        self,
        case_id: str,
        organization_id: str
    ) -> Dict[str, Any]:
        """向量化项目案例"""

        # 1. 获取案例详情
        response = await self.java_client.get(f"/api/v1/capabilities/cases/{case_id}")
        case_data = response.json()['data']

        # 2. 构建向量化文本（包含多维度信息）
        vectorize_text = self._build_case_text(case_data)

        # 3. 生成向量
        embedding = await self.embedding_model.aget_text_embedding(vectorize_text)

        # 4. 存储到Elasticsearch
        await self.es_store.add_document(
            doc_id=case_id,
            embedding=embedding,
            metadata={
                'capability_id': case_id,
                'organization_id': organization_id,
                'capability_type': 'case',
                'project_name': case_data['projectName'],
                'client_name': case_data['clientName'],
                'client_industry': case_data['clientIndustry'],
                'contract_amount': case_data.get('contractAmount'),
                'achievements': case_data.get('achievements', []),
                'technologies_used': case_data.get('technologiesUsed', []),
                'customer_satisfaction': case_data.get('customerSatisfaction'),
                'tags': case_data.get('tags', []),
                'vectorized_at': datetime.utcnow().isoformat()
            },
            index_name="capabilities"
        )

        # 5. 回调Java服务
        await self._callback_java_service(case_id, "completed")

        return {
            'case_id': case_id,
            'status': 'completed',
            'embedding_dim': len(embedding)
        }

    def _build_case_text(self, case_data: Dict[str, Any]) -> str:
        """构建案例向量化文本"""
        parts = []

        # 项目基本信息
        parts.append(f"项目名称：{case_data['projectName']}")
        parts.append(f"客户：{case_data['clientName']}")
        if case_data.get('clientIndustry'):
            parts.append(f"行业：{case_data['clientIndustry']}")

        # 项目描述
        parts.append(f"项目描述：{case_data['projectDescription']}")

        # 挑战和解决方案
        if case_data.get('challenges'):
            parts.append(f"面临挑战：{case_data['challenges']}")
        if case_data.get('solutions'):
            parts.append(f"解决方案：{case_data['solutions']}")

        # 成果
        if case_data.get('achievements'):
            achievements_text = "、".join(case_data['achievements'])
            parts.append(f"项目成果：{achievements_text}")

        # 技术栈
        if case_data.get('technologiesUsed'):
            tech_text = "、".join(case_data['technologiesUsed'])
            parts.append(f"技术栈：{tech_text}")

        # 客户评价
        if case_data.get('customerFeedback'):
            parts.append(f"客户评价：{case_data['customerFeedback']}")

        return "\n".join(parts)
```

**验证标准**:
- [ ] 案例文本构建包含所有关键信息
- [ ] 向量生成成功
- [ ] Elasticsearch存储成功
- [ ] 回调Java服务成功

#### 5) 部署

```yaml
# docker-compose.yml 中添加案例向量化worker
services:
  case-vectorization-worker:
    build: ./backend-python
    command: celery -A app.tasks.celery_app worker --loglevel=info -Q case_vectorization
    environment:
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - JAVA_SERVICE_URL=http://backend-java:8080
```

**验证标准**:
- [ ] Worker正常启动
- [ ] 能接收并处理案例向量化任务

---
