# AIBidComposer - 服务启动验证指南 - 详细验证步骤

### 1. 前置检查

#### 1.1 检查Docker环境

```bash
# 检查Docker是否运行
docker info

# 检查Docker版本（需要24+）
docker --version
```

**预期结果**:
```
Docker version 24.0.7, build afdd53b
```

#### 1.2 检查Docker Compose

```bash
# 检查docker-compose版本
docker-compose --version
```

**预期结果**:
```
Docker Compose version v2.23.0
```

#### 1.3 检查环境变量配置

```bash
# 检查.env文件是否存在
ls -la .env

# 验证关键环境变量
grep -E "POSTGRES_PASSWORD|REDIS_PASSWORD|OPENAI_API_KEY" .env
```

**必需配置**:
- ✅ `POSTGRES_PASSWORD` - 数据库密码（至少16字符）
- ✅ `REDIS_PASSWORD` - Redis密码
- ✅ `OPENAI_API_KEY` - OpenAI API密钥
- ✅ `JWT_SECRET` - JWT密钥（至少32字符）

---

### 2. 启动所有服务

#### 2.1 启动开发环境

```bash
# 使用自动化脚本（推荐）
./scripts/start-dev.sh

# 或手动启动
docker-compose up -d
```

#### 2.2 启动生产环境

```bash
# 使用自动化脚本（推荐）
./scripts/start-prod.sh

# 或手动启动
docker-compose -f docker-compose.prod.yml up -d
```

#### 2.3 检查容器状态

```bash
# 查看所有容器状态
docker-compose ps

# 预期看到类似输出：
# NAME                      STATUS              PORTS
# aibidcomposer-postgres    Up (healthy)        5432/tcp
# aibidcomposer-redis       Up (healthy)        6379/tcp
# aibidcomposer-backend-java Up                 0.0.0.0:8080->8080/tcp
# ...
```

---

### 3. 验证基础数据服务

#### 3.1 PostgreSQL验证

```bash
# 检查PostgreSQL可连接性
docker-compose exec postgres pg_isready -U postgres

# 预期输出
/var/run/postgresql:5432 - accepting connections

# 连接到数据库
docker-compose exec postgres psql -U postgres -d aibidcomposer

# 在psql中执行以下命令：
\l                          # 列出所有数据库
\dx                         # 列出已安装扩展
SELECT version();           # 查看PostgreSQL版本
\q                          # 退出
```

**验证要点**:
- ✅ 数据库 `aibidcomposer` 已创建
- ✅ 扩展已安装: `uuid-ossp`, `pg_trgm`, `btree_gin`
- ✅ 时区设置为 `Asia/Shanghai`

**常见问题**:
```bash
# 如果连接失败，检查日志
docker-compose logs postgres

# 检查数据卷
docker volume ls | grep postgres
```

#### 3.2 Elasticsearch验证

```bash
# 检查集群健康状态
curl -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health?pretty

# 预期输出（JSON格式）：
{
  "cluster_name": "aibidcomposer-cluster",
  "status": "yellow",  # 单节点集群为yellow是正常的
  "number_of_nodes": 1,
  "active_primary_shards": 0
}

# 查看节点信息
curl -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cat/nodes?v

# 查看索引
curl -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cat/indices?v
```

**验证要点**:
- ✅ 集群状态为 `green` 或 `yellow`（单节点为yellow是正常的）
- ✅ 节点数量正确
- ✅ 可以访问API

**常见问题**:
```bash
# 内存不足错误
# 解决方案：增加vm.max_map_count
sudo sysctl -w vm.max_map_count=262144

# 查看Elasticsearch日志
docker-compose logs elasticsearch
```

#### 3.3 Redis验证

```bash
# 使用redis-cli测试
docker-compose exec redis redis-cli -a ${REDIS_PASSWORD}

# 在redis-cli中执行：
PING                        # 应该返回PONG
SET test_key "hello"        # 设置测试键
GET test_key                # 获取测试键
DEL test_key                # 删除测试键
INFO SERVER                 # 查看服务器信息
EXIT                        # 退出

# 或直接执行命令
docker-compose exec redis redis-cli -a ${REDIS_PASSWORD} PING
```

**验证要点**:
- ✅ PING命令返回PONG
- ✅ 可以正常读写
- ✅ Redis版本为7.x

**性能测试**:
```bash
# Redis基准测试
docker-compose exec redis redis-benchmark -a ${REDIS_PASSWORD} -n 10000 -q
```

#### 3.4 RabbitMQ验证

```bash
# 访问Management UI
open http://localhost:15672

# 默认凭据：
# 用户名: guest
# 密码: guest

# 使用API检查
curl -u guest:guest http://localhost:15672/api/overview

# 检查队列
curl -u guest:guest http://localhost:15672/api/queues
```

**验证要点**:
- ✅ Management UI可访问
- ✅ 可以查看overview和队列信息
- ✅ RabbitMQ版本为3.x

**功能测试**:
```bash
# 创建测试队列（通过Management UI或命令行）
docker-compose exec rabbitmq rabbitmqctl list_queues
```

#### 3.5 MinIO验证

```bash
# 检查MinIO健康状态
curl http://localhost:9000/minio/health/live

# 预期输出
200 OK

# 访问MinIO Console
open http://localhost:9001

# 默认凭据：
# Access Key: minioadmin
# Secret Key: minioadmin
```

**验证要点**:
- ✅ Health endpoint返回200
- ✅ Console可访问
- ✅ 可以登录和查看buckets

**创建测试bucket**:
```bash
# 通过Console创建bucket，或使用mc客户端
docker-compose exec minio mc mb local/test-bucket
docker-compose exec minio mc ls local/
```

---

### 4. 验证应用服务

#### 4.1 Java Spring Boot服务验证

```bash
# 等待服务启动（可能需要30-60秒）
sleep 30

# 检查健康状态
curl http://localhost:8080/actuator/health | jq

# 预期输出
{
  "status": "UP",
  "components": {
    "db": { "status": "UP" },
    "redis": { "status": "UP" },
    "diskSpace": { "status": "UP" }
  }
}

# 检查数据库连接
curl http://localhost:8080/actuator/health/db | jq

# 检查Redis连接
curl http://localhost:8080/actuator/health/redis | jq

# 访问Swagger UI
open http://localhost:8080/swagger-ui.html
```

**验证要点**:
- ✅ `/actuator/health` 返回 `UP`
- ✅ 数据库组件状态为 `UP`
- ✅ Redis组件状态为 `UP`
- ✅ Swagger UI可访问

**查看日志**:
```bash
# 实时查看日志
docker-compose logs -f backend-java

# 查看最近100行
docker-compose logs --tail=100 backend-java

# 搜索错误
docker-compose logs backend-java | grep -i error
```

#### 4.2 Python FastAPI服务验证

```bash
# 等待服务启动（可能需要10-20秒）
sleep 10

# 检查健康状态
curl http://localhost:8001/health | jq

# 预期输出
{
  "status": "healthy",
  "service": "ai-service",
  "version": "1.0.0",
  "timestamp": "2025-11-26T08:00:00Z"
}

# 访问API文档
open http://localhost:8001/docs     # Swagger UI
open http://localhost:8001/redoc    # ReDoc

# 测试API端点
curl http://localhost:8001/api/v1/ai/models
```

**验证要点**:
- ✅ `/health` 返回 `healthy`
- ✅ API文档可访问
- ✅ 可以调用API端点

**查看日志**:
```bash
# 实时查看日志
docker-compose logs -f backend-python

# 查看启动日志
docker-compose logs backend-python | grep "Uvicorn running"
```

#### 4.3 React前端服务验证

```bash
# 访问前端（开发环境）
open http://localhost:5173

# 检查Vite开发服务器
curl http://localhost:5173
```

**验证要点**:
- ✅ 前端页面可访问
- ✅ 页面正常加载
- ✅ 热模块替换（HMR）工作正常

**测试热重载**:
```bash
# 修改前端源文件
echo "// test" >> apps/frontend/src/App.tsx

# 浏览器应自动刷新，无需手动reload
```

**查看日志**:
```bash
docker-compose logs -f frontend
```

#### 4.4 Celery Worker验证

```bash
# 检查Worker状态
docker-compose ps ai-worker

# 查看Worker日志
docker-compose logs ai-worker | grep "celery@"

# 预期看到类似输出：
[2025-11-26 08:00:00,000: INFO/MainProcess] celery@ai-worker ready.

# 检查注册的任务
docker-compose logs ai-worker | grep "tasks"
```

**验证要点**:
- ✅ Worker进程运行中
- ✅ 已连接到RabbitMQ
- ✅ 任务已注册

**发送测试任务**:
```bash
# 通过Python服务API发送测试任务
curl -X POST http://localhost:8001/api/v1/ai/test-task
```

#### 4.5 Celery Beat验证

```bash
# 检查Beat调度器状态
docker-compose ps celery-beat

# 查看Beat日志
docker-compose logs celery-beat | grep "Scheduler"

# 预期看到定时任务调度日志
```

**验证要点**:
- ✅ Beat进程运行中
- ✅ 可以看到定时任务调度日志

---

### 5. 服务间通信验证

#### 5.1 Java → PostgreSQL

```bash
# 通过actuator健康检查验证
curl http://localhost:8080/actuator/health/db | jq

# 预期输出
{
  "status": "UP",
  "details": {
    "database": "PostgreSQL",
    "validationQuery": "isValid()"
  }
}
```

#### 5.2 Java → Redis

```bash
# 通过actuator健康检查验证
curl http://localhost:8080/actuator/health/redis | jq

# 预期输出
{
  "status": "UP",
  "details": {
    "version": "7.x.x"
  }
}
```

#### 5.3 Java → Python AI服务

```bash
# 查看Java服务配置
docker-compose exec backend-java env | grep AI_SERVICE_URL

# 应该输出
AI_SERVICE_URL=http://backend-python:8001

# 测试Java调用Python服务（需要实现相应API）
# curl -X POST http://localhost:8080/api/v1/test-ai-connection
```

#### 5.4 Python → Elasticsearch

```bash
# 查看Python服务日志中的Elasticsearch连接
docker-compose logs backend-python | grep -i "elasticsearch"

# 测试Python服务的向量检索功能
curl -X POST http://localhost:8001/api/v1/ai/test-vector-search \
  -H "Content-Type: application/json" \
  -d '{"query": "test"}'
```

#### 5.5 Python → Redis

```bash
# 查看Python服务配置
docker-compose exec backend-python env | grep REDIS_URL

# 测试缓存功能（通过API）
curl http://localhost:8001/api/v1/cache/test
```

#### 5.6 Python → RabbitMQ

```bash
# 检查Celery Worker连接
docker-compose logs ai-worker | grep "Connected to"

# 预期看到
Connected to amqp://rabbitmq:**@rabbitmq:5672//
```

---

### 6. 功能性验证

#### 6.1 用户认证流程（Java服务）

```bash
# 测试用户注册
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "SecurePassword123!"
  }'

# 测试用户登录
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "SecurePassword123!"
  }'

# 应该返回JWT Token
```

#### 6.2 文件上传（MinIO集成）

```bash
# 测试文件上传API
curl -X POST http://localhost:8080/api/v1/files/upload \
  -H "Authorization: Bearer {TOKEN}" \
  -F "file=@test.pdf"
```

#### 6.3 AI服务调用（Python服务）

```bash
# 测试AI内容生成
curl -X POST http://localhost:8001/api/v1/ai/generate-content \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "生成测试内容",
    "max_tokens": 100
  }'
```

---

### 7. 性能验证

#### 7.1 数据库性能

```bash
# PostgreSQL连接池状态
docker-compose exec postgres psql -U postgres -d aibidcomposer \
  -c "SELECT * FROM pg_stat_activity;"

# 慢查询日志
docker-compose exec postgres psql -U postgres -d aibidcomposer \
  -c "SELECT query, calls, total_time FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;"
```

#### 7.2 Redis性能

```bash
# Redis统计信息
docker-compose exec redis redis-cli -a ${REDIS_PASSWORD} INFO STATS

# 内存使用
docker-compose exec redis redis-cli -a ${REDIS_PASSWORD} INFO MEMORY
```

#### 7.3 应用服务性能

```bash
# Java服务JVM内存使用
curl http://localhost:8080/actuator/metrics/jvm.memory.used | jq

# Java服务线程数
curl http://localhost:8080/actuator/metrics/jvm.threads.live | jq

# Python服务进程信息
docker-compose exec backend-python ps aux
```

---

### 8. 日志验证

#### 8.1 查看所有服务日志

```bash
# 所有服务日志
docker-compose logs

# 实时跟踪所有日志
docker-compose logs -f

# 最近100行
docker-compose logs --tail=100

# 特定时间范围
docker-compose logs --since "2025-11-26T08:00:00"
```

#### 8.2 搜索错误日志

```bash
# 搜索所有ERROR级别日志
docker-compose logs | grep -i "error"

# 搜索WARNING级别日志
docker-compose logs | grep -i "warn"

# 搜索异常堆栈
docker-compose logs | grep -A 10 "Exception"
```

#### 8.3 服务特定日志

```bash
# PostgreSQL日志
docker-compose logs postgres

# Java服务日志
docker-compose logs backend-java

# Python AI服务日志
docker-compose logs backend-python

# Celery Worker日志
docker-compose logs ai-worker
```

---
