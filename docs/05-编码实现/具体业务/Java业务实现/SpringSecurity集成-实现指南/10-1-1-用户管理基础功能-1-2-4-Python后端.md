# Java Spring Boot 服务任务详细计划 - JAVA-001 Part1 - 1.1 用户管理基础功能 - 1.2.4 Python后端

> **说明**: Python AI 服务不直接实现认证，但需要验证来自前端的 JWT Token。

#### JWT Token 验证（Python）

```python
# backend/fastapi-ai-service/app/core/security.py
"""
JWT Token验证
需求编号: REQ-JAVA-001
"""
from typing import Optional, Dict, Any
from datetime import datetime, timedelta
from jose import jwt, JWTError
from fastapi import HTTPException, Security
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from app.core.config import settings
from app.core.logging import logger

# HTTP Bearer 认证方案
security = HTTPBearer()

class JWTValidator:
    """
    JWT Token验证器
    验证来自前端的JWT Token（由Java服务签发）
    """

    def __init__(self):
        self.secret_key = settings.JWT_SECRET
        self.algorithm = "HS256"

    def verify_token(self, token: str) -> Dict[str, Any]:
        """
        验证JWT Token

        Args:
            token: JWT Token字符串

        Returns:
            Token payload（包含user_id, username, permissions等）

        Raises:
            HTTPException: Token无效或过期
        """
        try:
            payload = jwt.decode(
                token,
                self.secret_key,
                algorithms=[self.algorithm]
            )

            # 检查过期时间
            exp = payload.get("exp")
            if exp is None:
                raise HTTPException(
                    status_code=401,
                    detail="Token缺少过期时间"
                )

            if datetime.fromtimestamp(exp) < datetime.utcnow():
                raise HTTPException(
                    status_code=401,
                    detail="Token已过期"
                )

            return payload

        except JWTError as e:
            logger.error(f"JWT验证失败: {str(e)}")
            raise HTTPException(
                status_code=401,
                detail="无效的Token"
            )

    def extract_user_id(self, token: str) -> str:
        """
        从Token中提取用户ID

        Args:
            token: JWT Token

        Returns:
            用户ID字符串
        """
        payload = self.verify_token(token)
        user_id = payload.get("sub")

        if not user_id:
            raise HTTPException(
                status_code=401,
                detail="Token缺少用户ID"
            )

        return user_id

    def extract_permissions(self, token: str) -> list[str]:
        """
        从Token中提取权限列表

        Args:
            token: JWT Token

        Returns:
            权限列表
        """
        payload = self.verify_token(token)
        return payload.get("permissions", [])

    def check_permission(self, token: str, required_permission: str) -> bool:
        """
        检查Token是否具有指定权限

        Args:
            token: JWT Token
            required_permission: 所需权限

        Returns:
            True-有权限, False-无权限
        """
        permissions = self.extract_permissions(token)
        return required_permission in permissions

# 全局实例
jwt_validator = JWTValidator()

# FastAPI Dependency
async def get_current_user_id(
    credentials: HTTPAuthorizationCredentials = Security(security)
) -> str:
    """
    FastAPI依赖注入：获取当前用户ID

    使用方式:
        @app.get("/api/ai/tasks")
        async def get_tasks(user_id: str = Depends(get_current_user_id)):
            ...
    """
    token = credentials.credentials
    return jwt_validator.extract_user_id(token)

async def require_permission(required_permission: str):
    """
    FastAPI依赖注入：检查权限

    使用方式:
        @app.post("/api/ai/tasks")
        async def create_task(
            _: None = Depends(require_permission("ai:generate"))
        ):
            ...
    """
    def permission_checker(
        credentials: HTTPAuthorizationCredentials = Security(security)
    ):
        token = credentials.credentials
        if not jwt_validator.check_permission(token, required_permission):
            raise HTTPException(
                status_code=403,
                detail=f"缺少权限: {required_permission}"
            )
        return None

    return permission_checker
```

#### Python API 路由（使用JWT认证）

```python
# backend/fastapi-ai-service/app/api/v1/endpoints/ai_tasks.py
"""
AI任务API端点
需求编号: REQ-AI-001, REQ-JAVA-001
"""
from fastapi import APIRouter, Depends, HTTPException
from typing import List
from app.core.security import get_current_user_id, require_permission
from app.schemas.ai_task import AITaskCreate, AITaskResponse
from app.services.ai.task_service import ai_task_service

router = APIRouter()

@router.get("/tasks", response_model=List[AITaskResponse])
async def get_ai_tasks(
    user_id: str = Depends(get_current_user_id)  # JWT认证
):
    """
    获取AI任务列表
    需要认证
    """
    tasks = await ai_task_service.get_user_tasks(user_id)
    return tasks

@router.post("/tasks", response_model=AITaskResponse)
async def create_ai_task(
    task_data: AITaskCreate,
    user_id: str = Depends(get_current_user_id),
    _: None = Depends(require_permission("ai:generate"))  # 权限检查
):
    """
    创建AI任务
    需要认证和"ai:generate"权限
    """
    task = await ai_task_service.create_task(task_data, user_id)
    return task
```

**验证标准**:
- [ ] JWT Token 验证正确
- [ ] Token 过期检查正确
- [ ] 用户ID 提取正确
- [ ] 权限检查正确
- [ ] 401/403 错误正确返回
- [ ] FastAPI Depends 正确使用
