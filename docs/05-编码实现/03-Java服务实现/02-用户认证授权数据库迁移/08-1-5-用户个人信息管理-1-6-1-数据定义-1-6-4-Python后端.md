# Java Spring Boot 服务任务详细计划 - JAVA-001 Part3 - 1.5: 用户个人信息管理 - 1.6.1 数据定义 - 1.6.4 Python后端

**任务描述**: Python服务不直接操作数据库schema，但需要读取权限数据进行JWT验证

**实现说明**:

Python AI服务**不负责**数据库迁移，但需要：

1. **读取权限数据**: 从PostgreSQL读取用户的roles和permissions（通过Java服务REST API）
2. **JWT验证**: 解析JWT token中的permissions字段，进行权限验证

**数据库连接配置** (仅用于读取，非迁移):

**文件**: `backend-python/app/core/database.py`

```python
# backend-python/app/core/database.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

# 创建数据库引擎（只读连接）
engine = create_engine(
    settings.DATABASE_URL,
    pool_pre_ping=True,
    pool_size=5,
    max_overflow=10,
    echo=settings.DEBUG
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def get_db():
    """获取数据库会话"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**JWT权限验证装饰器** (使用数据库中的权限数据):

**文件**: `backend-python/app/core/security.py`

```python
# backend-python/app/core/security.py
from functools import wraps
from typing import List
from fastapi import HTTPException, Depends
from jose import jwt, JWTError
from app.core.config import settings
from app.core.database import get_db

def require_permissions(required_permissions: List[str]):
    """
    权限验证装饰器

    从JWT token中提取permissions字段，验证用户是否拥有所需权限

    Args:
        required_permissions: 所需权限代码列表（如 ['document:parse', 'document:generate']）
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 获取当前用户（从JWT token解析）
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(status_code=401, detail="未登录")

            # 从JWT payload获取权限列表
            user_permissions = current_user.get('permissions', [])

            # 检查是否拥有所有所需权限
            missing_permissions = [
                perm for perm in required_permissions
                if perm not in user_permissions
            ]

            if missing_permissions:
                raise HTTPException(
                    status_code=403,
                    detail=f"缺少权限: {', '.join(missing_permissions)}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator

async def get_current_user(token: str = Depends(oauth2_scheme)):
    """
    从JWT token解析当前用户

    JWT payload格式:
    {
        "sub": "user_id",
        "email": "user@example.com",
        "permissions": ["user:read", "document:parse", ...],
        "exp": 1234567890
    }
    """
    try:
        payload = jwt.decode(
            token,
            settings.SECRET_KEY,
            algorithms=[settings.ALGORITHM]
        )
        user_id: str = payload.get("sub")
        if user_id is None:
            raise HTTPException(status_code=401, detail="Invalid token")

        return {
            "id": user_id,
            "email": payload.get("email"),
            "permissions": payload.get("permissions", [])
        }
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

**使用示例**:

```python
# backend-python/app/api/v1/ai.py
from fastapi import APIRouter, Depends, UploadFile, File
from app.core.security import require_permissions, get_current_user
from app.services.document_parser import DocumentParser

router = APIRouter()

@router.post("/parse-document")
@require_permissions(["document:parse"])  # 需要 document:parse 权限
async def parse_document(
    file: UploadFile = File(...),
    current_user: dict = Depends(get_current_user)
):
    """解析招标文档（需要权限验证）"""
    parser = DocumentParser()
    result = await parser.parse(file, user_id=current_user['id'])
    return {"success": True, "data": result}
```

**验证检查清单**:

1. Python后端 (100%)
   - [ ] 数据库只读连接配置正确
   - [ ] JWT权限验证装饰器正常工作
   - [ ] 权限检查逻辑正确
   - [ ] 不尝试执行数据库迁移

---
