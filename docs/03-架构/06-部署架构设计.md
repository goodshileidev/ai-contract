# AIæ ‡ä¹¦æ™ºèƒ½åˆ›ä½œå¹³å° - éƒ¨ç½²æ¶æ„è®¾è®¡

## ğŸ“‹ éƒ¨ç½²æ¦‚è§ˆ

### éƒ¨ç½²ç¯å¢ƒ

```yaml
ç¯å¢ƒè§„åˆ’:
  å¼€å‘ç¯å¢ƒ (Development):
    ç”¨é€”: æœ¬åœ°å¼€å‘å’Œè°ƒè¯•
    éƒ¨ç½²æ–¹å¼: Docker Compose
    è§„æ¨¡: å•æœºéƒ¨ç½²
    åŸŸå: dev.aibidcomposer.local

  æµ‹è¯•ç¯å¢ƒ (Testing):
    ç”¨é€”: åŠŸèƒ½æµ‹è¯•ã€é›†æˆæµ‹è¯•
    éƒ¨ç½²æ–¹å¼: Kubernetes (å•èŠ‚ç‚¹)
    è§„æ¨¡: å°è§„æ¨¡ï¼ˆ2C4Gï¼‰
    åŸŸå: test.aibidcomposer.com

  é¢„å‘ç¯å¢ƒ (Staging):
    ç”¨é€”: æ€§èƒ½æµ‹è¯•ã€UATæµ‹è¯•
    éƒ¨ç½²æ–¹å¼: Kubernetes (å¤šèŠ‚ç‚¹)
    è§„æ¨¡: ç”Ÿäº§åŒç­‰é…ç½®
    åŸŸå: staging.aibidcomposer.com

  ç”Ÿäº§ç¯å¢ƒ (Production):
    ç”¨é€”: æ­£å¼æœåŠ¡
    éƒ¨ç½²æ–¹å¼: Kubernetes (é«˜å¯ç”¨é›†ç¾¤)
    è§„æ¨¡: æ ¹æ®è´Ÿè½½åŠ¨æ€æ‰©å±•
    åŸŸå: www.aibidcomposer.com
```

### éƒ¨ç½²æ¶æ„

```
ç”Ÿäº§ç¯å¢ƒæ‹“æ‰‘:

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DNS / CDN         â”‚
                    â”‚   (CloudFlare/AWS)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load Balancer      â”‚
                    â”‚  (Nginx/ALB/SLB)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes Cluster                          â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Ingress Controller (Nginx/Traefik)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Gateway (Kong)                                     â”‚  â”‚
â”‚  â”‚  - Authentication                                        â”‚  â”‚
â”‚  â”‚  - Rate Limiting                                         â”‚  â”‚
â”‚  â”‚  - Load Balancing                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Application Services (Pods)                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ Frontend (3 replicas)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ Backend API (5 replicas)                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ AI Service (3 replicas)                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ Document Service (3 replicas)                      â”‚  â”‚
â”‚  â”‚  â””â”€ Worker Service (2 replicas)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Data Services (StatefulSets)                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ PostgreSQL (Primary + 2 Replicas)                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Redis (Cluster Mode, 6 nodes)                      â”‚  â”‚
â”‚  â”‚  â””â”€ RabbitMQ (3 nodes)                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    External Services                           â”‚
â”‚  â”œâ”€ MinIO / AWS S3 (Object Storage)                           â”‚
â”‚  â”œâ”€ Pinecone (Vector Database)                                â”‚
â”‚  â”œâ”€ Neo4j Cloud (Graph Database)                              â”‚
â”‚  â”œâ”€ OpenAI API (LLM Service)                                  â”‚
â”‚  â”œâ”€ Prometheus + Grafana (Monitoring)                         â”‚
â”‚  â””â”€ ELK Stack (Logging)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ³ Dockeré…ç½®

### 1. å‰ç«¯Dockerfile

```dockerfile
# ============================================================================
# å‰ç«¯ç”Ÿäº§ç¯å¢ƒDockerfile
# ============================================================================
# å¤šé˜¶æ®µæ„å»º

# é˜¶æ®µ1: æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# é˜¶æ®µ2: ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY docker/frontend/nginx.conf /etc/nginx/conf.d/default.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1

# å¯åŠ¨Nginx
CMD ["nginx", "-g", "daemon off;"]
```

### 2. å‰ç«¯Nginxé…ç½®

```nginx
# docker/frontend/nginx.conf
server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/x-javascript application/xml+rss
               application/javascript application/json;

    # ç¼“å­˜é™æ€èµ„æº
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPAè·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
    }

    # APIä»£ç†
    location /api {
        proxy_pass http://backend-service:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocketä»£ç†
    location /ws {
        proxy_pass http://backend-service:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 3. åç«¯Dockerfile

```dockerfile
# ============================================================================
# åç«¯ç”Ÿäº§ç¯å¢ƒDockerfile
# ============================================================================

FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements/prod.txt requirements.txt

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY app /app/app
COPY alembic /app/alembic
COPY alembic.ini /app/

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app

USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```

### 4. åç«¯å¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
# docker/backend/entrypoint.sh

set -e

echo "Waiting for database..."
while ! nc -z $POSTGRES_HOST $POSTGRES_PORT; do
  sleep 0.1
done
echo "Database is ready!"

echo "Running database migrations..."
alembic upgrade head

echo "Starting application..."
exec uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers ${WORKERS:-4}
```

### 5. Docker Compose (å¼€å‘ç¯å¢ƒ)

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:14-alpine
    container_name: aibidcomposer-postgres
    environment:
      POSTGRES_DB: aibidcomposer
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: aibidcomposer-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: aibidcomposer-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    container_name: aibidcomposer-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # åç«¯APIæœåŠ¡
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aibidcomposer-backend
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/aibidcomposer
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@rabbitmq:5672/
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      SECRET_KEY: ${SECRET_KEY}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./backend/app:/app/app
      - ./backend/alembic:/app/alembic
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Celery Worker
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aibidcomposer-celery-worker
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/aibidcomposer
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@rabbitmq:5672/
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    command: celery -A app.tasks.celery_app worker --loglevel=info

  # Celery Beat
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aibidcomposer-celery-beat
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/aibidcomposer
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@rabbitmq:5672/
    depends_on:
      - postgres
      - redis
      - rabbitmq
    command: celery -A app.tasks.celery_app beat --loglevel=info

  # å‰ç«¯åº”ç”¨
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: aibidcomposer-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    environment:
      VITE_API_BASE_URL: http://localhost:8000
    command: npm run dev

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  minio_data:
```

### 6. ç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
# .env.example
# å¤åˆ¶æ­¤æ–‡ä»¶ä¸º.envå¹¶å¡«å†™å®é™…å€¼

# æ•°æ®åº“é…ç½®
POSTGRES_PASSWORD=your_secure_password
DATABASE_URL=postgresql://postgres:your_secure_password@postgres:5432/aibidcomposer

# Redisé…ç½®
REDIS_PASSWORD=your_redis_password
REDIS_URL=redis://:your_redis_password@redis:6379/0

# RabbitMQé…ç½®
RABBITMQ_USER=rabbitmq
RABBITMQ_PASSWORD=your_rabbitmq_password
RABBITMQ_URL=amqp://rabbitmq:your_rabbitmq_password@rabbitmq:5672/

# MinIOé…ç½®
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=your_minio_password
MINIO_ENDPOINT=minio:9000

# åº”ç”¨é…ç½®
SECRET_KEY=your_secret_key_min_32_characters_long
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# AIæœåŠ¡é…ç½®
OPENAI_API_KEY=sk-your-openai-api-key
ANTHROPIC_API_KEY=your-anthropic-api-key

# Pineconeé…ç½®
PINECONE_API_KEY=your-pinecone-api-key
PINECONE_ENVIRONMENT=your-pinecone-environment

# Neo4jé…ç½®
NEO4J_URI=neo4j://neo4j:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_neo4j_password

# å‰ç«¯é…ç½®
VITE_API_BASE_URL=http://localhost:8000
VITE_WS_BASE_URL=ws://localhost:8000
```

## â˜¸ï¸ Kubernetesé…ç½®

### 1. Namespaceé…ç½®

```yaml
# k8s/namespaces/application.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: aibidcomposer
  labels:
    name: aibidcomposer
    environment: production
```

### 2. ConfigMapé…ç½®

```yaml
# k8s/configmaps/backend-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: aibidcomposer
data:
  LOG_LEVEL: "INFO"
  WORKERS: "4"
  ENVIRONMENT: "production"
  TZ: "Asia/Shanghai"
  CORS_ORIGINS: "https://www.aibidcomposer.com,https://app.aibidcomposer.com"
```

### 3. Secreté…ç½®

```yaml
# k8s/secrets/database-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: database-secret
  namespace: aibidcomposer
type: Opaque
stringData:
  POSTGRES_PASSWORD: "your_secure_password"
  DATABASE_URL: "postgresql://postgres:your_secure_password@postgres-service:5432/aibidcomposer"
```

```yaml
# k8s/secrets/api-keys-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: api-keys-secret
  namespace: aibidcomposer
type: Opaque
stringData:
  OPENAI_API_KEY: "sk-your-openai-api-key"
  ANTHROPIC_API_KEY: "your-anthropic-api-key"
  PINECONE_API_KEY: "your-pinecone-api-key"
  SECRET_KEY: "your_secret_key_min_32_characters_long"
```

### 4. PostgreSQL StatefulSet

```yaml
# k8s/statefulsets/postgres-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: aibidcomposer
spec:
  serviceName: postgres-service
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:14-alpine
        env:
        - name: POSTGRES_DB
          value: "aibidcomposer"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: POSTGRES_PASSWORD
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "standard"
      resources:
        requests:
          storage: 100Gi
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-service
  namespace: aibidcomposer
spec:
  ports:
  - port: 5432
    targetPort: 5432
  clusterIP: None
  selector:
    app: postgres
```

### 5. Redis StatefulSet

```yaml
# k8s/statefulsets/redis-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: aibidcomposer
spec:
  serviceName: redis-service
  replicas: 6
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - --cluster-enabled
        - "yes"
        - --cluster-config-file
        - /data/nodes.conf
        - --cluster-node-timeout
        - "5000"
        - --appendonly
        - "yes"
        - --requirepass
        - $(REDIS_PASSWORD)
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: REDIS_PASSWORD
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
  volumeClaimTemplates:
  - metadata:
      name: redis-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 6. åç«¯Deployment

```yaml
# k8s/deployments/backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: aibidcomposer
spec:
  replicas: 5
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
        version: v1
    spec:
      containers:
      - name: backend
        image: aibidcomposer/backend:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
          name: http
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: REDIS_URL
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: OPENAI_API_KEY
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: api-keys-secret
              key: SECRET_KEY
        envFrom:
        - configMapRef:
            name: backend-config
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: aibidcomposer
spec:
  selector:
    app: backend
  ports:
  - protocol: TCP
    port: 8000
    targetPort: 8000
  type: ClusterIP
```

### 7. å‰ç«¯Deployment

```yaml
# k8s/deployments/frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: aibidcomposer
spec:
  replicas: 3
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: aibidcomposer/frontend:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 80
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: aibidcomposer
spec:
  selector:
    app: frontend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
```

### 8. Ingressé…ç½®

```yaml
# k8s/ingress/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: aibidcomposer-ingress
  namespace: aibidcomposer
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
spec:
  tls:
  - hosts:
    - www.aibidcomposer.com
    - api.aibidcomposer.com
    secretName: aibidcomposer-tls
  rules:
  - host: www.aibidcomposer.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  - host: api.aibidcomposer.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 8000
```

### 9. HPA (æ°´å¹³Podè‡ªåŠ¨æ‰©ç¼©å®¹)

```yaml
# k8s/hpa/backend-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: aibidcomposer
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
```

### 10. PersistentVolume

```yaml
# k8s/persistentvolumes/postgres-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv
spec:
  capacity:
    storage: 100Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: standard
  hostPath:
    path: /mnt/data/postgres
```

## ğŸš€ éƒ¨ç½²è„šæœ¬

### 1. æ„å»ºè„šæœ¬

```bash
#!/bin/bash
# scripts/build-images.sh

set -e

VERSION=${1:-latest}
REGISTRY=${DOCKER_REGISTRY:-registry.example.com}

echo "Building Docker images version: $VERSION"

# æ„å»ºå‰ç«¯é•œåƒ
echo "Building frontend image..."
docker build -t $REGISTRY/aibidcomposer/frontend:$VERSION \
  -f docker/frontend/Dockerfile.prod \
  ./frontend

# æ„å»ºåç«¯é•œåƒ
echo "Building backend image..."
docker build -t $REGISTRY/aibidcomposer/backend:$VERSION \
  -f docker/backend/Dockerfile \
  ./backend

# æ¨é€é•œåƒ
if [ "$PUSH" = "true" ]; then
  echo "Pushing images to registry..."
  docker push $REGISTRY/aibidcomposer/frontend:$VERSION
  docker push $REGISTRY/aibidcomposer/backend:$VERSION
fi

echo "Build completed successfully!"
```

### 2. éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

ENVIRONMENT=${1:-production}
NAMESPACE="aibidcomposer"

echo "Deploying to $ENVIRONMENT environment..."

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# åº”ç”¨é…ç½®
echo "Applying ConfigMaps and Secrets..."
kubectl apply -f k8s/configmaps/ -n $NAMESPACE
kubectl apply -f k8s/secrets/ -n $NAMESPACE

# éƒ¨ç½²æ•°æ®æœåŠ¡
echo "Deploying data services..."
kubectl apply -f k8s/statefulsets/ -n $NAMESPACE

# ç­‰å¾…æ•°æ®æœåŠ¡å°±ç»ª
echo "Waiting for data services to be ready..."
kubectl wait --for=condition=ready pod -l app=postgres -n $NAMESPACE --timeout=300s
kubectl wait --for=condition=ready pod -l app=redis -n $NAMESPACE --timeout=300s

# éƒ¨ç½²åº”ç”¨æœåŠ¡
echo "Deploying application services..."
kubectl apply -f k8s/deployments/ -n $NAMESPACE

# åº”ç”¨HPA
echo "Applying HPA..."
kubectl apply -f k8s/hpa/ -n $NAMESPACE

# åº”ç”¨Ingress
echo "Applying Ingress..."
kubectl apply -f k8s/ingress/ -n $NAMESPACE

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
echo "Checking deployment status..."
kubectl get pods -n $NAMESPACE
kubectl get svc -n $NAMESPACE
kubectl get ingress -n $NAMESPACE

echo "Deployment completed successfully!"
```

### 3. å›æ»šè„šæœ¬

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

DEPLOYMENT=$1
NAMESPACE="aibidcomposer"

if [ -z "$DEPLOYMENT" ]; then
  echo "Usage: ./rollback.sh <deployment-name>"
  exit 1
fi

echo "Rolling back $DEPLOYMENT..."

kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE

kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE

echo "Rollback completed!"
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. Prometheusç›‘æ§

```yaml
# k8s/monitoring/prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - aibidcomposer
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
```

### 2. æ—¥å¿—æ”¶é›†

```yaml
# k8s/logging/fluentd-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: kube-system
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*aibidcomposer*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      format json
    </source>

    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      logstash_format true
      logstash_prefix aibidcomposer
    </match>
```

## ğŸ” å®‰å…¨é…ç½®

### 1. Network Policy

```yaml
# k8s/network-policies/backend-network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-network-policy
  namespace: aibidcomposer
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: kong
    ports:
    - protocol: TCP
      port: 8000
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
```

### 2. Pod Security Policy

```yaml
# k8s/security/pod-security-policy.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
  readOnlyRootFilesystem: false
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´11æœˆ14æ—¥
**Kubernetesç‰ˆæœ¬**: 1.28+
**Dockerç‰ˆæœ¬**: 24+
