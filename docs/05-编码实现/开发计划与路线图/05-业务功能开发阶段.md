---
文档类型: 实现文档
需求编号: DOC-2025-11-001
创建日期: 2025-11-29
创建者: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
最后更新: 2025-11-29
更新者: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
状态: 已批准
---

# AI标书智能创作平台 - 业务功能开发阶段

> **开发周期**: 第13-16周（4周）
> **团队**: 全员
> **目标**: 完成模板管理、企业能力库、协作审批、导出功能

## 📋 文档导航

本文档是开发计划与路线图的一部分，其他相关文档：

1. [00-开发计划总览.md](./00-开发计划总览.md) - 项目阶段概览和团队配置
2. [01-准备与基础设施阶段.md](./01-准备与基础设施阶段.md) - 阶段0-1开发计划
3. [02-后端开发阶段.md](./02-后端开发阶段.md) - 阶段2后端核心开发
4. [03-前端开发阶段.md](./03-前端开发阶段.md) - 阶段3前端核心开发
5. [04-AI能力开发阶段.md](./04-AI能力开发阶段.md) - 阶段4 AI能力开发
6. **05-业务功能开发阶段.md**（本文档）- 阶段5业务功能开发
7. [06-测试部署与总结.md](./06-测试部署与总结.md) - 阶段6-7测试部署

## 阶段5：业务功能开发 (第13-16周)


**目标**: 完成标书文档、模板、协作、审批等核心业务功能

### 任务 5.1: 标书文档管理

**负责人**: 后端工程师 + 前端工程师
**工时**: 32小时（后端16h + 前端16h）
**依赖**: 阶段4完成

**后端部分** (16h):

1. **文档Schema定义** (2h)
   - [ ] 创建BidDocumentCreate
   - [ ] 创建BidDocumentUpdate
   - [ ] 创建DocumentSectionCreate
   - [ ] 添加复杂字段验证

2. **文档CRUD** (6h)
   - [ ] 实现创建标书文档
   - [ ] 实现文档更新
   - [ ] 实现章节管理（CRUD）
   - [ ] 实现文档锁定机制（防止并发编辑）
   - [ ] 实现文档复制

3. **版本控制** (4h)
   - [ ] 实现版本创建
   - [ ] 实现版本比较
   - [ ] 实现版本回滚
   - [ ] 实现版本列表查询

4. **文档评论** (2h)
   - [ ] 实现评论CRUD
   - [ ] 实现评论回复
   - [ ] 实现@提醒

5. **API端点** (2h)
   - [ ] POST /api/v1/documents (创建文档)
   - [ ] PUT /api/v1/documents/{id} (更新文档)
   - [ ] POST /api/v1/documents/{id}/sections (创建章节)
   - [ ] POST /api/v1/documents/{id}/versions (创建版本)
   - [ ] GET /api/v1/documents/{id}/versions (版本列表)
   - [ ] POST /api/v1/documents/{id}/comments (添加评论)

**前端部分** (16h):

1. **文档编辑器** (8h)
   - [ ] 集成BlockNote编辑器:
     ```typescript
     import { useBlockNote } from '@blocknote/react';

     export function DocumentEditor({ documentId }: { documentId: string }) {
       const editor = useBlockNote({
         onEditorContentChange: (editor) => {
           // 自动保存
           debouncedSave(editor.getJSON());
         },
       });

       return <BlockNoteView editor={editor} />;
     }
     ```
   - [ ] 实现富文本编辑
   - [ ] 实现自动保存
   - [ ] 实现协作光标（Yjs）
   - [ ] 实现格式化工具栏

2. **章节管理** (3h)
   - [ ] 实现章节树形结构
   - [ ] 实现章节拖拽排序
   - [ ] 实现章节折叠/展开
   - [ ] 实现章节导航

3. **版本管理UI** (3h)
   - [ ] 实现版本列表
   - [ ] 实现版本对比界面
   - [ ] 实现版本回滚确认
   - [ ] 显示版本差异

4. **评论系统** (2h)
   - [ ] 实现评论面板
   - [ ] 实现评论输入
   - [ ] 实现@提醒下拉
   - [ ] 实现评论通知

**交付物**:
- 文档管理后端API
- 文档编辑器
- 章节管理UI
- 版本控制系统
- 评论系统

**验收标准**:
- 文档能够正常创建和编辑
- 章节管理正常
- 版本控制正常工作
- 评论功能正常
- 自动保存不丢失数据

---

### 任务 5.2: 模板管理

**负责人**: 后端工程师 + 前端工程师
**工时**: 24小时（后端12h + 前端12h）
**依赖**: 任务5.1

**后端部分** (12h):

1. **模板CRUD** (4h)
   - [ ] 实现模板创建
   - [ ] 实现模板更新
   - [ ] 实现模板查询（公开/私有）
   - [ ] 实现模板删除

2. **模板章节管理** (3h)
   - [ ] 实现模板章节CRUD
   - [ ] 实现章节排序
   - [ ] 支持变量占位符

3. **模板使用** (3h)
   - [ ] 实现从模板创建文档
   - [ ] 实现变量替换
   - [ ] 记录使用日志

4. **API端点** (2h)
   - [ ] 标准CRUD端点
   - [ ] POST /api/v1/templates/{id}/use (使用模板)

**前端部分** (12h):

1. **模板库** (5h)
   - [ ] 实现模板列表（卡片视图）
   - [ ] 实现模板预览
   - [ ] 实现模板搜索和筛选
   - [ ] 实现模板分类

2. **模板编辑器** (4h)
   - [ ] 复用文档编辑器
   - [ ] 添加变量插入功能
   - [ ] 添加变量管理
   - [ ] 预览变量效果

3. **使用模板对话框** (3h)
   - [ ] 实现变量填写表单
   - [ ] 实现预览生成结果
   - [ ] 实现创建文档

**交付物**:
- 模板管理API
- 模板库UI
- 模板编辑器
- 使用模板功能

**验收标准**:
- 模板CRUD正常
- 能够从模板创建文档
- 变量替换正确
- 模板库易用

---

### 任务 5.3: 实时协作

**负责人**: 后端工程师 + 前端工程师
**工时**: 28小时（后端14h + 前端14h）
**依赖**: 任务5.1

**后端部分** (14h):

1. **WebSocket配置** (4h)
   - [ ] 安装websockets: `pip install websockets`
   - [ ] 配置FastAPI WebSocket:
     ```python
     from fastapi import WebSocket, WebSocketDisconnect

     @app.websocket("/ws/collaboration/{document_id}")
     async def websocket_endpoint(
         websocket: WebSocket,
         document_id: str,
         token: str
     ):
         # 验证token
         user = await verify_token(token)

         # 加入协作会话
         await collaboration_manager.connect(document_id, user.id, websocket)

         try:
             while True:
                 data = await websocket.receive_json()
                 await collaboration_manager.broadcast(
                     document_id,
                     data,
                     exclude=[user.id]
                 )
         except WebSocketDisconnect:
             await collaboration_manager.disconnect(document_id, user.id)
     ```

2. **协作管理器** (5h)
   - [ ] 创建ConnectionManager:
     ```python
     class CollaborationManager:
         def __init__(self):
             self.active_connections: dict[str, list[WebSocket]] = {}

         async def connect(self, document_id: str, user_id: str, websocket: WebSocket):
             await websocket.accept()
             if document_id not in self.active_connections:
                 self.active_connections[document_id] = []
             self.active_connections[document_id].append({
                 "user_id": user_id,
                 "websocket": websocket
             })

             # 通知其他用户
             await self.broadcast(
                 document_id,
                 {"type": "user_joined", "user_id": user_id},
                 exclude=[user_id]
             )

         async def disconnect(self, document_id: str, user_id: str):
             # 移除连接
             # 通知其他用户
             pass

         async def broadcast(self, document_id: str, message: dict, exclude: list[str] = []):
             if document_id in self.active_connections:
                 for conn in self.active_connections[document_id]:
                     if conn["user_id"] not in exclude:
                         await conn["websocket"].send_json(message)
     ```
   - [ ] 实现连接管理
   - [ ] 实现消息广播
   - [ ] 实现断线重连

3. **协作事件** (3h)
   - [ ] 实现光标位置同步
   - [ ] 实现选区同步
   - [ ] 实现编辑操作同步
   - [ ] 实现用户在线状态

4. **协作会话** (2h)
   - [ ] 记录协作会话
   - [ ] 记录协作事件
   - [ ] 实现会话查询

**前端部分** (14h):

1. **WebSocket客户端** (4h)
   - [ ] 创建WebSocket连接:
     ```typescript
     export class CollaborationClient {
       private ws: WebSocket | null = null;

       connect(documentId: string, token: string) {
         this.ws = new WebSocket(
           `ws://localhost:8000/ws/collaboration/${documentId}?token=${token}`
         );

         this.ws.onmessage = (event) => {
           const data = JSON.parse(event.data);
           this.handleMessage(data);
         };

         this.ws.onclose = () => {
           // 重连逻辑
           setTimeout(() => this.connect(documentId, token), 3000);
         };
       }

       send(message: any) {
         if (this.ws?.readyState === WebSocket.OPEN) {
           this.ws.send(JSON.stringify(message));
         }
       }

       disconnect() {
         this.ws?.close();
       }
     }
     ```
   - [ ] 实现自动重连
   - [ ] 实现消息队列
   - [ ] 实现心跳检测

2. **Yjs集成** (6h)
   - [ ] 安装Yjs: `npm install yjs y-websocket`
   - [ ] 集成到BlockNote:
     ```typescript
     import * as Y from 'yjs';
     import { WebsocketProvider } from 'y-websocket';

     const ydoc = new Y.Doc();
     const provider = new WebsocketProvider(
       'ws://localhost:8000/yjs',
       documentId,
       ydoc
     );

     const editor = useBlockNote({
       collaboration: {
         provider,
         fragment: ydoc.getXmlFragment('prosemirror'),
         user: {
           name: currentUser.name,
           color: generateColor(currentUser.id),
         },
       },
     });
     ```
   - [ ] 实现CRDT同步
   - [ ] 实现冲突解决

3. **协作UI** (4h)
   - [ ] 显示在线用户列表
   - [ ] 显示协作光标
   - [ ] 显示用户选区
   - [ ] 显示编辑状态

**交付物**:
- WebSocket服务
- 协作管理器
- 实时同步系统
- 协作UI

**验收标准**:
- 多用户能够同时编辑
- 编辑内容实时同步
- 没有冲突丢失
- 协作光标正常显示
- 网络断开能够重连

---

### 任务 5.4: 审批工作流

**负责人**: 后端工程师 + 前端工程师
**工时**: 24小时（后端12h + 前端12h）
**依赖**: 任务5.1

**后端部分** (12h):

1. **工作流定义** (4h)
   - [ ] 实现工作流模板CRUD
   - [ ] 实现审批节点配置
   - [ ] 实现条件分支
   - [ ] 支持串行/并行审批

2. **审批任务** (4h)
   - [ ] 实现创建审批实例
   - [ ] 实现审批操作（通过/拒绝/转交）
   - [ ] 实现审批历史记录
   - [ ] 实现审批提醒

3. **API端点** (2h)
   - [ ] POST /api/v1/approvals (创建审批)
   - [ ] POST /api/v1/approvals/{id}/approve (审批通过)
   - [ ] POST /api/v1/approvals/{id}/reject (审批拒绝)
   - [ ] GET /api/v1/approvals/pending (待审批列表)

4. **通知集成** (2h)
   - [ ] 实现邮件通知
   - [ ] 实现站内通知
   - [ ] 实现WebSocket推送

**前端部分** (12h):

1. **工作流设计器** (6h)
   - [ ] 集成流程图库（React Flow）
   - [ ] 实现节点拖拽
   - [ ] 实现连线
   - [ ] 实现节点配置

2. **审批界面** (4h)
   - [ ] 实现待审批列表
   - [ ] 实现审批详情
   - [ ] 实现审批操作按钮
   - [ ] 实现审批历史时间线

3. **通知中心** (2h)
   - [ ] 实现通知列表
   - [ ] 实现通知标记
   - [ ] 实现实时推送

**交付物**:
- 审批工作流引擎
- 工作流设计器
- 审批界面
- 通知系统

**验收标准**:
- 工作流能够正常执行
- 审批操作正常
- 通知及时送达
- 审批历史完整

---

## 阶段6：集成测试与优化 (第17-18周)

## 🔗 相关文档

- **开发计划总览**: [00-开发计划总览.md](./00-开发计划总览.md)
- **后端开发**: [02-后端开发阶段.md](./02-后端开发阶段.md)
- **前端开发**: [03-前端开发阶段.md](./03-前端开发阶段.md)
- **AI能力开发**: [04-AI能力开发阶段.md](./04-AI能力开发阶段.md)

## 修改历史

| 日期 | 版本 | 修改者 | 修改内容概要 |
|------|------|--------|-------------|
| 2025-11-29 | 1.0 | claude-sonnet-4-5 (claude-sonnet-4-5-20250929) | 从开发计划与路线图.md拆分创建业务功能开发阶段文档 |

---

**文档版本**: v1.0
**创建时间**: 2025年11月29日
**文档状态**: ✅ 已批准
