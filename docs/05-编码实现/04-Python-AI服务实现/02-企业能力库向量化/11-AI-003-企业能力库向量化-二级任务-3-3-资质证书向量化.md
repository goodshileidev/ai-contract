# Python FastAPI AI 服务任务详细计划 - AI-003 - AI-003: 企业能力库向量化 - 二级任务 3.3: 资质证书向量化

**工作量估算**: 3 人天
**优先级**: P2 - 中优先级
**技术难点**:
- 证书信息的标准化提取
- 有效期管理
- 证书图片的OCR识别（可选）

#### 1) 数据定义

##### Pydantic模型
```python
# app/models/certification.py
class Certification(BaseModel):
    """资质证书模型"""
    id: str
    organization_id: str

    # 证书信息
    certification_name: str = Field(..., description="证书名称")
    certification_type: str = Field(..., description="证书类型")
    issuing_authority: str = Field(..., description="颁发机构")
    certificate_number: Optional[str] = Field(None, description="证书编号")

    # 有效期
    issue_date: Optional[date] = Field(None, description="颁发日期")
    expiry_date: Optional[date] = Field(None, description="到期日期")
    is_valid: bool = Field(True, description="是否有效")

    # 详细信息
    scope: Optional[str] = Field(None, description="认证范围")
    level: Optional[str] = Field(None, description="等级")
    certificate_url: Optional[str] = Field(None, description="证书文件URL")

    # 向量化
    embedding: Optional[List[float]] = None
    vectorized_at: Optional[datetime] = None

    tags: List[str] = Field(default_factory=list)
    created_at: datetime = Field(default_factory=datetime.utcnow)
```

##### 数据库表
```sql
CREATE TABLE certifications (
    id UUID PRIMARY KEY,
    organization_id UUID NOT NULL,
    certification_name VARCHAR(200) NOT NULL,
    certification_type VARCHAR(100),
    issuing_authority VARCHAR(200),
    certificate_number VARCHAR(100),
    issue_date DATE,
    expiry_date DATE,
    is_valid BOOLEAN DEFAULT TRUE,
    scope TEXT,
    level VARCHAR(50),
    certificate_url TEXT,
    embedding_status VARCHAR(20) DEFAULT 'pending',
    vectorized_at TIMESTAMP WITH TIME ZONE,
    tags TEXT[],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (organization_id) REFERENCES organizations(id)
);

-- 索引
CREATE INDEX idx_certifications_org ON certifications(organization_id);
CREATE INDEX idx_certifications_type ON certifications(certification_type);
CREATE INDEX idx_certifications_valid ON certifications(is_valid, expiry_date);
```

**验证标准**:
- [ ] 模型验证通过
- [ ] 表创建成功
- [ ] 有效期字段类型正确

#### 2) 前端

```typescript
// src/pages/Capability/CertificationList.tsx
export default function CertificationList() {
  const columns: ProColumns<Certification>[] = [
    {
      title: '证书名称',
      dataIndex: 'certificationName',
      width: 200,
    },
    {
      title: '类型',
      dataIndex: 'certificationType',
      width: 150,
      valueType: 'select',
      valueEnum: {
        iso: 'ISO认证',
        qualification: '企业资质',
        patent: '专利证书',
        software: '软件著作权',
      },
    },
    {
      title: '颁发机构',
      dataIndex: 'issuingAuthority',
      width: 200,
    },
    {
      title: '证书编号',
      dataIndex: 'certificateNumber',
      width: 150,
    },
    {
      title: '颁发日期',
      dataIndex: 'issueDate',
      width: 120,
      valueType: 'date',
    },
    {
      title: '到期日期',
      dataIndex: 'expiryDate',
      width: 120,
      valueType: 'date',
      render: (_, record) => {
        const isExpiringSoon = record.expiryDate &&
          new Date(record.expiryDate) < new Date(Date.now() + 90 * 24 * 60 * 60 * 1000);
        return (
          <span style={{ color: isExpiringSoon ? 'red' : 'inherit' }}>
            {record.expiryDate}
            {isExpiringSoon && <Tag color="orange">即将到期</Tag>}
          </span>
        );
      },
    },
    {
      title: '状态',
      dataIndex: 'isValid',
      width: 100,
      valueType: 'select',
      valueEnum: {
        true: { text: '有效', status: 'Success' },
        false: { text: '已过期', status: 'Error' },
      },
    },
    {
      title: '向量化状态',
      dataIndex: 'embeddingStatus',
      width: 120,
      valueEnum: {
        pending: { text: '待处理', status: 'Default' },
        completed: { text: '已完成', status: 'Success' },
      },
    },
    {
      title: '操作',
      width: 180,
      render: (_, record) => (
        <Space>
          <a onClick={() => handleView(record.certificateUrl)}>查看证书</a>
          <a onClick={() => handleEdit(record)}>编辑</a>
          <a onClick={() => handleVectorize(record)}>向量化</a>
        </Space>
      ),
    },
  ];

  return (
    <ProTable<Certification>
      headerTitle="资质证书库"
      columns={columns}
      toolBarRender={() => [
        <Button key="add" type="primary" icon={<PlusOutlined />}>
          新增证书
        </Button>,
        <Button key="check" onClick={handleCheckExpiry}>
          检查到期证书
        </Button>,
      ]}
    />
  );
}
```

**验证标准**:
- [ ] 即将到期证书高亮显示
- [ ] 证书文件能正常查看
- [ ] 批量向量化功能正常

#### 3) Java后端

```java
@Service
public class CertificationService {

    /**
     * 创建资质证书
     * 需求编号: REQ-AI-003
     */
    public Certification createCertification(CreateCertificationRequest request) {
        Certification cert = new Certification();
        cert.setOrganizationId(request.getOrganizationId());
        cert.setCertificationName(request.getCertificationName());
        cert.setCertificationType(request.getCertificationType());
        cert.setIssuingAuthority(request.getIssuingAuthority());
        cert.setCertificateNumber(request.getCertificateNumber());
        cert.setIssueDate(request.getIssueDate());
        cert.setExpiryDate(request.getExpiryDate());

        // 检查有效性
        cert.setIsValid(checkValidity(request.getExpiryDate()));

        cert.setEmbeddingStatus("pending");
        certificationMapper.insert(cert);

        // 发送向量化消息
        VectorizeMessage message = VectorizeMessage.builder()
            .capabilityId(cert.getId())
            .capabilityType("certification")
            .organizationId(cert.getOrganizationId())
            .build();

        rabbitTemplate.convertAndSend(
            "ai.vectorize.exchange",
            "vectorize.certification",
            message
        );

        return cert;
    }

    /**
     * 检查即将到期的证书
     */
    public List<Certification> checkExpiringCertifications(int daysBeforeExpiry) {
        LocalDate expiryThreshold = LocalDate.now().plusDays(daysBeforeExpiry);

        return certificationMapper.selectList(
            new QueryWrapper<Certification>()
                .le("expiry_date", expiryThreshold)
                .ge("expiry_date", LocalDate.now())
                .eq("is_valid", true)
        );
    }

    private boolean checkValidity(LocalDate expiryDate) {
        if (expiryDate == null) {
            return true;  // 长期有效
        }
        return expiryDate.isAfter(LocalDate.now());
    }
}
```

**验证标准**:
- [ ] 证书有效性自动判断
- [ ] 即将到期证书能正确查询
- [ ] 向量化消息发送成功

#### 4) Python后端

```python
# app/services/ai/certification_vectorization_service.py
class CertificationVectorizationService:
    """资质证书向量化服务"""

    async def vectorize_certification(
        self,
        certification_id: str,
        organization_id: str
    ) -> Dict[str, Any]:
        """向量化资质证书"""

        # 1. 获取证书详情
        response = await self.java_client.get(
            f"/api/v1/capabilities/certifications/{certification_id}"
        )
        cert_data = response.json()['data']

        # 2. 构建向量化文本
        vectorize_text = self._build_certification_text(cert_data)

        # 3. 生成向量
        embedding = await self.embedding_model.aget_text_embedding(vectorize_text)

        # 4. 存储到Elasticsearch
        await self.es_store.add_document(
            doc_id=certification_id,
            embedding=embedding,
            metadata={
                'capability_id': certification_id,
                'organization_id': organization_id,
                'capability_type': 'certification',
                'certification_name': cert_data['certificationName'],
                'certification_type': cert_data['certificationType'],
                'issuing_authority': cert_data['issuingAuthority'],
                'issue_date': cert_data.get('issueDate'),
                'expiry_date': cert_data.get('expiryDate'),
                'is_valid': cert_data.get('isValid', True),
                'scope': cert_data.get('scope'),
                'level': cert_data.get('level'),
                'tags': cert_data.get('tags', []),
                'vectorized_at': datetime.utcnow().isoformat()
            },
            index_name="capabilities"
        )

        # 5. 回调Java服务
        await self._callback_java_service(certification_id, "completed")

        return {
            'certification_id': certification_id,
            'status': 'completed'
        }

    def _build_certification_text(self, cert_data: Dict[str, Any]) -> str:
        """构建证书向量化文本"""
        parts = []

        parts.append(f"证书名称：{cert_data['certificationName']}")
        parts.append(f"证书类型：{cert_data.get('certificationType', '未分类')}")
        parts.append(f"颁发机构：{cert_data['issuingAuthority']}")

        if cert_data.get('scope'):
            parts.append(f"认证范围：{cert_data['scope']}")

        if cert_data.get('level'):
            parts.append(f"等级：{cert_data['level']}")

        if cert_data.get('certificateNumber'):
            parts.append(f"证书编号：{cert_data['certificateNumber']}")

        return "\n".join(parts)
```

**验证标准**:
- [ ] 证书文本构建完整
- [ ] 有效期信息正确存储
- [ ] 向量生成成功

#### 5) 部署

```yaml
# RabbitMQ队列配置
services:
  vectorization-consumer:
    environment:
      - CERT_QUEUE_NAME=ai.vectorize.certification.queue
```

**验证标准**:
- [ ] 证书向量化队列正常工作
- [ ] Worker能处理证书向量化任务

---
