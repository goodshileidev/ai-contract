---
文档类型: 架构文档
需求编号: DOC-2025-11-001
创建日期: 2025-11-15
创建者: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
最后更新: 2025-11-26
更新者: claude-sonnet-4-5 (claude-sonnet-4-5-20250929)
状态: 已批准
---

# AI标书智能创作平台 - 数据库设计 - ✅ 审批域

### 29. approval_workflows (审批流程表)

```sql
CREATE TABLE approval_workflows (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(200) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    workflow_type VARCHAR(50) DEFAULT 'sequential' CHECK (workflow_type IN ('sequential', 'parallel', 'conditional', 'custom')),
    organization_id UUID,
    document_type VARCHAR(50),
    definition JSONB NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    is_default BOOLEAN DEFAULT FALSE,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_by UUID,
    updated_by UUID,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE,
    FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL
);

-- 索引
CREATE INDEX idx_approval_workflows_code ON approval_workflows(code) WHERE deleted_at IS NULL;
CREATE INDEX idx_approval_workflows_organization_id ON approval_workflows(organization_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_approval_workflows_is_active ON approval_workflows(is_active);

-- 注释
COMMENT ON TABLE approval_workflows IS '审批流程表';
COMMENT ON COLUMN approval_workflows.definition IS '流程定义(JSON)';
```

### 30. approval_tasks (审批任务表)

```sql
CREATE TABLE approval_tasks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    workflow_id UUID NOT NULL,
    document_id UUID NOT NULL,
    task_name VARCHAR(200) NOT NULL,
    step_number INTEGER NOT NULL,
    assignee_id UUID NOT NULL,
    assignee_type VARCHAR(20) DEFAULT 'user' CHECK (assignee_type IN ('user', 'role')),
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'cancelled')),
    decision VARCHAR(20),
    comments TEXT,
    deadline TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES approval_workflows(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES bid_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (assignee_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_approval_tasks_workflow_id ON approval_tasks(workflow_id);
CREATE INDEX idx_approval_tasks_document_id ON approval_tasks(document_id);
CREATE INDEX idx_approval_tasks_assignee_id ON approval_tasks(assignee_id);
CREATE INDEX idx_approval_tasks_status ON approval_tasks(status);
CREATE INDEX idx_approval_tasks_deadline ON approval_tasks(deadline) WHERE status = 'pending';

-- 注释
COMMENT ON TABLE approval_tasks IS '审批任务表';
```

### 31. approval_logs (审批日志表)

```sql
CREATE TABLE approval_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    task_id UUID NOT NULL,
    document_id UUID NOT NULL,
    user_id UUID NOT NULL,
    action VARCHAR(50) NOT NULL CHECK (action IN ('submit', 'approve', 'reject', 'reassign', 'cancel', 'comment')),
    decision VARCHAR(20),
    comments TEXT,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES approval_tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (document_id) REFERENCES bid_documents(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_approval_logs_task_id ON approval_logs(task_id);
CREATE INDEX idx_approval_logs_document_id ON approval_logs(document_id);
CREATE INDEX idx_approval_logs_user_id ON approval_logs(user_id);
CREATE INDEX idx_approval_logs_created_at ON approval_logs(created_at DESC);

-- 注释
COMMENT ON TABLE approval_logs IS '审批日志表';
```
