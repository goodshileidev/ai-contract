# Java Spring Boot 服务任务详细计划 - JAVA-001 Part2 - 1.4: 权限控制 - 1.4.4 Python后端

**验证清单**:
- [ ] JWT权限验证中间件实现
- [ ] 角色权限检查装饰器实现

#### 权限检查装饰器

```python
# backend-python/app/core/security.py
from functools import wraps
from typing import List, Optional
from fastapi import HTTPException, status, Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from jose import jwt, JWTError
from app.core.config import settings
from app.models.user import User

# JWT Bearer Token验证
security = HTTPBearer()

def decode_token(token: str) -> dict:
    """
    解码JWT Token
    需求编号: REQ-JAVA-001
    """
    try:
        payload = jwt.decode(
            token,
            settings.JWT_SECRET_KEY,
            algorithms=[settings.JWT_ALGORITHM]
        )
        return payload
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="无效的Token"
        )

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> dict:
    """
    从Token获取当前用户信息
    需求编号: REQ-JAVA-001
    """
    token = credentials.credentials
    payload = decode_token(token)

    user_id = payload.get("sub")
    if not user_id:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Token中缺少用户信息"
        )

    return payload

def require_permissions(required_permissions: List[str]):
    """
    权限检查装饰器

    使用示例:
    @router.post("/documents")
    @require_permissions(["document:create"])
    async def create_document(current_user: dict = Depends(get_current_user)):
        ...

    需求编号: REQ-JAVA-001
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 从依赖注入获取current_user
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="未登录"
                )

            # 检查权限
            user_permissions = current_user.get('permissions', [])

            missing_permissions = [
                perm for perm in required_permissions
                if perm not in user_permissions
            ]

            if missing_permissions:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"缺少权限: {', '.join(missing_permissions)}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator

def require_roles(required_roles: List[str]):
    """
    角色检查装饰器

    使用示例:
    @router.delete("/users/{user_id}")
    @require_roles(["ADMIN"])
    async def delete_user(user_id: str, current_user: dict = Depends(get_current_user)):
        ...

    需求编号: REQ-JAVA-001
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            current_user = kwargs.get('current_user')
            if not current_user:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="未登录"
                )

            # 检查角色
            user_roles = current_user.get('roles', [])

            has_required_role = any(role in user_roles for role in required_roles)

            if not has_required_role:
                raise HTTPException(
                    status_code=status.HTTP_403_FORBIDDEN,
                    detail=f"需要以下角色之一: {', '.join(required_roles)}"
                )

            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

#### AI服务权限检查示例

```python
# backend-python/app/api/v1/ai.py
from fastapi import APIRouter, Depends, UploadFile, File
from app.core.security import get_current_user, require_permissions
from app.services.ai.document_parser import DocumentParser

router = APIRouter()

@router.post("/parse-document")
@require_permissions(["document:parse"])
async def parse_document(
    file: UploadFile = File(...),
    current_user: dict = Depends(get_current_user)
):
    """
    解析招标文件（需要 document:parse 权限）
    需求编号: REQ-AI-001
    """
    parser = DocumentParser()
    result = await parser.parse(file, user_id=current_user['sub'])

    return {
        "success": True,
        "data": result
    }

@router.post("/generate-content")
@require_permissions(["document:generate"])
async def generate_content(
    document_id: str,
    section_id: str,
    current_user: dict = Depends(get_current_user)
):
    """
    生成内容（需要 document:generate 权限）
    需求编号: REQ-AI-002
    """
    # AI内容生成逻辑
    pass
```
